from pyspark.sql import functions as F
from pyspark.sql.window import Window

# =========================
# 0) Parámetros hardcode
# =========================
gerentes = ["GXXXXX"]  # <-- reemplaza
supervisores = ["S00001", "S00002", "S00003", "S00004", "S00005", "S00006"]  # <-- reemplaza

# Procesos
is_tc = F.col("PROCESO").like("%APROBACION CREDITOS TC%")
is_cef = (
    F.col("PROCESO").isin(
        "CO SOLICITUD APROBACIONES TLMK",
        "SFCP APROBACIONES EDUCATIVO",
        "CO SOLICITUD APROBACIONES"
    )
)

# Pasos
paso_tc_analista = (F.col("NBRPASO") == "APROBACION DE CREDITOS ANALISTA")
paso_tc_supervisor = (F.col("NBRPASO") == "APROBACION DE CREDITOS SUPERVISOR")
paso_tc_gerente = (F.col("NBRPASO") == "APROBACION DE CREDITOS GERENTE")

paso_cef_analista = (F.col("NBRPASO") == "EVALUACION DE SOLICITUD")
paso_cef_aprobador = (F.col("NBRPASO") == "EVALUACION DE SOLICITUD APROBADOR")

# Helpers: rol de una matrícula
def rol_por_matricula(col_mat):
    return (
        F.when(col_mat.isin(gerentes), F.lit("GERENTE"))
         .when(col_mat.isin(supervisores), F.lit("SUPERVISOR"))
         .when(col_mat.isNotNull(), F.lit("ANALISTA"))
         .otherwise(F.lit(None))
    )

def es_sup_o_ger(col_mat):
    return col_mat.isin(gerentes + supervisores)

# =========================
# 1) Pegar productos a estados (sin duplicar)
# =========================
df_productos_for_join = (
    df_productos_enriq
      .select(
          "CODSOLICITUD",
          "NBRPRODUCTO",
          "ETAPA",
          "TIPACCION",
          "FECCREACION",
          "CODMESCREACION",
          "NBRANALISTA",
          "MATORGANICO_ANALISTA",
          "MATSUPERIOR_ANALISTA"
      )
      .dropDuplicates(["CODSOLICITUD"])
)

df_estados_prod = (
    df_salesforce_enriq
      .join(df_productos_for_join, on="CODSOLICITUD", how="left")
      .withColumn("TIPO_PRODUCTO", F.when(is_tc, "TC").when(is_cef, "CEF").otherwise("OTRO"))
)

# =========================
# 2) df_last_estado: último evento por CODSOLICITUD (MÁS ACTUAL)
# =========================
w_last = Window.partitionBy("CODSOLICITUD").orderBy(
    F.col("FECHORINICIOEVALUACION").desc(),
    F.col("FECHORFINEVALUACION").desc()
)

df_last_estado = (
    df_estados_prod
      .withColumn("rn_last", F.row_number().over(w_last))
      .filter(F.col("rn_last") == 1)
      .select(
          "CODSOLICITUD",
          F.col("CODMESEVALUACION").alias("CODMESEVALUACION_ULTIMO"),
          F.col("PROCESO").alias("PROCESO_ULTIMO"),
          F.col("NBRPASO").alias("NBRPASO_ULTIMO"),
          F.col("ESTADOSOLICITUD").alias("ESTADOSOLICITUD_ULTIMO"),
          F.col("FECINICIOEVALUACION").alias("FECINICIOEVALUACION_ULTIMO"),
          F.col("HORINICIOEVALUACION").alias("HORINICIOEVALUACION_ULTIMO"),
          F.col("FECHORINICIOEVALUACION").alias("FECHORINICIOEVALUACION_ULTIMO"),
          F.col("FECFINEVALUACION").alias("FECFINEVALUACION_ULTIMO"),
          F.col("HORFINEVALUACION").alias("HORFINEVALUACION_ULTIMO"),
          F.col("FECHORFINEVALUACION").alias("FECHORFINEVALUACION_ULTIMO"),
          F.col("NBRULTACTOR").alias("NBRULTACTOR_ULTIMO"),
          F.col("NBRULTACTORPASO").alias("NBRULTACTORPASO_ULTIMO"),
      )
)

# =========================
# 3) df_base_analista: resolver analista desde PASO BASE (Mat1->Mat2->Mat3)
# =========================
es_paso_base = (
    (is_tc & paso_tc_analista) |
    (is_cef & paso_cef_analista)
)

df_base_candidates = (
    df_estados_prod
      .filter(es_paso_base)
      .withColumn("MAT1", F.col("MATORGANICO"))       # Mat1
      .withColumn("MAT2", F.col("MATORGANICOPASO"))   # Mat2
      .withColumn("MAT3", F.col("MATORGANICO_ANALISTA"))  # Mat3 (productos)
      .withColumn(
          "MAT_ANALISTA_ESTADOS",
          F.when(F.col("MAT1").isNotNull() & (~es_sup_o_ger(F.col("MAT1"))), F.col("MAT1"))
           .when(F.col("MAT2").isNotNull() & (~es_sup_o_ger(F.col("MAT2"))), F.col("MAT2"))
           .otherwise(F.lit(None).cast("string"))
      )
      .withColumn(
          "ORIGEN_MAT_ANALISTA_ESTADOS",
          F.when(F.col("MAT1").isNotNull() & (~es_sup_o_ger(F.col("MAT1"))), F.lit("ESTADOS_MAT1"))
           .when(F.col("MAT2").isNotNull() & (~es_sup_o_ger(F.col("MAT2"))), F.lit("ESTADOS_MAT2"))
           .otherwise(F.lit(None))
      )
)

# quedarnos con el paso base MÁS RECIENTE por solicitud
w_base = Window.partitionBy("CODSOLICITUD").orderBy(F.col("FECHORINICIOEVALUACION").desc())

df_base_analista = (
    df_base_candidates
      .withColumn("rn_base", F.row_number().over(w_base))
      .filter(F.col("rn_base") == 1)
      .select(
          "CODSOLICITUD",
          F.lit(1).alias("FLG_EXISTE_PASO_BASE"),
          F.col("MAT_ANALISTA_ESTADOS"),
          F.col("ORIGEN_MAT_ANALISTA_ESTADOS"),
          F.col("FECHORINICIOEVALUACION").alias("TS_PASO_BASE")
      )
)

# =========================
# 4) df_autonomia: detectar autonomía (TC por paso, CEF por aprobador)
# =========================

# --- TC autonomía: si hay GERENTE -> gerente; si no, SUPERVISOR -> supervisor
df_aut_tc = (
    df_estados_prod
      .filter(is_tc & (paso_tc_gerente | paso_tc_supervisor))
      .withColumn("MAT1", F.col("MATORGANICO"))
      .withColumn("MAT2", F.col("MATORGANICOPASO"))
      .withColumn("MAT_AUTONOMIA", F.coalesce(F.col("MAT1"), F.col("MAT2")))
      .withColumn(
          "ROL_AUTONOMIA",
          F.when(paso_tc_gerente, F.lit("GERENTE"))
           .when(paso_tc_supervisor, F.lit("SUPERVISOR"))
      )
      .withColumn(
          "PRIORIDAD_AUTONOMIA",
          F.when(F.col("ROL_AUTONOMIA") == "GERENTE", F.lit(3))
           .when(F.col("ROL_AUTONOMIA") == "SUPERVISOR", F.lit(2))
           .otherwise(F.lit(0))
      )
      .withColumn("NBRPASO_AUTONOMIA", F.col("NBRPASO"))
)

# --- CEF autonomía: solo cuando existe APROBADOR
df_aut_cef = (
    df_estados_prod
      .filter(is_cef & paso_cef_aprobador)
      .withColumn("MAT1", F.col("MATORGANICO"))
      .withColumn("MAT2", F.col("MATORGANICOPASO"))
      .withColumn("MAT_AUTONOMIA", F.coalesce(F.col("MAT1"), F.col("MAT2")))
      .withColumn("ROL_AUTONOMIA", rol_por_matricula(F.col("MAT_AUTONOMIA")))
      .withColumn(
          "PRIORIDAD_AUTONOMIA",
          F.when(F.col("ROL_AUTONOMIA") == "GERENTE", F.lit(3))
           .when(F.col("ROL_AUTONOMIA") == "SUPERVISOR", F.lit(2))
           .when(F.col("ROL_AUTONOMIA") == "ANALISTA", F.lit(1))
           .otherwise(F.lit(0))
      )
      .withColumn("NBRPASO_AUTONOMIA", F.col("NBRPASO"))
)

df_aut_all = df_aut_tc.unionByName(df_aut_cef, allowMissingColumns=True)

# quedarnos con la autonomía "más fuerte" (Gerente > Supervisor > Analista) y más reciente
w_aut = Window.partitionBy("CODSOLICITUD").orderBy(
    F.col("PRIORIDAD_AUTONOMIA").desc(),
    F.col("FECHORINICIOEVALUACION").desc()
)

df_autonomia = (
    df_aut_all
      .withColumn("rn_aut", F.row_number().over(w_aut))
      .filter(F.col("rn_aut") == 1)
      .select(
          "CODSOLICITUD",
          F.col("MAT_AUTONOMIA"),
          F.col("ROL_AUTONOMIA"),
          F.col("NBRPASO_AUTONOMIA"),
          F.col("FECHORINICIOEVALUACION").alias("TS_AUTONOMIA"),
          F.when(F.col("ROL_AUTONOMIA") == "GERENTE", 1).otherwise(0).alias("FLG_AUTONOMIA_GERENTE"),
          F.when(F.col("ROL_AUTONOMIA") == "SUPERVISOR", 1).otherwise(0).alias("FLG_AUTONOMIA_SUPERVISOR"),
          F.when(F.col("ROL_AUTONOMIA") == "ANALISTA", 1).otherwise(0).alias("FLG_AUTONOMIA_ANALISTA")
      )
)

# =========================
# 5) df_final (1 fila por CODSOLICITUD)
# =========================
df_final = (
    df_productos_for_join
      .join(df_last_estado, on="CODSOLICITUD", how="left")
      .join(df_base_analista, on="CODSOLICITUD", how="left")
      .join(df_autonomia, on="CODSOLICITUD", how="left")
      .withColumn("FLG_FALTA_PASO_BASE", F.when(F.col("FLG_EXISTE_PASO_BASE").isNull(), 1).otherwise(0))
      .withColumn("FLG_AUTONOMIA_SIN_PASO_BASE",
                  F.when((F.col("ROL_AUTONOMIA").isNotNull()) & (F.col("FLG_EXISTE_PASO_BASE").isNull()), 1).otherwise(0))
      .withColumn(
          "MAT_ANALISTA_FINAL",
          F.coalesce(F.col("MAT_ANALISTA_ESTADOS"), F.col("MATORGANICO_ANALISTA"))
      )
      .withColumn(
          "ORIGEN_MAT_ANALISTA",
          F.when(F.col("MAT_ANALISTA_ESTADOS").isNotNull(), F.col("ORIGEN_MAT_ANALISTA_ESTADOS"))
           .when(F.col("MATORGANICO_ANALISTA").isNotNull(), F.lit("PRODUCTOS_MAT3"))
           .otherwise(F.lit(None))
      )
      .withColumn("TS_ULTIMO_EVENTO", F.col("FECHORINICIOEVALUACION_ULTIMO"))
)

# Selección final sugerida (puedes ajustar)
df_final_solicitud = df_final.select(
    "CODSOLICITUD",
    "CODMESCREACION", "FECCREACION",
    "NBRPRODUCTO", "ETAPA", "TIPACCION",
    "NBRANALISTA", "MATORGANICO_ANALISTA", "MATSUPERIOR_ANALISTA",

    "PROCESO_ULTIMO", "CODMESEVALUACION_ULTIMO",
    "NBRPASO_ULTIMO", "ESTADOSOLICITUD_ULTIMO",
    "FECHORINICIOEVALUACION_ULTIMO", "FECINICIOEVALUACION_ULTIMO", "HORINICIOEVALUACION_ULTIMO",
    "FECHORFINEVALUACION_ULTIMO", "FECFINEVALUACION_ULTIMO", "HORFINEVALUACION_ULTIMO",
    "NBRULTACTOR_ULTIMO", "NBRULTACTORPASO_ULTIMO",

    "MAT_ANALISTA_FINAL", "ORIGEN_MAT_ANALISTA",
    "MAT_AUTONOMIA", "ROL_AUTONOMIA", "NBRPASO_AUTONOMIA",
    "FLG_AUTONOMIA_GERENTE", "FLG_AUTONOMIA_SUPERVISOR", "FLG_AUTONOMIA_ANALISTA",
    "FLG_FALTA_PASO_BASE", "FLG_AUTONOMIA_SIN_PASO_BASE",
    "TS_ULTIMO_EVENTO"
)

print("Final 1x solicitud:", df_final_solicitud.count())