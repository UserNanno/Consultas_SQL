from pyspark.sql import functions as F
from pyspark.sql.window import Window

# =========================
# PARAMETROS: HARD CODE
# =========================
gerentes = ["GXXXXX"]  # <-- reemplaza
supervisores = ["S00001", "S00002", "S00003", "S00004", "S00005", "S00006"]  # <-- reemplaza

def rol_por_matricula(col_mat):
    return (
        F.when(col_mat.isin(gerentes), F.lit("GERENTE"))
         .when(col_mat.isin(supervisores), F.lit("SUPERVISOR"))
         .when(col_mat.isNotNull(), F.lit("ANALISTA"))
         .otherwise(F.lit(None))
    )

def es_sup_o_ger(col_mat):
    return col_mat.isin(gerentes + supervisores)



# =========================================================
# 1) Productos base (Mat3) - sin nombres, 1 fila por solicitud
# =========================================================
df_productos_base = (
    df_productos_enriq
      .select(
          "CODSOLICITUD",
          "NBRPRODUCTO", "ETAPA", "TIPACCION",
          "FECCREACION", "CODMESCREACION",
          "MATORGANICO_ANALISTA",      # Mat3
          "MATSUPERIOR_ANALISTA"
      )
)

# =========================================================
# 2) Clasificación proceso TC / CEF
#    (PROCESO ya viene en MAYUS y sin tildes)
# =========================================================
is_tc = F.col("PROCESO").like("%APROBACION CREDITOS TC%")
is_cef = F.col("PROCESO").isin(
    "CO SOLICITUD APROBACIONES TLMK",
    "SFCP APROBACIONES EDUCATIVO",
    "CO SOLICITUD APROBACIONES"
)

# Pasos
paso_tc_analista   = (F.col("NBRPASO") == "APROBACION DE CREDITOS ANALISTA")
paso_tc_supervisor = (F.col("NBRPASO") == "APROBACION DE CREDITOS SUPERVISOR")
paso_tc_gerente    = (F.col("NBRPASO") == "APROBACION DE CREDITOS GERENTE")

paso_cef_analista  = (F.col("NBRPASO") == "EVALUACION DE SOLICITUD")
paso_cef_aprobador = (F.col("NBRPASO") == "EVALUACION DE SOLICITUD APROBADOR")

# =========================================================
# 3) df_last_estado: snapshot MAS ACTUAL por CODSOLICITUD
# =========================================================
w_last = Window.partitionBy("CODSOLICITUD").orderBy(
    F.col("FECHORINICIOEVALUACION").desc(),
    F.col("FECHORFINEVALUACION").desc()
)

df_last_estado = (
    df_salesforce_enriq
      .withColumn("rn_last", F.row_number().over(w_last))
      .filter(F.col("rn_last") == 1)
      .withColumn("TIPO_PRODUCTO", F.when(is_tc, "TC").when(is_cef, "CEF").otherwise("OTRO"))
      .select(
          "CODSOLICITUD",
          "TIPO_PRODUCTO",
          F.col("CODMESEVALUACION").alias("CODMESEVALUACION_ULTIMO"),
          F.col("PROCESO").alias("PROCESO_ULTIMO"),
          F.col("NBRPASO").alias("NBRPASO_ULTIMO"),
          F.col("ESTADOSOLICITUD").alias("ESTADOSOLICITUD_ULTIMO"),
          F.col("FECHORINICIOEVALUACION").alias("FECHORINICIOEVALUACION_ULTIMO"),
          F.col("FECINICIOEVALUACION").alias("FECINICIOEVALUACION_ULTIMO"),
          F.col("HORINICIOEVALUACION").alias("HORINICIOEVALUACION_ULTIMO"),
          F.col("FECHORFINEVALUACION").alias("FECHORFINEVALUACION_ULTIMO"),
          F.col("FECFINEVALUACION").alias("FECFINEVALUACION_ULTIMO"),
          F.col("HORFINEVALUACION").alias("HORFINEVALUACION_ULTIMO"),
      )
)

# =========================================================
# 4) df_analista_from_estados: PASO BASE (Mat1->Mat2), evita sup/ger
#    - TC: APROBACION ... ANALISTA
#    - CEF: EVALUACION DE SOLICITUD
# =========================================================
es_paso_base = (is_tc & paso_tc_analista) | (is_cef & paso_cef_analista)

df_base_candidates = (
    df_salesforce_enriq
      .filter(es_paso_base)
      .withColumn("MAT1", F.col("MATORGANICO"))
      .withColumn("MAT2", F.col("MATORGANICOPASO"))
)

w_base = Window.partitionBy("CODSOLICITUD").orderBy(F.col("FECHORINICIOEVALUACION").desc())

df_base_latest = (
    df_base_candidates
      .withColumn("rn_base", F.row_number().over(w_base))
      .filter(F.col("rn_base") == 1)
      .select("CODSOLICITUD", "MAT1", "MAT2")
      .withColumn("FLG_EXISTE_PASO_BASE", F.lit(1))
)

df_analista_from_estados = (
    df_base_latest
      .withColumn(
          "MAT_ANALISTA_ESTADOS",
          F.when(F.col("MAT1").isNotNull() & (~es_sup_o_ger(F.col("MAT1"))), F.col("MAT1"))
           .when(F.col("MAT2").isNotNull() & (~es_sup_o_ger(F.col("MAT2"))), F.col("MAT2"))
           .otherwise(F.lit(None).cast("string"))
      )
      .withColumn(
          "ORIGEN_MAT_ANALISTA_ESTADOS",
          F.when(F.col("MAT1").isNotNull() & (~es_sup_o_ger(F.col("MAT1"))), F.lit("ESTADOS_MAT1"))
           .when(F.col("MAT2").isNotNull() & (~es_sup_o_ger(F.col("MAT2"))), F.lit("ESTADOS_MAT2"))
           .otherwise(F.lit(None))
      )
      .select(
          "CODSOLICITUD",
          "FLG_EXISTE_PASO_BASE",
          "MAT_ANALISTA_ESTADOS",
          "ORIGEN_MAT_ANALISTA_ESTADOS"
      )
)

# =========================================================
# 5) df_autonomia: autonomía desde estados COMPLETO (sin dedup)
#    - TC: GERENTE/SUPERVISOR por nombre de paso
#    - CEF: APROBADOR, rol por matrícula
# =========================================================

# TC
df_aut_tc = (
    df_salesforce_enriq
      .filter(is_tc & (paso_tc_gerente | paso_tc_supervisor))
      .withColumn("MAT1", F.col("MATORGANICO"))
      .withColumn("MAT2", F.col("MATORGANICOPASO"))
      .withColumn("MAT_AUTONOMIA", F.coalesce(F.col("MAT1"), F.col("MAT2")))
      .withColumn(
          "ROL_AUTONOMIA",
          F.when(paso_tc_gerente, F.lit("GERENTE"))
           .when(paso_tc_supervisor, F.lit("SUPERVISOR"))
      )
      .withColumn(
          "PRIORIDAD_AUTONOMIA",
          F.when(F.col("ROL_AUTONOMIA") == "GERENTE", F.lit(3))
           .when(F.col("ROL_AUTONOMIA") == "SUPERVISOR", F.lit(2))
           .otherwise(F.lit(0))
      )
      .withColumn("NBRPASO_AUTONOMIA", F.col("NBRPASO"))
)

# CEF
df_aut_cef = (
    df_salesforce_enriq
      .filter(is_cef & paso_cef_aprobador)
      .withColumn("MAT1", F.col("MATORGANICO"))
      .withColumn("MAT2", F.col("MATORGANICOPASO"))
      .withColumn("MAT_AUTONOMIA", F.coalesce(F.col("MAT1"), F.col("MAT2")))
      .withColumn("ROL_AUTONOMIA", rol_por_matricula(F.col("MAT_AUTONOMIA")))
      .withColumn(
          "PRIORIDAD_AUTONOMIA",
          F.when(F.col("ROL_AUTONOMIA") == "GERENTE", F.lit(3))
           .when(F.col("ROL_AUTONOMIA") == "SUPERVISOR", F.lit(2))
           .when(F.col("ROL_AUTONOMIA") == "ANALISTA", F.lit(1))
           .otherwise(F.lit(0))
      )
      .withColumn("NBRPASO_AUTONOMIA", F.col("NBRPASO"))
)

df_aut_all = df_aut_tc.unionByName(df_aut_cef, allowMissingColumns=True)

w_aut = Window.partitionBy("CODSOLICITUD").orderBy(
    F.col("PRIORIDAD_AUTONOMIA").desc(),
    F.col("FECHORINICIOEVALUACION").desc()
)

df_autonomia = (
    df_aut_all
      .withColumn("rn_aut", F.row_number().over(w_aut))
      .filter(F.col("rn_aut") == 1)
      .select(
          "CODSOLICITUD",
          "ROL_AUTONOMIA",
          "MAT_AUTONOMIA",
          "NBRPASO_AUTONOMIA",
          F.when(F.col("ROL_AUTONOMIA") == "GERENTE", 1).otherwise(0).alias("FLG_AUTONOMIA_GERENTE"),
          F.when(F.col("ROL_AUTONOMIA") == "SUPERVISOR", 1).otherwise(0).alias("FLG_AUTONOMIA_SUPERVISOR"),
          F.when(F.col("ROL_AUTONOMIA") == "ANALISTA", 1).otherwise(0).alias("FLG_AUTONOMIA_ANALISTA"),
          F.col("FECHORINICIOEVALUACION").alias("TS_AUTONOMIA")
      )
)








df_final_solicitud = (
    df_last_estado
      .join(df_productos_base, on="CODSOLICITUD", how="left")
      .join(df_analista_from_estados, on="CODSOLICITUD", how="left")
      .join(df_autonomia, on="CODSOLICITUD", how="left")
      .withColumn("FLG_FALTA_PASO_BASE", F.when(F.col("FLG_EXISTE_PASO_BASE").isNull(), 1).otherwise(0))
      .withColumn(
          "FLG_AUTONOMIA_SIN_PASO_BASE",
          F.when((F.col("ROL_AUTONOMIA").isNotNull()) & (F.col("FLG_EXISTE_PASO_BASE").isNull()), 1).otherwise(0)
      )
      # Analista final: Mat1/Mat2 (estados) y fallback a Mat3 (productos)
      .withColumn(
          "MAT_ANALISTA_FINAL",
          F.coalesce(F.col("MAT_ANALISTA_ESTADOS"), F.col("MATORGANICO_ANALISTA"))
      )
      .withColumn(
          "ORIGEN_MAT_ANALISTA",
          F.when(F.col("MAT_ANALISTA_ESTADOS").isNotNull(), F.col("ORIGEN_MAT_ANALISTA_ESTADOS"))
           .when(F.col("MATORGANICO_ANALISTA").isNotNull(), F.lit("PRODUCTOS_MAT3"))
           .otherwise(F.lit(None))
      )
      .withColumn("TS_ULTIMO_EVENTO", F.col("FECHORINICIOEVALUACION_ULTIMO"))
)

# Selección final SIN NOMBRES (todo por matrícula)
df_final_solicitud = df_final_solicitud.select(
    "CODSOLICITUD",
    "TIPO_PRODUCTO",

    # Productos
    "CODMESCREACION", "FECCREACION",
    "NBRPRODUCTO", "ETAPA", "TIPACCION",
    "MATORGANICO_ANALISTA", "MATSUPERIOR_ANALISTA",

    # Último estado (snapshot)
    "CODMESEVALUACION_ULTIMO", "PROCESO_ULTIMO",
    "NBRPASO_ULTIMO", "ESTADOSOLICITUD_ULTIMO",
    "FECHORINICIOEVALUACION_ULTIMO", "FECINICIOEVALUACION_ULTIMO", "HORINICIOEVALUACION_ULTIMO",
    "FECHORFINEVALUACION_ULTIMO", "FECFINEVALUACION_ULTIMO", "HORFINEVALUACION_ULTIMO",

    # Analista final
    "MAT_ANALISTA_FINAL", "ORIGEN_MAT_ANALISTA",
    "FLG_FALTA_PASO_BASE",

    # Autonomía
    "ROL_AUTONOMIA", "MAT_AUTONOMIA", "NBRPASO_AUTONOMIA",
    "FLG_AUTONOMIA_GERENTE", "FLG_AUTONOMIA_SUPERVISOR", "FLG_AUTONOMIA_ANALISTA",
    "FLG_AUTONOMIA_SIN_PASO_BASE",
    "TS_AUTONOMIA",

    # Control
    "TS_ULTIMO_EVENTO"
)

# =========================
# VALIDACIONES CLAVE
# =========================
print("Final (1 fila por CODSOLICITUD):", df_final_solicitud.count())

# 1) Confirmar 1 fila por solicitud
dups_final = df_final_solicitud.groupBy("CODSOLICITUD").count().filter("count > 1").count()
print("Duplicados en final (debe ser 0):", dups_final)

# 2) Benchmark de solicitudes (debe coincidir)
n_solic_estados = df_salesforce_enriq.select("CODSOLICITUD").distinct().count()
print("Solicitudes unicas en estados:", n_solic_estados)

# 3) Distribución de autonomía
df_final_solicitud.groupBy("ROL_AUTONOMIA").count().show()

# 4) Origen del analista
df_final_solicitud.groupBy("ORIGEN_MAT_ANALISTA").count().show()
