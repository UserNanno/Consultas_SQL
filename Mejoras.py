ESTO EJECUTABA EN UN NOTEBOOK DE DATABRICKS QUE USABA PYTHON PYSPARK

%sql
CREATE TABLE CATALOG_LHCL_PROD_BCP_EXPL.BCP_EDV_RBMBDN.T72496_DASH_SOLICITUDES_SCRM
AS
SELECT
	CODMES,
	CENTROATENCION,
	CANAL,
	NBRAGE,
	MATANALISTA,
    NBRAREAUNIDADORGANIZATIVAVENDEDOR,
    ESTADOSOLICITUD,
    NBREQUIPO,
	MOTIVOMALADERIVACION,
	SUBMOTIVOMALADERIVACION,
	NIVELAUTONOMIA,
    TIEMPOATENCIONANALISTA,
    NUMDIA,
    FLGCAMBIOTASA,
	COUNT(*) AS CTDSOLICITUDES,
	SUM(FLGRECUPERADA) AS CTDSOLICITUDESRECUPERADAS,
	SUM(FLGAPROBADO) AS CTDSOLICITUDESAPROBADAS,
	SUM(FLGDENEGADO) AS CTDSOLICITUDESDENEGADAS,
	SUM(FLGAPROBADONORENEGOCIADO) AS CTDSOLICITUDESNORENEGOCIADAS,
	SUM(FLGAPROBADORENEGOCIADO) AS CTDSOLICITUDESRENEGOCIADAS,
	SUM(FLGDESEMBOLSADO) AS CTDSOLICITUDESDESEMBOLSADAS,
	SUM(FLGNODESEMBOLSADO) AS CTDSOLICITUDESNODESEMBOLSADAS,
	SUM(MTOSOLICITADO) AS MTOSOLICITADO,
	SUM(MTOAPROBADO) AS MTOAPROBADO,
	SUM(MTOSOLICITADORECUPERADA) AS MTOSOLICITADORECUPERADA,
	SUM(MTODENEGADO) AS MTODENEGADO,
	SUM(MTOAPROBADONORENEGOCIADO) AS MTOAPROBADONORENEGOCIADO,
	SUM(MTOAPROBADORENEGOCIADO) AS MTOAPROBADORENEGOCIADO,
	SUM(MTODESEMBOLSADO) AS MTODESEMBOLSADO,
	SUM(MTONODESEMBOLSADO) AS MTONODESEMBOLSADO,
	SUM(MTODENEGADOTOTAL) AS MTODENEGADOTOTAL,
--	SUM(FLGAUTONOMIA) AS CTDSOLICITUDESAPROBADASAUTONOMIA,
--	SUM(FLGDESEMBOLSOAUTONOMIA) AS CTDSOLICITUDESDESEMBOLSADASAUTONOMIA,
--	SUM(MTOAPROBADOAUTONOMIA) AS MTOAPROBADOAUTONOMIA,
--	SUM(MTODESEMBOLSADOAUTONOMIA) AS MTODESEMBOLSADOAUTONOMIA,
	SUM(FLGDENEGADAMALDERIVADA) AS CTDSOLICITUDESDENEGADASMALDERIVADAS,
	SUM(MTODENEGADOMALDERIVADO) AS MTODENEGADOMALDERIVADO,
--	TIPOPERACION,
	DESTIPOPERACION,
	PRODUCTO,
	DESPRODUCTO,
	DESCAMPANIA,
	DESTIPEVALUACIONRIESGO,
	FECSOLICITUD,
	HORINICIOATENCION,
	NUMDIAINICIOATENCION,
	NUMSEMANAMESINICIOATENCION,
	NBRDIASEMANAINICIOATENCION,
	NBRDIASEMANAINICIOATENCION_ORD,
	FLGDIAUTIL,
	DESTIPRENTA,
	SEGMENTO,
--	BRACKETRENEGOCIADO,
--	BRACKETATENCIONSOLICITUD,
--	BRACKETATENCIONSOLICITUD_ORD,
--	BRACKETDERIVACIONANALISTA,
--	BRACKETDERIVACIONANALISTA_ORD,
	BRACKETATENCIONANALISTA, -- TIEMPO ANALISTA
	BRACKETATENCIONANALISTA_ORD,
	BRACKETATENCIONSOLICITUDANALISTA, -- TIEMPO CLIENTE
	BRACKETATENCIONSOLICITUDANALISTA_ORD
	--BRACKETDESEMBOLSOPOSTATENCIONANALISTA
FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_HM_SOLICITUDES_SCRM
GROUP BY
    CODMES, CENTROATENCION, CANAL, NBRAGE, MATANALISTA, NBRAREAUNIDADORGANIZATIVAVENDEDOR, DESTIPOPERACION, PRODUCTO, DESPRODUCTO,
    NBREQUIPO, MOTIVOMALADERIVACION, SUBMOTIVOMALADERIVACION, NIVELAUTONOMIA, HORINICIOATENCION, FLGCAMBIOTASA,
    NUMDIAINICIOATENCION, NUMSEMANAMESINICIOATENCION, NBRDIASEMANAINICIOATENCION, NBRDIASEMANAINICIOATENCION_ORD,
    DESCAMPANIA, DESTIPEVALUACIONRIESGO, FECSOLICITUD, FLGDIAUTIL, ESTADOSOLICITUD, DESTIPRENTA, SEGMENTO, TIEMPOATENCIONANALISTA, 
    NUMDIA, BRACKETATENCIONANALISTA, BRACKETATENCIONANALISTA_ORD, BRACKETATENCIONSOLICITUDANALISTA, BRACKETATENCIONSOLICITUDANALISTA_ORD;








from pyspark.sql.types import (
    StructType, StructField, StringType, IntegerType, DecimalType, DateType
)
from pyspark.sql.functions import col, upper, lpad, to_date
from datetime import datetime

# PATHS
df_base = spark.table("CATALOG_LHCL_PROD_BCP_EXPL.BCP_EDV_RBMBDN.T72496_DASH_SOLICITUDES_SCRM")

csv_organico = "abfss://bcp-edv-rbmbdn@adlscu1lhclbackp05.dfs.core.windows.net/T72496/CARGA/ORGANICO/ORGANICO_ANALISTA_EDV.csv"


df_orga = (spark.read.format("csv")
      .option("header", "true")
      .option("delimiter", ";")
      .load(csv_organico))



# LEFT JOIN
df_joined = (
    df_base.alias("a")
    .join(
        df_orga.alias("b"),
        (col("a.CODMES") == col("b.CODMES")) &
        (col("a.MATANALISTA") == col("b.MATORGANICO")),
        "left"
    )
    .select(
        col("a.*"),
        col("b.NOMBRE_CORTO") 
    )
)



count_df = df_base.count()
print(f"Registros en df: {count_df}")

count_df_joined = df_joined.count()
print(f"Registros en df_joined: {count_df_joined}")




final_dir = "abfss://bcp-edv-rbmbdn@adlscu1lhclbackp05.dfs.core.windows.net/T72496/EXPORTS/WEEKLY/EXPORT/"
tmp_dir   = "abfss://bcp-edv-rbmbdn@adlscu1lhclbackp05.dfs.core.windows.net/T72496/EXPORTS/WEEKLY/.tmp_export/"

(df_joined
    .coalesce(1)
    .write
    .mode("overwrite")
    .option("header", "true")
    .option("delimiter", ";")
    .option("quote", '"')
    .option("escape", '"')
    .option("nullValue", "")
    .csv(tmp_dir)
)



# Encuentra el part-*.csv
part_files = [f.path for f in dbutils.fs.ls(tmp_dir) if f.name.startswith("part-") and f.name.endswith(".csv")]
assert len(part_files) == 1, f"Esperaba 1 part-*.csv, encontr√© {len(part_files)}"
part_file = part_files[0]

dbutils.fs.mkdirs(final_dir)
for f in dbutils.fs.ls(final_dir):
    if f.name.endswith(".csv"):
        dbutils.fs.rm(f.path, True)

custom_name = "WEEKLY.csv"
# custom_name = "CENTRALIZADO.csv"
dest_file = f"{final_dir}{custom_name}"

dbutils.fs.mv(part_file, dest_file)
dbutils.fs.rm(tmp_dir, True)



DROP TABLE IF EXISTS CATALOG_LHCL_PROD_BCP_EXPL.BCP_EDV_RBMBDN.T72496_DASH_SOLICITUDES_SCRM;



PERO AHORA QUIERO MIGRAR ESTO MISMO A SAS STUDIO, YA TENGO ACTUALMENTE ESTO PERO AUN ME FALTA INCLUIR MAS COSAS DE LO ANTERIOR

SAS: 

LIBNAME dtbrcks ODBC DSN="RBMNEG_SQLW" AUTHDOMAIN="DatabricksAuth" DBMAX_TEXT=128;

PROC SQL NOPRINT NOFEEDBACK;
CONNECT USING dtbrcks;
CREATE TABLE TEST_WEEKLY
AS
SELECT
*
FROM connection to dtbrcks (
SELECT
	CODMES,
	CENTROATENCION,
	CANAL,
	NBRAGE,
	MATANALISTA,
    NBRAREAUNIDADORGANIZATIVAVENDEDOR,
    ESTADOSOLICITUD,
    NBREQUIPO,
	MOTIVOMALADERIVACION,
	SUBMOTIVOMALADERIVACION,
	NIVELAUTONOMIA,
    TIEMPOATENCIONANALISTA,
    NUMDIA,
    FLGCAMBIOTASA,
	COUNT(*) AS CTDSOLICITUDES,
	SUM(FLGRECUPERADA) AS CTDSOLICITUDESRECUPERADAS,
	SUM(FLGAPROBADO) AS CTDSOLICITUDESAPROBADAS,
	SUM(FLGDENEGADO) AS CTDSOLICITUDESDENEGADAS,
	SUM(FLGAPROBADONORENEGOCIADO) AS CTDSOLICITUDESNORENEGOCIADAS,
	SUM(FLGAPROBADORENEGOCIADO) AS CTDSOLICITUDESRENEGOCIADAS,
	SUM(FLGDESEMBOLSADO) AS CTDSOLICITUDESDESEMBOLSADAS,
	SUM(FLGNODESEMBOLSADO) AS CTDSOLICITUDESNODESEMBOLSADAS,
	SUM(MTOSOLICITADO) AS MTOSOLICITADO,
	SUM(MTOAPROBADO) AS MTOAPROBADO,
	SUM(MTOSOLICITADORECUPERADA) AS MTOSOLICITADORECUPERADA,
	SUM(MTODENEGADO) AS MTODENEGADO,
	SUM(MTOAPROBADONORENEGOCIADO) AS MTOAPROBADONORENEGOCIADO,
	SUM(MTOAPROBADORENEGOCIADO) AS MTOAPROBADORENEGOCIADO,
	SUM(MTODESEMBOLSADO) AS MTODESEMBOLSADO,
	SUM(MTONODESEMBOLSADO) AS MTONODESEMBOLSADO,
	SUM(MTODENEGADOTOTAL) AS MTODENEGADOTOTAL,
	SUM(FLGDENEGADAMALDERIVADA) AS CTDSOLICITUDESDENEGADASMALDERIVADAS,
	SUM(MTODENEGADOMALDERIVADO) AS MTODENEGADOMALDERIVADO,
	DESTIPOPERACION,
	PRODUCTO,
	DESPRODUCTO,
	DESCAMPANIA,
	DESTIPEVALUACIONRIESGO,
	FECSOLICITUD,
	HORINICIOATENCION,
	NUMDIAINICIOATENCION,
	NUMSEMANAMESINICIOATENCION,
	NBRDIASEMANAINICIOATENCION,
	NBRDIASEMANAINICIOATENCION_ORD,
	FLGDIAUTIL,
	DESTIPRENTA,
	SEGMENTO,
	BRACKETATENCIONANALISTA,
	BRACKETATENCIONANALISTA_ORD,
	BRACKETATENCIONSOLICITUDANALISTA,
	BRACKETATENCIONSOLICITUDANALISTA_ORD
	--BRACKETDESEMBOLSOPOSTATENCIONANALISTA
FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_HM_SOLICITUDES_SCRM
GROUP BY
    CODMES, CENTROATENCION, CANAL, NBRAGE, MATANALISTA, NBRAREAUNIDADORGANIZATIVAVENDEDOR, DESTIPOPERACION, PRODUCTO, DESPRODUCTO,
    NBREQUIPO, MOTIVOMALADERIVACION, SUBMOTIVOMALADERIVACION, NIVELAUTONOMIA, HORINICIOATENCION, FLGCAMBIOTASA,
    NUMDIAINICIOATENCION, NUMSEMANAMESINICIOATENCION, NBRDIASEMANAINICIOATENCION, NBRDIASEMANAINICIOATENCION_ORD,
    DESCAMPANIA, DESTIPEVALUACIONRIESGO, FECSOLICITUD, FLGDIAUTIL, ESTADOSOLICITUD, DESTIPRENTA, SEGMENTO, TIEMPOATENCIONANALISTA, 
    NUMDIA, BRACKETATENCIONANALISTA, BRACKETATENCIONANALISTA_ORD, BRACKETATENCIONSOLICITUDANALISTA, BRACKETATENCIONSOLICITUDANALISTA_ORD;
);

DISCONNECT FROM dtbrcks;
QUIT;

PROC EXPORT DATA=TEST_WEEKLY
	OUTFILE="/sasdata01/RBM_NEG_DESA_01/T72496/WEEKLY.csv"
	DBMS=CSV
	REPLACE;
RUN;
