WITH
LKP_CONSUMO AS (
  SELECT
      TRIM(CODSOLICITUD) AS CODSOLICITUD,
      TRIM(CODINTERNOCOMPUTACIONAL) AS CODINTERNOCOMPUTACIONAL
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO
),
LKP_TARJETA AS (
  SELECT
      TRIM(CODSOLICITUD) AS CODSOLICITUD,
      TRIM(CODINTERNOCOMPUTACIONAL) AS CODINTERNOCOMPUTACIONAL
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDTARJETACREDITO
),
BASE AS (
  SELECT
      A.OPORTUNIDAD,
      A.FECCREACION,
      A.ESTADO,
      CAST(date_format(A.FECCREACION, 'yyyyMM') AS INT) AS CODMES,
      date_format(A.FECCREACION, 'yyyy-MM') AS MES,
      CASE WHEN A.FECCREACION < DATE '2025-01-21' THEN 'ANTES' ELSE 'DESPUES' END AS PERIODO,
      TRIM(A.CODINTERNOCOMPUTACIONAL) AS CODINT_ORIG,
      COALESCE(
        NULLIF(TRIM(A.CODINTERNOCOMPUTACIONAL), ''),
        (SELECT L1.CODINTERNOCOMPUTACIONAL FROM LKP_CONSUMO L1
         WHERE UPPER(TRIM(L1.CODSOLICITUD)) = UPPER(TRIM(A.OPORTUNIDAD)) FETCH FIRST 1 ROWS ONLY),
        (SELECT L2.CODINTERNOCOMPUTACIONAL FROM LKP_TARJETA L2
         WHERE UPPER(TRIM(L2.CODSOLICITUD)) = UPPER(TRIM(A.OPORTUNIDAD)) FETCH FIRST 1 ROWS ONLY)
      ) AS CODINTERNOCOMPUTACIONAL_FILLED
  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASE_CENTRALIZADO A
  WHERE
      A.TIPPRODUCTO = 'CC'
),
BASE_ENRIQ AS (
  SELECT
      A.OPORTUNIDAD,
      A.FECCREACION,
      A.ESTADO,
      A.CODMES,
      A.MES,
      A.PERIODO,
      A.CODINT_ORIG,
      A.CODINTERNOCOMPUTACIONAL_FILLED AS CODINTERNOCOMPUTACIONAL,
      B.CODCLAVEPARTYCLI
  FROM BASE A
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_CLIENTE B
    ON UPPER(TRIM(A.CODINTERNOCOMPUTACIONAL_FILLED)) = UPPER(TRIM(B.CODINTERNOCOMPUTACIONAL))
  WHERE
      A.CODINTERNOCOMPUTACIONAL_FILLED IS NOT NULL
      AND B.CODCLAVEPARTYCLI IS NOT NULL
),
TRANSACCIONES_ADS AS (
  SELECT
      TO_DATE(FECTRX) AS FECTRANSACCION,
      CODCLAVEPARTYCLI
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_TRANSACCIONADELANTOCUENTASUELDO
  WHERE
      DESTRX = 'ADELANTO SUELDO'
      AND DESOPECTASUELDO = 'DISPOSICION'
),
RESULT_BASE AS (
  SELECT
      A.CODINTERNOCOMPUTACIONAL,
      A.OPORTUNIDAD,
      A.FECCREACION,
      A.CODMES,
      A.MES,
      A.PERIODO,
      A.ESTADO,
      CASE WHEN A.ESTADO = 'ACEPTADAS' THEN 1 ELSE 0 END AS FLGAPROBADA,
      CASE WHEN A.ESTADO = 'DENEGADAS' THEN 1 ELSE 0 END AS FLGDENEGADA,
      CASE WHEN NVL(COUNT(B.FECTRANSACCION), 0) > 0 THEN 1 ELSE 0 END AS FLG_ADS_U3M
  FROM BASE_ENRIQ A
  LEFT JOIN TRANSACCIONES_ADS B
    ON B.CODCLAVEPARTYCLI = A.CODCLAVEPARTYCLI
   AND B.FECTRANSACCION BETWEEN ADD_MONTHS(A.FECCREACION, -3) AND A.FECCREACION
  GROUP BY ALL
)
SELECT
    CODMES,
    MES,
    PERIODO,
    FLG_ADS_U3M,
    COUNT(*) AS SOLICITUDES,
    SUM(FLGAPROBADA) AS APROBADAS,
    SUM(FLGDENEGADA) AS DENEGADAS
FROM RESULT_BASE
GROUP BY ALL
ORDER BY 1, 3, 4;
