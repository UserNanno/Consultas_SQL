-- ------------------------------------------------------------------------------------
-- Contexto: Databricks SQL / Photon
-- Objetivo: Igualar semántica de la consulta original con mejor rendimiento/claridad.
-- Notas:
--  - Se corrige JOIN de C (A.CODSOLICITUD = C.CODSOLICITUD).
--  - Se reemplaza DATEDIFF(SECOND, ...) por TIMESTAMPDIFF(SECOND, ...) (Databricks SQL).
--  - Se evita referenciar alias en el mismo SELECT (se usan CTEs).
--  - Se eliminan columnas 100% duplicadas por alias repetido (ver justificación).
-- ------------------------------------------------------------------------------------

WITH
-- 1) Filtro temprano y normalizaciones básicas del hecho A
base AS (
  SELECT
      A.CODSOLICITUD,
      TO_TIMESTAMP(CONCAT_WS(' ', A.FECSOLICITUD, LPAD(A.HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECREGISTRO,
      A.DESTIPFLUJOVENTATARJETACREDITO,
      A.DESCAMPANIA,
      UPPER(COALESCE(A.DESCAMPANIA, '')) AS CAMPANIA_UP,    -- para búsquedas case-insensitive
      A.DESPRODUCTO,
      A.TIPESTADOSOLICITUD,
      A.DESTIPETAPA,
      A.DESMOTIVOCDA,
      A.DESCOMENTARIO,
      A.NBRMONEDA,
      A.MTOSOLICITADO,
      A.MTOAPROBADO,
      TO_TIMESTAMP(CONCAT_WS(' ', A.FECINICIOEVALUACION, LPAD(A.HORINICIOEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS INICIOEVALUACION,
      TO_TIMESTAMP(CONCAT_WS(' ', A.FECFINEVALUACION, LPAD(A.HORFINEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FINEVALUACION,
      A.FECEMISIONTARJETACREDITO,
      A.CODMATRICULACOLABORADORAPROBADOR,
      A.CODMATRICULACOLABORADORVENDEDOR,
      A.CODINTERNOCOMPUTACIONAL,
      A.MTOCUOTAMENSUALAPROBADO,
      A.PCTTASAEFECTIVAANUALSOLICITUD,
      A.MTOINGRESOBRUTOSOLICITUD,
      A.FECSOLICITUD,
      A.CODCOLABORADORVENDEDOR
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDTARJETACREDITO A
  WHERE A.CODTIPREGAPP IN ('0126O000001xsIYQAY','0126O000001h0WaQAI','0126O000001h0WbQAI')
    AND A.FECSOLICITUD >= '2025-10-01'
),

-- 2) Dimensiones prefiltradas por rol (evita CASE por columna luego)
ind_tit AS (
  SELECT
      CODSOLICITUD,
      FLGCLIPAGOHABERESBCP         AS FLGPDH,
      TIPRENTA                     AS TIPRENTATITULAR,
      NUMPUNTAJEPRECALIF           AS SCOREEVALUACION,
      TIPPARTYIDENTIFICACION       AS TIPIDCTITULAR,
      MTOINGRESODIGITADO           AS INGRESOBRUTOTITULAR,
      MTOOTROINGRESODIGITADO       AS OTROINGRESOBRUTOTITULAR,
      MTOINGRESOCALCULADO          AS INGRESOPROMEDIOTITULAR,
      MTOCEM                       AS CEM,
      MTOCEMASESORVENTA            AS CEMVENDEDOR,
      MTOCEMANALISTACREDITO        AS CEMANALISTACREDITO,
      DESSUBSEGMENTO               AS SEGMENTOTITULAR,
      CODSEGMENTORIESGOSCORE       AS SEGMENTORIESGOSTITULAR,
      DESTIPNIVELEDUCACIONAL       AS GRADOINTRUSCCION,
      DESTIPOCUPACION              AS SITUACIONLABORALTITULAR,
      NUMDEPENDIENTE               AS NUMDEPENDIENTESTITULAR,
      DESTIPESTCIVIL               AS ESTADOCIVIL
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDINDIVIDUO
  WHERE DESTIPROLSOLICITUD = 'TITULAR'
),
ind_cony AS (
  SELECT
      CODSOLICITUD,
      TIPRENTA                     AS TIPRENTACONYUGE,
      TIPPARTYIDENTIFICACION       AS TIPIDCCONYUGE,
      MTOINGRESODIGITADO           AS INGRESOBRUTOCONYUGE,
      MTOOTROINGRESODIGITADO       AS OTROINGRESOBRUTOCONYUGE,
      MTOINGRESOCALCULADO          AS INGRESOPROMEDIOCONYUGE,
      DESTIPOCUPACION              AS SITUACIONLABORALCONYUGE
      -- Nota: En la consulta original se usa C.TIPPARTYIDENTIFICACION para SEGMENTORIESGOSCONYUGE (se respeta abajo)
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDINDIVIDUO
  WHERE DESTIPROLSOLICITUD = 'CONYUGE'
),
party_tit AS (
  SELECT
      CODSOLICITUD,
      DESTIPCLASIFRIESGOCLI        AS CLASIFSBSTITULTAR
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDPARTY
  WHERE DESTIPROLSOLICITUD = 'TITULAR'
),
party_cony AS (
  SELECT
      CODSOLICITUD,
      DESTIPCLASIFRIESGOCLI        AS CLASIFSBSCONYUGE
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDPARTY
  WHERE DESTIPROLSOLICITUD = 'CONYUGE'
),
usr AS (
  SELECT
      CODUSUARIOAPP,
      DESPOSICIONCOLABORADOR AS FUNCIONVENDEDOR
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_USUARIOAPLICATIVO
),

-- 3) Join maestro
jn AS (
  SELECT
      b.*,
      t.*,
      c.*,
      pt.CLASIFSBSTITULTAR,
      pc.CLASIFSBSCONYUGE,
      u.FUNCIONVENDEDOR
  FROM base b
  LEFT JOIN ind_tit  t ON b.CODSOLICITUD = t.CODSOLICITUD
  LEFT JOIN ind_cony c ON b.CODSOLICITUD = c.CODSOLICITUD    -- (corrección respecto al SQL original)
  LEFT JOIN party_tit pt ON b.CODSOLICITUD = pt.CODSOLICITUD
  LEFT JOIN party_cony pc ON b.CODSOLICITUD = pc.CODSOLICITUD
  LEFT JOIN usr       u ON b.CODCOLABORADORVENDEDOR = u.CODUSUARIOAPP
),

-- 4) Enriquecimiento: mapeos y métricas reutilizables
enr AS (
  SELECT
      *,
      -- TIPOEVALUACION (se respeta literal original con su ortografía)
      CASE WHEN CODMATRICULACOLABORADORAPROBADOR IS NOT NULL
           THEN 'EVLUACION EN CENTRALIZADO' ELSE 'EVALUACION AUTOMATICA' END AS TIPOEVALUACION,

      -- Flags de campaña (se usa INSTR sobre UPPER para eficiencia y consistencia)
      (INSTR(CAMPANIA_UP,'PRESTAMO TAR')   > 0 OR INSTR(CAMPANIA_UP,'PRÉSTAMO TAR') > 0) AS HAS_PRESTAMO_TAR,
      (INSTR(CAMPANIA_UP,'PTC')            > 0 OR INSTR(CAMPANIA_UP,'EP')            > 0) AS HAS_PTC,
      (INSTR(CAMPANIA_UP,'BALANCE TRA')    > 0 OR INSTR(CAMPANIA_UP,'TC+BT')         > 0 OR INSTR(CAMPANIA_UP,'BT') > 0) AS HAS_BT,
      (INSTR(CAMPANIA_UP,'AMPLIACION')     > 0 OR INSTR(CAMPANIA_UP,'AMPLIACIÓN')    > 0) AS HAS_AMPLIACION,
      (INSTR(CAMPANIA_UP,'UPGRADE')        > 0 OR INSTR(CAMPANIA_UP,'UPG')           > 0) AS HAS_UPGRADE,
      (INSTR(CAMPANIA_UP,'ADICIONAL')      > 0) AS HAS_ADICIONAL,
      (INSTR(CAMPANIA_UP,'100%')           > 0) AS HAS_100,
      (INSTR(CAMPANIA_UP,'PREAPR')         > 0) AS HAS_PREAPR,
      (INSTR(CAMPANIA_UP,'SIN CAMP')       > 0) AS HAS_SIN_CAMP,
      (INSTR(CAMPANIA_UP,'INVITA')         > 0) AS HAS_INVITA,

      -- TIPOPRODUCTO
      CASE
        WHEN DESTIPFLUJOVENTATARJETACREDITO IN ('EP','PTC','BT','AMPLIACION','UPGRADE','ADICIONAL')
          THEN 'TARJETA CREDITO STOCK'
        WHEN DESTIPFLUJOVENTATARJETACREDITO IN ('SEGUNDA TC','TC')
          THEN 'TARJETA CREDITO NUEVA'
        WHEN HAS_PRESTAMO_TAR OR HAS_PTC OR HAS_BT OR HAS_AMPLIACION OR HAS_UPGRADE OR HAS_ADICIONAL
          THEN 'TARJETA CREDITO STOCK'
        ELSE 'SIN DATA'
      END AS TIPOPRODUCTO,

      -- SUBPRODUCTO (respeta lógica/orden original)
      CASE
        WHEN DESTIPFLUJOVENTATARJETACREDITO = 'EP'         THEN 'PTC'
        WHEN DESTIPFLUJOVENTATARJETACREDITO = 'SEGUNDA TC' THEN 'TC'
        WHEN DESTIPFLUJOVENTATARJETACREDITO IS NOT NULL    THEN DESTIPFLUJOVENTATARJETACREDITO
        WHEN (HAS_PRESTAMO_TAR OR HAS_PTC)                 THEN 'PTC'
        WHEN  HAS_BT                                       THEN 'BT'
        WHEN  HAS_AMPLIACION                               THEN 'AMPLIACION'
        WHEN  HAS_UPGRADE                                  THEN 'UPGRADE'
        WHEN  HAS_ADICIONAL                                THEN 'ADICIONAL'
        ELSE 'Sin data'
      END AS SUBPRODUCTO,

      -- RESULTADOANALISTA
      CASE TIPESTADOSOLICITUD
        WHEN 'ACPD' THEN 'ACEPTADA'
        WHEN 'DCLD' THEN 'DENEGADA'
        WHEN 'ENPR' THEN 'EN PROCESO'
        WHEN 'IRFC' THEN 'INGRESADO'
        WHEN 'EEEL' THEN 'EN PROCESO DE CALIFICACION'
        WHEN 'DIGI' THEN 'DIGITADO'
        ELSE 'SIN DATA'
      END AS RESULTADOANALISTA,

      -- ESTADO_F
      CASE
        WHEN TIPESTADOSOLICITUD = 'ACPD' AND DESTIPETAPA = 'CERRADA'   THEN 'ACEPTADA'
        WHEN TIPESTADOSOLICITUD = 'DCLD' AND DESTIPETAPA = 'RECHAZADA' THEN 'DENEGADA'
        WHEN TIPESTADOSOLICITUD = 'ENPR' AND DESTIPETAPA = 'DESESTIMADA' THEN 'DESESTIMADA'
        WHEN TIPESTADOSOLICITUD = 'IRFC' AND DESTIPETAPA = 'PERDIDA'   THEN 'DESESTIMADA'
        WHEN TIPESTADOSOLICITUD = 'ENPR' THEN 'EN PROCESO'
        WHEN TIPESTADOSOLICITUD = 'IRFC' THEN 'INGRESADO'
        WHEN TIPESTADOSOLICITUD = 'EEEL' THEN 'EN PROCESO DE CALIFICACION'
        WHEN TIPESTADOSOLICITUD = 'DIGI' THEN 'DIGITADO'
        ELSE 'SIN DATA'
      END AS ESTADO_F,

      -- CAMPANACORTA
      CASE
        WHEN HAS_100        THEN '100% APROBADO'
        WHEN HAS_PREAPR     THEN 'PREAPROBADO'
        WHEN HAS_SIN_CAMP   THEN 'SIN CAMPANIA'
        WHEN HAS_INVITA     THEN 'INVITADO'
        WHEN DESTIPFLUJOVENTATARJETACREDITO = 'EP'         THEN 'PTC'
        WHEN DESTIPFLUJOVENTATARJETACREDITO = 'SEGUNDA TC' THEN 'TC'
        WHEN DESTIPFLUJOVENTATARJETACREDITO IS NOT NULL    THEN DESTIPFLUJOVENTATARJETACREDITO
        WHEN HAS_PRESTAMO_TAR OR HAS_PTC                   THEN 'PTC'
        WHEN HAS_BT                                         THEN 'BT'
        WHEN HAS_AMPLIACION                                 THEN 'AMPLIACION'
        WHEN HAS_UPGRADE                                    THEN 'UPGRADE'
        WHEN HAS_ADICIONAL                                  THEN 'ADICIONAL'
        ELSE 'SIN DATA'
      END AS CAMPANACORTA,

      -- Monto a soles (tasa fija 3.81 como en original)
      CASE WHEN NBRMONEDA = 'DOLAR AMERICANO             EE.UU       ' THEN MTOSOLICITADO * 3.81
           ELSE MTOSOLICITADO END AS MTOSOLICITADOSOLES,
      CASE WHEN NBRMONEDA = 'DOLAR AMERICANO             EE.UU       ' THEN MTOAPROBADO   * 3.81
           ELSE MTOAPROBADO   END AS MTOAPROBADOSOLES,

      -- Tiempos (segundos y horas)
      TIMESTAMPDIFF(SECOND, FECREGISTRO, FINEVALUACION)                  AS TIEMPOCLIENTESEGUNDOS,
      TIMESTAMPDIFF(SECOND, INICIOEVALUACION, FINEVALUACION)             AS TIEMPOANALISTASEGUNDOS,
      (TIMESTAMPDIFF(SECOND, FECREGISTRO, FINEVALUACION)      / 3600.0)  AS TIEMPOCLIENTEHRS,
      (TIMESTAMPDIFF(SECOND, INICIOEVALUACION, FINEVALUACION) / 3600.0)  AS TIEMPOANALISTAHRS
  FROM jn
),

-- 5) Clasificaciones derivadas de columnas ya calculadas (usa alias previos sin re-evaluar)
fin AS (
  SELECT
      *,
      CASE
        WHEN MTOSOLICITADOSOLES <= 0                  THEN 'SIN DATA'
        WHEN MTOSOLICITADOSOLES BETWEEN 1      AND 23000   THEN 'A. 1-23K'
        WHEN MTOSOLICITADOSOLES BETWEEN 23001  AND 46000   THEN 'B. 23K-46K'
        WHEN MTOSOLICITADOSOLES BETWEEN 46001  AND 69000   THEN 'C. 46K-69K'
        WHEN MTOSOLICITADOSOLES BETWEEN 69001  AND 92000   THEN 'D. 69K-92K'
        WHEN MTOSOLICITADOSOLES BETWEEN 92001  AND 115000  THEN 'E. 92K-115K'
        WHEN MTOSOLICITADOSOLES BETWEEN 115001 AND 138000  THEN 'F. 115K-138K'
        WHEN MTOSOLICITADOSOLES BETWEEN 138001 AND 160000  THEN 'G. 138K-160K'
        ELSE 'H. >160K'
      END AS RANGOMTOSOLICITADOSOLES,

      CASE
        WHEN SCOREEVALUACION <= 0                        THEN 'SIN DATA'
        WHEN SCOREEVALUACION BETWEEN 1   AND 300         THEN 'A. 1-300'
        WHEN SCOREEVALUACION BETWEEN 301 AND 330         THEN 'B. 301-330'   -- (corrige sólo el literal)
        WHEN SCOREEVALUACION BETWEEN 331 AND 360         THEN 'C. 331-360'
        WHEN SCOREEVALUACION BETWEEN 361 AND 390         THEN 'D. 361-390'
        WHEN SCOREEVALUACION BETWEEN 391 AND 420         THEN 'E. 391-420'
        WHEN SCOREEVALUACION BETWEEN 421 AND 450         THEN 'F. 421-450'
        ELSE NULL
      END AS RANGOSCORE,

      CASE
        WHEN TIEMPOCLIENTEHRS IS NULL OR TIEMPOCLIENTEHRS <= 0 THEN 'SIN DATA'
        WHEN TIEMPOCLIENTEHRS BETWEEN 1  AND 3   THEN 'A. 1-3'
        WHEN TIEMPOCLIENTEHRS BETWEEN 4  AND 6   THEN 'B. 4-6'
        WHEN TIEMPOCLIENTEHRS BETWEEN 7  AND 12  THEN 'C. 7-12'
        WHEN TIEMPOCLIENTEHRS BETWEEN 13 AND 18  THEN 'D. 13-18'
        WHEN TIEMPOCLIENTEHRS BETWEEN 19 AND 24  THEN 'E. 19-24'
        ELSE 'F. >24'
      END AS RANGOATENCIONCLIENTE
  FROM enr
)

-- 6) Proyección final (orden/alias como en el SQL original, evitando duplicados exactos)
SELECT
  CODSOLICITUD,
  FECREGISTRO,
  TIPOEVALUACION,
  TIPOPRODUCTO,
  SUBPRODUCTO,
  DESPRODUCTO,
  RESULTADOANALISTA,
  ESTADO_F,
  NULL AS RESULTADOMOTORDCA,
  DESMOTIVOCDA,
  DESTIPETAPA AS ETAPA,
  NULL AS JUSTIFICACIONANALISTA,
  DESCOMENTARIO AS COMENTARIOANALISTA,
  DESCAMPANIA AS CAMPANIA,
  CAMPANACORTA,
  NBRMONEDA AS MONEDA,
  MTOSOLICITADO,
  MTOAPROBADO,
  INICIOEVALUACION,
  FINEVALUACION,
  FECEMISIONTARJETACREDITO AS FECDESEMBOLSO,
  CODMATRICULACOLABORADORAPROBADOR AS MATANALISTA,
  CODMATRICULACOLABORADORVENDEDOR AS MATVENDEDOR,
  CODINTERNOCOMPUTACIONAL,
  FLGPDH,
  TIPRENTATITULAR,
  TIPRENTACONYUGE,
  SCOREEVALUACION,
  TIPIDCTITULAR,
  TIPIDCCONYUGE,
  INGRESOBRUTOTITULAR,
  INGRESOBRUTOCONYUGE,
  OTROINGRESOBRUTOTITULAR,
  OTROINGRESOBRUTOCONYUGE,
  INGRESOPROMEDIOTITULAR,
  INGRESOPROMEDIOCONYUGE,
  MTOCUOTAMENSUALAPROBADO,
  NULL AS PLAZOSOLICITADO,
  NULL AS PLAZOAPROBADO,
  PCTTASAEFECTIVAANUALSOLICITUD AS TASASOLICITADA,
  NULL AS TASAAPROBADA,
  CEM,
  CEMVENDEDOR,
  CEMANALISTACREDITO,
  SEGMENTOTITULAR,
  NULL AS POSICIONCONSOLIDADA,
  SEGMENTORIESGOSTITULAR,
  -- En el SQL original este alias usa C.TIPPARTYIDENTIFICACION (se mantiene para equivalencia)
  ind_cony.TIPIDCCONYUGE AS SEGMENTORIESGOSCONYUGE,
  NULL AS MTODESEMBOLSADO,
  GRADOINTRUSCCION,
  SITUACIONLABORALTITULAR AS SITUACIONLAOBRALTITULAR,
  SITUACIONLABORALCONYUGE AS SITUACIONLAOBRALCONYUGE,
  CLASIFSBSTITULTAR,
  CLASIFSBSCONYUGE,
  NUMDEPENDIENTESTITULAR,
  ESTADOCIVIL,
  FUNCIONVENDEDOR,
  MTOINGRESOBRUTOSOLICITUD AS MTOINGRESOVERIFICADO,
  DAY(FECSOLICITUD)   AS DIASOLICITUD,
  MONTH(FECSOLICITUD) AS MESSOLICITUD,
  YEAR(FECSOLICITUD)  AS ANIOSOLICITUD,
  DATE_FORMAT(FECSOLICITUD, 'yyyyMM') AS CODMESSOLICITUD,
  RANGOSCORE,
  MTOSOLICITADOSOLES,
  MTOAPROBADOSOLES,
  NULL AS MTODESEMBOLSADOSOLES,
  NULL AS FLGMTODESEMBOLSADOSOLES,
  RANGOMTOSOLICITADOSOLES,
  TIEMPOCLIENTEHRS,
  TIEMPOANALISTAHRS,
  TIEMPOCLIENTESEGUNDOS,
  TIEMPOANALISTASEGUNDOS,
  RANGOATENCIONCLIENTE
FROM fin
;