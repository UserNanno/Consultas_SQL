WITH BASE AS (
  SELECT
      A.CODINTERNOCOMPUTACIONAL,
      B.CODCLAVEPARTYCLI,
      A.OPORTUNIDAD,
      A.FECCREACION,
      A.ESTADO,
      /* CODMES: formato YYYYMM */
      CAST(date_format(A.FECCREACION, 'yyyyMM') AS INT) AS CODMES,
      CASE
        WHEN A.FECCREACION < DATE '2025-01-21' THEN 'ANTES'
        ELSE 'DESPUES'
      END AS PERIODO
  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASE_CENTRALIZADO A
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_CLIENTE B
    ON UPPER(TRIM(A.CODINTERNOCOMPUTACIONAL)) = UPPER(TRIM(B.CODINTERNOCOMPUTACIONAL))
  WHERE
      A.CODINTERNOCOMPUTACIONAL IS NOT NULL
      AND A.TIPPRODUCTO = 'CC'
      AND B.CODCLAVEPARTYCLI IS NOT NULL
),
TRANSACCIONES_ADS AS (
  SELECT
      TO_DATE(FECTRX) AS FECTRANSACCION,
      CODCLAVEPARTYCLI
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_TRANSACCIONADELANTOCUENTASUELDO
  WHERE
      DESTRX = 'ADELANTO SUELDO'
      AND DESOPECTASUELDO = 'DISPOSICION'
)
SELECT
    A.CODINTERNOCOMPUTACIONAL,
    A.OPORTUNIDAD,
    A.FECCREACION,
    A.CODMES,
    A.ESTADO,
    A.PERIODO,
    ADD_MONTHS(A.FECCREACION, -3) AS FECHA_INICIO_VENTANA_ADS,
    A.FECCREACION               AS FECHA_FIN_VENTANA_ADS,
    CASE WHEN A.ESTADO = 'ACEPTADAS' THEN 1 ELSE 0 END AS FLGAPROBADA,
    CASE WHEN A.ESTADO = 'DENEGADAS' THEN 1 ELSE 0 END AS FLGDENEGADA,
    CASE WHEN NVL(COUNT(B.FECTRANSACCION), 0) > 0 THEN 1 ELSE 0 END AS FLG_ADS_U3M,
    NVL(COUNT(B.FECTRANSACCION), 0) AS CNT_TRX_U3M
FROM BASE A
LEFT JOIN TRANSACCIONES_ADS B
  ON B.CODCLAVEPARTYCLI = A.CODCLAVEPARTYCLI
 AND B.FECTRANSACCION BETWEEN ADD_MONTHS(A.FECCREACION, -3) AND A.FECCREACION
GROUP BY ALL
ORDER BY 1, 2, 3 ASC;
