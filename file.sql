**Rol:** Experto optimizador SQL para Databricks SQL Editor.
**Objetivo:** Optimizar la consulta SQL adjunta para Databricks. Prioridades:
1. **Rendimiento:** disminuir tiempo ejecución, disminuir costos (DBUs).
2. **Legibilidad:** Código claro, bien estructurado.
3. **Mantenibilidad:** Facilitar modificaciones.
La consulta optimizada debe ser **semánticamente equivalente** a la original (salvo cambios como
`UNION` a `UNION ALL`, que deben justificarse).
**Instrucciones (Aplica y justifica brevemente cada punto):**
1. **CTEs:** Usar para modularidad/claridad. Nombres descriptivos. Evitar materialización
innecesaria.
2. **Origen de Columnas:** Reglas estrictas sobre el origen exacto de columnas según el SELECT
original.
3. **UNION/UNION ALL:** Preferir UNION ALL si no se requiere deduplicación. Justificarlo.
4. **Filtros (Predicate Pushdown):** Aplicar filtros lo más temprano posible.
5. **Tipos de JOIN:** Mantener tipos originales. Justificar cambios implícitos.
6. **Mejoras Adicionales (Databricks):** Sintaxis, legibilidad, funciones Spark SQL.
**Formato de Salida (En español):**
**A. Consulta SQL Optimizada:** (Código SQL listo para Databricks)
**B. Justificación de Cambios:** Para cada una de las 6 directrices:
- Cambios aplicados
- Impacto (rendimiento, legibilidad, mantenibilidad)
- Verificación del origen de columnas (punto 2)
- Confirmar equivalencia semántica
---
SELECT
  A.CODSOLICITUD,
  TO_TIMESTAMP(CONCAT_WS(' ', A.FECSOLICITUD, LPAD(A.HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECREGISTRO,
  (CASE WHEN A.CODMATRICULACOLABORADORAPROBADOR IS NOT NULL THEN 'EVLUACION EN CENTRALIZADO' ELSE 'EVALUACION AUTOMATICA' END) AS TIPOEVALUACION,
  (CASE
    WHEN A.DESTIPFLUJOVENTATARJETACREDITO IN ('EP', 'PTC', 'BT', 'AMPLIACION', 'UPGRADE', 'ADICIONAL') THEN 'TARJETA CREDITO STOCK'
    WHEN A.DESTIPFLUJOVENTATARJETACREDITO IN ('SEGUNDA TC', 'TC') THEN 'TARJETA CREDITO NUEVA'
    WHEN 
      CONTAINS(A.DESCAMPANIA, 'PRESTAMO TAR') OR
      CONTAINS(A.DESCAMPANIA, 'PRÉSTAMO TAR') OR
      CONTAINS(A.DESCAMPANIA, 'PTC') OR
      CONTAINS(A.DESCAMPANIA, 'EP') OR
      CONTAINS(A.DESCAMPANIA, 'BALANCE TRA') OR
      CONTAINS(A.DESCAMPANIA, 'TC+BT') OR
      CONTAINS(A.DESCAMPANIA, 'BT') OR
      CONTAINS(A.DESCAMPANIA, 'AMPLIACION') OR
      CONTAINS(A.DESCAMPANIA, 'AMPLIACIÓN') OR
      CONTAINS(A.DESCAMPANIA, 'UPGRADE') OR
      CONTAINS(A.DESCAMPANIA, 'UPG') OR
      CONTAINS(A.DESCAMPANIA, 'ADICIONAL') THEN 'TARJETA CREDITO STOCK'
    ELSE 'SIN DATA'
  END) AS TIPOPRODUCTO,
  (CASE
    WHEN A.destipflujoventatarjetacredito = 'EP' THEN 'PTC'
    WHEN A.destipflujoventatarjetacredito = 'SEGUNDA TC' THEN 'TC'
    WHEN A.destipflujoventatarjetacredito IS NOT NULL THEN A.destipflujoventatarjetacredito
    WHEN contains(A.descampania, 'PRESTAMO TAR') OR
        contains(A.descampania, 'PRÉSTAMO TAR') OR
        contains(A.descampania, 'PTC') OR
        contains(A.descampania, 'EP') THEN 'PTC'
    WHEN contains(A.descampania, 'BALANCE TRA') OR
        contains(A.descampania, 'TC+BT') OR
        contains(A.descampania, 'BT') THEN 'BT'
    WHEN contains(A.descampania, 'AMPLIACION') OR
        contains(A.descampania, 'AMPLIACIÓN') THEN 'AMPLIACION'
    WHEN contains(A.descampania, 'UPGRADE') OR
        contains(A.descampania, 'UPG') THEN 'UPGRADE'
    WHEN contains(A.descampania, 'ADICIONAL') THEN 'ADICIONAL'
    ELSE 'Sin data'
  END) AS SUBPRODUCTO,
  A.DESPRODUCTO,
  (CASE
    WHEN A.TIPESTADOSOLICITUD = 'ACPD' THEN 'ACEPTADA'
    WHEN A.TIPESTADOSOLICITUD = 'DCLD' THEN 'DENEGADA'
    WHEN A.TIPESTADOSOLICITUD = 'ENPR' THEN 'EN PROCESO'
    WHEN A.TIPESTADOSOLICITUD = 'IRFC' THEN 'INGRESADO'
    WHEN A.TIPESTADOSOLICITUD = 'EEEL' THEN 'EN PROCESO DE CALIFICACION'
    WHEN A.TIPESTADOSOLICITUD = 'DIGI' THEN 'DIGITADO'
  ELSE 'SIN DATA'
  END) AS RESULTADOANALISTA,
  (CASE
    WHEN A.TIPESTADOSOLICITUD = 'ACPD' AND DESTIPETAPA = 'CERRADA' THEN 'ACEPTADA'
    WHEN A.TIPESTADOSOLICITUD = 'DCLD' AND DESTIPETAPA = 'RECHAZADA' THEN 'DENEGADA'
    WHEN A.TIPESTADOSOLICITUD = 'ENPR' AND DESTIPETAPA = 'DESESTIMADA' THEN 'DESESTIMADA'
    WHEN A.TIPESTADOSOLICITUD = 'IRFC' AND DESTIPETAPA = 'PERDIDA' THEN 'DESESTIMADA'
    WHEN A.TIPESTADOSOLICITUD = 'ENPR' THEN 'EN PROCESO'
    WHEN A.TIPESTADOSOLICITUD = 'IRFC' THEN 'INGRESADO'
    WHEN A.TIPESTADOSOLICITUD = 'EEEL' THEN 'EN PROCESO DE CALIFICACION'
    WHEN A.TIPESTADOSOLICITUD = 'DIGI' THEN 'DIGITADO'
  ELSE 'SIN DATA'
  END) AS ESTADO_F,
  NULL AS RESULTADOMOTORDCA,
  A.DESMOTIVOCDA,
  A.DESTIPETAPA AS ETAPA,
  NULL AS JUSTIFICACIONANALISTA,
  A.DESCOMENTARIO AS COMENTARIOANALISTA,
  A.DESCAMPANIA AS CAMPANIA,
  (CASE
    WHEN CONTAINS(A.DESCAMPANIA, '100%') THEN '100% APROBADO'
    WHEN CONTAINS(A.DESCAMPANIA, 'PREAPR') THEN 'PREAPROBADO'
    WHEN CONTAINS(A.DESCAMPANIA, 'SIN CAMP') THEN 'SIN CAMPANIA'
    WHEN CONTAINS(A.DESCAMPANIA, 'INVITA') THEN 'INVITADO'
    WHEN A.DESTIPFLUJOVENTATARJETACREDITO = 'EP' THEN 'PTC'
    WHEN A.DESTIPFLUJOVENTATARJETACREDITO = 'SEGUNDA TC' THEN 'TC'
    WHEN A.DESTIPFLUJOVENTATARJETACREDITO IS NOT NULL THEN A.DESTIPFLUJOVENTATARJETACREDITO
    WHEN CONTAINS(A.DESCAMPANIA, 'PRESTAMO TAR') THEN 'PTC'
    WHEN CONTAINS(A.DESCAMPANIA, 'PRÉTAMO TAR') THEN 'PTC'
    WHEN CONTAINS(A.DESCAMPANIA, 'PTC') THEN 'PTC'
    WHEN CONTAINS(A.DESCAMPANIA, 'EP') THEN 'PTC'
    WHEN CONTAINS(A.DESCAMPANIA, 'BALANCE TRA') THEN 'BT'
    WHEN CONTAINS(A.DESCAMPANIA, 'TC+BT') THEN 'BT'
    WHEN CONTAINS(A.DESCAMPANIA, 'BT') THEN 'BT'
    WHEN CONTAINS(A.DESCAMPANIA, 'AMPLIACION') THEN 'AMPLIACION'
    WHEN CONTAINS(A.DESCAMPANIA, 'AMPLIACIÓN') THEN 'AMPLIACION'
    WHEN CONTAINS(A.DESCAMPANIA, 'UPGRADE') THEN 'UPGRADE'
    WHEN CONTAINS(A.DESCAMPANIA, 'UPG') THEN 'UPGRADE'
    WHEN CONTAINS(A.DESCAMPANIA, 'ADICIONAL') THEN 'ADICIONAL'
  ELSE 'SIN DATA'
  END) AS CAMPANACORTA,
  A.NBRMONEDA AS MONEDA,
  A.MTOSOLICITADO AS MTOSOLICITADO,
  A.MTOAPROBADO AS MTOAPROBADO,
  TO_TIMESTAMP(CONCAT_WS(' ', A.FECINICIOEVALUACION, LPAD(A.HORINICIOEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS INICIOEVALUACION,
  TO_TIMESTAMP(CONCAT_WS(' ', A.FECFINEVALUACION, LPAD(A.HORFINEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FINEVALUACION,
  A.FECEMISIONTARJETACREDITO AS FECDESEMBOLSO,
  A.CODMATRICULACOLABORADORAPROBADOR AS MATANALISTA,
  A.CODMATRICULACOLABORADORVENDEDOR AS MATVENDEDOR,
  A.CODINTERNOCOMPUTACIONAL,
  (CASE WHEN B.DESTIPROLSOLICITUD = 'TITULAR' THEN B.FLGCLIPAGOHABERESBCP ELSE NULL END) AS FLGPDH,
  (CASE WHEN B.DESTIPROLSOLICITUD = 'TITULAR' THEN B.TIPRENTA ELSE NULL END) AS TIPRENTATITULAR,
  (CASE WHEN C.DESTIPROLSOLICITUD = 'CONYUGE' THEN C.TIPRENTA ELSE NULL END) AS TIPRENTACONYUGE,
  (CASE WHEN B.DESTIPROLSOLICITUD = 'TITULAR' THEN B.NUMPUNTAJEPRECALIF ELSE NULL END) AS SCOREEVALUACION,
  (CASE WHEN B.DESTIPROLSOLICITUD = 'TITULAR' THEN B.TIPPARTYIDENTIFICACION ELSE NULL END) AS TIPIDCTITULAR,
  (CASE WHEN C.DESTIPROLSOLICITUD = 'CONYUGE' THEN C.TIPPARTYIDENTIFICACION ELSE NULL END) AS TIPIDCCONYUGE,
  (CASE WHEN B.DESTIPROLSOLICITUD = 'TITULAR' THEN B.MTOINGRESODIGITADO ELSE NULL END) AS INGRESOBRUTOTITULAR,
  (CASE WHEN C.DESTIPROLSOLICITUD = 'CONYUGE' THEN C.MTOINGRESODIGITADO ELSE NULL END) AS INGRESOBRUTOCONYUGE,
  (CASE WHEN B.DESTIPROLSOLICITUD = 'TITULAR' THEN B.MTOOTROINGRESODIGITADO ELSE NULL END) AS OTROINGRESOBRUTOTITULAR,
  (CASE WHEN C.DESTIPROLSOLICITUD = 'CONYUGE' THEN C.MTOOTROINGRESODIGITADO ELSE NULL END) AS OTROINGRESOBRUTOCONYUGE,
  (CASE WHEN B.DESTIPROLSOLICITUD = 'TITULAR' THEN B.MTOINGRESOCALCULADO ELSE NULL END) AS INGRESOPROMEDIOTITULAR,
  (CASE WHEN C.DESTIPROLSOLICITUD = 'CONYUGE' THEN C.MTOINGRESOCALCULADO ELSE NULL END) AS INGRESOPROMEDIOCONYUGE,
  A.MTOCUOTAMENSUALAPROBADO,
  NULL AS PLAZOSOLICITADO,
  NULL AS PLAZOAPROBADO,
  A.PCTTASAEFECTIVAANUALSOLICITUD AS TASASOLICITADA,
  NULL AS TASAAPROBADA,
  B.MTOCEM AS CEM,
  B.MTOCEMASESORVENTA AS CEMVENDEDOR,
  B.MTOCEMANALISTACREDITO AS CEMANALISTACREDITO,
  (CASE WHEN B.DESTIPROLSOLICITUD = 'TITULAR' THEN B.DESSUBSEGMENTO ELSE NULL END) AS SEGMENTOTITULAR,
  NULL AS POSICIONCONSOLIDADA,
  (CASE WHEN B.DESTIPROLSOLICITUD = 'TITULAR' THEN B.CODSEGMENTORIESGOSCORE ELSE NULL END) AS SEGMENTORIESGOSTITULAR,
  (CASE WHEN C.DESTIPROLSOLICITUD = 'CONYUGE' THEN C.TIPPARTYIDENTIFICACION ELSE NULL END) AS SEGMENTORIESGOSCONYUGE,
  NULL AS MTODESEMBOLSADO,
  (CASE WHEN B.DESTIPROLSOLICITUD = 'TITULAR' THEN B.DESTIPNIVELEDUCACIONAL ELSE NULL END) AS GRADOINTRUSCCION,
  (CASE WHEN B.DESTIPROLSOLICITUD = 'TITULAR' THEN B.DESTIPOCUPACION ELSE NULL END) AS SITUACIONLAOBRALTITULAR,
  (CASE WHEN C.DESTIPROLSOLICITUD = 'CONYUGE' THEN C.DESTIPOCUPACION ELSE NULL END) AS SITUACIONLAOBRALCONYUGE,
  (CASE WHEN B.DESTIPROLSOLICITUD = 'TITULAR' THEN B.DESTIPOCUPACION ELSE NULL END) AS SITUACIONLAOBRALTITULAR,
  (CASE WHEN C.DESTIPROLSOLICITUD = 'CONYUGE' THEN C.DESTIPOCUPACION ELSE NULL END) AS SITUACIONLAOBRALCONYUGE,
  (CASE WHEN D.DESTIPROLSOLICITUD = 'TITULAR' THEN D.DESTIPCLASIFRIESGOCLI ELSE NULL END) AS CLASIFSBSTITULTAR,
  (CASE WHEN E.DESTIPROLSOLICITUD = 'CONYUGE' THEN E.DESTIPCLASIFRIESGOCLI ELSE NULL END) AS CLASIFSBSCONYUGE,
  (CASE WHEN B.DESTIPROLSOLICITUD = 'TITULAR' THEN B.NUMDEPENDIENTE ELSE NULL END) AS NUMDEPENDIENTESTITULAR,
  (CASE WHEN B.DESTIPROLSOLICITUD = 'TITULAR' THEN B.DESTIPESTCIVIL ELSE NULL END) AS ESTADOCIVIL,
  F.DESPOSICIONCOLABORADOR AS FUNCIONVENDEDOR,
  A.MTOINGRESOBRUTOSOLICITUD AS MTOINGRESOVERIFICADO,
  DAY(A.FECSOLICITUD) AS DIASOLICITUD,
  MONTH(A.FECSOLICITUD) AS MESSOLICITUD,
  YEAR(A.FECSOLICITUD) AS ANIOSOLICITUD,
  DATE_FORMAT(A.FECSOLICITUD, 'yyyyMM') AS CODMESSOLICITUD,
  (CASE
    WHEN B.NUMPUNTAJEPRECALIF <= 0 THEN 'SIN DATA'
    WHEN B.NUMPUNTAJEPRECALIF BETWEEN 1 AND 300 THEN 'A. 1-300'
    WHEN B.NUMPUNTAJEPRECALIF BETWEEN 301 AND 330 THEN 'B. 301-300'
    WHEN B.NUMPUNTAJEPRECALIF BETWEEN 331 AND 360 THEN 'C. 331-360'
    WHEN B.NUMPUNTAJEPRECALIF BETWEEN 361 AND 390 THEN 'D. 361-390'
    WHEN B.NUMPUNTAJEPRECALIF BETWEEN 391 AND 420 THEN 'E. 391-420'
    WHEN B.NUMPUNTAJEPRECALIF BETWEEN 421 AND 450 THEN 'F. 421-450'
    ELSE NULL
  END) AS RANGOSCORE,
  (CASE 
    WHEN A.NBRMONEDA = 'DOLAR AMERICANO             EE.UU       ' THEN A.MTOSOLICITADO * 3.81
    ELSE A.MTOSOLICITADO
  END) AS MTOSOLICITADOSOLES,
  (CASE 
    WHEN A.NBRMONEDA = 'DOLAR AMERICANO             EE.UU       ' THEN A.MTOAPROBADO * 3.81
    ELSE A.MTOAPROBADO
  END) AS MTOAPROBADOSOLES,
  NULL AS MTODESEMBOLSADOSOLES,
  NULL AS FLGMTODESEMBOLSADOSOLES,
  (CASE
    WHEN MTOSOLICITADOSOLES <= 0 THEN 'SIN DATA'
    WHEN MTOSOLICITADOSOLES BETWEEN 1 AND 23000 THEN 'A. 1-23K'
    WHEN MTOSOLICITADOSOLES BETWEEN 23001 AND 46000 THEN 'B. 23K-46K'
    WHEN MTOSOLICITADOSOLES BETWEEN 46001 AND 69000 THEN 'C. 46K-69K'
    WHEN MTOSOLICITADOSOLES BETWEEN 69001 AND 92000 THEN 'D. 69K-92K'
    WHEN MTOSOLICITADOSOLES BETWEEN 92001 AND 115000 THEN 'E. 92K-115K'
    WHEN MTOSOLICITADOSOLES BETWEEN 115001 AND 138000 THEN 'F. 115K-138K'
    WHEN MTOSOLICITADOSOLES BETWEEN 138001 AND 160000 THEN 'G. 138K-160K'
    ELSE 'H. >160K'
  END) AS RANGOMTOSOLICITADOSOLES,
  DATEDIFF(SECOND, FECREGISTRO, FINEVALUACION) / 3600 AS TIEMPOCLIENTEHRS,
  DATEDIFF(SECOND, INICIOEVALUACION, FINEVALUACION) / 3600 AS TIEMPOANALISTAHRS,
  DATEDIFF(SECOND, FECREGISTRO, FINEVALUACION) AS TIEMPOCLIENTESEGUNDOS,
  DATEDIFF(SECOND, INICIOEVALUACION, FINEVALUACION) AS TIEMPOANALISTASEGUNDOS,
  (CASE
    WHEN TIEMPOCLIENTEHRS IS NULL THEN NULL
    WHEN TIEMPOCLIENTEHRS <= 0 THEN 'SIN DATA'
    WHEN TIEMPOCLIENTEHRS BETWEEN 1 AND 3 THEN 'A. 1-3'
    WHEN TIEMPOCLIENTEHRS BETWEEN 4 AND 6 THEN 'B. 4-6'
    WHEN TIEMPOCLIENTEHRS BETWEEN 7 AND 12 THEN 'C. 7-12'
    WHEN TIEMPOCLIENTEHRS BETWEEN 13 AND 18 THEN 'D. 13-18'
    WHEN TIEMPOCLIENTEHRS BETWEEN 19 AND 24 THEN 'E. 19-24'
    ELSE 'F. >24'
  END) AS RANGOATENCIONCLIENTE
FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDTARJETACREDITO A
LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDINDIVIDUO B ON (A.CODSOLICITUD = B.CODSOLICITUD AND B.DESTIPROLSOLICITUD = 'TITULAR')
LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDINDIVIDUO C ON (A.CODSOLICITUD = B.CODSOLICITUD AND B.DESTIPROLSOLICITUD = 'CONYUGE')
LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDPARTY D ON (A.CODSOLICITUD = D.CODSOLICITUD AND D.DESTIPROLSOLICITUD = 'TITULAR')
LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDPARTY E ON (A.CODSOLICITUD = E.CODSOLICITUD AND E.DESTIPROLSOLICITUD = 'CONYUGE')
LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_USUARIOAPLICATIVO F ON (A.CODCOLABORADORVENDEDOR = F.CODUSUARIOAPP)
WHERE A.CODTIPREGAPP IN ('0126O000001xsIYQAY','0126O000001h0WaQAI','0126O000001h0WbQAI') AND A.FECSOLICITUD >= '2025-10-01';
