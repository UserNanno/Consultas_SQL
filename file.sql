WITH base AS (
  SELECT
    A.CODSOLICITUD,
    A.ESTADO_RESULTADOANALISTA,
    D.OPERACION,
    D.RESULTADOANALISTA,
    CASE
      WHEN D.OPERACION IS NOT NULL THEN 'EVALUACION EN CENTRALIZADO'
      ELSE 'EVALUACION AUTOMATICA'
    END AS TipoEvaluacion
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO A
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_REGISTRO_OPORTUNIDADES D
    ON A.CODSOLICITUD = D.OPERACION
),

-- Mapeo equivalente a AW:AX como función (devuelve NULL si no hay match)
mapeado AS (
  SELECT
    *,
    CASE
      WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'DENEGADO'                          THEN 'DENEGADAS'
      WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'APROBADO'                          THEN 'ACEPTADAS'
      WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'FACA'                              THEN 'FACA'
      WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'DESESTIMADO'                       THEN 'DESACTIVADA'
      WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'ACEPTADA'                          THEN 'ACEPTADAS'
      WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'DENEGADO POR ANALISTA DE CREDITO'  THEN 'DENEGADAS'
      WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'APROBADO POR ANALISTA DE CREDITO'  THEN 'ACEPTADAS'
      WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'EN PROCESO'                        THEN 'EN PROCESO'
      WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'SOLICITUD CANCELADA'               THEN 'SOLICITUD CANCELADA'
      WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'ENVIADO AL CENTRALIZADO'           THEN 'ENVIADO AL CENTRALIZADO'
      ELSE NULL
    END AS MAP_RES
  FROM base
)

SELECT
  -- =SI.ERROR( BUSCARV(BUSCARV(...), AW:AX, 2, 0),
  --            SI(TipoEvaluación="EVALUACION EN CENTRALIZADO", Estado_resultadoanalista, BUSCARV(...)) )
  COALESCE(
    MAP_RES,
    CASE
      WHEN TipoEvaluacion = 'EVALUACION EN CENTRALIZADO' THEN ESTADO_RESULTADOANALISTA
      ELSE
        -- repetir el mapeo (si no mapea, queda NULL tal como en Excel)
        CASE
          WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'DENEGADO'                          THEN 'DENEGADAS'
          WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'APROBADO'                          THEN 'ACEPTADAS'
          WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'FACA'                              THEN 'FACA'
          WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'DESESTIMADO'                       THEN 'DESACTIVADA'
          WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'ACEPTADA'                          THEN 'ACEPTADAS'
          WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'DENEGADO POR ANALISTA DE CREDITO'  THEN 'DENEGADAS'
          WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'APROBADO POR ANALISTA DE CREDITO'  THEN 'ACEPTADAS'
          WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'EN PROCESO'                        THEN 'EN PROCESO'
          WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'SOLICITUD CANCELADA'               THEN 'SOLICITUD CANCELADA'
          WHEN UPPER(TRIM(RESULTADOANALISTA)) = 'ENVIADO AL CENTRALIZADO'           THEN 'ENVIADO AL CENTRALIZADO'
          ELSE NULL
        END
    END
  ) AS ResultadoExcel
FROM mapeado;
