WITH 
TP_BASE AS (
  SELECT
    A.CODSOLICITUD,
    A.TIPCLASIFINTERNASOLICITUD,
    A.DESTIPCLASIFINTERNASOLICITUD,
    A.FECSOLICITUD,
    A.HORSOLICITUD,
    A.DESTIPESTADOSOLICITUD,
    A.TIPESTADOJUSTIFICACIONSOLICITUD,
    A.DESTIPESTADOJUSTIFICACIONSOLICITUD,
    A.CODPRODUCTO,
    A.NBRMONEDA,
    A.MTOAPROBADO,
    A.MTOSOLICITADO,
    A.CTDPLAZOAPROBADO,
    A.CTDPLAZOSOLICITADO,
    A.CODCOLABORADORANALISTA,
    A.CODMATRICULACOLABORADORANALISTA,
    A.CODCOLABORADORAPROBADOR,
    A.CODMATRICULACOLABORADORAPROBADOR,
    A.CODCOLABORADOREXCEPTUADOR,
    A.CODMATRICULACOLABORADOREXCEPTUADOR,
    A.CODCOLABORADORVENDEDOR,
    A.CODMATRICULACOLABORADORVENDEDOR,
    A.DESTIPSOLICITUD,
    A.FECINICIOCALIF,
    A.FECFINCALIF,
    A.NBREXCEP,
    A.NBRTIPEXCEP,
    A.DESTIPVENTACDA,
    A.DESTIPESTADOEVALUACIONANALISTA AS RESULTADOANALISTA,      -- esto es tu [@[Estado_resultadoanalista]] en Excel
    A.DESTIPESTADOEVALUACIONCDA AS ESTADO_EVAL_CDA,             -- ← arreglé el alias que faltaba
    A.DESTIPEVALUACIONRIESGO AS TIPOCAMPANA,
    A.DESCAMPANIA AS CAMPANIA,
    A.FECDESEMBOLSO,
    A.TIPETAPA,
    A.DESTIPETAPA,
    A.CODINTERNOCOMPUTACIONAL,
    A.DESTIPEVALUACIONSOLICITUD,
    B.AREA_TRIBU_COE AS AREAANALISTA,
    C.AREA_TRIBU_COE AS AREAVENDEDOR,

    /* bandera de centralizado/automática (tu BUSCARX de TipoEvaluación) */
    CASE WHEN D.OPERACION IS NOT NULL 
         THEN 'EVALUACION EN CENTRALIZADO'
         ELSE 'EVALUACION AUTOMATICA'
    END AS TIPEVALUACIONMANUAL,

    /* Columna 6 del Registro_Manual (necesaria para el mapeo AW:AX) */
    D.RESULTADOANALISTA AS RESULTADOANALISTA_RM

  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO A
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_ORGANICO B 
    ON A.CODMATRICULACOLABORADORANALISTA = B.MATORGANICO 
   AND B.CODMES = TO_CHAR(A.FECSOLICITUD, 'yyyyMM')
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_ORGANICO C 
    ON A.CODMATRICULACOLABORADORVENDEDOR = C.MATORGANICO 
   AND C.CODMES = TO_CHAR(A.FECSOLICITUD, 'yyyyMM')
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_REGISTRO_OPORTUNIDADES D 
    ON A.CODSOLICITUD = D.OPERACION
  WHERE A.FECSOLICITUD >= DATE '2025-10-01' 
    AND A.FECSOLICITUD <= DATE '2025-10-16'
),

TP_BASE2 AS (
  SELECT
    A.*,

    /* === AQUÍ va tu fórmula Excel 1:1 en UNA sola columna === */
    COALESCE(
      /* BUSCARV(BUSCARV(...); AW:AX; 2; 0) usando RESULTADOANALISTA_RM */
      CASE
        WHEN A.RESULTADOANALISTA_RM = 'Denegado' THEN 'DENEGADAS'
        WHEN A.RESULTADOANALISTA_RM = 'Aprobado' THEN 'ACEPTADAS'
        WHEN A.RESULTADOANALISTA_RM = 'FACA' THEN 'FACA'
        WHEN A.RESULTADOANALISTA_RM = 'Desestimado' THEN 'DESACTIVADA'
        WHEN A.RESULTADOANALISTA_RM = 'ACEPTADA' THEN 'ACEPTADAS'
        WHEN A.RESULTADOANALISTA_RM = 'Denegado por Analista de credito' THEN 'DENEGADAS'
        WHEN A.RESULTADOANALISTA_RM = 'Aprobado por Analista de credito' THEN 'ACEPTADAS'
        WHEN A.RESULTADOANALISTA_RM = 'EN PROCESO' THEN 'EN PROCESO'
        WHEN A.RESULTADOANALISTA_RM = 'SOLICITUD CANCELADA' THEN 'SOLICITUD CANCELADA'
        WHEN A.RESULTADOANALISTA_RM = 'ENVIADO AL CENTRALIZADO' THEN 'ENVIADO AL CENTRALIZADO'
        ELSE NULL
      END,
      /* SI(TipoEvaluación="EVALUACION EN CENTRALIZADO"; Estado_resultadoanalista; BUSCARV(...)) */
      CASE
        WHEN A.TIPEVALUACIONMANUAL = 'EVALUACION EN CENTRALIZADO' THEN A.RESULTADOANALISTA
        ELSE
          CASE
            WHEN A.RESULTADOANALISTA_RM = 'Denegado' THEN 'DENEGADAS'
            WHEN A.RESULTADOANALISTA_RM = 'Aprobado' THEN 'ACEPTADAS'
            WHEN A.RESULTADOANALISTA_RM = 'FACA' THEN 'FACA'
            WHEN A.RESULTADOANALISTA_RM = 'Desestimado' THEN 'DESACTIVADA'
            WHEN A.RESULTADOANALISTA_RM = 'ACEPTADA' THEN 'ACEPTADAS'
            WHEN A.RESULTADOANALISTA_RM = 'Denegado por Analista de credito' THEN 'DENEGADAS'
            WHEN A.RESULTADOANALISTA_RM = 'Aprobado por Analista de credito' THEN 'ACEPTADAS'
            WHEN A.RESULTADOANALISTA_RM = 'EN PROCESO' THEN 'EN PROCESO'
            WHEN A.RESULTADOANALISTA_RM = 'SOLICITUD CANCELADA' THEN 'SOLICITUD CANCELADA'
            WHEN A.RESULTADOANALISTA_RM = 'ENVIADO AL CENTRALIZADO' THEN 'ENVIADO AL CENTRALIZADO'
            ELSE NULL
          END
      END
    ) AS ResultadoExcel

  FROM TP_BASE A
)

SELECT * 
FROM TP_BASE2;
