WITH 
TP_BASE AS (
  SELECT
  A.CODSOLICITUD,
  A.TIPCLASIFINTERNASOLICITUD,
  A.DESTIPCLASIFINTERNASOLICITUD,
  A.FECSOLICITUD,
  A.HORSOLICITUD,
  A.DESTIPESTADOSOLICITUD,
  A.TIPESTADOJUSTIFICACIONSOLICITUD,
  A.DESTIPESTADOJUSTIFICACIONSOLICITUD,
  A.CODPRODUCTO,
  A.NBRMONEDA,
  A.MTOAPROBADO,
  A.MTOSOLICITADO,
  A.CTDPLAZOAPROBADO,
  A.CTDPLAZOSOLICITADO,
  A.CODCOLABORADORANALISTA,
  A.CODMATRICULACOLABORADORANALISTA,
  A.CODCOLABORADORAPROBADOR,
  A.CODMATRICULACOLABORADORAPROBADOR,
  A.CODCOLABORADOREXCEPTUADOR,
  A.CODMATRICULACOLABORADOREXCEPTUADOR,
  A.CODCOLABORADORVENDEDOR,
  A.CODMATRICULACOLABORADORVENDEDOR,
  A.DESTIPSOLICITUD,
  A.FECINICIOCALIF,
  A.FECFINCALIF,
  A.NBREXCEP,
  A.NBRTIPEXCEP,
  A.DESTIPVENTACDA,
  A.DESTIPESTADOEVALUACIONANALISTA AS RESULTADOANALISTA,
  A.DESTIPESTADOEVALUACIONCDA AS,
  A.DESTIPEVALUACIONRIESGO AS TIPOCAMPANA,
  A.DESCAMPANIA AS CAMPANIA,
  A.FECDESEMBOLSO,
  --TIPRENTA
  A.TIPETAPA,
  A.DESTIPETAPA,
  A.CODINTERNOCOMPUTACIONAL,
  A.DESTIPEVALUACIONSOLICITUD,
  --NOMBRE ANALISTA NO VA
  B.AREA_TRIBU_COE AS AREAANALISTA,
  C.AREA_TRIBU_COE AS AREAVENDEDOR,
  (CASE
    WHEN D.OPERACION IS NOT NULL THEN 'EVALUACION EN CENTRALIZADO'
    ELSE 'EVALUACION AUTOMATICA'
  END) AS TIPEVALUACIONMANUAL
FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO A
LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_ORGANICO B ON (A.CODMATRICULACOLABORADORANALISTA = B.MATORGANICO AND B.CODMES = TO_CHAR(A.FECSOLICITUD, 'yyyyMM'))
LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_ORGANICO C ON (A.CODMATRICULACOLABORADORVENDEDOR = C.MATORGANICO AND C.CODMES = TO_CHAR(A.FECSOLICITUD, 'yyyyMM'))
LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_REGISTRO_OPORTUNIDADES D ON (A.CODSOLICITUD = D.OPERACION)
WHERE A.FECSOLICITUD >= DATE '2025-10-01' AND A.FECSOLICITUD <= DATE '2025-10-16'
),
TP_BASE2 AS 
(
SELECT
  A.*,
    (CASE 
    WHEN A.TIPEVALUACIONMANUAL = 'EVALUACION AUTOMATICA' THEN
      (CASE 
        WHEN A.DESTIPESTADOSOLICITUD = 'SOLICITUD CANCELADA' THEN 'SOLICITUD CANCELADA - SALES'
        WHEN A.DESTIPESTADOSOLICITUD = 'DESACTIVADA' THEN 'DESACTIVADA - SALES'
        WHEN A.DESTIPESTADOSOLICITUD = 'DENEGADA' THEN 'DENEGADAS'
        WHEN A.DESTIPESTADOSOLICITUD = 'ACEPTADA' THEN 'ACEPTADAS'
        WHEN A.DESTIPESTADOSOLICITUD = 'EN PROCESO' THEN 'EN PROCESO - SALES'
        WHEN A.DESTIPESTADOSOLICITUD IS NULL THEN 'EN PROCESO - SALES'
      END)
    WHEN A.TIPEVALUACIONMANUAL = 'EVALUACION EN CENTRALIZADO' AND A.DESTIPETAPA = 'DESESTIMADA' AND A.RESULTADOANALISTA NOT IN ('APROBADO POR ANALISTA DE CREDITOS', 'APROBADO POR GERENTE - FIRMAS Y DESEMBOLSO') THEN 'SOLICITUD CANCELADA'
    WHEN A.TIPEVALUACIONMANUAL = 'EVALUACION EN CENTRALIZADO' AND A.RESULTADOANALISTA IS NULL THEN
      (CASE 
        WHEN A.DESTIPESTADOSOLICITUD = 'SOLICITUD CANCELADA' THEN 'SOLICITUD CANCELADA - SALES'
        WHEN A.DESTIPESTADOSOLICITUD = 'DESACTIVADA' THEN 'DESACTIVADA - SALES'
        WHEN A.DESTIPESTADOSOLICITUD = 'DENEGADA' THEN 'DENEGADAS'
        WHEN A.DESTIPESTADOSOLICITUD = 'ACEPTADA' THEN 'ACEPTADAS'
        WHEN A.DESTIPESTADOSOLICITUD = 'EN PROCESO' THEN 'EN PROCESO - SALES'
        WHEN A.DESTIPESTADOSOLICITUD IS NULL THEN 'EN PROCESO - SALES'
      END)
    WHEN A.TIPEVALUACIONMANUAL = 'EVALUACION EN CENTRALIZADO' THEN
      (CASE
        WHEN A.RESULTADOANALISTA = 'APROBADO POR ANALISTA DE CREDITOS' THEN 'ACEPTADAS'
        WHEN A.RESULTADOANALISTA = 'APROBADO POR GERENTE - FIRMAS Y DESEMBOLSO' THEN 'ACEPTADAS'
        WHEN A.RESULTADOANALISTA = 'RECHAZADO POR GERENTE - DOCUMENTACION ADICIONAL' THEN 'DENEGADAS'
        WHEN A.RESULTADOANALISTA = 'RECHAZADO POR GERENTE - FIRMAS Y DESEMBOLSO' THEN 'DENEGADAS'
        WHEN A.RESULTADOANALISTA = 'ENVIADO A ANALISTA DE CREDITOS' THEN 'EN PROCESO - SALES'
        WHEN A.RESULTADOANALISTA = 'ENVIADO A GERENTE - DOCUMENTACION ADICIONAL' THEN 'EN PROCESO - SALES'
        WHEN A.RESULTADOANALISTA = 'ENVIADO A GERENTE - FIRMAS Y DESEMBOLSO' THEN 'EN PROCESO - SALES'
      END)
    ELSE A.TIPEVALUACIONMANUAL
  END) AS ESTADORESULTADOANALISTAMANUAL
FROM TP_BASE A
