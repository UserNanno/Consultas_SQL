WITH BASE AS (
  SELECT
    A.CODMES,
    A.CODSOLICITUD,
    B.CODINTERNOCOMPUTACIONAL,
    A.ESTADOFINAL,
    COALESCE(A.FLGCAMPANIA,0) AS FLGCAMPANIA
  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASE_PDC A
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_V.M_SOLICITUDCREDITOCONSUMO B
    ON A.CODSOLICITUD = B.CODSOLICITUD
  WHERE A.TIPOPERACION = 'CREDITO CONSUMO NUEVO' AND CODMES = 202512
),

BASE_CLIENTE AS (
  SELECT
    x.*,
    c.CODCLAVEPARTYCLI
  FROM BASE x
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_V.M_CLIENTE c
    ON UPPER(TRIM(x.CODINTERNOCOMPUTACIONAL)) = UPPER(TRIM(c.CODINTERNOCOMPUTACIONAL))
),

CLIENTE_MES AS (
  SELECT
    CODMES,
    CODCLAVEPARTYCLI,
    MAX(CASE WHEN FLGCAMPANIA = 1 THEN 1 ELSE 0 END) AS TIENE_CON_CAMPANIA,
    MAX(CASE WHEN FLGCAMPANIA = 0 THEN 1 ELSE 0 END) AS TIENE_SIN_CAMPANIA
  FROM BASE_CLIENTE
  WHERE CODCLAVEPARTYCLI IS NOT NULL
  GROUP BY CODMES, CODCLAVEPARTYCLI
),

MIXTOS AS (
  SELECT
    CODMES,
    CODCLAVEPARTYCLI
  FROM CLIENTE_MES
  WHERE TIENE_CON_CAMPANIA = 1
    AND TIENE_SIN_CAMPANIA = 1
)

SELECT
  b.CODMES,
  b.CODCLAVEPARTYCLI,
  b.CODSOLICITUD,
  b.ESTADOFINAL,
  b.FLGCAMPANIA
FROM BASE_CLIENTE b
JOIN MIXTOS m
  ON b.CODMES = m.CODMES
 AND b.CODCLAVEPARTYCLI = m.CODCLAVEPARTYCLI
ORDER BY
  b.CODMES,
  b.CODCLAVEPARTYCLI,
  b.CODSOLICITUD;
