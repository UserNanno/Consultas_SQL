WITH
BASE_CENTRALIZADO AS (
  SELECT
    A.CODMES,
    A.CODSOLICITUD,
    B.CODINTERNOCOMPUTACIONAL,
    A.ESTADOFINAL,
    A.FLGCAMPANIA,
    A.FLGCASTIGONUEVO,
    A.FLGDESEMBOLSO,
    CASE WHEN A.FLGCAMPANIA = 'Con Campania' THEN 1 ELSE 0 END AS FLGCAMPANIAORD,
    CASE WHEN A.FLGCASTIGONUEVO = 'Con Castigo' THEN 1 ELSE 0 END AS FLGCASTIGOORD,
    CASE WHEN A.FLGDESEMBOLSO = 'Desembolsado' THEN 1 ELSE 0 END AS FLGDESEMBOLSOORD
  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASE_DESEMBOLSOS_CENTRALIZADO A
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_V.M_SOLICITUDCREDITOCONSUMO B
    ON A.CODSOLICITUD = B.CODSOLICITUD
  WHERE A.TIPOPERACION = 'Credito Consumo Nuevo'
    AND A.ESTADOFINAL IN ('ACEPTADAS', 'DENEGADAS')
),

BASE_FLAGS AS (
  SELECT
    A.CODMES,
    A.CODSOLICITUD,
    A.CODINTERNOCOMPUTACIONAL,
    C.CODCLAVEPARTYCLI,
    CASE WHEN A.ESTADOFINAL = 'ACEPTADAS' THEN 1 ELSE 0 END AS FLGACEPTADAS,
    CASE WHEN A.ESTADOFINAL = 'DENEGADAS' THEN 1 ELSE 0 END AS FLGDENEGADO,
    CASE WHEN A.ESTADOFINAL='ACEPTADAS' AND A.FLGCAMPANIAORD=1 AND A.FLGCASTIGOORD=1 AND A.FLGDESEMBOLSOORD=0 THEN 1 ELSE 0 END AS FLGACEPTADAS_CON_CAMPANIA_CON_RENEGOCIACION_SIN_DESEMBOLSO,
    CASE WHEN A.ESTADOFINAL='ACEPTADAS' AND A.FLGCAMPANIAORD=1 AND A.FLGCASTIGOORD=0 AND A.FLGDESEMBOLSOORD=0 THEN 1 ELSE 0 END AS FLGACEPTADAS_CON_CAMPANIA_SIN_RENEGOCIACION_SIN_DESEMBOLSO,
    CASE WHEN A.ESTADOFINAL='ACEPTADAS' AND A.FLGCAMPANIAORD=0 AND A.FLGCASTIGOORD=1 AND A.FLGDESEMBOLSOORD=0 THEN 1 ELSE 0 END AS FLGACEPTADAS_SIN_CAMPANIA_CON_RENEGOCIACION_SIN_DESEMBOLSO,
    CASE WHEN A.ESTADOFINAL='ACEPTADAS' AND A.FLGCAMPANIAORD=0 AND A.FLGCASTIGOORD=0 AND A.FLGDESEMBOLSOORD=0 THEN 1 ELSE 0 END AS FLGACEPTADAS_SIN_CAMPANIA_SIN_RENEGOCIACION_SIN_DESEMBOLSO
  FROM BASE_CENTRALIZADO A
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_V.M_CLIENTE C
    ON UPPER(TRIM(A.CODINTERNOCOMPUTACIONAL)) = UPPER(TRIM(C.CODINTERNOCOMPUTACIONAL))
),

SBS_DEUDA AS (
  SELECT
    CAST(date_format(FECDIA,'yyyyMM') AS INT) AS CODMESDEUDA,
    CODCLAVEPARTYCLI,
    SUM(MTODEUDASOL) AS MTODEUDASOL_SISTEMA
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_DEUDORSBSDETALLE
  WHERE UPPER(TRIM(NBREMPSISTEMAFINANCIERO)) NOT LIKE 'BANCO DE CREDITO DEL PER%'
  GROUP BY CAST(date_format(FECDIA,'yyyyMM') AS INT), CODCLAVEPARTYCLI
),

BASE_MESREF AS (
  SELECT
    b.*,
    CAST(date_format(add_months(to_date(concat(CAST(b.CODMES AS STRING),'01'),'yyyyMMdd'),-1),'yyyyMM') AS INT) AS CODMES_SBS_MENOS_1,
    b.CODMES AS CODMES_SBS_MES
  FROM BASE_FLAGS b
),

BASE_SBS AS (
  SELECT
    x.*,
    COALESCE(s1.MTODEUDASOL_SISTEMA,0) AS MTO_DEUDA_SBS_MES_MENOS_1,
    COALESCE(s2.MTODEUDASOL_SISTEMA,0) AS MTO_DEUDA_SBS_MES,
    COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) AS DELTA_DEUDA_SBS,
    CASE WHEN (COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0)) > 3000 THEN 1 ELSE 0 END AS FLG_DESEMBOLSO_OTRO_BANCO_REGLA
  FROM BASE_MESREF x
  LEFT JOIN SBS_DEUDA s1
    ON x.CODCLAVEPARTYCLI = s1.CODCLAVEPARTYCLI
   AND x.CODMES_SBS_MENOS_1 = s1.CODMESDEUDA
  LEFT JOIN SBS_DEUDA s2
    ON x.CODCLAVEPARTYCLI = s2.CODCLAVEPARTYCLI
   AND x.CODMES_SBS_MES = s2.CODMESDEUDA
)

SELECT
  CODMES,
  CODSOLICITUD,
  CODINTERNOCOMPUTACIONAL,
  CASE WHEN FLGDENEGADO = 1 AND FLG_DESEMBOLSO_OTRO_BANCO_REGLA = 1 THEN 1 ELSE 0 END AS FLGDENEGADO_CON_DESEMBOLSO_OTRO_BANCO,
  CASE WHEN FLGACEPTADAS_CON_CAMPANIA_CON_RENEGOCIACION_SIN_DESEMBOLSO = 1 AND FLG_DESEMBOLSO_OTRO_BANCO_REGLA = 1 THEN 1 ELSE 0 END AS FLG_ACC_CAMP_RENEG_SIN_DES_CON_DESEMBOLSO_OTRO_BANCO,
  CASE WHEN FLGACEPTADAS_CON_CAMPANIA_SIN_RENEGOCIACION_SIN_DESEMBOLSO = 1 AND FLG_DESEMBOLSO_OTRO_BANCO_REGLA = 1 THEN 1 ELSE 0 END AS FLG_ACC_CAMP_SIN_RENEG_SIN_DES_CON_DESEMBOLSO_OTRO_BANCO,
  CASE WHEN FLGACEPTADAS_SIN_CAMPANIA_CON_RENEGOCIACION_SIN_DESEMBOLSO = 1 AND FLG_DESEMBOLSO_OTRO_BANCO_REGLA = 1 THEN 1 ELSE 0 END AS FLG_ACC_SIN_CAMP_RENEG_SIN_DES_CON_DESEMBOLSO_OTRO_BANCO,
  CASE WHEN FLGACEPTADAS_SIN_CAMPANIA_SIN_RENEGOCIACION_SIN_DESEMBOLSO = 1 AND FLG_DESEMBOLSO_OTRO_BANCO_REGLA = 1 THEN 1 ELSE 0 END AS FLG_ACC_SIN_CAMP_SIN_RENEG_SIN_DES_CON_DESEMBOLSO_OTRO_BANCO
FROM BASE_SBS;
