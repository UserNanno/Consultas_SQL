TP_BASE_PREV AS (
	SELECT
		A.CODMES,
		A.CODSOLICITUD,
		B.MATANALISTA,
		B.NBRAREAUNIDADORGANIZATIVA AS NBRAREAUNIDADORGANIZATIVAANALISTA,
		B.MATSUPERIOR,
		A.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
		(CASE
			WHEN A.NBRAREAUNIDADORGANIZATIVAVENDEDOR IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1') THEN 'ASESOR DE VENTAS Y SERVICIOS'
			WHEN A.NBRAREAUNIDADORGANIZATIVAVENDEDOR = 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS' THEN 'TELEMARKETING'
			WHEN A.NBRAREAUNIDADORGANIZATIVAVENDEDOR = 'GCIA DE AREA BANCA AFLUENTE' AND A.NBRSERVUNIDADORGANIZATIVAVENDEDOR = 'GERENCIA DE BANCA ENALTA' THEN 'ENALTA ASESOR FINANCIERO'
			WHEN A.NBRAREAUNIDADORGANIZATIVAVENDEDOR = 'GCIA DE AREA BANCA AFLUENTE' AND A.NBRSERVUNIDADORGANIZATIVAVENDEDOR = 'GERENCIA DE BANCA EXCLUSIVA DIGITAL' THEN 'BEX DIGITAL EJECUTIVO'
			ELSE 'OTROS'
		END) AS CANAL,
		A.DESTIPESTADOSOLICITUD,
		A.TIPOPERACION,
		A.DESTIPOPERACION,
		COALESCE(A.PRODUCTO, B.PRODUCTO) AS PRODUCTO,
		(CASE
			WHEN A.DESPRODUCTO IS NULL AND A.TIPOPERACION = 'CREDITO CONSUMO' THEN B.DESPRODUCTO
			ELSE COALESCE(B.DESPRODUCTO, A.DESPRODUCTO)
		END) AS DESPRODUCTO,
		A.DESCAMPANIA,
		A.DESTIPEVALUACIONRIESGO,
		A.FECSOLICITUD,
		A.FECHORSOLICITUD,
		A.FECHORINICIOEVALUACION,
		A.FECHORFINEVALUACION,
		A.FECDESEMBOLSO,
		A.FECHORDESEMBOLSO,
		A.TIEMPOATENCIONSOLICITUD,
		A.TIEMPODERIVACIONANALISTA,
		A.TIEMPOATENCIONANALISTA,
		A.TIEMPODESEMBOLSOPOSTATENCIONANALISTA,
		A.NBRMONEDA,
		A.DESTIPRENTA,
		A.SEGMENTO,
		B.ESTADOSOLICITUD,
		A.MTOSOLICITADO,
--		(CASE WHEN A.FECHORINICIOEVALUACION IS NULL THEN 1 ELSE 0 END) AS FLGPENDIENTEATENCION,
--		(CASE WHEN A.FECHORFINEVALUACION IS NULL THEN 1 ELSE 0 END) AS FLGPENDIENTEEVALUACION,
--		(CASE WHEN A.FECDESEMBOLSO IS NULL THEN 1 ELSE 0 END) AS FLGPENDIENTEDESEMBOLSO,
		(CASE
			WHEN B.ESTADOSOLICITUD = 'APROBADO' THEN A.MTOAPROBADO
			ELSE 0
		END) AS MTOAPROBADO,
		(CASE
			WHEN B.ESTADOSOLICITUD = 'APROBADO' AND A.FECDESEMBOLSO IS NOT NULL THEN A.MTODESEMBOLSADO
			ELSE 0
		END) AS MTODESEMBOLSADO,
		(CASE
			WHEN B.ESTADOSOLICITUD = 'APROBADO' AND A.MTOSOLICITADO <> A.MTOAPROBADO THEN (A.MTOSOLICITADO - A.MTOAPROBADO)
			ELSE 0
		END) AS MTORENEGOCIADO,
		(CASE
			WHEN B.ESTADOSOLICITUD = 'RECHAZADO' THEN A.MTOSOLICITADO
			ELSE 0
		END) AS MTODENEGADO,
		(CASE
			WHEN B.ESTADOSOLICITUD = 'APROBADO' THEN
				(CASE
					WHEN A.FECDESEMBOLSO IS NULL THEN A.MTOAPROBADO
					WHEN A.MTOAPROBADO > A.MTODESEMBOLSADO THEN A.MTOAPROBADO - A.MTODESEMBOLSADO
					ELSE 0
				END)
			ELSE 0
		END) AS MTONODESEMBOLSADO,
		(CASE
			WHEN 
				A.NBRAREAUNIDADORGANIZATIVAVENDEDOR IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1', 'GCIA DE AREA BANCA AFLUENTE', 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS') 
				AND B.MATANALISTA IS NULL 
				AND A.DESTIPESTADOSOLICITUD IN ('DESACTIVADA', 'ACEPTADA') THEN 'PUNTO DE CONTACTO'
			WHEN B.MATANALISTA IS NOT NULL AND B.NBRAREAUNIDADORGANIZATIVA = 'TRIBU RIESGOS BDN Y CREDITOS MINORISTAS' THEN 'CENTRALIZADO'
			ELSE 'SIN INFORMACION'
		END) AS CENTROATENCION,
		(CASE
			-- Para CENTRALIZADO, manda ESTADOSOLICITUD (analista/SF)
			WHEN 
				(CASE
					WHEN 
						A.NBRAREAUNIDADORGANIZATIVAVENDEDOR IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1', 'GCIA DE AREA BANCA AFLUENTE', 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS') 
						AND B.MATANALISTA IS NULL 
						AND A.DESTIPESTADOSOLICITUD IN ('DESACTIVADA', 'ACEPTADA') THEN 'PUNTO DE CONTACTO'
					WHEN B.MATANALISTA IS NOT NULL AND B.NBRAREAUNIDADORGANIZATIVA = 'TRIBU RIESGOS BDN Y CREDITOS MINORISTAS' THEN 'CENTRALIZADO'
					ELSE 'SIN INFORMACION'
				END) = 'CENTRALIZADO'
				THEN B.ESTADOSOLICITUD

			-- Para PUNTO DE CONTACTO, mapeas DESTIPESTADOSOLICITUD a APROBADO/RECHAZADO
			WHEN 
				(CASE
					WHEN 
						A.NBRAREAUNIDADORGANIZATIVAVENDEDOR IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1', 'GCIA DE AREA BANCA AFLUENTE', 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS') 
						AND B.MATANALISTA IS NULL 
						AND A.DESTIPESTADOSOLICITUD IN ('DESACTIVADA', 'ACEPTADA') THEN 'PUNTO DE CONTACTO'
					WHEN B.MATANALISTA IS NOT NULL AND B.NBRAREAUNIDADORGANIZATIVA = 'TRIBU RIESGOS BDN Y CREDITOS MINORISTAS' THEN 'CENTRALIZADO'
					ELSE 'SIN INFORMACION'
				END) = 'PUNTO DE CONTACTO'
				AND A.DESTIPESTADOSOLICITUD = 'ACEPTADA'
				THEN 'APROBADO'

			WHEN 
				(CASE
					WHEN 
						A.NBRAREAUNIDADORGANIZATIVAVENDEDOR IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1', 'GCIA DE AREA BANCA AFLUENTE', 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS') 
						AND B.MATANALISTA IS NULL 
						AND A.DESTIPESTADOSOLICITUD IN ('DESACTIVADA', 'ACEPTADA') THEN 'PUNTO DE CONTACTO'
					WHEN B.MATANALISTA IS NOT NULL AND B.NBRAREAUNIDADORGANIZATIVA = 'TRIBU RIESGOS BDN Y CREDITOS MINORISTAS' THEN 'CENTRALIZADO'
					ELSE 'SIN INFORMACION'
				END) = 'PUNTO DE CONTACTO'
				AND A.DESTIPESTADOSOLICITUD = 'DESACTIVADA'
				THEN 'RECHAZADO'

			-- FALLBACK
			ELSE COALESCE(B.ESTADOSOLICITUD, A.DESTIPESTADOSOLICITUD)
		END) AS ESTADO_FINAL
	FROM TP_BASE_UNION A
	LEFT JOIN TP_BASE_SOLICITUDES B ON (A.CODSOLICITUD = B.CODSOLICITUD)
),
TP_BASE AS (
	SELECT
		CODMES,
		CODSOLICITUD,
		MATANALISTA,
		NBRAREAUNIDADORGANIZATIVAANALISTA,
		MATSUPERIOR,
		NBRAREAUNIDADORGANIZATIVAVENDEDOR,
		CANAL,
		DESTIPESTADOSOLICITUD,
		TIPOPERACION,
		DESTIPOPERACION,
		PRODUCTO,
		DESPRODUCTO,
		DESCAMPANIA,
		DESTIPEVALUACIONRIESGO,
		FECSOLICITUD,
		FECHORSOLICITUD,
		FECHORINICIOEVALUACION,
		FECHORFINEVALUACION,
		FECDESEMBOLSO,
		TIEMPOATENCIONSOLICITUD,
		TIEMPODERIVACIONANALISTA,
		TIEMPOATENCIONANALISTA,
		TIEMPODESEMBOLSOPOSTATENCIONANALISTA,
		NBRMONEDA,
		DESTIPRENTA,
		SEGMENTO,
		ESTADOSOLICITUD,
		MTOSOLICITADO,
		CENTROATENCION,
		ESTADO_FINAL,
		(CASE
			WHEN ESTADO_FINAL = 'APROBADO' THEN MTOAPROBADO
			ELSE 0
		END) AS MTOAPROBADO,
		(CASE
			WHEN ESTADO_FINAL = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL THEN MTODESEMBOLSADO
			ELSE 0
		END) AS MTODESEMBOLSADO,
		(CASE
			WHEN ESTADO_FINAL = 'APROBADO' AND MTOSOLICITADO <> MTOAPROBADO THEN (MTOSOLICITADO - MTOAPROBADO)
			ELSE 0
		END) AS MTORENEGOCIADO,
		(CASE
			WHEN ESTADO_FINAL = 'RECHAZADO' THEN MTOSOLICITADO
			ELSE 0
		END) AS MTODENEGADO,
		(CASE
			WHEN ESTADO_FINAL = 'APROBADO' THEN
				CASE
					WHEN FECDESEMBOLSO IS NULL THEN MTOAPROBADO
					WHEN MTOAPROBADO > MTODESEMBOLSADO THEN MTOAPROBADO - MTODESEMBOLSADO
				ELSE 0
				END
			ELSE 0
		END) AS MTONODESEMBOLSADO
	FROM TP_BASE_PREV
),
TP_BASE_TIEMPOS AS (
	SELECT
		CODMES,
		CODSOLICITUD,
		CENTROATENCION,
		CANAL,
		MATANALISTA,
		MATSUPERIOR,
	    NBRAREAUNIDADORGANIZATIVAVENDEDOR,
	    TIPOPERACION,
	    DESTIPOPERACION,
	    PRODUCTO,
	    DESPRODUCTO,
	    DESCAMPANIA,
	    DESTIPEVALUACIONRIESGO,
	    FECSOLICITUD,
	    TIEMPOATENCIONSOLICITUD,
	    TIEMPODERIVACIONANALISTA,
	    TIEMPOATENCIONANALISTA,
	    TIEMPODESEMBOLSOPOSTATENCIONANALISTA,
	    NBRMONEDA,
	    DESTIPRENTA,
	    SEGMENTO,
	    ESTADOSOLICITUD,
	    DESTIPESTADOSOLICITUD,
--	    FLGPENDIENTEATENCION,
--	    FLGPENDIENTEEVALUACION,
--	    FLGPENDIENTEDESEMBOLSO,
	    MTOSOLICITADO,
	    MTOAPROBADO,
	    MTODESEMBOLSADO,
	    MTORENEGOCIADO,
	    MTODENEGADO,
	    MTONODESEMBOLSADO,
	    FECDESEMBOLSO,
		(CASE WHEN ESTADO_FINAL = 'APROBADO' THEN 1 ELSE 0 END) AS FLGAPROBADA,
		(CASE WHEN ESTADO_FINAL = 'RECHAZADO' THEN 1 ELSE 0 END) AS FLGDENEGADA,
		(CASE WHEN ESTADO_FINAL = 'APROBADO' AND MTOSOLICITADO <> MTOAPROBADO THEN 1 ELSE 0 END) AS FLGRENEGOCIADA,
		(CASE WHEN ESTADO_FINAL = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL THEN 1 ELSE 0 END) AS FLGDESEMBOLSADA,
				(CASE 
			WHEN ESTADO_FINAL = 'APROBADO' THEN
				(CASE
					WHEN FECDESEMBOLSO IS NULL THEN 1
					WHEN FECDESEMBOLSO IS NOT NULL AND MTOAPROBADO > MTODESEMBOLSADO THEN 1
					ELSE 0
				END)
		END) AS FLGNODESEMBOLSADA,
		(CASE
			WHEN TIEMPOATENCIONSOLICITUD IS NULL THEN 'SIN INF.'
		    WHEN TIEMPOATENCIONSOLICITUD > 0 AND TIEMPOATENCIONSOLICITUD <= 12 THEN '0h - 12h'
		    WHEN TIEMPOATENCIONSOLICITUD > 12 and TIEMPOATENCIONSOLICITUD <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETATENCIONSOLICITUD,
		(CASE
			WHEN TIEMPODERIVACIONANALISTA IS NULL THEN 'SIN INF.'
		    WHEN TIEMPODERIVACIONANALISTA > 0 and TIEMPODERIVACIONANALISTA <= 12 THEN '0h - 12h'
		    WHEN TIEMPODERIVACIONANALISTA > 12 and TIEMPODERIVACIONANALISTA <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETDERIVACIONANALISTA,
		(CASE
			WHEN TIEMPOATENCIONANALISTA IS NULL THEN 'SIN INF.'
		    WHEN TIEMPOATENCIONANALISTA > 0 AND TIEMPOATENCIONANALISTA <= 12 THEN '0h - 12h'
		    WHEN TIEMPOATENCIONANALISTA > 12 AND TIEMPOATENCIONANALISTA <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETATENCIONANALISTA,		
		(CASE
			WHEN TIEMPODESEMBOLSOPOSTATENCIONANALISTA IS NULL THEN 'SIN INF.'
		    WHEN TIEMPODESEMBOLSOPOSTATENCIONANALISTA > 0 AND TIEMPODESEMBOLSOPOSTATENCIONANALISTA <= 12 THEN '0h - 12h'
		    WHEN TIEMPODESEMBOLSOPOSTATENCIONANALISTA > 12 AND TIEMPODESEMBOLSOPOSTATENCIONANALISTA <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETDESEMBOLSOPOSTATENCIONANALISTA
	FROM TP_BASE
	WHERE CENTROATENCION IN ('CENTRALIZADO', 'PUNTO DE CONTACTO')
)
