WITH
TP_TIPOCAMBIO AS (
	SELECT 3.81 AS TC_USD_SOL
),
TP_BASESOLICITUDESPAPPS AS (
	SELECT
		CODSOLICITUD,
		MATANALISTA
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASESOLICITUDES
),
TP_BASESOLICITUDESSALESFORCE AS (
	SELECT
		CODMESEVALUACION AS CODMES,
    	CODSOLICITUD,
    	MATRICULA AS MATANALISTA,
    	ESTADOSOLICITUD,
    	DESTIPPRODUCTO AS PRODUCTO,
    	DESPRODUCTO,
    	DESTIPETAPA AS ETAPA
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_SALESFORCEBASESOLICITUDES
),
TP_ORGANICO AS (
	SELECT
		CODMES,
		MATORGANICO,
		MATSUPERIOR,
		NBRUNIDADORGANIZATIVA,
		NBRAREAUNIDADORGANIZATIVA,
		NBRSERVUNIDADORGANIZATIVA
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_ORGANICO
),
TP_COLABORADORANALISTA AS (
	SELECT
		CODMES,
    	MATORGANICO,
    	MATSUPERIOR
	FROM TP_ORGANICO
),
TP_COLABORADORVENDEDOR AS (
	SELECT
		CODMES,
		MATORGANICO,
    	NBRUNIDADORGANIZATIVA AS NBRUNIDADORGANIZATIVAVENDEDOR,
    	NBRAREAUNIDADORGANIZATIVA AS NBRAREAUNIDADORGANIZATIVAVENDEDOR,
    	NBRSERVUNIDADORGANIZATIVA AS NBRSERVUNIDADORGANIZATIVAVENDEDOR,
    	MATSUPERIOR
	FROM TP_ORGANICO
),
TP_SOLICITUDINDIVIDUO AS (
	SELECT
    	CODSOLICITUD,
    	DESSUBSEGMENTO,
    	DESTIPRENTA
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDINDIVIDUO
	WHERE DESTIPROLSOLICITUD = 'TITULAR'
),
TP_SOLICITUDCREDITOCONSUMO AS (
	SELECT
		A.CODSOLICITUD,
		A.DESTIPSOLICITUD AS TIPOPERACION,
		CAST(NULL AS STRING) AS PRODUCTO,
		A.DESPRODUCTO AS DESPRODUCTO,
		UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		A.DESTIPEVALUACIONRIESGO,
		A.CODMATRICULACOLABORADORVENDEDOR,
		A.FECSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECSOLICITUD, LPAD(A.HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECINICIOCALIF, LPAD(A.HORINICIOCALIF, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORINICIOEVALUACION,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECFINCALIF, LPAD(A.HORFINCALIF, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORFINEVALUACION,
		(CASE
			WHEN A.NBRMONEDA LIKE '%SOL%' THEN 'SOLES'
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN 'DOLARES'
			ELSE NULL
		END) AS NBRMONEDA,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOSOLICITADO * B.TC_USD_SOL
			ELSE A.MTOSOLICITADO
		END) AS MTOSOLICITADO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
		A.FECDESEMBOLSO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN
				(CASE
					WHEN A.FECDESEMBOLSO IS NOT NULL THEN A.MTOAPROBADO * B.TC_USD_SOL
					ELSE NULL 
				END)
            ELSE
            	(CASE
            		WHEN A.FECDESEMBOLSO IS NOT NULL THEN A.MTOAPROBADO 
            		ELSE NULL
            	END)
		END) AS MTODESEMBOLSADO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO A
	CROSS JOIN TP_TIPOCAMBIO B
),
TP_SOLICITUDTARJETACREDITO AS (
	SELECT
		A.CODSOLICITUD,
		(CASE
			WHEN A.DESTIPFLUJOVENTATARJETACREDITO IN ('ADICIONAL', 'AMPLIACION', 'EP', 'UPGRADE', 'BT') THEN 'TARJETA CREDITO STOCK'
			WHEN A.DESTIPFLUJOVENTATARJETACREDITO IN ('TC', 'SEGUNDA TC') THEN 'TARJETA CREDITO NUEVA'
			ELSE NULL
		END) AS TIPOPERACION,
		A.DESTIPFLUJOVENTATARJETACREDITO AS PRODUCTO,
		A.DESPRODUCTO AS DESPRODUCTO,
		UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		(CASE
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%100%%' THEN '100% APROBADO'
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%PREA%' THEN 'PREAPROBADO' -- [PREAPROBADO, PREAPROB, PREAPRO, PREAPR]
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%REACTIVO%' THEN 'REACTIVO'
			ELSE 'OTROS'
		END) AS DESTIPEVALUACIONRIESGO,
		A.CODMATRICULACOLABORADORVENDEDOR,
		A.FECSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECSOLICITUD, LPAD(A.HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECINICIOEVALUACION, LPAD(A.HORINICIOEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORINICIOEVALUACION,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECFINEVALUACION, LPAD(A.HORFINEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORFINEVALUACION,
		(CASE
			WHEN A.NBRMONEDA LIKE '%SOL%' THEN 'SOLES'
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN 'DOLARES'
			ELSE NULL
		END) AS NBRMONEDA,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOSOLICITADO * B.TC_USD_SOL
			ELSE A.MTOSOLICITADO
		END) AS MTOSOLICITADO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
		A.FECEMISIONTARJETACREDITO AS FECDESEMBOLSO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN
				(CASE
					WHEN A.FECEMISIONTARJETACREDITO IS NOT NULL THEN A.MTOAPROBADO * B.TC_USD_SOL
					ELSE NULL 
				END)
            ELSE
            	(CASE
            		WHEN A.FECEMISIONTARJETACREDITO IS NOT NULL THEN A.MTOAPROBADO 
            		ELSE NULL
            	END)
		END) AS MTODESEMBOLSADO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDTARJETACREDITO A
	CROSS JOIN TP_TIPOCAMBIO B
	WHERE A.CODTIPREGAPP IN ('0126O000001xsIYQAY','0126O000001h0WaQAI','0126O000001h0WbQAI')
),
TP_UNION AS (
	SELECT * FROM TP_SOLICITUDCREDITOCONSUMO
	UNION ALL
	SELECT * FROM TP_SOLICITUDTARJETACREDITO
),
TP_BASE AS (
	SELECT
		A.CODMES,
		COALESCE(A.CODSOLICITUD, F.CODSOLICITUD) AS CODSOLICITUD,
		COALESCE(A.MATANALISTA, F.MATANALISTA) AS MATANALISTA,
		C.MATSUPERIOR,
    	D.NBRUNIDADORGANIZATIVAVENDEDOR,
    	D.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
    	D.NBRSERVUNIDADORGANIZATIVAVENDEDOR,
		B.TIPOPERACION,
		(CASE 
			WHEN B.DESPRODUCTO IS NULL AND B.TIPOPERACION = 'CREDITO CONSUMO' THEN A.DESPRODUCTO 
			ELSE B.DESPRODUCTO
		END) AS PRODUCTO,
		B.DESPRODUCTO,
		B.DESCAMPANIA,
		B.DESTIPEVALUACIONRIESGO,
		B.FECSOLICITUD,
		ROUND(date_diff(SECOND, B.FECHORSOLICITUD, B.FECDESEMBOLSO) / 3600, 2) AS TIEMPOATENCIONSOLICITUD,
		ROUND(date_diff(SECOND, B.FECHORSOLICITUD, B.FECHORINICIOEVALUACION) / 3600, 2) AS TIEMPODERIVACIONANALISTA,
		ROUND(date_diff(SECOND, B.FECHORINICIOEVALUACION, B.FECHORFINEVALUACION) / 3600, 2) AS TIEMPOATENCIONANALISTA,
		ROUND(date_diff(SECOND, B.FECHORFINEVALUACION, B.FECDESEMBOLSO) / 3600, 2) AS TIEMPODESEMBOLSOPOSTATENCIONANALISTA,
		B.MTOSOLICITADO,
		(CASE
			WHEN A.ESTADOSOLICITUD = 'APROBADO' THEN B.MTOAPROBADO
			ELSE 0
		END) AS MTOAPROBADO,
		B.FECDESEMBOLSO,
		(CASE
			WHEN A.ESTADOSOLICITUD = 'APROBADO' AND B.FECDESEMBOLSO IS NOT NULL THEN B.MTODESEMBOLSADO
			ELSE 0
		END) AS MTODESEMBOLSADO,
		(CASE
			WHEN A.ESTADOSOLICITUD = 'APROBADO' AND B.MTOSOLICITADO <> B.MTOAPROBADO THEN (B.MTOSOLICITADO - B.MTOAPROBADO)
			ELSE 0
		END) AS MTORENEGOCIADO,
		(CASE
			WHEN A.ESTADOSOLICITUD = 'RECHAZADO' THEN B.MTOSOLICITADO
			ELSE 0
		END) AS MTODENEGADO,
		(CASE
			WHEN A.ESTADOSOLICITUD = 'APROBADO' AND B.FECDESEMBOLSO IS NULL THEN B.MTOAPROBADO
			ELSE 0
		END) AS MTONODESEMBOLSADO,
		A.ESTADOSOLICITUD,
		E.DESTIPRENTA,
		E.DESSUBSEGMENTO
	FROM TP_BASESOLICITUDESSALESFORCE A
	INNER JOIN TP_UNION B ON (A.CODSOLICITUD = B.CODSOLICITUD)
	INNER JOIN TP_COLABORADORANALISTA C ON (A.MATANALISTA = C.MATORGANICO AND A.CODMES = C.CODMES)
	LEFT JOIN TP_COLABORADORVENDEDOR D ON (B.CODMATRICULACOLABORADORVENDEDOR = D.MATORGANICO AND A.CODMES = D.CODMES)
	LEFT JOIN TP_SOLICITUDINDIVIDUO E ON (A.CODSOLICITUD = E.CODSOLICITUD)
	LEFT JOIN TP_BASESOLICITUDESPAPPS F ON (A.CODSOLICITUD = E.CODSOLICITUD)
),
TP_BASE_TIEMPOS AS (
	SELECT
		CODMES,
		CODSOLICITUD,
		MATANALISTA,
		MATSUPERIOR,
	    NBRUNIDADORGANIZATIVAVENDEDOR,
	    NBRAREAUNIDADORGANIZATIVAVENDEDOR,
	    NBRSERVUNIDADORGANIZATIVAVENDEDOR,
		TIPOPERACION,
		PRODUCTO,
		DESPRODUCTO,
		DESCAMPANIA,
		DESTIPEVALUACIONRIESGO,
		FECSOLICITUD,
		MTOSOLICITADO,
		MTOAPROBADO,
		MTODENEGADO,
		MTORENEGOCIADO,
		FECDESEMBOLSO,
		MTODESEMBOLSADO,
		MTONODESEMBOLSADO,
		ESTADOSOLICITUD,
		DESTIPRENTA,
		DESSUBSEGMENTO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' THEN 1 ELSE 0 END) AS FLGAPROBADA,
		(CASE WHEN ESTADOSOLICITUD = 'RECHAZADO' THEN 1 ELSE 0 END) AS FLGDENEGADA,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOSOLICITADO <> MTOAPROBADO THEN 1 ELSE 0 END) AS FLGRENEGOCIADA,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL THEN 1 ELSE 0 END) AS FLGDESEMBOLSADA,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NULL THEN 1 ELSE 0 END) AS FLGNODESEMBOLSADA,
		(CASE
			WHEN TIEMPOATENCIONSOLICITUD IS NULL THEN 'SIN INF.'
		    WHEN TIEMPOATENCIONSOLICITUD <= 6 THEN '<= 6h'
		    WHEN TIEMPOATENCIONSOLICITUD <= 12 THEN '<= 12h'
		    WHEN TIEMPOATENCIONSOLICITUD <= 24 THEN '<= 24h'
	    	ELSE '> 24h'
		END) AS BRACKETATENCIONSOLICITUD,
		(CASE
			WHEN TIEMPODERIVACIONANALISTA IS NULL THEN 'SIN INF.'
		    WHEN TIEMPODERIVACIONANALISTA <= 6 THEN '<= 6h'
		    WHEN TIEMPODERIVACIONANALISTA <= 12 THEN '<= 12h'
		    WHEN TIEMPODERIVACIONANALISTA <= 24 THEN '<= 24h'
	    	ELSE '> 24h'
		END) AS BRACKETDERIVACIONANALISTA,
		(CASE
			WHEN TIEMPOATENCIONANALISTA IS NULL THEN 'SIN INF.'
		    WHEN TIEMPOATENCIONANALISTA <= 6 THEN '<= 6h'
		    WHEN TIEMPOATENCIONANALISTA <= 12 THEN '<= 12h'
		    WHEN TIEMPOATENCIONANALISTA <= 24 THEN '<= 24h'
	    	ELSE '> 24h'
		END) AS BRACKETATENCIONANALISTA,		
		(CASE
			WHEN TIEMPODESEMBOLSOPOSTATENCIONANALISTA IS NULL THEN 'SIN INF.'
		    WHEN TIEMPODESEMBOLSOPOSTATENCIONANALISTA <= 6 THEN '<= 6h'
		    WHEN TIEMPODESEMBOLSOPOSTATENCIONANALISTA <= 12 THEN '<= 12h'
		    WHEN TIEMPODESEMBOLSOPOSTATENCIONANALISTA <= 24 THEN '<= 24h'
	    	ELSE '> 24h'
		END) AS BRACKETDESEMBOLSOPOSTATENCIONANALISTA
	FROM TP_BASE
)
SELECT
	CODMES,
	MATANALISTA,
	MATSUPERIOR,
    NBRUNIDADORGANIZATIVAVENDEDOR,
    NBRAREAUNIDADORGANIZATIVAVENDEDOR,
    NBRSERVUNIDADORGANIZATIVAVENDEDOR,
	COUNT(CODSOLICITUD) AS CTDSOLICITUDES,
	SUM(FLGAPROBADA) AS CTDSOLICITUDESAPROBADAS,
	SUM(FLGDENEGADA) AS CTDSOLICITUDESDENEGADAS,
	SUM(FLGRENEGOCIADA) AS CTDSOLICITUDESRENEGOCIADAS,
	SUM(FLGDESEMBOLSADA) AS CTDSOLICITUDESDESEMBOLSADAS,
	SUM(FLGNODESEMBOLSADA) AS CTDSOLICITUDESNODESEMBOLSADAS,
	TIPOPERACION,
	PRODUCTO,
	DESPRODUCTO,
	DESCAMPANIA,
	DESTIPEVALUACIONRIESGO,
	FECSOLICITUD,
	SUM(MTOSOLICITADO) AS MTOSOLICITADO,
	SUM(MTOAPROBADO) AS MTOAPROBADO,
	SUM(MTODENEGADO) AS MTODENEGADO,
	SUM(MTORENEGOCIADO) AS MTORENEGOCIADO,
	FECDESEMBOLSO,
	SUM(MTODESEMBOLSADO) AS MTODESEMBOLSADO,
	SUM(MTONODESEMBOLSADO) AS MTONODESEMBOLSADO,
	ESTADOSOLICITUD,
	DESTIPRENTA,
	DESSUBSEGMENTO,
	BRACKETATENCIONSOLICITUD,
	BRACKETDERIVACIONANALISTA,
	BRACKETATENCIONANALISTA,
	BRACKETDESEMBOLSOPOSTATENCIONANALISTA
FROM TP_BASE_TIEMPOS
GROUP BY 
	CODMES, MATANALISTA, MATSUPERIOR, NBRUNIDADORGANIZATIVAVENDEDOR, NBRAREAUNIDADORGANIZATIVAVENDEDOR,
	NBRSERVUNIDADORGANIZATIVAVENDEDOR, TIPOPERACION, PRODUCTO, DESPRODUCTO, DESCAMPANIA, DESTIPEVALUACIONRIESGO, 
	FECSOLICITUD, FECDESEMBOLSO, ESTADOSOLICITUD, DESTIPRENTA, DESSUBSEGMENTO, BRACKETATENCIONSOLICITUD, BRACKETDERIVACIONANALISTA, 
	BRACKETDESEMBOLSOPOSTATENCIONANALISTA, BRACKETATENCIONANALISTA;
