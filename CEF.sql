WITH SOL AS (
  SELECT
    A.CODMESEVALUACION,
    A.FECSOLICITUDEVALUACION,
    A.FECEVALUACION,
    A.DESCANALVENTARBMPER,
    A.TIPPRODUCTOSOLICITUDRBM,
    A.DESCANALVENTASOLICITUDRBM,
    A.DESTIPDECISIONRESULTADORBM,
    TRIM(regexp_replace(A.CODINTERNOCOMPUTACIONAL, '[\\n\\r\\t]', '')) AS CODINTERNOCOMPUTACIONAL,
    A.DESTIPDECISIONRESULTADOPRIORIZACION,
    A.DESCAMPANIASOLICITUD,
    A.DESTIPEVALUACIONSOLICITUDCREDITO,
    A.CODIDEVALUACION,
    A.CODEVALUACIONSOLICITUD,
    A.CODSECUENCIALDECISIONRBM,
    A.NUMSOLICITUDEVALUACION,

    CASE
      WHEN A.DESCANALVENTARBMPER = 'SALEFORCE' THEN SUBSTR(TRIM(A.NUMSOLICITUDEVALUACION), 5, 7)
      WHEN A.DESCANALVENTARBMPER = 'LOANS'     THEN SUBSTR(TRIM(A.NUMSOLICITUDEVALUACION), 3, 8)
      ELSE TRIM(A.NUMSOLICITUDEVALUACION)
    END AS NUMSOLICITUDEVALUACIONCORTO,

    B.CODCLAVEPARTYCLI,

    CASE
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO IN ('Regular LD','Cuotealo')
        AND A.DESCAMPANIASOLICITUD IN ('100% Aprobado','Pre-Aprobado') THEN 'LD APR'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO IN ('Regular LD','Cuotealo')
        AND A.DESCAMPANIASOLICITUD = 'CEF Shield' THEN 'LD SHD'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'Regular LD'
        AND A.DESCAMPANIASOLICITUD = 'Convenio' THEN 'LD CONV'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'Regular LD'
        AND A.DESCAMPANIASOLICITUD = 'Invitado' THEN 'LD INV'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'Compra de Deuda'
        AND A.DESCAMPANIASOLICITUD IN ('100% Aprobado','Pre-Aprobado') THEN 'CDD APR'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'Compra de Deuda'
        AND A.DESCAMPANIASOLICITUD = 'Convenio' THEN 'CDD CONV'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'LD + Consolidación'
        AND A.DESCAMPANIASOLICITUD IN ('100% Aprobado','Pre-Aprobado') THEN 'REE APR'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'LD + Consolidación'
        AND A.DESCAMPANIASOLICITUD = 'Convenio' THEN 'REE CONV'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'LD + Compra de Deuda + Consolidación'
        AND A.DESCAMPANIASOLICITUD IN ('100% Aprobado','Pre-Aprobado') THEN 'CONS APR'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'LD + Compra de Deuda + Consolidación'
        AND A.DESCAMPANIASOLICITUD = 'Convenio' THEN 'CONS CONV'
      ELSE 'REACTIVO'
    END AS LEAD_CEF_SOL

  FROM CATALOG_LHCL_PROD_BCP.BCP_DDV_RBMRBMPER_MODELOGESTION_VU.MD_EVALUACIONSOLICITUDCREDITO A
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_CLIENTE B
    ON TRIM(regexp_replace(A.CODINTERNOCOMPUTACIONAL, '[\\n\\r\\t]', '')) = TRIM(B.CODINTERNOCOMPUTACIONAL)
  WHERE A.TIPPRODUCTOSOLICITUDRBM = 'CC'
    AND A.DESCANALVENTARBMPER NOT IN ('YAPE','OTROS')
    AND A.DESTIPDECISIONRESULTADORBM IN ('Approve','Decline','Investigate')
    AND A.CODINTERNOCOMPUTACIONAL IS NOT NULL
    AND TRIM(regexp_replace(A.CODINTERNOCOMPUTACIONAL, '[\\n\\r\\t]', '')) <> ''
),

SOL_NORM AS (
  SELECT
    s.*,
    CASE WHEN s.CODEVALUACIONSOLICITUD LIKE 'OP-%' THEN 1 ELSE 0 END AS FLG_OP_PREFIX,
    COALESCE(CAST(NULLIF(regexp_extract(s.CODEVALUACIONSOLICITUD,'([0-9]+)',1),'') AS BIGINT),-1) AS CODEVAL_NUM
  FROM SOL s
),

SOL_ORD AS (
  SELECT
    n.*,
    ROW_NUMBER() OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS RN_SOL,

    LAG(n.FECSOLICITUDEVALUACION) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS PREV_FECSOL,

    LAG(n.FLG_OP_PREFIX) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS PREV_FLG_OP,

    LAG(n.CODEVAL_NUM) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS PREV_CODEVAL_NUM,

    LAG(n.CODEVALUACIONSOLICITUD) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS PREV_CODEVAL_TXT
  FROM SOL_NORM n
),

SOL_REING AS (
  SELECT
    o.*,
    CASE
      WHEN o.PREV_FECSOL IS NULL THEN 0
      WHEN (
        o.FECSOLICITUDEVALUACION > o.PREV_FECSOL
        OR (
          o.FECSOLICITUDEVALUACION = o.PREV_FECSOL
          AND (
            o.FLG_OP_PREFIX > o.PREV_FLG_OP
            OR (o.FLG_OP_PREFIX = o.PREV_FLG_OP AND o.CODEVAL_NUM > o.PREV_CODEVAL_NUM)
            OR (o.FLG_OP_PREFIX = o.PREV_FLG_OP AND o.CODEVAL_NUM = o.PREV_CODEVAL_NUM AND o.CODEVALUACIONSOLICITUD > o.PREV_CODEVAL_TXT)
          )
        )
      )
      AND o.FECSOLICITUDEVALUACION <= add_months(o.PREV_FECSOL,1)
      THEN 1 ELSE 0
    END AS FLG_REINGRESO_1M
  FROM SOL_ORD o
),

VENTA AS (
  SELECT
    CAST(date_format(FECAPERTURA,'yyyyMM') AS INT) AS CODMESAPERTURA,
    CODSOLICITUD,
    CASE
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2) IN ('CX','DX') THEN SUBSTR(TRIM(CODSOLICITUD),3,8)
      WHEN CODSOLICITUD LIKE '2________' THEN SUBSTR(TRIM(CODSOLICITUD),3,7)
      WHEN CODSOLICITUD LIKE '      2________' THEN SUBSTR(TRIM(CODSOLICITUD),3,7)
      WHEN CODSOLICITUD LIKE 'O%' THEN SUBSTR(TRIM(CODSOLICITUD),3,7)
      ELSE TRIM(CODSOLICITUD)
    END AS CODSOLICITUDCORTO,
    CASE
      WHEN CODPRODUCTO='CPEFIA' THEN 'CUOTEALO'
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2)='PE' THEN 'CUOTEALO'
      WHEN CODPRODUCTO='CPEYAP' THEN 'YAPE'
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2)='YP' THEN 'YAPE'
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2)='JB' THEN 'BANCA MÓVIL'
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2) IN ('CX','DX') THEN 'LOANS'
      WHEN CODSOLICITUD LIKE '2________' THEN 'SALEFORCE'
      WHEN CODSOLICITUD LIKE '      2________' THEN 'SALEFORCE'
      WHEN CODSOLICITUD LIKE 'O%' THEN 'SALEFORCE'
      ELSE 'OTROS'
    END AS CANAL_MDPREST,
    FECAPERTURA,
    FECDESEMBOLSO,
    MTOORIGINALCREDITO,
    MTODESEMBOLSADO,
    CODCLAVEPARTYCLI
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_CUENTACREDITOPERSONAL
  WHERE CODPRODUCTO IN ('CPEEFM','CPECMC','CPEDPP','CPECEM','CPEECV','CPEGEN','CPEADH','CPEFIA')
    AND FLGREGELIMINADOFUENTE='N'
),

MATCH_ONE AS (
  SELECT *
  FROM (
    SELECT
      s.*,
      v.CODMESAPERTURA,
      v.CODSOLICITUD,
      v.CANAL_MDPREST,
      v.FECAPERTURA,
      v.MTOORIGINALCREDITO,
      v.MTODESEMBOLSADO,
      ROW_NUMBER() OVER (
        PARTITION BY s.CODINTERNOCOMPUTACIONAL, s.CODIDEVALUACION, s.CODEVALUACIONSOLICITUD
        ORDER BY ABS(datediff(v.FECAPERTURA,s.FECSOLICITUDEVALUACION)), v.FECAPERTURA
      ) AS RN_MATCH
    FROM SOL_REING s
    LEFT JOIN VENTA v
      ON s.CODCLAVEPARTYCLI = v.CODCLAVEPARTYCLI
     AND s.DESCANALVENTARBMPER = v.CANAL_MDPREST
     AND TRIM(s.NUMSOLICITUDEVALUACIONCORTO) = TRIM(v.CODSOLICITUDCORTO)
     AND datediff(v.FECAPERTURA,s.FECSOLICITUDEVALUACION) BETWEEN 0 AND 40
  ) x
  WHERE RN_MATCH = 1
),

BASE_FLAGS AS (
  SELECT
    m.CODEVALUACIONSOLICITUD,
    m.CODINTERNOCOMPUTACIONAL,
    m.CODCLAVEPARTYCLI,
    m.CODMESEVALUACION AS CODMESSOLICITUDEVALUACION,
    m.FECSOLICITUDEVALUACION,
    m.DESCANALVENTARBMPER AS DESCANALVENTARBM,
    m.DESTIPDECISIONRESULTADORBM,
    m.DESCAMPANIASOLICITUD,
    m.DESTIPEVALUACIONSOLICITUDCREDITO,
    m.CANAL_MDPREST,
    m.FLG_REINGRESO_1M,
    m.LEAD_CEF_SOL,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' THEN 1 ELSE 0 END AS FLG_APROBADO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM IN ('Decline','Investigate') THEN 1 ELSE 0 END AS FLG_DENEGADO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM IN ('Decline','Investigate') AND m.FLG_REINGRESO_1M = 1 THEN 1 ELSE 0 END AS FLG_DENEGADO_CON_REINGRESO_1M,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM IN ('Decline','Investigate') AND m.FLG_REINGRESO_1M = 0 THEN 1 ELSE 0 END AS FLG_DENEGADO_SIN_REINGRESO_1M,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FECAPERTURA IS NOT NULL THEN 1 ELSE 0 END AS FLG_DESEMBOLSADO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FECAPERTURA IS NULL THEN 1 ELSE 0 END AS FLG_NODESEMBOLSADO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FLG_REINGRESO_1M = 1 AND m.FECAPERTURA IS NOT NULL THEN 1 ELSE 0 END AS FLG_APROBADO_CON_REINGRESO_1M_CON_DESEMBOLSO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FLG_REINGRESO_1M = 1 AND m.FECAPERTURA IS NULL THEN 1 ELSE 0 END AS FLG_APROBADO_CON_REINGRESO_1M_SIN_DESEMBOLSO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FLG_REINGRESO_1M = 0 AND m.FECAPERTURA IS NULL THEN 1 ELSE 0 END AS FLG_APROBADO_SIN_REINGRESO_SIN_DESEMBOLSO
  FROM MATCH_ONE m
),

HM_LEADS_BDI_BASE AS (
  SELECT
    CODLOTEOFERTA,
    TRIM(CODINTERNOCOMPUTACIONAL) AS CODINTERNOCOMPUTACIONAL,
    TIPVENTA,
    TIPOFERTA,
    CODCONDICIONCLIENTE,
    FECINICIOVIGENCIA,
    CASE
      WHEN TIPVENTA = 6   AND TIPOFERTA = 3  AND CODCONDICIONCLIENTE IN ('APR','PRE') THEN 1
      WHEN TIPVENTA = 6   AND TIPOFERTA = 3  AND CODCONDICIONCLIENTE = 'OPT' THEN 2
      WHEN TIPVENTA = 6   AND TIPOFERTA = 41 AND CODCONDICIONCLIENTE IN ('APR','PRE') THEN 3
      WHEN TIPVENTA = 6   AND TIPOFERTA = 38 AND CODCONDICIONCLIENTE IN ('APR','PRE') THEN 4
      WHEN TIPVENTA = 6   AND TIPOFERTA IN (89,98) THEN 5
      WHEN TIPVENTA = 6   AND TIPOFERTA = 3  AND CODCONDICIONCLIENTE = 'INV' THEN 6
      WHEN TIPVENTA = 6   AND TIPOFERTA = 187 THEN 7
      WHEN TIPVENTA = 110 AND TIPOFERTA = 3 THEN 8
      WHEN TIPVENTA = 110 AND TIPOFERTA = 41 THEN 9
      WHEN TIPVENTA = 110 AND TIPOFERTA = 38 THEN 10
      ELSE 11
    END AS PRIORIDADLEAD,
    CASE
      WHEN TIPVENTA = 6   AND TIPOFERTA = 3  AND CODCONDICIONCLIENTE IN ('APR','PRE') THEN 'LD APR'
      WHEN TIPVENTA = 6   AND TIPOFERTA = 3  AND CODCONDICIONCLIENTE = 'OPT' THEN 'LD OPT'
      WHEN TIPVENTA = 6   AND TIPOFERTA = 41 AND CODCONDICIONCLIENTE IN ('APR','PRE') THEN 'CDD APR'
      WHEN TIPVENTA = 6   AND TIPOFERTA = 38 AND CODCONDICIONCLIENTE IN ('APR','PRE') THEN 'REE APR'
      WHEN TIPVENTA = 6   AND TIPOFERTA IN (89,98) THEN 'LD SHD'
      WHEN TIPVENTA = 6   AND TIPOFERTA = 3  AND CODCONDICIONCLIENTE = 'INV' THEN 'LD INV'
      WHEN TIPVENTA = 6   AND TIPOFERTA = 187 THEN 'CDD INS'
      WHEN TIPVENTA = 110 AND TIPOFERTA = 3 THEN 'LD CONV'
      WHEN TIPVENTA = 110 AND TIPOFERTA = 41 THEN 'CDD CONV'
      WHEN TIPVENTA = 110 AND TIPOFERTA = 38 THEN 'REE CONV'
      ELSE 'OTRO'
    END AS LEAD_CEF
  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.HM_LEADS_BDI
  WHERE CODPAUTARBM <> 41
    AND TIPVENTA IN (6,110)
    AND DESCAMPANA NOT IN ('CREDITO PERSONAL, VENTA AMPLIACION PLAZO', 'VENTA SKIP')
    AND CODLOTEOFERTA BETWEEN 202501 AND 202512
),

LEADS_UNICOS AS (
  SELECT *
  FROM HM_LEADS_BDI_BASE
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY CODLOTEOFERTA, CODINTERNOCOMPUTACIONAL
    ORDER BY PRIORIDADLEAD ASC, FECINICIOVIGENCIA ASC
  ) = 1
),

BASE_FLAGS_LEAD AS (
  SELECT
    b.*,
    CASE
      WHEN b.LEAD_CEF_SOL IN ('REACTIVO','CONS APR','CONS CONV')
        THEN CASE WHEN c.CODINTERNOCOMPUTACIONAL IS NOT NULL THEN 1 ELSE 0 END
      ELSE CASE WHEN (m.CODINTERNOCOMPUTACIONAL IS NOT NULL OR c.CODINTERNOCOMPUTACIONAL IS NOT NULL) THEN 1 ELSE 0 END
    END AS FLG_CON_LEAD,
    CASE
      WHEN (
        CASE
          WHEN b.LEAD_CEF_SOL IN ('REACTIVO','CONS APR','CONS CONV')
            THEN CASE WHEN c.CODINTERNOCOMPUTACIONAL IS NOT NULL THEN 1 ELSE 0 END
          ELSE CASE WHEN (m.CODINTERNOCOMPUTACIONAL IS NOT NULL OR c.CODINTERNOCOMPUTACIONAL IS NOT NULL) THEN 1 ELSE 0 END
        END
      ) = 1 THEN 'CON_LEAD' ELSE 'SIN_LEAD'
    END AS TIPO_LEAD
  FROM BASE_FLAGS b
  LEFT JOIN LEADS_UNICOS m
    ON m.CODLOTEOFERTA = b.CODMESSOLICITUDEVALUACION
   AND TRIM(m.CODINTERNOCOMPUTACIONAL) = TRIM(b.CODINTERNOCOMPUTACIONAL)
   AND m.LEAD_CEF = b.LEAD_CEF_SOL
  LEFT JOIN LEADS_UNICOS c
    ON c.CODLOTEOFERTA = b.CODMESSOLICITUDEVALUACION
   AND TRIM(c.CODINTERNOCOMPUTACIONAL) = TRIM(b.CODINTERNOCOMPUTACIONAL)
),

SBS_DEUDA AS (
  SELECT
    CAST(date_format(FECDIA,'yyyyMM') AS INT) AS CODMESDEUDA,
    CODCLAVEPARTYCLI,
    SUM(MTODEUDASOL) AS MTODEUDASOL_SISTEMA,
    MAX(
      CASE
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) = 'NORMAL' THEN 1
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('CON PROBLEMAS POTENCIALES(CPP)','CPP','CON PROBLEMAS POTENCIALES (CPP)') THEN 2
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) = 'DEFICIENTE' THEN 3
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) = 'DUDOSO' THEN 4
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('PERDIDA','PÉRDIDA') THEN 5
        ELSE 0
      END
    ) AS RIESGO_PEOR_ORD
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_DEUDORSBSDETALLE
  WHERE CAST(date_format(FECDIA,'yyyyMM') AS INT) BETWEEN 202412 AND 202512
    AND UPPER(TRIM(NBREMPSISTEMAFINANCIERO)) NOT LIKE 'BANCO DE CREDITO DEL PER%'
  GROUP BY CAST(date_format(FECDIA,'yyyyMM') AS INT), CODCLAVEPARTYCLI
),

BASE_MESREF AS (
  SELECT
    b.*,
    CAST(date_format(add_months(to_date(concat(CAST(b.CODMESSOLICITUDEVALUACION AS STRING),'01'),'yyyyMMdd'),-1),'yyyyMM') AS INT) AS CODMES_SBS_MENOS_1,
    b.CODMESSOLICITUDEVALUACION AS CODMES_SBS_MES
  FROM BASE_FLAGS_LEAD b
),

BASE_SBS AS (
  SELECT
    x.*,
    COALESCE(s1.MTODEUDASOL_SISTEMA,0) AS MTO_DEUDA_SBS_MES_MENOS_1,
    COALESCE(s2.MTODEUDASOL_SISTEMA,0) AS MTO_DEUDA_SBS_MES,
    COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) AS DELTA_DEUDA_SBS,
    CASE WHEN COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) > 0 THEN 1 ELSE 0 END AS FLG_AUMENTO_DEUDA_SBS,
    CASE WHEN COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) > 0
         THEN COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) ELSE 0 END AS MTO_AUMENTO_DEUDA_SBS,
    CASE WHEN (COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0)) > 100 THEN 1 ELSE 0 END AS FLG_AUMENTO_DEUDA_SBS_REGLA,
    CASE WHEN (COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0)) > 100
         THEN (COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0)) ELSE 0 END AS MTO_AUMENTO_DEUDA_SBS_REGLA,
    CASE COALESCE(s2.RIESGO_PEOR_ORD,0)
      WHEN 1 THEN 'NORMAL'
      WHEN 2 THEN 'CON PROBLEMAS POTENCIALES(CPP)'
      WHEN 3 THEN 'DEFICIENTE'
      WHEN 4 THEN 'DUDOSO'
      WHEN 5 THEN 'PERDIDA'
      ELSE 'SIN INFO'
    END AS DESTIPCLASIFRIESGO_PEOR,
    COALESCE(s2.RIESGO_PEOR_ORD,0) AS DESTIPCLASIFRIESGO_PEOR_ORD
  FROM BASE_MESREF x
  LEFT JOIN SBS_DEUDA s1
    ON x.CODCLAVEPARTYCLI = s1.CODCLAVEPARTYCLI
   AND x.CODMES_SBS_MENOS_1 = s1.CODMESDEUDA
  LEFT JOIN SBS_DEUDA s2
    ON x.CODCLAVEPARTYCLI = s2.CODCLAVEPARTYCLI
   AND x.CODMES_SBS_MES = s2.CODMESDEUDA
)

SELECT
  CODMESSOLICITUDEVALUACION,
  DESCANALVENTARBM,
  DESTIPCLASIFRIESGO_PEOR,
  DESTIPCLASIFRIESGO_PEOR_ORD,
  TIPO_LEAD,
  COUNT(*) AS N_SOLICITUDES,
  SUM(FLG_APROBADO) AS CTDSOLICITUDESAPROBADAS,
  SUM(FLG_DENEGADO) AS CTDSOLICITUDESDENEGADAS,
  SUM(FLG_REINGRESO_1M) AS CTDSOLICITUDESREINGRESADAS,
  SUM(FLG_DESEMBOLSADO) AS CTDSOLICITUDESDESEMBOLSADAS,
  SUM(FLG_NODESEMBOLSADO) AS CTDSOLICITUDESNODESEMBOLSADAS,
  SUM(FLG_APROBADO_CON_REINGRESO_1M_CON_DESEMBOLSO) AS CTDSOLICITUDESAPROBADASDESEMBOLSADASREINGRESO,
  SUM(FLG_APROBADO_CON_REINGRESO_1M_SIN_DESEMBOLSO) AS CTDSOLICITUDESAPROBADASNODESEMBOLSADASREINGRESO,
  SUM(FLG_APROBADO_SIN_REINGRESO_SIN_DESEMBOLSO) AS CTDSOLICITUDESAPROBADASNODESEMBOLSADASSINREINGRESO,
  SUM(FLG_AUMENTO_DEUDA_SBS_REGLA) AS CTDSOLICITUDESAUMENTARONDEUDASBS,
  SUM(CASE WHEN FLG_DENEGADO = 1 AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1 THEN 1 ELSE 0 END) AS CTDSOLICITUDESDENEGADASAUMENTARONDEUDASBS,
  SUM(CASE WHEN FLG_NODESEMBOLSADO = 1 AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1 THEN 1 ELSE 0 END) AS CTDSOLICITUDESNODESEMBOLSADASAUMENTARONDEUDASBS,
  SUM(CASE WHEN FLG_NODESEMBOLSADO = 1 AND FLG_AUMENTO_DEUDA_SBS_REGLA = 0 THEN 1 ELSE 0 END) AS CTDSOLICITUDESNODESEMBOLSADASNOAUMENTARONDEUDASBS
FROM BASE_SBS
WHERE CODMESSOLICITUDEVALUACION BETWEEN 202501 AND 202512
  AND DESCANALVENTARBM NOT IN ('SALEFORCE')
GROUP BY
  CODMESSOLICITUDEVALUACION,
  DESCANALVENTARBM,
  DESTIPCLASIFRIESGO_PEOR,
  DESTIPCLASIFRIESGO_PEOR_ORD,
  TIPO_LEAD
ORDER BY
  CODMESSOLICITUDEVALUACION,
  DESCANALVENTARBM,
  DESTIPCLASIFRIESGO_PEOR_ORD,
  TIPO_LEAD;
