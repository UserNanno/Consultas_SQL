LIBNAME dtbrcks ODBC DSN="RBMNEG_SQLW" AUTHDOMAIN="DatabricksAuth" DBMAX_TEXT=128;

PROC SQL NOPRINT;
    CONNECT USING dtbrcks;

    CREATE TABLE TEST_WEEKLY AS
    SELECT *
    FROM connection to dtbrcks (
        SELECT *
        FROM CATALOG_LHCL_PROD_BCP_EXPL.BCP_EDV_RBMBDN.T72496_UNIONWEEKLY
    );

    DISCONNECT FROM dtbrcks;
QUIT;




PROC IMPORT DATAFILE="/sasdata01/RBM_NEG_DESA_01/T72496/ANALISTAS.csv"
    OUT=ANALISTAS
    DBMS=CSV
    REPLACE;
    GETNAMES=YES;
    GUESSINGROWS=MAX;
RUN;




PROC SQL;
    CREATE TABLE TEST_WEEKLY_ENRICH AS
    SELECT
        a.*,
        CASE 
            WHEN a.CENTROATENCION = 'CENTRALIZADO' THEN b.NOMBRECORTO
            ELSE ""
        END AS NOMBRECORTO LENGTH=50
    FROM TEST_WEEKLY AS a
    LEFT JOIN ANALISTAS AS b
        ON a.CODMES      = b.CODMES
        AND a.MATANALISTA = b.MATANALISTA;
QUIT;




PROC EXPORT DATA=TEST_WEEKLY_ENRICH
    OUTFILE="/sasdata01/RBM_NEG_DESA_01/T72496/WEEKLY_FINAL.csv"
    DBMS=CSV
    REPLACE;
RUN;
