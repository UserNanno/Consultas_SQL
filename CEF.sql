TP_BASE AS (
	SELECT
		A.CODMES,
		A.CODSOLICITUD,
		B.MATANALISTA,
		B.NBRAREAUNIDADORGANIZATIVA AS NBRAREAUNIDADORGANIZATIVAANALISTA,
		B.MATSUPERIOR,
		A.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
		...
		(AquÃ­ va tu CASE de CENTROATENCION) AS CENTROATENCION,
		
		-- ðŸ‘‡ NUEVO CAMPO
		CASE
			-- Para CENTRALIZADO, manda ESTADOSOLICITUD (analista/SF)
			WHEN 
				(CASE
					WHEN 
						A.NBRAREAUNIDADORGANIZATIVAVENDEDOR IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1', 'GCIA DE AREA BANCA AFLUENTE', 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS') 
						AND B.MATANALISTA IS NULL 
						AND A.DESTIPESTADOSOLICITUD IN ('DESACTIVADA', 'ACEPTADA') THEN 'PUNTO DE CONTACTO'
					WHEN B.MATANALISTA IS NOT NULL AND B.NBRAREAUNIDADORGANIZATIVA = 'TRIBU RIESGOS BDN Y CREDITOS MINORISTAS' THEN 'CENTRALIZADO'
					ELSE 'SIN INFORMACION'
				END) = 'CENTRALIZADO'
				THEN B.ESTADOSOLICITUD

			-- Para PUNTO DE CONTACTO, mapeas DESTIPESTADOSOLICITUD a APROBADO/RECHAZADO
			WHEN 
				(CASE
					WHEN 
						A.NBRAREAUNIDADORGANIZATIVAVENDEDOR IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1', 'GCIA DE AREA BANCA AFLUENTE', 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS') 
						AND B.MATANALISTA IS NULL 
						AND A.DESTIPESTADOSOLICITUD IN ('DESACTIVADA', 'ACEPTADA') THEN 'PUNTO DE CONTACTO'
					WHEN B.MATANALISTA IS NOT NULL AND B.NBRAREAUNIDADORGANIZATIVA = 'TRIBU RIESGOS BDN Y CREDITOS MINORISTAS' THEN 'CENTRALIZADO'
					ELSE 'SIN INFORMACION'
				END) = 'PUNTO DE CONTACTO'
				AND A.DESTIPESTADOSOLICITUD = 'ACEPTADA'
				THEN 'APROBADO'

			WHEN 
				(CASE
					WHEN 
						A.NBRAREAUNIDADORGANIZATIVAVENDEDOR IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1', 'GCIA DE AREA BANCA AFLUENTE', 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS') 
						AND B.MATANALISTA IS NULL 
						AND A.DESTIPESTADOSOLICITUD IN ('DESACTIVADA', 'ACEPTADA') THEN 'PUNTO DE CONTACTO'
					WHEN B.MATANALISTA IS NOT NULL AND B.NBRAREAUNIDADORGANIZATIVA = 'TRIBU RIESGOS BDN Y CREDITOS MINORISTAS' THEN 'CENTRALIZADO'
					ELSE 'SIN INFORMACION'
				END) = 'PUNTO DE CONTACTO'
				AND A.DESTIPESTADOSOLICITUD = 'DESACTIVADA'
				THEN 'RECHAZADO'

			-- fallback por si acaso
			ELSE COALESCE(B.ESTADOSOLICITUD, A.DESTIPESTADOSOLICITUD)
		END AS ESTADO_FINAL















	(CASE
    WHEN ESTADO_FINAL = 'APROBADO' THEN A.MTOAPROBADO
    ELSE 0
END) AS MTOAPROBADO,

(CASE
    WHEN ESTADO_FINAL = 'APROBADO' AND A.FECDESEMBOLSO IS NOT NULL THEN A.MTODESEMBOLSADO
    ELSE 0
END) AS MTODESEMBOLSADO,

(CASE
    WHEN ESTADO_FINAL = 'APROBADO' AND A.MTOSOLICITADO <> A.MTOAPROBADO 
        THEN (A.MTOSOLICITADO - A.MTOAPROBADO)
    ELSE 0
END) AS MTORENEGOCIADO,

(CASE
    WHEN ESTADO_FINAL = 'RECHAZADO' THEN A.MTOSOLICITADO
    ELSE 0
END) AS MTODENEGADO,

(CASE
    WHEN ESTADO_FINAL = 'APROBADO' THEN
        (CASE
            WHEN A.FECDESEMBOLSO IS NULL THEN A.MTOAPROBADO
            WHEN A.MTOAPROBADO > A.MTODESEMBOLSADO THEN A.MTOAPROBADO - A.MTODESEMBOLSADO
            ELSE 0
        END)
    ELSE 0
END) AS MTONODESEMBOLSADO,


















(CASE WHEN ESTADO_FINAL = 'APROBADO' THEN 1 ELSE 0 END) AS FLGAPROBADA,
(CASE WHEN ESTADO_FINAL = 'RECHAZADO' THEN 1 ELSE 0 END) AS FLGDENEGADA,
(CASE WHEN ESTADO_FINAL = 'APROBADO' AND MTOSOLICITADO <> MTOAPROBADO THEN 1 ELSE 0 END) AS FLGRENEGOCIADA,
(CASE WHEN ESTADO_FINAL = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL THEN 1 ELSE 0 END) AS FLGDESEMBOLSADA,
(CASE 
    WHEN ESTADO_FINAL = 'APROBADO' THEN
        (CASE
            WHEN FECDESEMBOLSO IS NULL THEN 1
            WHEN FECDESEMBOLSO IS NOT NULL AND MTOAPROBADO > MTODESEMBOLSADO THEN 1
            ELSE 0
        END)
END) AS FLGNODESEMBOLSADA,

