WITH
/* =========================================================
   1) Reusa tu pipeline hasta BASE_FLAGS_LEAD (como lo tienes)
   - BASE_FLAGS_LEAD debe tener:
     CODMESSOLICITUDEVALUACION, DESCANALVENTARBM, CODCLAVEPARTYCLI,
     TIPO_LEAD ('CON_LEAD'/'SIN_LEAD'),
     FLG_DENEGADO, FLG_NODESEMBOLSADO (y los que necesites)
   ========================================================= */

CLIENTE_MES_UNIV AS (
  SELECT
    CODMESSOLICITUDEVALUACION AS CODMES,
    DESCANALVENTARBM,
    CODCLAVEPARTYCLI,
    TIPO_LEAD,

    -- Universos cliente-mes (flags)
    MAX(FLG_DENEGADO)       AS FLG_TUVO_DENEGADO,
    MAX(FLG_NODESEMBOLSADO) AS FLG_TUVO_APR_SIN_DESEMBOLSO

  FROM BASE_FLAGS_LEAD
  WHERE CAST(date_format(FECDIA,'yyyyMM') AS INT) BETWEEN 202412 AND 202512
    AND UPPER(TRIM(NBREMPSISTEMAFINANCIERO)) NOT LIKE 'BANCO DE CREDITO DEL PER%'
    AND UPPER(TRIM(DESCTACONTABLESBS)) NOT LIKE '%TARJET%'
    AND DESTIPCREDITO IN ('CREDITO DE CONSUMO NO REVOLVENTE','CREDITO HIPOTECARIOS PARA VIVIENDA')
  GROUP BY
    CODMESSOLICITUDEVALUACION,
    DESCANALVENTARBM,
    CODCLAVEPARTYCLI,
    TIPO_LEAD
),

SBS_DEUDA AS (
  SELECT
    CAST(date_format(FECDIA,'yyyyMM') AS INT) AS CODMESDEUDA,
    CODCLAVEPARTYCLI,
    SUM(MTODEUDASOL) AS MTODEUDASOL_SISTEMA,
    MAX(
      CASE
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) = 'NORMAL' THEN 1
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('CON PROBLEMAS POTENCIALES(CPP)','CPP','CON PROBLEMAS POTENCIALES (CPP)') THEN 2
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) = 'DEFICIENTE' THEN 3
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) = 'DUDOSO' THEN 4
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('PERDIDA','PÉRDIDA') THEN 5
        ELSE 0
      END
    ) AS RIESGO_PEOR_ORD
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_DEUDORSBSDETALLE
  WHERE CAST(date_format(FECDIA,'yyyyMM') AS INT) BETWEEN 202412 AND 202512
    AND UPPER(TRIM(NBREMPSISTEMAFINANCIERO)) NOT LIKE 'BANCO DE CREDITO DEL PER%'
  GROUP BY CAST(date_format(FECDIA,'yyyyMM') AS INT), CODCLAVEPARTYCLI
),

CLIENTE_MES_SBS AS (
  SELECT
    c.*,

    COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) AS DELTA_DEUDA_SBS,
    GREATEST(COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0), 0) AS DELTA_DEUDA_SBS_POS,

    -- Regla de "desembolso otro banco" (ajusta umbral si quieres)
    CASE WHEN (COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0)) > 100 THEN 1 ELSE 0 END
      AS FLG_AUMENTO_DEUDA_SBS_REGLA,

    COALESCE(s2.RIESGO_PEOR_ORD,0) AS DESTIPCLASIFRIESGO_PEOR_ORD,
    CASE COALESCE(s2.RIESGO_PEOR_ORD,0)
      WHEN 1 THEN 'NORMAL'
      WHEN 2 THEN 'CON PROBLEMAS POTENCIALES(CPP)'
      WHEN 3 THEN 'DEFICIENTE'
      WHEN 4 THEN 'DUDOSO'
      WHEN 5 THEN 'PERDIDA'
      ELSE 'SIN INFO'
    END AS DESTIPCLASIFRIESGO_PEOR

  FROM CLIENTE_MES_UNIV c
  LEFT JOIN SBS_DEUDA s1
    ON c.CODCLAVEPARTYCLI = s1.CODCLAVEPARTYCLI
   AND CAST(date_format(add_months(to_date(concat(CAST(c.CODMES AS STRING),'01'),'yyyyMMdd'),-1),'yyyyMM') AS INT) = s1.CODMESDEUDA
  LEFT JOIN SBS_DEUDA s2
    ON c.CODCLAVEPARTYCLI = s2.CODCLAVEPARTYCLI
   AND c.CODMES = s2.CODMESDEUDA
),

AGG_CLIENTES AS (
  SELECT
    CODMES,
    DESCANALVENTARBM,
    DESTIPCLASIFRIESGO_PEOR,
    DESTIPCLASIFRIESGO_PEOR_ORD,

    /* ====== UNIDADES: DENEGADOS (cliente-mes) ====== */
    COUNT(DISTINCT CASE WHEN FLG_TUVO_DENEGADO = 1 THEN CODCLAVEPARTYCLI END) AS CTDCLIENTESDENEGADOS,
    COUNT(DISTINCT CASE WHEN FLG_TUVO_DENEGADO = 1 AND TIPO_LEAD='CON_LEAD' THEN CODCLAVEPARTYCLI END) AS CTDCLIENTESDENEGADOS_CON_LEAD,
    COUNT(DISTINCT CASE WHEN FLG_TUVO_DENEGADO = 1 AND TIPO_LEAD='SIN_LEAD' THEN CODCLAVEPARTYCLI END) AS CTDCLIENTESDENEGADOS_SIN_LEAD,

    /* ====== UNIDADES: APR SIN DESEMBOLSO (cliente-mes) ====== */
    COUNT(DISTINCT CASE WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1 THEN CODCLAVEPARTYCLI END) AS CTDCLIENTES_APR_SIN_DESEMBOLSO,
    COUNT(DISTINCT CASE WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1 AND TIPO_LEAD='CON_LEAD' THEN CODCLAVEPARTYCLI END) AS CTDCLIENTES_APR_SIN_DESEMBOLSO_CON_LEAD,
    COUNT(DISTINCT CASE WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1 AND TIPO_LEAD='SIN_LEAD' THEN CODCLAVEPARTYCLI END) AS CTDCLIENTES_APR_SIN_DESEMBOLSO_SIN_LEAD,

    /* ====== UNIDADES: “desembolso otro banco” por SBS regla, dentro de cada universo ====== */
    COUNT(DISTINCT CASE
      WHEN FLG_TUVO_DENEGADO = 1 AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1 THEN CODCLAVEPARTYCLI END
    ) AS CTDCLIENTESDENEGADOS_SBS,

    COUNT(DISTINCT CASE
      WHEN FLG_TUVO_DENEGADO = 1 AND TIPO_LEAD='CON_LEAD' AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1 THEN CODCLAVEPARTYCLI END
    ) AS CTDCLIENTESDENEGADOS_CON_LEAD_SBS,

    COUNT(DISTINCT CASE
      WHEN FLG_TUVO_DENEGADO = 1 AND TIPO_LEAD='SIN_LEAD' AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1 THEN CODCLAVEPARTYCLI END
    ) AS CTDCLIENTESDENEGADOS_SIN_LEAD_SBS,

    COUNT(DISTINCT CASE
      WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1 AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1 THEN CODCLAVEPARTYCLI END
    ) AS CTDCLIENTES_APR_SIN_DESEMBOLSO_SBS,

    /* ====== MONTOS: suma del delta (cliente-mes) para los que cumplen regla SBS dentro de cada universo ====== */
    SUM(CASE
      WHEN FLG_TUVO_DENEGADO = 1 AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1 THEN DELTA_DEUDA_SBS_POS ELSE 0 END
    ) AS MTO_AUM_SBS_DENEGADOS,

    SUM(CASE
      WHEN FLG_TUVO_DENEGADO = 1 AND TIPO_LEAD='CON_LEAD' AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1 THEN DELTA_DEUDA_SBS_POS ELSE 0 END
    ) AS MTO_AUM_SBS_DENEGADOS_CON_LEAD,

    SUM(CASE
      WHEN FLG_TUVO_DENEGADO = 1 AND TIPO_LEAD='SIN_LEAD' AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1 THEN DELTA_DEUDA_SBS_POS ELSE 0 END
    ) AS MTO_AUM_SBS_DENEGADOS_SIN_LEAD,

    SUM(CASE
      WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1 AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1 THEN DELTA_DEUDA_SBS_POS ELSE 0 END
    ) AS MTO_AUM_SBS_APR_SIN_DESEMBOLSO

  FROM CLIENTE_MES_SBS
  GROUP BY
    CODMES,
    DESCANALVENTARBM,
    DESTIPCLASIFRIESGO_PEOR,
    DESTIPCLASIFRIESGO_PEOR_ORD
)

SELECT *
FROM AGG_CLIENTES
ORDER BY
  CODMES,
  DESCANALVENTARBM,
  DESTIPCLASIFRIESGO_PEOR_ORD;
