-------------- TARJETA CREDITO
SELECT A.TIPO_EVALUACION, COUNT(*) FROM (
SELECT
    A.CODSOLICITUD,
    A.DESTIPFLUJOVENTATARJETACREDITO,
    A.DESTIPESTADOSOLICITUD,
    A.TIPESTADOSOLICITUD,
    A.DESTIPETAPA,
    A.CODMATRICULACOLABORADORVENDEDOR,
    A.CODMATRICULACOLABORADORAPROBADOR,
    A.FECSOLICITUD,
    CASE 
        WHEN B.CODSOLICITUD IS NOT NULL THEN 'EVALUACION EN CENTRALIZADO'
        ELSE 'EVALUACION AUTOMATICA'
    END AS TIPO_EVALUACION
FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDTARJETACREDITO A
LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_SALESFORCEBASESOLICITUDES B ON (A.CODSOLICITUD = B.CODSOLICITUD AND B.CODMESEVALUACION = 202510)
WHERE date_format(A.FECSOLICITUD, 'yyyyMM') = 202510 AND A.CODTIPREGAPP IN ('0126O000001xsIYQAY','0126O000001h0WaQAI','0126O000001h0WbQAI')
) A
LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_COLABORADOR B ON (A.CODMATRICULACOLABORADORVENDEDOR = B.CODMATRICULA AND A.FECSOLICITUD = B.FECDIA)
WHERE B.NBRAREAUNIDADORGANIZATIVA NOT IN ('GCIA DE AREA DE NEGOCIOS BANCA MINORISTA', 'GCIA DE AREA SOFTWARE ENGINEERING - CIO', 'GERENCIA DE AREA BANCA PRIVADA') 
AND A.TIPESTADOSOLICITUD IN ('ACPD', 'DCLD') AND A.DESTIPETAPA IN ('CERRADA')
GROUP BY ALL;


-- CREDITO CONSUMO

WITH
-- 1. Solicitudes de crédito consumo (solo columnas necesarias)
M_SOLICITUDCREDITOCONSUMO AS (
    SELECT
        CODSOLICITUD,
        FECSOLICITUD,
        DESTIPESTADOSOLICITUD,
        CODMATRICULACOLABORADORVENDEDOR,
        CODMATRICULACOLABORADORANALISTA
    FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO
    WHERE date_format(FECSOLICITUD, 'yyyyMM') = 202510
),

-- 2. Salesforce (solo columnas necesarias)
T72496_SALESFORCEBASESOLICITUDES AS (
    SELECT
        CODSOLICITUD
    FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_SALESFORCEBASESOLICITUDES
    WHERE CODMESEVALUACION = 202510
),

-- 3. Colaboradores (solo columnas necesarias)
H_COLABORADOR AS (
    SELECT
        CODMATRICULA,
        FECDIA,
        NBRAREAUNIDADORGANIZATIVA
    FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_COLABORADOR
),

-- 4. Cruce y lógica de negocio
TP_BASE AS (
    SELECT
        A.CODSOLICITUD,
        A.FECSOLICITUD,
        CASE 
            WHEN B.CODSOLICITUD IS NOT NULL THEN 'EVALUACION EN CENTRALIZADO'
            ELSE 'EVALUACION AUTOMATICA'
        END AS TIPO_EVALUACION,
        CASE
            WHEN B.CODSOLICITUD IS NOT NULL THEN 'CENTRALIZADO'
            ELSE 'PUNTO DE CONTACTO'
        END AS CENTROATENCION
    FROM M_SOLICITUDCREDITOCONSUMO A
    LEFT JOIN T72496_SALESFORCEBASESOLICITUDES B ON A.CODSOLICITUD = B.CODSOLICITUD
    LEFT JOIN H_COLABORADOR C ON A.CODMATRICULACOLABORADORVENDEDOR = C.CODMATRICULA AND A.FECSOLICITUD = C.FECDIA
    
    WHERE A.DESTIPESTADOSOLICITUD IN ('ACEPTADA', 'DESACTIVADA')
      AND C.NBRAREAUNIDADORGANIZATIVA NOT IN (
          'GERENCIA DE AREA BANCA PRIVADA',
          'GCIA DE AREA SOFTWARE ENGINEERING - CIO',
          'TRIBU PRESTAMOS'
      )
      AND A.CODMATRICULACOLABORADORANALISTA IS NULL
)

-- 5. Resultado final
SELECT CENTROATENCION, COUNT(*) AS TOTAL
FROM TP_BASE
GROUP BY CENTROATENCION;  -- 11852 (PDC)



