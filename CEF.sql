WITH
TP_TIPOCAMBIO AS (
	SELECT 3.81 AS TC_USD_SOL
),
BASE_PDC AS (
  SELECT
    CODMES,
    CODSOLICITUD,
    ESTADOFINAL,
    FLGCAMPANIA
  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASE_PDC
  WHERE TIPOPERACION = 'CREDITO CONSUMO NUEVO' AND ESTADOFINAL IN ('ACEPTADAS', 'DENEGADAS') AND CODMES BETWEEN 202501 AND 202512
),
M_SOLICITUDCREDITOCONSUMO AS (
	SELECT
		A.CODSOLICITUD,
		A.CODINTERNOCOMPUTACIONAL,
		A.FECSOLICITUD,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOSOLICITADO * B.TC_USD_SOL
			ELSE A.MTOSOLICITADO
		END) AS MTOSOLICITADO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
		A.FECDESEMBOLSO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO A
	CROSS JOIN TP_TIPOCAMBIO B
),
TP_BASE AS (
	SELECT
		A.CODMES,
		A.CODSOLICITUD,
		A.ESTADOFINAL,
		A.FLGCAMPANIA,
		B.CODINTERNOCOMPUTACIONAL,
		B.FECSOLICITUD,
		B.MTOSOLICITADO,
		B.MTOAPROBADO,
		B.FECDESEMBOLSO
	FROM BASE_PDC A
	LEFT JOIN M_SOLICITUDCREDITOCONSUMO B ON (A.CODSOLICITUD = B.CODSOLICITUD)
),
TP_BASE_2 AS (
	SELECT
		CODMES,
		CODSOLICITUD,
		CODINTERNOCOMPUTACIONAL,
		FECSOLICITUD,
		
		(CASE WHEN ESTADOFINAL = 'ACEPTADAS' THEN 1 ELSE 0 END) AS FLGAPROBADA,
		(CASE WHEN ESTADOFINAL = 'DENEGADAS' THEN 1 ELSE 0 END) AS FLGDENEGADA,
		(CASE WHEN ESTADOFINAL = 'ACEPTADAS' THEN COALESCE(MTOAPROBADO,0) ELSE 0 END) AS MTOAPROBADO,
		(CASE WHEN ESTADOFINAL = 'DENEGADAS' THEN COALESCE(MTOSOLICITADO,0) ELSE 0 END) AS MTODENEGADO,
		
		(CASE WHEN ESTADOFINAL = 'ACEPTADAS' AND FLGCAMPANIA = 1 THEN 1 ELSE 0 END) AS FLGAPROBADA_CON_LEAD,
		(CASE WHEN ESTADOFINAL = 'ACEPTADAS' AND FLGCAMPANIA = 0 THEN 1 ELSE 0 END) AS FLGAPROBADA_SIN_LEAD,
		(CASE WHEN ESTADOFINAL = 'DENEGADAS' AND FLGCAMPANIA = 1 THEN 1 ELSE 0 END) AS FLGDENEGADA_CON_LEAD,
		(CASE WHEN ESTADOFINAL = 'DENEGADAS' AND FLGCAMPANIA = 0 THEN 1 ELSE 0 END) AS FLGDENEGADA_SIN_LEAD,
		
		(CASE WHEN ESTADOFINAL = 'ACEPTADAS' AND FLGCAMPANIA = 1 THEN COALESCE(MTOAPROBADO,0) ELSE 0 END) AS MTOAPROBADO_CON_LEAD,
		(CASE WHEN ESTADOFINAL = 'ACEPTADAS' AND FLGCAMPANIA = 0 THEN COALESCE(MTOAPROBADO,0) ELSE 0 END) AS MTOAPROBADO_SIN_LEAD,
		(CASE WHEN ESTADOFINAL = 'DENEGADAS' AND FLGCAMPANIA = 1 THEN COALESCE(MTOSOLICITADO,0) ELSE 0 END) AS MTODENEGADO_CON_LEAD,
		(CASE WHEN ESTADOFINAL = 'DENEGADAS' AND FLGCAMPANIA = 0 THEN COALESCE(MTOSOLICITADO,0) ELSE 0 END) AS MTODENEGADO_SIN_LEAD
		
	FROM TP_BASE
),
SBS AS (
	SELECT
		CAST(date_format(FECDIA,'yyyyMM') AS INT) AS CODMESDEUDA,
		CODCLAVEPARTYCLI,
		SUM(MTODEUDASOL) AS MTODEUDASOL_SISTEMA,
		MAX(
			CASE
			WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('NORMAL') THEN 1
			WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('CON PROBLEMAS POTENCIALES(CPP)','CPP','CON PROBLEMAS POTENCIALES (CPP)') THEN 2
			WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('DEFICIENTE') THEN 3
			WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('DUDOSO') THEN 4
			WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('PERDIDA','PÃ‰RDIDA') THEN 5
			ELSE 0
		END) AS RIESGO_PEOR_ORD
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_DEUDORSBSDETALLE
	WHERE UPPER(TRIM(NBREMPSISTEMAFINANCIERO)) NOT LIKE 'BANCO DE CREDITO DEL PER%' AND UPPER(DESCTACONTABLESBS) NOT LIKE '%TARJET%' AND DESTIPCREDITO IN ('CREDITO DE CONSUMO NO REVOLVENTE','CREDITO HIPOTECARIOS PARA VIVIENDA')
	GROUP BY CAST(date_format(FECDIA,'yyyyMM') AS INT), CODCLAVEPARTYCLI
)
