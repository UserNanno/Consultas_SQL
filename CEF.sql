WITH
PLANCHON AS (
  SELECT
    CODMES,
    CODSOLICITUD,
    ESTADOFINAL
  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_PLANCHON_CORTE_DIC
  WHERE CODMES = 202512
    AND ESTADOFINAL IN ('ACEPTADAS', 'DENEGADAS')
),
NUEVA AS (
  SELECT
    CODMES,
    CODSOLICITUD,
    ESTADOSOLICITUD,
    DESTIPETAPA,
  FROM CATALOG_LHCL_PROD_BCP_EXPL.BCP_EDV_RBMBDN.T72496_UNIONWEEKLY
  WHERE CODMES = 202512
    AND ESTADOSOLICITUD IN ('RECHAZADO', 'APROBADO')
),
COMPARA AS (
  SELECT
    COALESCE(p.CODMES, n.CODMES) AS CODMES,
    COALESCE(p.CODSOLICITUD, n.CODSOLICITUD) AS CODSOLICITUD,
    p.ESTADOFINAL AS ESTADO_ANTIGUO,
    n.ESTADOSOLICITUD AS ESTADO_NUEVO,
    n.DESTIPETAPA
  FROM PLANCHON p
  FULL OUTER JOIN NUEVA n
    ON p.CODMES = n.CODMES
   AND p.CODSOLICITUD = n.CODSOLICITUD
)
SELECT
  CODMES,
  CODSOLICITUD,
  ESTADO_ANTIGUO,
  ESTADO_NUEVO,
  DESTIPETAPA
FROM COMPARA
WHERE ESTADO_ANTIGUO = 'ACEPTADAS'
  AND ESTADO_NUEVO   = 'RECHAZADO'
ORDER BY CODSOLICITUD;
