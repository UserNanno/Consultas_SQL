WITH
TP_TIPOCAMBIO AS (
	SELECT 3.81 AS TC_USD_SOL
),
BASE_CENTRALIZADO AS (
  SELECT
    CODMES,
    CODSOLICITUD,
    ESTADOFINAL,
    FLGCAMPANIA,
    FLGCASTIGONUEVO,
    FLGDESEMBOLSO,
    (CASE WHEN FLGCAMPANIA = 'Con Campania' THEN 1 ELSE 0 END) AS FLGCAMPANIAORD,
    (CASE WHEN FLGCASTIGONUEVO = 'Con Castigo' THEN 1 ELSE 0 END) AS FLGCASTIGOORD,
    (CASE WHEN FLGDESEMBOLSO = 'Desembolsado' THEN 1 ELSE 0 END) AS FLGDESEMBOLSOORD
  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASE_DESEMBOLSOS_CENTRALIZADO A
  WHERE TIPOPERACION = 'Credito Consumo Nuevo' AND ESTADOFINAL IN ('ACEPTADAS', 'DENEGADAS')
),
M_SOLICITUDCREDITOCONSUMO AS (
	SELECT
		A.CODSOLICITUD,
		A.CODCLAVEPARTYCLI,
		A.FECSOLICITUD,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOSOLICITADO * B.TC_USD_SOL
			ELSE A.MTOSOLICITADO
		END) AS MTOSOLICITADO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
		A.FECDESEMBOLSO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO A
	CROSS JOIN TP_TIPOCAMBIO B
),
TP_BASE AS (
	SELECT
		A.CODMES,
		A.CODSOLICITUD,
		A.ESTADOFINAL,
		A.FLGCAMPANIAORD,
		A.FLGCASTIGOORD,
		A.FLGDESEMBOLSOORD,
		B.CODCLAVEPARTYCLI,
		B.MTOSOLICITADO,
		B.MTOAPROBADO
	FROM BASE_CENTRALIZADO A
	LEFT JOIN M_SOLICITUDCREDITOCONSUMO B ON (A.CODSOLICITUD = B.CODSOLICITUD)
),
TP_BASE_2 AS (
  SELECT
    CODMES,
    CODSOLICITUD,
    CODCLAVEPARTYCLI,
    MTOSOLICITADO,
    (CASE WHEN ESTADOFINAL = 'ACEPTADAS' THEN 1 ELSE 0 END) AS FLGACEPTADAS,
    (CASE WHEN ESTADOFINAL = 'DENEGADAS' THEN 1 ELSE 0 END) AS FLGDENEGADO,
    (CASE WHEN ESTADOFINAL = 'ACEPTADAS' THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADO,
    (CASE WHEN ESTADOFINAL = 'DENEGADAS' THEN MTOSOLICITADO ELSE 0 END) AS MTODENEGADO,

    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD = 1 THEN 1 ELSE 0 END) AS FLGACEPTADAS_CON_CAMPANIA,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD = 0 THEN 1 ELSE 0 END) AS FLGACEPTADAS_SIN_CAMPANIA,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD = 1 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADAS_CON_CAMPANIA,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD = 0 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADAS_SIN_CAMPANIA,
    
    (CASE WHEN ESTADOFINAL='DENEGADAS' AND FLGCAMPANIAORD = 1 THEN 1 ELSE 0 END) AS FLGDENEGADAS_CON_CAMPANIA,
    (CASE WHEN ESTADOFINAL='DENEGADAS' AND FLGCAMPANIAORD = 0 THEN 1 ELSE 0 END) AS FLGDENEGADAS_SIN_CAMPANIA,
    (CASE WHEN ESTADOFINAL='DENEGADAS' AND FLGCAMPANIAORD = 1 THEN MTOSOLICITADO ELSE 0 END) AS MTODENEGADAS_CON_CAMPANIA,
    (CASE WHEN ESTADOFINAL='DENEGADAS' AND FLGCAMPANIAORD = 0 THEN MTOSOLICITADO ELSE 0 END) AS MTODENEGADAS_SIN_CAMPANIA,

    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD = 1 AND FLGCASTIGOORD = 1 THEN 1 ELSE 0 END) AS FLGACEPTADAS_CON_CAMPANIA_CON_RENEGOCIACION,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD = 1 AND FLGCASTIGOORD = 0 THEN 1 ELSE 0 END) AS FLGACEPTADAS_CON_CAMPANIA_SIN_RENEGOCIACION,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD = 0 AND FLGCASTIGOORD = 1 THEN 1 ELSE 0 END) AS FLGACEPTADAS_SIN_CAMPANIA_CON_RENEGOCIACION,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD = 0 AND FLGCASTIGOORD = 0 THEN 1 ELSE 0 END) AS FLGACEPTADAS_SIN_CAMPANIA_SIN_RENEGOCIACION,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD = 1 AND FLGCASTIGOORD = 1 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADAS_CON_CAMPANIA_CON_RENEGOCIACION,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD = 1 AND FLGCASTIGOORD = 0 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADAS_CON_CAMPANIA_SIN_RENEGOCIACION,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD = 0 AND FLGCASTIGOORD = 1 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADAS_SIN_CAMPANIA_CON_RENEGOCIACION,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD = 0 AND FLGCASTIGOORD = 0 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADAS_SIN_CAMPANIA_SIN_RENEGOCIACION,

    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=1 AND FLGCASTIGOORD=1 AND FLGDESEMBOLSOORD=1 THEN 1 ELSE 0 END) AS FLGACEPTADAS_CON_CAMPANIA_CON_RENEGOCIACION_CON_DESEMBOLSO,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=1 AND FLGCASTIGOORD=1 AND FLGDESEMBOLSOORD=0 THEN 1 ELSE 0 END) AS FLGACEPTADAS_CON_CAMPANIA_CON_RENEGOCIACION_SIN_DESEMBOLSO,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=1 AND FLGCASTIGOORD=0 AND FLGDESEMBOLSOORD=1 THEN 1 ELSE 0 END) AS FLGACEPTADAS_CON_CAMPANIA_SIN_RENEGOCIACION_CON_DESEMBOLSO,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=1 AND FLGCASTIGOORD=0 AND FLGDESEMBOLSOORD=0 THEN 1 ELSE 0 END) AS FLGACEPTADAS_CON_CAMPANIA_SIN_RENEGOCIACION_SIN_DESEMBOLSO,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=0 AND FLGCASTIGOORD=1 AND FLGDESEMBOLSOORD=1 THEN 1 ELSE 0 END) AS FLGACEPTADAS_SIN_CAMPANIA_CON_RENEGOCIACION_CON_DESEMBOLSO,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=0 AND FLGCASTIGOORD=1 AND FLGDESEMBOLSOORD=0 THEN 1 ELSE 0 END) AS FLGACEPTADAS_SIN_CAMPANIA_CON_RENEGOCIACION_SIN_DESEMBOLSO,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=0 AND FLGCASTIGOORD=0 AND FLGDESEMBOLSOORD=1 THEN 1 ELSE 0 END) AS FLGACEPTADAS_SIN_CAMPANIA_SIN_RENEGOCIACION_CON_DESEMBOLSO,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=0 AND FLGCASTIGOORD=0 AND FLGDESEMBOLSOORD=0 THEN 1 ELSE 0 END) AS FLGACEPTADAS_SIN_CAMPANIA_SIN_RENEGOCIACION_SIN_DESEMBOLSO,
    
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=1 AND FLGCASTIGOORD=1 AND FLGDESEMBOLSOORD=1 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADAS_CON_CAMPANIA_CON_RENEGOCIACION_CON_DESEMBOLSO,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=1 AND FLGCASTIGOORD=1 AND FLGDESEMBOLSOORD=0 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADAS_CON_CAMPANIA_CON_RENEGOCIACION_SIN_DESEMBOLSO,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=1 AND FLGCASTIGOORD=0 AND FLGDESEMBOLSOORD=1 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADAS_CON_CAMPANIA_SIN_RENEGOCIACION_CON_DESEMBOLSO,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=1 AND FLGCASTIGOORD=0 AND FLGDESEMBOLSOORD=0 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADAS_CON_CAMPANIA_SIN_RENEGOCIACION_SIN_DESEMBOLSO,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=0 AND FLGCASTIGOORD=1 AND FLGDESEMBOLSOORD=1 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADAS_SIN_CAMPANIA_CON_RENEGOCIACION_CON_DESEMBOLSO,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=0 AND FLGCASTIGOORD=1 AND FLGDESEMBOLSOORD=0 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADAS_SIN_CAMPANIA_CON_RENEGOCIACION_SIN_DESEMBOLSO,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=0 AND FLGCASTIGOORD=0 AND FLGDESEMBOLSOORD=1 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADAS_SIN_CAMPANIA_SIN_RENEGOCIACION_CON_DESEMBOLSO,
    (CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGCAMPANIAORD=0 AND FLGCASTIGOORD=0 AND FLGDESEMBOLSOORD=0 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADAS_SIN_CAMPANIA_SIN_RENEGOCIACION_SIN_DESEMBOLSO

  FROM TP_BASE A
)
SELECT
	CODMES,
	COUNT(*) AS CTDSOLICITUDES,
	SUM(FLGACEPTADAS) AS CTDSOLICITUDESAPROBADAS,
	SUM(FLGDENEGADO) AS CTDSOLICITUDESDENEGADAS,
	SUM(FLGACEPTADAS_CON_CAMPANIA) AS CTDSOLICITUDESAPROBADAS_CON_LEAD,
	SUM(FLGACEPTADAS_SIN_CAMPANIA) AS CTDSOLICITUDESAPROBADAS_SIN_LEAD,
	SUM(FLGDENEGADAS_CON_CAMPANIA) AS CTDSOLICITUDESDENEGADAS_CON_LEAD,
	SUM(FLGDENEGADAS_SIN_CAMPANIA) AS CTDSOLICITUDESDENEGADAS_SIN_LEAD,
	SUM(FLGACEPTADAS_CON_CAMPANIA_CON_RENEGOCIACION) AS CTDSOLICITUDESACEPTADAS_CON_LEAD_CON_RENEGOCIACION,
	SUM(FLGACEPTADAS_CON_CAMPANIA_SIN_RENEGOCIACION) AS CTDSOLICITUDESACEPTADAS_CON_LEAD_SIN_RENEGOCIACION,
	SUM(FLGACEPTADAS_SIN_CAMPANIA_CON_RENEGOCIACION) AS CTDSOLICITUDESACEPTADAS_SIN_LEAD_CON_RENEGOCIACION,
	SUM(FLGACEPTADAS_SIN_CAMPANIA_SIN_RENEGOCIACION) AS CTDSOLICITUDESACEPTADAS_SIN_LEAD_SIN_RENEGOCIACION,
	SUM(FLGACEPTADAS_CON_CAMPANIA_CON_RENEGOCIACION_CON_DESEMBOLSO) AS CTDSOLICITUDESACEPTADAS_CON_LEAD_CON_RENEGOCIACION_CON_DESEMBOLSO,
	SUM(FLGACEPTADAS_CON_CAMPANIA_CON_RENEGOCIACION_SIN_DESEMBOLSO) AS CTDSOLICITUDESACEPTADAS_CON_LEAD_CON_RENEGOCIACION_SIN_DESEMBOLSO,
	SUM(FLGACEPTADAS_CON_CAMPANIA_SIN_RENEGOCIACION_CON_DESEMBOLSO) AS CTDSOLICITUDESACEPTADAS_CON_LEAD_SIN_RENEGOCIACION_CON_DESEMBOLSO,
	SUM(FLGACEPTADAS_CON_CAMPANIA_SIN_RENEGOCIACION_SIN_DESEMBOLSO) AS CTDSOLICITUDESACEPTADAS_CON_LEAD_SIN_RENEGOCIACION_SIN_DESEMBOLSO,
	SUM(FLGACEPTADAS_SIN_CAMPANIA_CON_RENEGOCIACION_CON_DESEMBOLSO) AS CTDSOLICITUDESACEPTADAS_SIN_LEAD_CON_RENEGOCIACION_CON_DESEMBOLSO,
	SUM(FLGACEPTADAS_SIN_CAMPANIA_CON_RENEGOCIACION_SIN_DESEMBOLSO) AS CTDSOLICITUDESACEPTADAS_SIN_LEAD_CON_RENEGOCIACION_SIN_DESEMBOLSO,
	SUM(FLGACEPTADAS_SIN_CAMPANIA_SIN_RENEGOCIACION_CON_DESEMBOLSO) AS CTDSOLICITUDESACEPTADAS_SIN_LEAD_SIN_RENEGOCIACION_CON_DESEMBOLSO,
	SUM(FLGACEPTADAS_SIN_CAMPANIA_SIN_RENEGOCIACION_SIN_DESEMBOLSO) AS CTDSOLICITUDESACEPTADAS_SIN_LEAD_SIN_RENEGOCIACION_SIN_DESEMBOLSO,
	
	SUM(MTOSOLICITADO) AS MTOSOLICITADO,
	SUM(MTOAPROBADO) AS MTOAPROBADO,
	SUM(MTODENEGADO) AS MTODENEGADO,
	SUM(MTOAPROBADAS_CON_CAMPANIA) AS MTOAPROBADAS_CON_CAMPANIA,
	SUM(MTOAPROBADAS_SIN_CAMPANIA) AS MTOAPROBADAS_SIN_CAMPANIA,
	SUM(MTODENEGADAS_CON_CAMPANIA) AS MTODENEGADAS_CON_CAMPANIA,
	SUM(MTODENEGADAS_SIN_CAMPANIA) AS MTODENEGADAS_SIN_CAMPANIA,
	SUM(MTOAPROBADAS_CON_CAMPANIA_CON_RENEGOCIACION) AS MTOAPROBADAS_CON_CAMPANIA_CON_RENEGOCIACION,
	SUM(MTOAPROBADAS_CON_CAMPANIA_SIN_RENEGOCIACION) AS MTOAPROBADAS_CON_CAMPANIA_SIN_RENEGOCIACION,
	SUM(MTOAPROBADAS_SIN_CAMPANIA_CON_RENEGOCIACION) AS MTOAPROBADAS_SIN_CAMPANIA_CON_RENEGOCIACION,
	SUM(MTOAPROBADAS_SIN_CAMPANIA_SIN_RENEGOCIACION) AS MTOAPROBADAS_SIN_CAMPANIA_SIN_RENEGOCIACION,
	SUM(MTOAPROBADAS_CON_CAMPANIA_CON_RENEGOCIACION_CON_DESEMBOLSO) AS MTOAPROBADAS_CON_CAMPANIA_CON_RENEGOCIACION_CON_DESEMBOLSO,
	SUM(MTOAPROBADAS_CON_CAMPANIA_CON_RENEGOCIACION_SIN_DESEMBOLSO) AS MTOAPROBADAS_CON_CAMPANIA_CON_RENEGOCIACION_SIN_DESEMBOLSO,
	SUM(MTOAPROBADAS_CON_CAMPANIA_SIN_RENEGOCIACION_CON_DESEMBOLSO) AS MTOAPROBADAS_CON_CAMPANIA_SIN_RENEGOCIACION_CON_DESEMBOLSO,
	SUM(MTOAPROBADAS_CON_CAMPANIA_SIN_RENEGOCIACION_SIN_DESEMBOLSO) AS MTOAPROBADAS_CON_CAMPANIA_SIN_RENEGOCIACION_SIN_DESEMBOLSO,
	SUM(MTOAPROBADAS_SIN_CAMPANIA_CON_RENEGOCIACION_CON_DESEMBOLSO) AS MTOAPROBADAS_SIN_CAMPANIA_CON_RENEGOCIACION_CON_DESEMBOLSO,
	SUM(MTOAPROBADAS_SIN_CAMPANIA_CON_RENEGOCIACION_SIN_DESEMBOLSO) AS MTOAPROBADAS_SIN_CAMPANIA_CON_RENEGOCIACION_SIN_DESEMBOLSO,
	SUM(MTOAPROBADAS_SIN_CAMPANIA_SIN_RENEGOCIACION_CON_DESEMBOLSO) AS MTOAPROBADAS_SIN_CAMPANIA_SIN_RENEGOCIACION_CON_DESEMBOLSO,
	SUM(MTOAPROBADAS_SIN_CAMPANIA_SIN_RENEGOCIACION_SIN_DESEMBOLSO) AS MTOAPROBADAS_SIN_CAMPANIA_SIN_RENEGOCIACION_SIN_DESEMBOLSO
FROM TP_BASE_2
GROUP BY CODMES;
