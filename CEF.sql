WITH
TP_TIPOCAMBIO AS (
	SELECT 3.81 AS TC_USD_SOL
),
TP_BASESOLICITUDESSALESFORCE AS (
	SELECT
		CODMESEVALUACION,
    	CODSOLICITUD,
    	MATRICULA,
    	ESTADOSOLICITUD,
    	DESTIPPRODUCTO,
    	DESPRODUCTO,
    	DESTIPETAPA
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_SALESFORCEBASESOLICITUDES
),
TP_BASESOLICITUDESAPPS AS (
	SELECT
		CODMES,
		CODSOLICITUD,
		MATANALISTA,
		RESULTADOANALISTA,
		PRODUCTO
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASESOLICITUDES
),
TP_COLABORADOR AS (
    SELECT
        FECDIA,
        date_format(FECDIA, 'yyyyMM') AS CODMES,
        CODMATRICULA,
        CODMATRICULASUP,
        NBRUNIDADORGANIZATIVA,
        NBRAREAUNIDADORGANIZATIVA,
        NBRSERVUNIDADORGANIZATIVA,
        (CASE
        	WHEN NBRAREAUNIDADORGANIZATIVA IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1') THEN 'DCA'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS' THEN 'TLMK'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA BANCA AFLUENTE' AND NBRSERVUNIDADORGANIZATIVA = 'GERENCIA DE BANCA ENALTA' THEN 'ENALTA'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA BANCA AFLUENTE' AND NBRSERVUNIDADORGANIZATIVA = 'GERENCIA DE BANCA EXCLUSIVA DIGITAL' THEN 'BEX'
			ELSE 'OTROS'
		END) AS CANAL
    FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_COLABORADOR
    WHERE DESTIPESTADOLABORAL = 'Activo'
),
TP_COLABORADORANALISTA AS (
    SELECT
        CODMES,
        MATORGANICO,
        MATSUPERIOR,
        NBRAREAUNIDADORGANIZATIVA
    FROM (
        SELECT
            CODMES,
            CODMATRICULA      AS MATORGANICO,
            CODMATRICULASUP   AS MATSUPERIOR,
            NBRAREAUNIDADORGANIZATIVA,
            ROW_NUMBER() OVER (
                PARTITION BY CODMES, CODMATRICULA
                ORDER BY FECDIA DESC   -- Ãºltima foto del mes
            ) AS rn
        FROM TP_COLABORADOR
    ) x
    WHERE rn = 1
),
TP_BASE_SOLICITUDES AS (
	SELECT
		COALESCE(B.CODMESEVALUACION, A.CODMES) AS CODMES,
	    COALESCE(B.CODSOLICITUD, A.CODSOLICITUD) AS CODSOLICITUD,
	    (CASE 
	    	WHEN COALESCE(B.ESTADOSOLICITUD, A.RESULTADOANALISTA) = 'PENDIENTE' AND B.DESTIPETAPA = 'DESESTIMADA' THEN 'RECHAZADO'
	    	ELSE COALESCE(B.ESTADOSOLICITUD, A.RESULTADOANALISTA)
	    END) AS ESTADOSOLICITUD,
	    COALESCE(B.MATRICULA, A.MATANALISTA) AS MATANALISTA,
	    COALESCE(B.DESTIPPRODUCTO, A.PRODUCTO) AS PRODUCTO,
	    B.DESPRODUCTO,
	    B.DESTIPETAPA,
	    CASE 
	        WHEN A.CODSOLICITUD IS NOT NULL AND B.CODSOLICITUD IS NOT NULL THEN 'AMBOS'
	        WHEN B.CODSOLICITUD IS NOT NULL THEN 'SOLO_SF'
	    END AS ORIGEN,
	    C.NBRAREAUNIDADORGANIZATIVA,
	    C.MATSUPERIOR
	FROM TP_BASESOLICITUDESAPPS A
	FULL OUTER JOIN TP_BASESOLICITUDESSALESFORCE B ON (A.CODSOLICITUD = B.CODSOLICITUD)
	LEFT JOIN TP_COLABORADORANALISTA C ON (C.CODMES = COALESCE(A.CODMES, B.CODMESEVALUACION) AND C.MATORGANICO = COALESCE(A.MATANALISTA, B.MATRICULA))
	WHERE B.CODSOLICITUD IS NOT NULL
),
