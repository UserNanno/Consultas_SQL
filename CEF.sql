WITH SOL AS (
  SELECT
    A.CODMESEVALUACION,
    A.FECSOLICITUDEVALUACION,
    A.FECEVALUACION,
    A.DESCANALVENTARBMPER,
    A.TIPPRODUCTOSOLICITUDRBM,
    A.DESTIPDECISIONRESULTADORBM,
    TRIM(regexp_replace(A.CODINTERNOCOMPUTACIONAL, '[\\n\\r\\t]', '')) AS CODINTERNOCOMPUTACIONAL,
    A.DESCAMPANIASOLICITUD,
    A.DESTIPEVALUACIONSOLICITUDCREDITO,
    A.CODIDEVALUACION,
    A.CODEVALUACIONSOLICITUD,
    A.CODSECUENCIALDECISIONRBM,
    A.NUMSOLICITUDEVALUACION,

    CASE
      WHEN A.DESCANALVENTARBMPER = 'SALEFORCE' THEN SUBSTR(TRIM(A.NUMSOLICITUDEVALUACION), 5, 7)
      WHEN A.DESCANALVENTARBMPER = 'LOANS'     THEN SUBSTR(TRIM(A.NUMSOLICITUDEVALUACION), 3, 8)
      ELSE TRIM(A.NUMSOLICITUDEVALUACION)
    END AS NUMSOLICITUDEVALUACIONCORTO,

    B.CODCLAVEPARTYCLI,

    CASE
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO IN ('Regular LD','Cuotealo')
        AND A.DESCAMPANIASOLICITUD IN ('100% Aprobado','Pre-Aprobado') THEN 'LD APR'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO IN ('Regular LD','Cuotealo')
        AND A.DESCAMPANIASOLICITUD = 'CEF Shield' THEN 'LD SHD'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'Regular LD'
        AND A.DESCAMPANIASOLICITUD = 'Convenio' THEN 'LD CONV'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'Regular LD'
        AND A.DESCAMPANIASOLICITUD = 'Invitado' THEN 'LD INV'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'Compra de Deuda'
        AND A.DESCAMPANIASOLICITUD IN ('100% Aprobado','Pre-Aprobado') THEN 'CDD APR'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'Compra de Deuda'
        AND A.DESCAMPANIASOLICITUD = 'Convenio' THEN 'CDD CONV'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'LD + Consolidación'
        AND A.DESCAMPANIASOLICITUD IN ('100% Aprobado','Pre-Aprobado') THEN 'REE APR'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'LD + Consolidación'
        AND A.DESCAMPANIASOLICITUD = 'Convenio' THEN 'REE CONV'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'LD + Compra de Deuda + Consolidación'
        AND A.DESCAMPANIASOLICITUD IN ('100% Aprobado','Pre-Aprobado') THEN 'CONS APR'
      WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'LD + Compra de Deuda + Consolidación'
        AND A.DESCAMPANIASOLICITUD = 'Convenio' THEN 'CONS CONV'
      ELSE 'REACTIVO'
    END AS LEAD_CEF_SOL

  FROM CATALOG_LHCL_PROD_BCP.BCP_DDV_RBMRBMPER_MODELOGESTION_VU.MD_EVALUACIONSOLICITUDCREDITO A
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_CLIENTE B
    ON TRIM(regexp_replace(A.CODINTERNOCOMPUTACIONAL, '[\\n\\r\\t]', '')) = TRIM(B.CODINTERNOCOMPUTACIONAL)
  WHERE A.TIPPRODUCTOSOLICITUDRBM = 'CC'
    AND A.DESCANALVENTARBMPER NOT IN ('YAPE','OTROS')
    AND A.DESTIPDECISIONRESULTADORBM IN ('Approve','Decline','Investigate')
    AND A.CODINTERNOCOMPUTACIONAL IS NOT NULL
    AND TRIM(regexp_replace(A.CODINTERNOCOMPUTACIONAL, '[\\n\\r\\t]', '')) <> ''
),

SOL_NORM AS (
  SELECT
    s.*,
    CASE WHEN s.CODEVALUACIONSOLICITUD LIKE 'OP-%' THEN 1 ELSE 0 END AS FLG_OP_PREFIX,
    COALESCE(CAST(NULLIF(regexp_extract(s.CODEVALUACIONSOLICITUD,'([0-9]+)',1),'') AS BIGINT),-1) AS CODEVAL_NUM
  FROM SOL s
),

SOL_ORD AS (
  SELECT
    n.*,
    ROW_NUMBER() OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS RN_SOL,

    LAG(n.FECSOLICITUDEVALUACION) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS PREV_FECSOL,

    LAG(n.FLG_OP_PREFIX) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS PREV_FLG_OP,

    LAG(n.CODEVAL_NUM) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS PREV_CODEVAL_NUM,

    LAG(n.CODEVALUACIONSOLICITUD) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS PREV_CODEVAL_TXT
  FROM SOL_NORM n
),

SOL_REING AS (
  SELECT
    o.*,
    CASE
      WHEN o.PREV_FECSOL IS NULL THEN 0
      WHEN (
        o.FECSOLICITUDEVALUACION > o.PREV_FECSOL
        OR (
          o.FECSOLICITUDEVALUACION = o.PREV_FECSOL
          AND (
            o.FLG_OP_PREFIX > o.PREV_FLG_OP
            OR (o.FLG_OP_PREFIX = o.PREV_FLG_OP AND o.CODEVAL_NUM > o.PREV_CODEVAL_NUM)
            OR (o.FLG_OP_PREFIX = o.PREV_FLG_OP AND o.CODEVAL_NUM = o.PREV_CODEVAL_NUM AND o.CODEVALUACIONSOLICITUD > o.PREV_CODEVAL_TXT)
          )
        )
      )
      AND o.FECSOLICITUDEVALUACION <= add_months(o.PREV_FECSOL,1)
      THEN 1 ELSE 0
    END AS FLG_REINGRESO_1M
  FROM SOL_ORD o
),

VENTA AS (
  SELECT
    CODSOLICITUD,
    CASE
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2) IN ('CX','DX') THEN SUBSTR(TRIM(CODSOLICITUD),3,8)
      WHEN CODSOLICITUD LIKE '2________' THEN SUBSTR(TRIM(CODSOLICITUD),3,7)
      WHEN CODSOLICITUD LIKE '      2________' THEN SUBSTR(TRIM(CODSOLICITUD),3,7)
      WHEN CODSOLICITUD LIKE 'O%' THEN SUBSTR(TRIM(CODSOLICITUD),3,7)
      ELSE TRIM(CODSOLICITUD)
    END AS CODSOLICITUDCORTO,
    CASE
      WHEN CODPRODUCTO='CPEFIA' THEN 'CUOTEALO'
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2)='PE' THEN 'CUOTEALO'
      WHEN CODPRODUCTO='CPEYAP' THEN 'YAPE'
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2)='YP' THEN 'YAPE'
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2)='JB' THEN 'BANCA MÓVIL'
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2) IN ('CX','DX') THEN 'LOANS'
      WHEN CODSOLICITUD LIKE '2________' THEN 'SALEFORCE'
      WHEN CODSOLICITUD LIKE '      2________' THEN 'SALEFORCE'
      WHEN CODSOLICITUD LIKE 'O%' THEN 'SALEFORCE'
      ELSE 'OTROS'
    END AS CANAL_MDPREST,
    FECAPERTURA,
    CODCLAVEPARTYCLI
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_CUENTACREDITOPERSONAL
  WHERE CODPRODUCTO IN ('CPEEFM','CPECMC','CPEDPP','CPECEM','CPEECV','CPEGEN','CPEADH','CPEFIA')
    AND FLGREGELIMINADOFUENTE='N'
),

MATCH_ONE AS (
  SELECT *
  FROM (
    SELECT
      s.*,
      v.FECAPERTURA,
      ROW_NUMBER() OVER (
        PARTITION BY s.CODINTERNOCOMPUTACIONAL, s.CODIDEVALUACION, s.CODEVALUACIONSOLICITUD
        ORDER BY ABS(datediff(v.FECAPERTURA,s.FECSOLICITUDEVALUACION)), v.FECAPERTURA
      ) AS RN_MATCH
    FROM SOL_REING s
    LEFT JOIN VENTA v
      ON s.CODCLAVEPARTYCLI = v.CODCLAVEPARTYCLI
     AND s.DESCANALVENTARBMPER = v.CANAL_MDPREST
     AND TRIM(s.NUMSOLICITUDEVALUACIONCORTO) = TRIM(v.CODSOLICITUDCORTO)
     AND datediff(v.FECAPERTURA,s.FECSOLICITUDEVALUACION) BETWEEN 0 AND 40
  ) x
  WHERE RN_MATCH = 1
),

BASE_FLAGS AS (
  SELECT
    m.CODEVALUACIONSOLICITUD,
    m.CODINTERNOCOMPUTACIONAL,
    m.CODCLAVEPARTYCLI,
    m.CODMESEVALUACION AS CODMESSOLICITUDEVALUACION,
    m.FECSOLICITUDEVALUACION,
    m.DESCANALVENTARBMPER AS DESCANALVENTARBM,
    m.DESTIPDECISIONRESULTADORBM,
    m.FLG_REINGRESO_1M,
    m.LEAD_CEF_SOL,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' THEN 1 ELSE 0 END AS FLG_APROBADO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM IN ('Decline','Investigate') THEN 1 ELSE 0 END AS FLG_DENEGADO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FECAPERTURA IS NOT NULL THEN 1 ELSE 0 END AS FLG_DESEMBOLSADO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FECAPERTURA IS NULL THEN 1 ELSE 0 END AS FLG_NODESEMBOLSADO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FLG_REINGRESO_1M = 1 AND m.FECAPERTURA IS NOT NULL THEN 1 ELSE 0 END AS FLG_APROBADO_CON_REINGRESO_1M_CON_DESEMBOLSO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FLG_REINGRESO_1M = 1 AND m.FECAPERTURA IS NULL THEN 1 ELSE 0 END AS FLG_APROBADO_CON_REINGRESO_1M_SIN_DESEMBOLSO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FLG_REINGRESO_1M = 0 AND m.FECAPERTURA IS NULL THEN 1 ELSE 0 END AS FLG_APROBADO_SIN_REINGRESO_SIN_DESEMBOLSO
  FROM MATCH_ONE m
),

HM_LEADS_BDI_BASE AS (
  SELECT
    CODLOTEOFERTA,
    TRIM(CODINTERNOCOMPUTACIONAL) AS CODINTERNOCOMPUTACIONAL,
    FECINICIOVIGENCIA,
    CASE
      WHEN TIPVENTA = 6   AND TIPOFERTA = 3  AND CODCONDICIONCLIENTE IN ('APR','PRE') THEN 1
      WHEN TIPVENTA = 6   AND TIPOFERTA = 3  AND CODCONDICIONCLIENTE = 'OPT' THEN 2
      WHEN TIPVENTA = 6   AND TIPOFERTA = 41 AND CODCONDICIONCLIENTE IN ('APR','PRE') THEN 3
      WHEN TIPVENTA = 6   AND TIPOFERTA = 38 AND CODCONDICIONCLIENTE IN ('APR','PRE') THEN 4
      WHEN TIPVENTA = 6   AND TIPOFERTA IN (89,98) THEN 5
      WHEN TIPVENTA = 6   AND TIPOFERTA = 3  AND CODCONDICIONCLIENTE = 'INV' THEN 6
      WHEN TIPVENTA = 6   AND TIPOFERTA = 187 THEN 7
      WHEN TIPVENTA = 110 AND TIPOFERTA = 3 THEN 8
      WHEN TIPVENTA = 110 AND TIPOFERTA = 41 THEN 9
      WHEN TIPVENTA = 110 AND TIPOFERTA = 38 THEN 10
      ELSE 11
    END AS PRIORIDADLEAD,
    CASE
      WHEN TIPVENTA = 6   AND TIPOFERTA = 3  AND CODCONDICIONCLIENTE IN ('APR','PRE') THEN 'LD APR'
      WHEN TIPVENTA = 6   AND TIPOFERTA = 3  AND CODCONDICIONCLIENTE = 'OPT' THEN 'LD OPT'
      WHEN TIPVENTA = 6   AND TIPOFERTA = 41 AND CODCONDICIONCLIENTE IN ('APR','PRE') THEN 'CDD APR'
      WHEN TIPVENTA = 6   AND TIPOFERTA = 38 AND CODCONDICIONCLIENTE IN ('APR','PRE') THEN 'REE APR'
      WHEN TIPVENTA = 6   AND TIPOFERTA IN (89,98) THEN 'LD SHD'
      WHEN TIPVENTA = 6   AND TIPOFERTA = 3  AND CODCONDICIONCLIENTE = 'INV' THEN 'LD INV'
      WHEN TIPVENTA = 6   AND TIPOFERTA = 187 THEN 'CDD INS'
      WHEN TIPVENTA = 110 AND TIPOFERTA = 3 THEN 'LD CONV'
      WHEN TIPVENTA = 110 AND TIPOFERTA = 41 THEN 'CDD CONV'
      WHEN TIPVENTA = 110 AND TIPOFERTA = 38 THEN 'REE CONV'
      ELSE 'OTRO'
    END AS LEAD_CEF
  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.HM_LEADS_BDI
  WHERE CODPAUTARBM <> 41
    AND TIPVENTA IN (6,110)
    AND DESCAMPANA NOT IN ('CREDITO PERSONAL, VENTA AMPLIACION PLAZO', 'VENTA SKIP')
    AND CODLOTEOFERTA BETWEEN 202501 AND 202512
),

LEADS_UNICOS AS (
  SELECT *
  FROM HM_LEADS_BDI_BASE
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY CODLOTEOFERTA, CODINTERNOCOMPUTACIONAL
    ORDER BY PRIORIDADLEAD ASC, FECINICIOVIGENCIA ASC
  ) = 1
),

BASE_FLAGS_LEAD AS (
  SELECT
    b.*,
    CASE
      WHEN b.LEAD_CEF_SOL IN ('REACTIVO','CONS APR','CONS CONV')
        THEN CASE WHEN c.CODINTERNOCOMPUTACIONAL IS NOT NULL THEN 1 ELSE 0 END
      ELSE CASE WHEN (m.CODINTERNOCOMPUTACIONAL IS NOT NULL OR c.CODINTERNOCOMPUTACIONAL IS NOT NULL) THEN 1 ELSE 0 END
    END AS FLG_CON_LEAD,
    CASE
      WHEN (
        CASE
          WHEN b.LEAD_CEF_SOL IN ('REACTIVO','CONS APR','CONS CONV')
            THEN CASE WHEN c.CODINTERNOCOMPUTACIONAL IS NOT NULL THEN 1 ELSE 0 END
          ELSE CASE WHEN (m.CODINTERNOCOMPUTACIONAL IS NOT NULL OR c.CODINTERNOCOMPUTACIONAL IS NOT NULL) THEN 1 ELSE 0 END
        END
      ) = 1 THEN 'CON_LEAD' ELSE 'SIN_LEAD'
    END AS TIPO_LEAD
  FROM BASE_FLAGS b
  LEFT JOIN LEADS_UNICOS m
    ON m.CODLOTEOFERTA = b.CODMESSOLICITUDEVALUACION
   AND TRIM(m.CODINTERNOCOMPUTACIONAL) = TRIM(b.CODINTERNOCOMPUTACIONAL)
   AND m.LEAD_CEF = b.LEAD_CEF_SOL
  LEFT JOIN LEADS_UNICOS c
    ON c.CODLOTEOFERTA = b.CODMESSOLICITUDEVALUACION
   AND TRIM(c.CODINTERNOCOMPUTACIONAL) = TRIM(b.CODINTERNOCOMPUTACIONAL)
)

SELECT
  CODMESSOLICITUDEVALUACION,
  DESCANALVENTARBM,
  TIPO_LEAD,
  COUNT(*) AS N_SOLICITUDES,
  SUM(FLG_APROBADO) AS CTD_APROBADAS,
  SUM(FLG_DENEGADO) AS CTD_DENEGADAS,
  SUM(FLG_REINGRESO_1M) AS CTD_REINGRESO_1M,
  SUM(FLG_DESEMBOLSADO) AS CTD_DESEMBOLSADAS,
  SUM(FLG_NODESEMBOLSADO) AS CTD_NO_DESEMBOLSADAS,
  SUM(FLG_APROBADO_CON_REINGRESO_1M_CON_DESEMBOLSO) AS CTD_APR_REING_CON_DES,
  SUM(FLG_APROBADO_CON_REINGRESO_1M_SIN_DESEMBOLSO) AS CTD_APR_REING_SIN_DES,
  SUM(FLG_APROBADO_SIN_REINGRESO_SIN_DESEMBOLSO) AS CTD_APR_SIN_REING_SIN_DES
FROM BASE_FLAGS_LEAD
WHERE CODMESSOLICITUDEVALUACION BETWEEN 202501 AND 202512
  AND DESCANALVENTARBM NOT IN ('SALEFORCE')
GROUP BY
  CODMESSOLICITUDEVALUACION,
  DESCANALVENTARBM,
  TIPO_LEAD
ORDER BY
  CODMESSOLICITUDEVALUACION,
  DESCANALVENTARBM,
  TIPO_LEAD;
