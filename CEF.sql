WITH
SOLICITUDES_CENTRALIZADO AS (
  SELECT
    MES AS CODMES,
    FECSOLICITUD,
    NROSOLICITUD AS CODSOLICITUD,
    PRODUCTO,
    DETPRODUCTO AS DESPRODUCTO,
    ESTADOFINAL,
    ETAPA,
    CANAL
  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_PLANCHON
),
M_SOLICITUDCREDITOCONSUMO AS (
  SELECT
    CODSOLICITUD,
    CODINTERNOCOMPUTACIONAL
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO
),
CLIENTES AS (
  SELECT
    A.CODMES,
    A.CODSOLICITUD,
    A.FECSOLICITUD,
    A.PRODUCTO,
    A.DESPRODUCTO,
    A.CANAL,
    A.ETAPA,
    A.ESTADOFINAL,
    B.CODINTERNOCOMPUTACIONAL
  FROM SOLICITUDES_CENTRALIZADO A
  LEFT JOIN M_SOLICITUDCREDITOCONSUMO B
    ON A.CODSOLICITUD = B.CODSOLICITUD
),

MARCADOS AS (
  SELECT
    CODMES,
    CODSOLICITUD,
    FECSOLICITUD,
    PRODUCTO,
    DESPRODUCTO,
    CANAL,
    ETAPA,
    CODINTERNOCOMPUTACIONAL,
    ESTADOFINAL,

    -- flag: tuvo alg√∫n rechazo previo en el mismo mes
    MAX(CASE WHEN ESTADOFINAL = 'RECHAZADO' THEN 1 ELSE 0 END) OVER (
      PARTITION BY CODINTERNOCOMPUTACIONAL, CODMES
      ORDER BY FECSOLICITUD, CODSOLICITUD
      ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
    ) AS FLAG_REINGRESO

  FROM CLIENTES
  WHERE CODINTERNOCOMPUTACIONAL IS NOT NULL
)

SELECT
  *,
  CASE
    WHEN ESTADOFINAL = 'APROBADO' AND FLAG_REINGRESO = 1 THEN 1
    ELSE 0
  END AS FLAG_APROBADO_REINGRESO
FROM MARCADOS
ORDER BY CODMES, CODINTERNOCOMPUTACIONAL, FECSOLICITUD;
