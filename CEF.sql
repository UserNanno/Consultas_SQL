AGG_CLIENTES AS (
  SELECT
    CODMES,
    DESCANALVENTARBM,
    DESTIPCLASIFRIESGO_PEOR,
    DESTIPCLASIFRIESGO_PEOR_ORD,

    /* ====== UNIDADES: DENEGADOS (cliente-mes) ====== */
    COUNT(DISTINCT CASE WHEN FLG_TUVO_DENEGADO = 1 THEN CODCLAVEPARTYCLI END) AS CTDCLIENTESDENEGADOS,
    COUNT(DISTINCT CASE WHEN FLG_TUVO_DENEGADO = 1 AND TIPO_LEAD='CON_LEAD' THEN CODCLAVEPARTYCLI END) AS CTDCLIENTESDENEGADOS_CON_LEAD,
    COUNT(DISTINCT CASE WHEN FLG_TUVO_DENEGADO = 1 AND TIPO_LEAD='SIN_LEAD' THEN CODCLAVEPARTYCLI END) AS CTDCLIENTESDENEGADOS_SIN_LEAD,

    /* ====== UNIDADES: APR SIN DESEMBOLSO (cliente-mes) ====== */
    COUNT(DISTINCT CASE WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1 THEN CODCLAVEPARTYCLI END) AS CTDCLIENTES_APR_SIN_DESEMBOLSO,
    COUNT(DISTINCT CASE WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1 AND TIPO_LEAD='CON_LEAD' THEN CODCLAVEPARTYCLI END) AS CTDCLIENTES_APR_SIN_DESEMBOLSO_CON_LEAD,
    COUNT(DISTINCT CASE WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1 AND TIPO_LEAD='SIN_LEAD' THEN CODCLAVEPARTYCLI END) AS CTDCLIENTES_APR_SIN_DESEMBOLSO_SIN_LEAD,

    /* ====== UNIDADES: “desembolso otro banco” por SBS regla ====== */
    COUNT(DISTINCT CASE
      WHEN FLG_TUVO_DENEGADO = 1
       AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1
      THEN CODCLAVEPARTYCLI END
    ) AS CTDCLIENTESDENEGADOS_SBS,

    COUNT(DISTINCT CASE
      WHEN FLG_TUVO_DENEGADO = 1
       AND TIPO_LEAD='CON_LEAD'
       AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1
      THEN CODCLAVEPARTYCLI END
    ) AS CTDCLIENTESDENEGADOS_CON_LEAD_SBS,

    COUNT(DISTINCT CASE
      WHEN FLG_TUVO_DENEGADO = 1
       AND TIPO_LEAD='SIN_LEAD'
       AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1
      THEN CODCLAVEPARTYCLI END
    ) AS CTDCLIENTESDENEGADOS_SIN_LEAD_SBS,

    COUNT(DISTINCT CASE
      WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1
       AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1
      THEN CODCLAVEPARTYCLI END
    ) AS CTDCLIENTES_APR_SIN_DESEMBOLSO_SBS,

    COUNT(DISTINCT CASE
      WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1
       AND TIPO_LEAD='CON_LEAD'
       AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1
      THEN CODCLAVEPARTYCLI END
    ) AS CTDCLIENTES_APR_SIN_DESEMBOLSO_CON_LEAD_SBS,

    COUNT(DISTINCT CASE
      WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1
       AND TIPO_LEAD='SIN_LEAD'
       AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1
      THEN CODCLAVEPARTYCLI END
    ) AS CTDCLIENTES_APR_SIN_DESEMBOLSO_SIN_LEAD_SBS,

    /* ====== MONTOS: suma del delta (cliente-mes) para los que cumplen regla SBS ====== */
    SUM(CASE
      WHEN FLG_TUVO_DENEGADO = 1
       AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1
      THEN DELTA_DEUDA_SBS_POS ELSE 0 END
    ) AS MTO_AUM_SBS_DENEGADOS,

    SUM(CASE
      WHEN FLG_TUVO_DENEGADO = 1
       AND TIPO_LEAD='CON_LEAD'
       AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1
      THEN DELTA_DEUDA_SBS_POS ELSE 0 END
    ) AS MTO_AUM_SBS_DENEGADOS_CON_LEAD,

    SUM(CASE
      WHEN FLG_TUVO_DENEGADO = 1
       AND TIPO_LEAD='SIN_LEAD'
       AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1
      THEN DELTA_DEUDA_SBS_POS ELSE 0 END
    ) AS MTO_AUM_SBS_DENEGADOS_SIN_LEAD,

    SUM(CASE
      WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1
       AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1
      THEN DELTA_DEUDA_SBS_POS ELSE 0 END
    ) AS MTO_AUM_SBS_APR_SIN_DESEMBOLSO,

    SUM(CASE
      WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1
       AND TIPO_LEAD='CON_LEAD'
       AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1
      THEN DELTA_DEUDA_SBS_POS ELSE 0 END
    ) AS MTO_AUM_SBS_APR_SIN_DESEMBOLSO_CON_LEAD,

    SUM(CASE
      WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1
       AND TIPO_LEAD='SIN_LEAD'
       AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1
      THEN DELTA_DEUDA_SBS_POS ELSE 0 END
    ) AS MTO_AUM_SBS_APR_SIN_DESEMBOLSO_SIN_LEAD

  FROM CLIENTE_MES_SBS
  GROUP BY
    CODMES,
    DESCANALVENTARBM,
    DESTIPCLASIFRIESGO_PEOR,
    DESTIPCLASIFRIESGO_PEOR_ORD
)

SELECT *
FROM AGG_CLIENTES
ORDER BY
  CODMES,
  DESCANALVENTARBM,
  DESTIPCLASIFRIESGO_PEOR_ORD;
