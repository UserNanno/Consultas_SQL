WITH base AS (
  SELECT
    CODMES,
    CODSOLICITUD,
    CENTROATENCION,
    CANAL,
    SEGMENTO,
    DESCAMPANIA,
    DESTIPRENTA,
    PRODUCTO,
    DESPRODUCTO,

    FLGAPROBADO,
    FLGDESEMBOLSADO,

    CAST(MTOSOLICITADO AS DECIMAL(25,6)) AS MTOSOL,
    CAST(MTOAPROBADO   AS DECIMAL(25,6)) AS MTOAPR,

    -- FECDESEMBOLSO: STRING -> DATE (ajusta formatos si conoces el exacto)
    COALESCE(
      TO_DATE(FECDESEMBOLSO, 'yyyy-MM-dd'),
      TO_DATE(FECDESEMBOLSO, 'dd/MM/yyyy'),
      TO_DATE(FECDESEMBOLSO)
    ) AS FEC_DESE_DATE,

    -- MTODESEMBOLSADO: STRING -> DECIMAL (robusto a separadores)
    CAST(
      REGEXP_REPLACE(
        REGEXP_REPLACE(COALESCE(MTODESEMBOLSADO,'0'), '\\.', ''), -- quita miles con punto
        ',', '.'                                                -- coma decimal -> punto
      )
      AS DECIMAL(25,6)
    ) AS MTO_DESE_DEC

  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_HM_SOLICITUDES_SCRM
  WHERE CENTROATENCION = 'CENTRALIZADO'
    AND CODMES BETWEEN '202510' AND '202602'
),

-- =========
-- (A) KPIs semanales (anclados a fecha de desembolso)
-- =========
kpi_semana AS (
  SELECT
    DATE_TRUNC('week', FEC_DESE_DATE) AS SEMANA_DESE,
    CONCAT(YEAR(FEC_DESE_DATE), '-W', LPAD(WEEKOFYEAR(FEC_DESE_DATE), 2, '0')) AS SEMANA_LABEL,

    -- Volumen total de solicitudes (en el universo filtrado)
    COUNT(DISTINCT CODSOLICITUD) AS N_SOL_TOTAL,

    -- Aprobados (del universo) - ojo: si FLGAPROBADO viene por fila única de solicitud ok
    SUM(CASE WHEN FLGAPROBADO = 1 THEN 1 ELSE 0 END) AS N_APR,

    -- Desembolsados (del universo) y su monto
    SUM(CASE WHEN FLGDESEMBOLSADO = 1 AND FEC_DESE_DATE IS NOT NULL THEN 1 ELSE 0 END) AS N_DESE,
    SUM(CASE WHEN FLGDESEMBOLSADO = 1 AND FEC_DESE_DATE IS NOT NULL THEN MTO_DESE_DEC ELSE 0 END) AS MTO_DESE,

    -- Tickets y montos aprobados/solicitados (solo referencia)
    SUM(CASE WHEN FLGAPROBADO = 1 THEN MTOAPR ELSE 0 END) AS MTO_APR_TOTAL,
    SUM(MTOSOL) AS MTO_SOL_TOTAL

  FROM base
  -- Para KPIs de desembolso semanal, necesitas semana definida:
  WHERE FEC_DESE_DATE IS NOT NULL
  GROUP BY DATE_TRUNC('week', FEC_DESE_DATE),
           CONCAT(YEAR(FEC_DESE_DATE), '-W', LPAD(WEEKOFYEAR(FEC_DESE_DATE), 2, '0'))
),

kpi_semana_delta AS (
  SELECT
    *,
    (MTO_DESE - LAG(MTO_DESE) OVER (ORDER BY SEMANA_DESE)) AS DELTA_MTO_DESE,

    -- Tasas
    (N_APR  * 1.0 / NULLIF(N_SOL_TOTAL,0)) AS TASA_APR,
    (N_DESE * 1.0 / NULLIF(N_APR,0))       AS TASA_DESE_POST,
    (MTO_DESE * 1.0 / NULLIF(N_DESE,0))    AS TICKET,

    -- Deltas de componentes
    (N_SOL_TOTAL - LAG(N_SOL_TOTAL) OVER (ORDER BY SEMANA_DESE)) AS DELTA_VOL,
    ((N_APR * 1.0 / NULLIF(N_SOL_TOTAL,0)) - LAG(N_APR * 1.0 / NULLIF(N_SOL_TOTAL,0)) OVER (ORDER BY SEMANA_DESE)) AS DELTA_TASA_APR,
    ((N_DESE * 1.0 / NULLIF(N_APR,0)) - LAG(N_DESE * 1.0 / NULLIF(N_APR,0)) OVER (ORDER BY SEMANA_DESE)) AS DELTA_TASA_DESE_POST,
    ((MTO_DESE * 1.0 / NULLIF(N_DESE,0)) - LAG(MTO_DESE * 1.0 / NULLIF(N_DESE,0)) OVER (ORDER BY SEMANA_DESE)) AS DELTA_TICKET
  FROM kpi_semana
),

-- =========
-- (B) Drivers: contribución al delta por dimensión (monto desembolsado)
-- =========
agg_dims AS (
  SELECT
    DATE_TRUNC('week', FEC_DESE_DATE) AS SEMANA_DESE,
    CONCAT(YEAR(FEC_DESE_DATE), '-W', LPAD(WEEKOFYEAR(FEC_DESE_DATE), 2, '0')) AS SEMANA_LABEL,

    'SEGMENTO'  AS DIM_TIPO, SEGMENTO    AS DIM,
    SUM(CASE WHEN FLGDESEMBOLSADO=1 THEN MTO_DESE_DEC ELSE 0 END) AS MTO_DESE
  FROM base
  WHERE FEC_DESE_DATE IS NOT NULL
  GROUP BY 1,2,3,4

  UNION ALL
  SELECT
    DATE_TRUNC('week', FEC_DESE_DATE),
    CONCAT(YEAR(FEC_DESE_DATE), '-W', LPAD(WEEKOFYEAR(FEC_DESE_DATE), 2, '0')),
    'CAMPANIA', DESCAMPANIA,
    SUM(CASE WHEN FLGDESEMBOLSADO=1 THEN MTO_DESE_DEC ELSE 0 END)
  FROM base
  WHERE FEC_DESE_DATE IS NOT NULL
  GROUP BY 1,2,3,4

  UNION ALL
  SELECT
    DATE_TRUNC('week', FEC_DESE_DATE),
    CONCAT(YEAR(FEC_DESE_DATE), '-W', LPAD(WEEKOFYEAR(FEC_DESE_DATE), 2, '0')),
    'TIPO_RENTA', DESTIPRENTA,
    SUM(CASE WHEN FLGDESEMBOLSADO=1 THEN MTO_DESE_DEC ELSE 0 END)
  FROM base
  WHERE FEC_DESE_DATE IS NOT NULL
  GROUP BY 1,2,3,4

  UNION ALL
  SELECT
    DATE_TRUNC('week', FEC_DESE_DATE),
    CONCAT(YEAR(FEC_DESE_DATE), '-W', LPAD(WEEKOFYEAR(FEC_DESE_DATE), 2, '0')),
    'CANAL', CANAL,
    SUM(CASE WHEN FLGDESEMBOLSADO=1 THEN MTO_DESE_DEC ELSE 0 END)
  FROM base
  WHERE FEC_DESE_DATE IS NOT NULL
  GROUP BY 1,2,3,4

  UNION ALL
  SELECT
    DATE_TRUNC('week', FEC_DESE_DATE),
    CONCAT(YEAR(FEC_DESE_DATE), '-W', LPAD(WEEKOFYEAR(FEC_DESE_DATE), 2, '0')),
    'PRODUCTO', COALESCE(DESPRODUCTO, PRODUCTO),
    SUM(CASE WHEN FLGDESEMBOLSADO=1 THEN MTO_DESE_DEC ELSE 0 END)
  FROM base
  WHERE FEC_DESE_DATE IS NOT NULL
  GROUP BY 1,2,3,4
),

delta_dims AS (
  SELECT
    *,
    (MTO_DESE - LAG(MTO_DESE) OVER (PARTITION BY DIM_TIPO, DIM ORDER BY SEMANA_DESE)) AS DELTA_DIM
  FROM agg_dims
),

delta_total AS (
  SELECT
    SEMANA_DESE,
    SUM(DELTA_DIM) AS DELTA_TOTAL
  FROM delta_dims
  GROUP BY SEMANA_DESE
),

ultima AS (SELECT MAX(SEMANA_DESE) AS SEMANA_MAX FROM kpi_semana)

-- =========
-- SALIDA 1: KPIs semanales (todas las semanas del rango)
-- =========
SELECT
  'KPI_SEMANA' AS SECCION,
  SEMANA_LABEL,
  SEMANA_DESE,

  N_SOL_TOTAL,
  N_APR,
  N_DESE,
  MTO_DESE,

  TASA_APR,
  TASA_DESE_POST,
  TICKET,

  DELTA_MTO_DESE,
  DELTA_VOL,
  DELTA_TASA_APR,
  DELTA_TASA_DESE_POST,
  DELTA_TICKET,

  CAST(NULL AS STRING)  AS DIM_TIPO,
  CAST(NULL AS STRING)  AS DIM,
  CAST(NULL AS DECIMAL(25,6)) AS DELTA_DIM,
  CAST(NULL AS DOUBLE)  AS CONTRIB_PCT

FROM kpi_semana_delta

UNION ALL

-- =========
-- SALIDA 2: Drivers (solo última semana vs anterior)
-- =========
SELECT
  'DRIVERS_ULT_SEMANA' AS SECCION,
  d.SEMANA_LABEL,
  d.SEMANA_DESE,

  CAST(NULL AS BIGINT) AS N_SOL_TOTAL,
  CAST(NULL AS BIGINT) AS N_APR,
  CAST(NULL AS BIGINT) AS N_DESE,
  CAST(NULL AS DECIMAL(25,6)) AS MTO_DESE,

  CAST(NULL AS DOUBLE) AS TASA_APR,
  CAST(NULL AS DOUBLE) AS TASA_DESE_POST,
  CAST(NULL AS DOUBLE) AS TICKET,

  t.DELTA_TOTAL AS DELTA_MTO_DESE,
  CAST(NULL AS DOUBLE) AS DELTA_VOL,
  CAST(NULL AS DOUBLE) AS DELTA_TASA_APR,
  CAST(NULL AS DOUBLE) AS DELTA_TASA_DESE_POST,
  CAST(NULL AS DOUBLE) AS DELTA_TICKET,

  d.DIM_TIPO,
  d.DIM,
  d.DELTA_DIM,
  (d.DELTA_DIM * 1.0 / NULLIF(t.DELTA_TOTAL,0)) AS CONTRIB_PCT

FROM delta_dims d
JOIN delta_total t
  ON d.SEMANA_DESE = t.SEMANA_DESE
JOIN ultima u
  ON d.SEMANA_DESE = u.SEMANA_MAX
WHERE d.DIM IS NOT NULL
ORDER BY SECCION, SEMANA_DESE DESC, ABS(DELTA_DIM) DESC;
