TP_COLABORADORANALISTA AS (
    SELECT
        CODMES,
        MATORGANICO,
        MATSUPERIOR,
        NBRAREAUNIDADORGANIZATIVA
    FROM (
        SELECT
            date_format(FECDIA, 'yyyyMM') AS CODMES,
            CODMATRICULA      AS MATORGANICO,
            CODMATRICULASUP   AS MATSUPERIOR,
            NBRAREAUNIDADORGANIZATIVA,
            ROW_NUMBER() OVER (
                PARTITION BY date_format(FECDIA, 'yyyyMM'), CODMATRICULA
                ORDER BY FECDIA DESC   -- última foto del mes
            ) AS rn
        FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_COLABORADOR
        WHERE DESTIPESTADOLABORAL = 'Activo'
    ) x
    WHERE rn = 1
),



TP_BASE_SOLICITUDES AS (
    SELECT
        ...
	    C.NBRAREAUNIDADORGANIZATIVA,
	    C.MATSUPERIOR
    FROM TP_BASESOLICITUDESAPPS A
    FULL OUTER JOIN TP_BASESOLICITUDESSALESFORCE B 
        ON (A.CODSOLICITUD = B.CODSOLICITUD)
    LEFT JOIN TP_COLABORADORANALISTA C 
        ON (C.CODMES = COALESCE(A.CODMES, B.CODMESEVALUACION) 
            AND C.MATORGANICO = COALESCE(A.MATANALISTA, B.MATRICULA))
    WHERE B.CODSOLICITUD IS NOT NULL
),








TP_COLABORADORVENDEDOR AS (
    SELECT
        FECDIA,
        date_format(FECDIA, 'yyyyMM') AS CODMES,
        CODMATRICULA AS MATORGANICO,
        CODMATRICULASUP AS MATSUPERIOR,
        NBRUNIDADORGANIZATIVA    AS NBRUNIDADORGANIZATIVAVENDEDOR,
        NBRAREAUNIDADORGANIZATIVA AS NBRAREAUNIDADORGANIZATIVAVENDEDOR,
        NBRSERVUNIDADORGANIZATIVA AS NBRSERVUNIDADORGANIZATIVAVENDEDOR
    FROM (
        SELECT
            FECDIA,
            CODMATRICULA,
            CODMATRICULASUP,
            NBRUNIDADORGANIZATIVA,
            NBRAREAUNIDADORGANIZATIVA,
            NBRSERVUNIDADORGANIZATIVA,
            ROW_NUMBER() OVER (
                PARTITION BY FECDIA, CODMATRICULA
                ORDER BY FECDIA DESC   -- por si acaso hay más de un registro ese día
            ) AS rn
        FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_COLABORADOR
        WHERE DESTIPESTADOLABORAL = 'Activo'
    ) x
    WHERE rn = 1
),









TP_BASE_UNION AS (
    SELECT 
        A.*,
        B.NBRUNIDADORGANIZATIVAVENDEDOR,
        B.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
        B.NBRSERVUNIDADORGANIZATIVAVENDEDOR,
        C.DESTIPRENTA,
        C.SEGMENTO,
        ROUND(date_diff(SECOND, A.FECHORSOLICITUD, A.FECHORDESEMBOLSO) / 3600, 2) AS TIEMPOATENCIONSOLICITUD,
        ROUND(date_diff(SECOND, A.FECHORSOLICITUD, A.FECHORINICIOEVALUACION) / 3600, 2) AS TIEMPODERIVACIONANALISTA,
        ROUND(date_diff(SECOND, A.FECHORINICIOEVALUACION, A.FECHORFINEVALUACION) / 3600, 2) AS TIEMPOATENCIONANALISTA,
        ROUND(date_diff(SECOND, A.FECHORFINEVALUACION, A.FECHORDESEMBOLSO) / 3600, 2) AS TIEMPODESEMBOLSOPOSTATENCIONANALISTA
    FROM TP_UNION A
    LEFT JOIN TP_COLABORADORVENDEDOR B 
        ON  A.FECSOLICITUD = B.FECDIA
        AND A.CODMATRICULACOLABORADORVENDEDOR = B.MATORGANICO
    LEFT JOIN TP_SOLICITUDINDIVIDUO C 
        ON A.CODSOLICITUD = C.CODSOLICITUD
),
