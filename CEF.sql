WITH
HD_CONSOLIDADOCAMPANIACRM AS (
  SELECT
    CODMESCAMPANIA,
    UPPER(TRIM(CODINTERNOCOMPUTACIONAL)) AS CODINTERNOCOMPUTACIONAL,
    DESPRODUCTOVENTACRM,
    DESTIPOFERTACRM,
    MTOOFERTASOL,
    TIPSEGMENTORIESGOSCORERBM,
    DESTIPSEGMENTORIESGOSCORERBM,
    FECRUTINA
  FROM CATALOG_LHCL_PROD_BCP.BCP_DDV_CRM_CAMPANIAMASIVA_VU.HD_CONSOLIDADOCAMPANIACRM
  WHERE CODMESCAMPANIA = 202602
    AND CODPRODUCTOVENTACRM = '0006'
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY CODMESCAMPANIA, UPPER(TRIM(CODINTERNOCOMPUTACIONAL))
    ORDER BY FECRUTINA DESC
  ) = 1
),
HM_SOLICITUDES_SCRM AS (
  SELECT
    CODMES, CODSOLICITUD, FECSOLICITUD, ESTADOSOLICITUD,
    MTOSOLICITADO, MTOAPROBADO, FECDESEMBOLSO, MTODESEMBOLSADO,
    CASE WHEN DESCAMPANIA IS NOT NULL THEN 1 ELSE 0 END AS FLGLEAD
  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_HM_SOLICITUDES_SCRM
  WHERE CODMES = 202602
    AND CENTROATENCION = 'CENTRALIZADO'
    AND DESTIPOPERACION = 'CREDITO CONSUMO'
),
M_SOLICITUDCREDITOCONSUMO AS (
  SELECT
    CODSOLICITUD,
    UPPER(TRIM(CODINTERNOCOMPUTACIONAL)) AS CODINTERNOCOMPUTACIONAL,
    CODCLAVEPARTYCLI
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO
),
TP_BASE AS (
  SELECT
    A.*,
    B.CODINTERNOCOMPUTACIONAL,
    B.CODCLAVEPARTYCLI
  FROM HM_SOLICITUDES_SCRM A
  LEFT JOIN M_SOLICITUDCREDITOCONSUMO B
    ON A.CODSOLICITUD = B.CODSOLICITUD
)
SELECT
  A.*,
  B.DESPRODUCTOVENTACRM,
  B.DESTIPOFERTACRM,
  B.MTOOFERTASOL,
  B.TIPSEGMENTORIESGOSCORERBM,
  B.DESTIPSEGMENTORIESGOSCORERBM,
  B.FECRUTINA
FROM TP_BASE A
LEFT JOIN HD_CONSOLIDADOCAMPANIACRM B
  ON A.CODMES = B.CODMESCAMPANIA
 AND A.CODINTERNOCOMPUTACIONAL = B.CODINTERNOCOMPUTACIONAL;
