CREATE OR REPLACE TABLE CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_UNIONWEEKLY
LOCATION 'abfss://bcp-edv-rbmbdn@adlscu1lhclbackp05.dfs.core.windows.net/T72496/TABLAS_DELTA/UNIONWEEKLY/'
AS
WITH
TP_BASESOLICITUDES AS (
	SELECT
		CODMES,
    	CODSOLICITUD,
    	MATANALISTA
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASESOLICITUDES
),
TP_SALESFORCEESTADOS AS (
	SELECT
    	CODSOLICITUD,
    	ESTADOSOLICITUD
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_SALESFORCEESTADOS
),
TP_SOLICITUDCREDITOCONSUMO AS (
	SELECT
		CODSOLICITUD,
		DESTIPEVALUACIONSOLICITUD,
		DESTIPESTADOSOLICITUD,
		DESTIPETAPA,
		DESTIPSOLICITUD AS TIPOPERACION,
		UPPER(TRANSLATE(DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		FECSOLICITUD,
		MTOSOLICITADO,
		(CASE
			WHEN NBRMONEDA LIKE '%SOL%' THEN 'SOLES'
			ELSE NULL
		END) AS NBRMONEDA,
		MTOAPROBADO,
		FECDESEMBOLSO,
		(CASE
			WHEN FECDESEMBOLSO IS NOT NULL THEN MTOAPROBADO
			ELSE NULL
		END) AS MTODESEMBOLSADO,
		FECINICIOCALIF,
		FECFINCALIF,
		CODINTERNOCOMPUTACIONAL
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO
),
TP_SOLICITUDTARJETACREDITO AS (
	SELECT
		CODSOLICITUD,
		DESTIPEVALUACIONSOLICITUD,
		DESTIPESTADOSOLICITUD,
		DESTIPETAPA,
		(CASE
			WHEN DESTIPFLUJOVENTATARJETACREDITO IN ('ADICIONAL', 'UPGRADE', 'AMPLIACION', 'BT', 'EP') THEN 'TARJETA CREDITO STOCK'
			ELSE 'TARJETA CREDITO NUEVA'
		END) AS TIPOPERACION,
		UPPER(TRANSLATE(DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		FECSOLICITUD,
		CODMATRICULACOLABORADORVENDEDOR,
		MTOSOLICITADO,
		(CASE
			WHEN NBRMONEDA LIKE '%SOL%' THEN 'SOLES'
			ELSE NULL
		END) AS NBRMONEDA,
		MTOAPROBADO,
		FECEMISIONTARJETACREDITO AS FECDESEMBOLSO,
		(CASE
			WHEN FECEMISIONTARJETACREDITO IS NOT NULL THEN MTOAPROBADO
			ELSE NULL
		END) AS MTODESEMBOLSADO,
		FECINICIOEVALUACION,
		FECFINEVALUACION,
		CODINTERNOCOMPUTACIONAL
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDTARJETACREDITO
	WHERE CODTIPREGAPP IN ('0126O000001xsIYQAY','0126O000001h0WaQAI','0126O000001h0WbQAI')
),
TP_DATA_SOLICITUDCREDITOCONSUMO AS (
	SELECT
		A.CODMES,
		A.CODSOLICITUD,
		B.DESTIPEVALUACIONSOLICITUD,
		B.TIPOPERACION,
		B.DESCAMPANIA,
		B.FECSOLICITUD,
		B.MTOSOLICITADO,
		B.NBRMONEDA,
		B.MTOAPROBADO,
		B.FECDESEMBOLSO,
		B.MTODESEMBOLSADO,
		C.ESTADOSOLICITUD,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'APROBADO' THEN 1
			ELSE 0
		END) AS FLGESTADOAPROBADO,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'RECHAZADO' THEN 1
			ELSE 0
		END) AS FLGESTADORECHAZADO,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'PENDIENTE' THEN 1
			ELSE 0
		END) AS FLGESTADOPENDIENTE,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'RECUPERADA' THEN 1
			ELSE 0
		END) AS FLGESTADORECUPERADO
	FROM TP_BASESOLICITUDES A
	INNER JOIN TP_SOLICITUDCREDITOCONSUMO B ON (A.CODSOLICITUD = B.CODSOLICITUD)
	INNER JOIN TP_SALESFORCEESTADOS C ON (A.CODSOLICITUD = C.CODSOLICITUD)
),
TP_DATA_SOLICITUDTARJETACREDITO AS (
	SELECT
		A.CODMES,
		A.CODSOLICITUD,
		B.DESTIPEVALUACIONSOLICITUD,
		B.TIPOPERACION,
		B.DESCAMPANIA,
		B.FECSOLICITUD,
		B.MTOSOLICITADO,
		B.NBRMONEDA,
		B.MTOAPROBADO,
		B.FECDESEMBOLSO,
		B.MTODESEMBOLSADO,
		C.ESTADOSOLICITUD,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'APROBADO' THEN 1
			ELSE 0
		END) AS FLGESTADOAPROBADO,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'RECHAZADO' THEN 1
			ELSE 0
		END) AS FLGESTADORECHAZADO,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'PENDIENTE' THEN 1
			ELSE 0
		END) AS FLGESTADOPENDIENTE,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'RECUPERADA' THEN 1
			ELSE 0
		END) AS FLGESTADORECUPERADO
	FROM TP_BASESOLICITUDES A
	INNER JOIN TP_SOLICITUDTARJETACREDITO B ON (A.CODSOLICITUD = B.CODSOLICITUD)
	INNER JOIN TP_SALESFORCEESTADOS C ON (A.CODSOLICITUD = C.CODSOLICITUD)
),
TP_BASE AS (
	SELECT * FROM TP_DATA_SOLICITUDCREDITOCONSUMO
	UNION ALL
	SELECT * FROM TP_DATA_SOLICITUDTARJETACREDITO
)
SELECT
	CODMES,
	COUNT(CODSOLICITUD) AS CTDSOLICITUDES,
	DESTIPEVALUACIONSOLICITUD,
	TIPOPERACION,
	DESCAMPANIA,
	FECSOLICITUD,
	SUM(MTOSOLICITADO) AS MTOSOLICITADO,
	NBRMONEDA,
	SUM(MTOAPROBADO) AS MTOAPROBADO,
	FECDESEMBOLSO,
	SUM(MTODESEMBOLSADO) AS MTODESEMBOLSADO,
	ESTADOSOLICITUD,
	FLGESTADOAPROBADO,
	FLGESTADORECHAZADO,
	FLGESTADOPENDIENTE,
	FLGESTADORECUPERADO
FROM TP_BASE
GROUP BY ALL;
