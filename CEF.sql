TP_BASE AS (
    SELECT
        CODMES,
        CODSOLICITUD,
        MATANALISTA,
        NBRAREAUNIDADORGANIZATIVAANALISTA,
        MATSUPERIOR,
        NBRAREAUNIDADORGANIZATIVAVENDEDOR,
        -- CANAL (igual que antes, usando las Ã¡reas del vendedor)
        CASE
            WHEN NBRAREAUNIDADORGANIZATIVAVENDEDOR IN (...) THEN 'ASESOR DE VENTAS Y SERVICIOS'
            ...
        END AS CANAL,
        DESTIPESTADOSOLICITUD,
        TIPOPERACION,
        DESTIPOPERACION,
        PRODUCTO,
        DESPRODUCTO,
        DESCAMPANIA,
        DESTIPEVALUACIONRIESGO,
        FECSOLICITUD,
        FECHORSOLICITUD,
        FECHORINICIOEVALUACION,
        FECHORFINEVALUACION,
        FECDESEMBOLSO,
        FECHORDESEMBOLSO,
        TIEMPOATENCIONSOLICITUD,
        TIEMPODERIVACIONANALISTA,
        TIEMPOATENCIONANALISTA,
        TIEMPODESEMBOLSOPOSTATENCIONANALISTA,
        NBRMONEDA,
        DESTIPRENTA,
        SEGMENTO,
        ESTADO_FINAL,
        MTOSOLICITADO,

        CASE
            WHEN ESTADO_FINAL = 'APROBADO' THEN MTOAPROBADO
            ELSE 0
        END AS MTOAPROBADO,

        CASE
            WHEN ESTADO_FINAL = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL THEN MTODESEMBOLSADO
            ELSE 0
        END AS MTODESEMBOLSADO,

        CASE
            WHEN ESTADO_FINAL = 'APROBADO' AND MTOSOLICITADO <> MTOAPROBADO THEN (MTOSOLICITADO - MTOAPROBADO)
            ELSE 0
        END AS MTORENEGOCIADO,

        CASE
            WHEN ESTADO_FINAL = 'RECHAZADO' THEN MTOSOLICITADO
            ELSE 0
        END AS MTODENEGADO,

        CASE
            WHEN ESTADO_FINAL = 'APROBADO' THEN
                CASE
                    WHEN FECDESEMBOLSO IS NULL THEN MTOAPROBADO
                    WHEN MTOAPROBADO > MTODESEMBOLSADO THEN MTOAPROBADO - MTODESEMBOLSADO
                    ELSE 0
                END
            ELSE 0
        END AS MTONODESEMBOLSADO,

        CENTROATENCION
    FROM TP_BASE_0
),
