A continuación se describe la lógica completa para la determinación de autonomías. Como punto de partida, los datos provienen de dos fuentes: df_estados_enriq, que constituye la base principal y puede contener múltiples registros por cada CODSOLICITUD, y df_productos_enriq, que funciona exclusivamente como respaldo y posee un único registro por solicitud. Todas las validaciones y reglas deben ejecutarse siempre priorizando la información contenida en df_estados_enriq; el uso de df_productos_enriq quedará restringido únicamente a los casos en que la información de la primera fuente no permita identificar adecuadamente al analista. Para complementar la lógica, se cuenta también con dos listas parametrizadas: una que identifica explícitamente las matrículas de gerentes (["U17293"]) y otra que agrupa las matrículas de supervisores (["U17560", "U13421", "S18795", "U18900", "E12624", "U23436"]). Asimismo, la clasificación del proceso entre TC y CEF se realiza a partir del campo PROCESO, el cual ya se encuentra normalizado en mayúsculas y sin tildes. Una solicitud se considera TC cuando PROCESO contiene el texto “APROBACION CREDITOS TC”, mientras que se considera CEF cuando PROCESO coincide con alguno de los valores “CO SOLICITUD APROBACIONES TLMK”, “SFCP APROBACIONES EDUCATIVO” o “CO SOLICITUD APROBACIONES”. Según esta clasificación, los pasos relevantes para cada tipo de producto se diferencian utilizando el campo NBRPASO, donde TC emplea los pasos “APROBACION DE CREDITOS ANALISTA”, “APROBACION DE CREDITOS SUPERVISOR” y “APROBACION DE CREDITOS GERENTE”, mientras que CEF utiliza “EVALUACION DE SOLICITUD” y “EVALUACION DE SOLICITUD APROBADOR”.
Una vez identificadas las reglas de clasificación del proceso, se procede con la determinación del MATANALISTA. Para ello, se filtran únicamente los registros relevantes dentro de df_estados_enriq: en CEF se considera el paso “EVALUACION DE SOLICITUD” y en TC el paso “APROBACION DE CREDITOS ANALISTA”. Cuando una solicitud presenta múltiples ocurrencias de estos pasos, es obligatorio seleccionar el registro más reciente, determinado por la mayor FECINICIOEVALUACION. A partir del registro seleccionado, se analiza inicialmente el campo NBRULTACTOR, el cual representa la matrícula que debería corresponder al analista real. No obstante, si este valor corresponde a una matrícula registrada en las listas de gerentes o supervisores, se debe validar también el campo NBRULTACTORPASO. Únicamente en el escenario en el que ambos campos contienen matrículas pertenecientes a supervisores o gerentes, se descarta la información proveniente de df_estados_enriq y el MATANALISTA se obtiene desde df_productos_enriq utilizando el campo NBRANALISTA. En cualquier otro caso, el valor proveniente de df_estados_enriq tiene prioridad. Una vez obtenido el MATANALISTA, este puede utilizarse posteriormente para derivar la matrícula del superior.
Posteriormente se calcula la MATAUTONOMIA, considerando únicamente los pasos de aprobación válidos según el tipo de producto. En CEF se utiliza el paso “EVALUACION DE SOLICITUD APROBADOR”, mientras que en TC se emplean “APROBACION DE CREDITOS SUPERVISOR” y “APROBACION DE CREDITOS GERENTE”. Como en las reglas anteriores, si una solicitud presenta múltiples registros de estos pasos, se debe seleccionar únicamente el más reciente. Una vez elegido el registro correcto, se analizan los campos NBRULTACTOR y NBRULTACTORPASO, evaluando sus matrículas contra las listas de gerentes y supervisores. Si ambos campos corresponden a un gerente, la autonomía se asigna al gerente; si ambos corresponden a un supervisor, la autonomía se asigna al supervisor. Cuando existe discrepancia entre los valores de ambos campos —ya sea porque uno pertenece a un nivel distinto o porque uno de ellos resulta ambiguo— la matrícula definitiva de la autonomía será la del campo NBRULTACTOR, pero marcando la solicitud con el indicador FLGAUTONOMIAOBSERVADA = 1, señalando que se requirió resolver una inconsistencia. Si ninguno de los dos actores pertenece a supervisor o gerente, la autonomía se asignará al nivel analista. En todos los casos debe generarse el campo NIVELAUTONOMIA, clasificando la autonomía como “GERENTE”, “SUPERVISOR” o “ANALISTA”, según corresponda. De igual manera, será obligatorio generar el indicador FLGAUTONOMIA, que tomará el valor 1 cuando la solicitud cuente con un paso válido de autonomía y 0 cuando no se haya encontrado ningún paso de dicho tipo.
Estas reglas fueron diseñadas para garantizar que tanto el MATANALISTA como la MATAUTONOMIA se asignen de manera consistente, precisa y priorizando siempre la información más confiable y reciente disponible en los registros. Además, aseguran que no se asignen matrículas incorrectas cuando los registros de estado contengan actores de niveles superiores. Para que el proceso funcione correctamente, la identificación de roles —ya sea gerente, supervisor o analista— es un componente fundamental, pues determina tanto la selección del actor válido como la correcta clasificación de la autonomía correspondiente.

Todo esto debe estar en un nuevo DF donde debe existir 1 registro por CODSOLICITUD
