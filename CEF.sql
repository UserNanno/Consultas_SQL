WITH
TP_TIPOCAMBIO AS (
	SELECT 3.81 AS TC_USD_SOL
),
TP_BASESOLICITUDESSALESFORCE AS (
	SELECT
		CODMESEVALUACION,
    	CODSOLICITUD,
    	MATRICULA,
    	ESTADOSOLICITUD,
    	DESTIPPRODUCTO,
    	DESPRODUCTO,
    	DESTIPETAPA
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_SALESFORCEBASESOLICITUDES
),
TP_BASESOLICITUDESAPPS AS (
	SELECT
		CODMES,
		CODSOLICITUD,
		MATANALISTA,
		RESULTADOANALISTA,
		PRODUCTO
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASESOLICITUDES
),
TP_ORGANICO AS (
	SELECT
		CODMES,
		MATORGANICO,
		MATSUPERIOR,
		NBRUNIDADORGANIZATIVA,
		NBRAREAUNIDADORGANIZATIVA,
		NBRSERVUNIDADORGANIZATIVA
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_ORGANICO
),
TP_COLABORADORANALISTA AS (
	SELECT
		CODMES,
    	MATORGANICO,
    	MATSUPERIOR,
    	NBRAREAUNIDADORGANIZATIVA
	FROM TP_ORGANICO
),
TP_BASE_SOLICITUDES AS (
	SELECT
		COALESCE(B.CODMESEVALUACION, A.CODMES) AS CODMES,
	    COALESCE(B.CODSOLICITUD, A.CODSOLICITUD) AS CODSOLICITUD,
	    (CASE 
	    	WHEN COALESCE(B.ESTADOSOLICITUD, A.RESULTADOANALISTA) = 'PENDIENTE' AND B.DESTIPETAPA = 'DESESTIMADA' THEN 'RECHAZADO'
	    	ELSE COALESCE(B.ESTADOSOLICITUD, A.RESULTADOANALISTA)
	    END) AS ESTADOSOLICITUD,
	    COALESCE(B.MATRICULA, A.MATANALISTA) AS MATANALISTA,
	    COALESCE(B.DESTIPPRODUCTO, A.PRODUCTO) AS PRODUCTO,
	    B.DESPRODUCTO,
	    B.DESTIPETAPA,
	    CASE 
	        WHEN A.CODSOLICITUD IS NOT NULL AND B.CODSOLICITUD IS NOT NULL THEN 'AMBOS'
	        WHEN B.CODSOLICITUD IS NOT NULL THEN 'SOLO_SF'
	    END AS ORIGEN,
	    C.NBRAREAUNIDADORGANIZATIVA,
	    C.MATSUPERIOR
	FROM TP_BASESOLICITUDESAPPS A
	FULL OUTER JOIN TP_BASESOLICITUDESSALESFORCE B ON (A.CODSOLICITUD = B.CODSOLICITUD)
	LEFT JOIN TP_COLABORADORANALISTA C ON (C.CODMES = COALESCE(A.CODMES, B.CODMESEVALUACION) AND C.MATORGANICO = COALESCE(A.MATANALISTA, B.MATRICULA))
	WHERE B.CODSOLICITUD IS NOT NULL
),
TP_COLABORADORVENDEDOR AS (
	SELECT
		CODMES,
		MATORGANICO,
    	NBRUNIDADORGANIZATIVA AS NBRUNIDADORGANIZATIVAVENDEDOR,
    	NBRAREAUNIDADORGANIZATIVA AS NBRAREAUNIDADORGANIZATIVAVENDEDOR,
    	NBRSERVUNIDADORGANIZATIVA AS NBRSERVUNIDADORGANIZATIVAVENDEDOR,
    	MATSUPERIOR
	FROM TP_ORGANICO
),
TP_SOLICITUDINDIVIDUO AS (
	SELECT
    	CODSOLICITUD,
    	(CASE
			WHEN CODSUBSEGMENTO IN ('X1N', 'X1E') THEN 'BEX'
			WHEN CODSUBSEGMENTO IN ('Q1N', 'Q1E') THEN 'PYME'
			WHEN CODSUBSEGMENTO IN ('P1N', 'P1E') THEN 'PRIVADA'
			WHEN CODSUBSEGMENTO IN ('NBN', 'NBE') THEN 'NO BANCO'
			WHEN CODSUBSEGMENTO IN ('M1N', 'M1E') THEN 'CONSUMO'
			WHEN CODSUBSEGMENTO IN ('LEN', 'LEE') THEN 'ENALTA'
			WHEN CODSUBSEGMENTO IN ('C1N', 'C1E') THEN 'NEGOCIOS'
			WHEN CODSUBSEGMENTO = 'G1N' THEN 'GREMIO 94'
			ELSE 'OTROS'
		END) AS SEGMENTO,
    	(CASE
			WHEN TIPRENTA = 5 THEN '5TA'
			WHEN TIPRENTA = 4 THEN '4TA'
			WHEN TIPRENTA = 3 THEN '3RA'
			WHEN TIPRENTA = 2 THEN '2DA'
			WHEN TIPRENTA = 1 THEN '1RA'
			ELSE 'OTROS'
		END) AS DESTIPRENTA
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDINDIVIDUO
	WHERE DESTIPROLSOLICITUD = 'TITULAR'
),
TP_SOLICITUDCREDITOCONSUMO AS (
	SELECT
		A.CODSOLICITUD,
		A.DESTIPESTADOSOLICITUD,
		A.DESTIPSOLICITUD AS TIPOPERACION,
		A.DESTIPSOLICITUD AS DESTIPOPERACION,
		(CASE
			WHEN A.CODPRODUCTO = 'EFME' THEN 'LIBRE DISPONIBILIDAD'
			WHEN A.CODPRODUCTO = 'EFCD' THEN 'COMPRA DEUDA'
			WHEN A.CODPRODUCTO = 'EFDP' THEN 'CONVENIO'
			ELSE 'OTROS'
		END) AS PRODUCTO,
		CAST(NULL AS STRING) AS DESPRODUCTO,
		UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		A.DESTIPEVALUACIONRIESGO,
		A.CODMATRICULACOLABORADORVENDEDOR,
		date_format(A.FECSOLICITUD, 'yyyyMM') AS CODMES,
		A.FECSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECSOLICITUD, LPAD(A.HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECINICIOCALIF, LPAD(A.HORINICIOCALIF, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORINICIOEVALUACION,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECFINCALIF, LPAD(A.HORFINCALIF, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORFINEVALUACION,
		(CASE
			WHEN A.NBRMONEDA LIKE '%SOL%' THEN 'SOLES'
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN 'DOLARES'
			ELSE NULL
		END) AS NBRMONEDA,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOSOLICITADO * B.TC_USD_SOL
			ELSE A.MTOSOLICITADO
		END) AS MTOSOLICITADO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
		A.FECDESEMBOLSO,
		TO_TIMESTAMP(CONCAT(A.FECDESEMBOLSO, ' 23:59:59'), 'yyyy-MM-dd HH:mm:ss') AS FECHORDESEMBOLSO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN
				(CASE
					WHEN A.FECDESEMBOLSO IS NOT NULL THEN A.MTOAPROBADO * B.TC_USD_SOL
					ELSE NULL 
				END)
            ELSE
            	(CASE
            		WHEN A.FECDESEMBOLSO IS NOT NULL THEN A.MTOAPROBADO 
            		ELSE NULL
            	END)
		END) AS MTODESEMBOLSADO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO A
	CROSS JOIN TP_TIPOCAMBIO B
),
TP_SOLICITUDTARJETACREDITO AS (
	SELECT
		A.CODSOLICITUD,
		A.DESTIPESTADOSOLICITUD,
		A.DESTIPSOLICITUD AS TIPOPERACION,
		(CASE
			WHEN A.DESTIPFLUJOVENTATARJETACREDITO IN ('ADICIONAL', 'AMPLIACION', 'EP', 'UPGRADE', 'BT') THEN 'TARJETA CREDITO STOCK'
			WHEN A.DESTIPFLUJOVENTATARJETACREDITO IN ('TC', 'SEGUNDA TC') THEN 'TARJETA CREDITO NUEVA'
			ELSE NULL
		END) AS DESTIPOPERACION,
		A.DESTIPFLUJOVENTATARJETACREDITO AS PRODUCTO,
		UPPER(A.DESPRODUCTO) AS DESPRODUCTO,
		UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		(CASE
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%100%%' THEN '100% APROBADO'
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%PREA%' THEN 'PREAPROBADO' -- [PREAPROBADO, PREAPROB, PREAPRO, PREAPR]
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%REACTIVO%' THEN 'REACTIVO'
			ELSE 'OTROS'
		END) AS DESTIPEVALUACIONRIESGO,
		A.CODMATRICULACOLABORADORVENDEDOR,
		date_format(A.FECSOLICITUD, 'yyyyMM') AS CODMES,
		A.FECSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECSOLICITUD, LPAD(A.HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECINICIOEVALUACION, LPAD(A.HORINICIOEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORINICIOEVALUACION,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECFINEVALUACION, LPAD(A.HORFINEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORFINEVALUACION,
		(CASE
			WHEN A.NBRMONEDA LIKE '%SOL%' THEN 'SOLES'
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN 'DOLARES'
			ELSE NULL
		END) AS NBRMONEDA,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOSOLICITADO * B.TC_USD_SOL
			ELSE A.MTOSOLICITADO
		END) AS MTOSOLICITADO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
		A.FECEMISIONTARJETACREDITO AS FECDESEMBOLSO,
		TO_TIMESTAMP(CONCAT(A.FECEMISIONTARJETACREDITO, ' 23:59:59'), 'yyyy-MM-dd HH:mm:ss') AS FECHORDESEMBOLSO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN
				(CASE
					WHEN A.FECEMISIONTARJETACREDITO IS NOT NULL THEN A.MTOAPROBADO * B.TC_USD_SOL
					ELSE NULL 
				END)
            ELSE
            	(CASE
            		WHEN A.FECEMISIONTARJETACREDITO IS NOT NULL THEN A.MTOAPROBADO 
            		ELSE NULL
            	END)
		END) AS MTODESEMBOLSADO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDTARJETACREDITO A
	CROSS JOIN TP_TIPOCAMBIO B
	WHERE A.CODTIPREGAPP IN ('0126O000001xsIYQAY','0126O000001h0WaQAI','0126O000001h0WbQAI')
),
TP_UNION AS (
	SELECT * FROM TP_SOLICITUDCREDITOCONSUMO
	UNION ALL
	SELECT * FROM TP_SOLICITUDTARJETACREDITO
),
TP_BASE_UNION AS (
	SELECT 
		A.*,
		B.NBRUNIDADORGANIZATIVAVENDEDOR,
		B.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
		B.NBRSERVUNIDADORGANIZATIVAVENDEDOR,
		C.DESTIPRENTA,
		C.SEGMENTO,
		ROUND(date_diff(SECOND, A.FECHORSOLICITUD, A.FECHORDESEMBOLSO) / 3600, 2) AS TIEMPOATENCIONSOLICITUD,
		ROUND(date_diff(SECOND, A.FECHORSOLICITUD, A.FECHORINICIOEVALUACION) / 3600, 2) AS TIEMPODERIVACIONANALISTA,
		ROUND(date_diff(SECOND, A.FECHORINICIOEVALUACION, A.FECHORFINEVALUACION) / 3600, 2) AS TIEMPOATENCIONANALISTA,
		ROUND(date_diff(SECOND, A.FECHORFINEVALUACION, A.FECHORDESEMBOLSO) / 3600, 2) AS TIEMPODESEMBOLSOPOSTATENCIONANALISTA
	FROM TP_UNION A
	LEFT JOIN TP_COLABORADORVENDEDOR B ON (A.CODMES = B.CODMES AND A.CODMATRICULACOLABORADORVENDEDOR = B.MATORGANICO)
	LEFT JOIN TP_SOLICITUDINDIVIDUO C ON (A.CODSOLICITUD = C.CODSOLICITUD)
),
