WITH SOL AS (
  SELECT
    A.CODMESEVALUACION,
    A.FECSOLICITUDEVALUACION,
    A.FECEVALUACION,
    A.DESCANALVENTARBMPER,
    A.TIPPRODUCTOSOLICITUDRBM,
    A.DESCANALVENTASOLICITUDRBM,
    A.DESTIPDECISIONRESULTADORBM,
    TRIM(regexp_replace(A.CODINTERNOCOMPUTACIONAL, '[\\n\\r\\t]', '')) AS CODINTERNOCOMPUTACIONAL,
    A.DESTIPDECISIONRESULTADOPRIORIZACION,
    A.DESCAMPANIASOLICITUD,
    A.DESTIPEVALUACIONSOLICITUDCREDITO,
    A.CODIDEVALUACION,
    A.CODEVALUACIONSOLICITUD,
    A.CODSECUENCIALDECISIONRBM,
    A.NUMSOLICITUDEVALUACION,
    CASE
      WHEN A.DESCANALVENTARBMPER = 'SALEFORCE' THEN SUBSTR(TRIM(A.NUMSOLICITUDEVALUACION), 5, 7)
      WHEN A.DESCANALVENTARBMPER = 'LOANS' THEN SUBSTR(TRIM(A.NUMSOLICITUDEVALUACION), 3, 8)
      ELSE TRIM(A.NUMSOLICITUDEVALUACION)
    END AS NUMSOLICITUDEVALUACIONCORTO,
    B.CODCLAVEPARTYCLI
  FROM CATALOG_LHCL_PROD_BCP.BCP_DDV_RBMRBMPER_MODELOGESTION_VU.MD_EVALUACIONSOLICITUDCREDITO A
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_CLIENTE B
    ON TRIM(regexp_replace(A.CODINTERNOCOMPUTACIONAL, '[\\n\\r\\t]', '')) = TRIM(B.CODINTERNOCOMPUTACIONAL)
  WHERE A.TIPPRODUCTOSOLICITUDRBM = 'CC'
    AND A.DESCANALVENTARBMPER NOT IN ('YAPE','OTROS')
    AND A.DESTIPDECISIONRESULTADORBM IN ('Approve','Decline','Investigate')
    AND A.CODINTERNOCOMPUTACIONAL IS NOT NULL
    AND TRIM(regexp_replace(A.CODINTERNOCOMPUTACIONAL, '[\\n\\r\\t]', '')) <> ''
),

SOL_NORM AS (
  SELECT
    s.*,
    CASE WHEN s.CODEVALUACIONSOLICITUD LIKE 'OP-%' THEN 1 ELSE 0 END AS FLG_OP_PREFIX,
    COALESCE(CAST(NULLIF(regexp_extract(s.CODEVALUACIONSOLICITUD,'([0-9]+)',1),'') AS BIGINT),-1) AS CODEVAL_NUM
  FROM SOL s
),

SOL_ORD AS (
  SELECT
    n.*,
    ROW_NUMBER() OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS RN_SOL,
    LAG(n.FECSOLICITUDEVALUACION) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS PREV_FECSOL,
    LAG(n.FLG_OP_PREFIX) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS PREV_FLG_OP,
    LAG(n.CODEVAL_NUM) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS PREV_CODEVAL_NUM,
    LAG(n.CODEVALUACIONSOLICITUD) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION,
        n.FLG_OP_PREFIX,
        n.CODEVAL_NUM,
        n.CODEVALUACIONSOLICITUD,
        n.CODSECUENCIALDECISIONRBM,
        n.CODIDEVALUACION
    ) AS PREV_CODEVAL_TXT
  FROM SOL_NORM n
),

SOL_REING AS (
  SELECT
    o.*,
    CASE
      WHEN o.PREV_FECSOL IS NULL THEN 0
      WHEN (
        o.FECSOLICITUDEVALUACION > o.PREV_FECSOL
        OR (
          o.FECSOLICITUDEVALUACION = o.PREV_FECSOL
          AND (
            o.FLG_OP_PREFIX > o.PREV_FLG_OP
            OR (o.FLG_OP_PREFIX = o.PREV_FLG_OP AND o.CODEVAL_NUM > o.PREV_CODEVAL_NUM)
            OR (o.FLG_OP_PREFIX = o.PREV_FLG_OP AND o.CODEVAL_NUM = o.PREV_CODEVAL_NUM AND o.CODEVALUACIONSOLICITUD > o.PREV_CODEVAL_TXT)
          )
        )
      )
      AND o.FECSOLICITUDEVALUACION <= add_months(o.PREV_FECSOL,1)
      THEN 1 ELSE 0
    END AS FLG_REINGRESO_1M
  FROM SOL_ORD o
),

VENTA AS (
  SELECT
    CAST(date_format(FECAPERTURA,'yyyyMM') AS INT) AS CODMESAPERTURA,
    CODSOLICITUD,
    CASE
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2) IN ('CX','DX') THEN SUBSTR(TRIM(CODSOLICITUD),3,8)
      WHEN CODSOLICITUD LIKE '2________' THEN SUBSTR(TRIM(CODSOLICITUD),3,7)
      WHEN CODSOLICITUD LIKE '      2________' THEN SUBSTR(TRIM(CODSOLICITUD),3,7)
      WHEN CODSOLICITUD LIKE 'O%' THEN SUBSTR(TRIM(CODSOLICITUD),3,7)
      ELSE TRIM(CODSOLICITUD)
    END AS CODSOLICITUDCORTO,
    CASE
      WHEN CODPRODUCTO='CPEFIA' THEN 'CUOTEALO'
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2)='PE' THEN 'CUOTEALO'
      WHEN CODPRODUCTO='CPEYAP' THEN 'YAPE'
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2)='YP' THEN 'YAPE'
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2)='JB' THEN 'BANCA MÓVIL'
      WHEN SUBSTR(TRIM(CODSOLICITUD),1,2) IN ('CX','DX') THEN 'LOANS'
      WHEN CODSOLICITUD LIKE '2________' THEN 'SALEFORCE'
      WHEN CODSOLICITUD LIKE '      2________' THEN 'SALEFORCE'
      WHEN CODSOLICITUD LIKE 'O%' THEN 'SALEFORCE'
      ELSE 'OTROS'
    END AS CANAL_MDPREST,
    FECAPERTURA,
    FECDESEMBOLSO,
    MTOORIGINALCREDITO,
    MTODESEMBOLSADO,
    CODCLAVEPARTYCLI
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_CUENTACREDITOPERSONAL
  WHERE CODPRODUCTO IN ('CPEEFM','CPECMC','CPEDPP','CPECEM','CPEECV','CPEGEN','CPEADH','CPEFIA')
    AND FLGREGELIMINADOFUENTE='N'
),

MATCH_ONE AS (
  SELECT *
  FROM (
    SELECT
      s.*,
      v.CODMESAPERTURA,
      v.CODSOLICITUD,
      v.CANAL_MDPREST,
      v.FECAPERTURA,
      v.MTOORIGINALCREDITO,
      v.MTODESEMBOLSADO,
      ROW_NUMBER() OVER (
        PARTITION BY s.CODINTERNOCOMPUTACIONAL, s.CODIDEVALUACION, s.CODEVALUACIONSOLICITUD
        ORDER BY ABS(datediff(v.FECAPERTURA,s.FECSOLICITUDEVALUACION)), v.FECAPERTURA
      ) AS RN_MATCH
    FROM SOL_REING s
    LEFT JOIN VENTA v
      ON s.CODCLAVEPARTYCLI = v.CODCLAVEPARTYCLI
     AND s.DESCANALVENTARBMPER = v.CANAL_MDPREST
     AND TRIM(s.NUMSOLICITUDEVALUACIONCORTO) = TRIM(v.CODSOLICITUDCORTO)
     AND datediff(v.FECAPERTURA,s.FECSOLICITUDEVALUACION) BETWEEN 0 AND 40
  ) x
  WHERE RN_MATCH = 1
),

BASE_FLAGS AS (
  SELECT
    m.CODEVALUACIONSOLICITUD,
    m.CODINTERNOCOMPUTACIONAL,
    m.CODCLAVEPARTYCLI,
    m.CODMESEVALUACION AS CODMESSOLICITUDEVALUACION,
    m.FECSOLICITUDEVALUACION,
    m.DESCANALVENTARBMPER AS DESCANALVENTARBM,
    m.DESTIPDECISIONRESULTADORBM,
    m.DESCAMPANIASOLICITUD,
    m.DESTIPEVALUACIONSOLICITUDCREDITO,
    m.CANAL_MDPREST,
    m.FLG_REINGRESO_1M,
    
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' THEN 1 ELSE 0 END AS FLG_APROBADO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM IN ('Decline','Investigate') THEN 1 ELSE 0 END AS FLG_DENEGADO,
    
    CASE WHEN m.DESTIPDECISIONRESULTADORBM IN ('Decline','Investigate') AND m.FLG_REINGRESO_1M = 1 THEN 1 ELSE 0 END AS FLG_DENEGADO_CON_REINGRESO_1M, -- SE VOLVIO A DENEGAR UNA SOLICITUD
    CASE WHEN m.DESTIPDECISIONRESULTADORBM IN ('Decline','Investigate') AND m.FLG_REINGRESO_1M = 0 THEN 1 ELSE 0 END AS FLG_DENEGADO_SIN_REINGRESO_1M, -- SE LE DENEGO Y NO VOLVIO A INGRESAR SOLICITUD
    
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FECAPERTURA IS NOT NULL THEN 1 ELSE 0 END AS FLG_DESEMBOLSADO, -- SE LE APRUEBA Y DESEMBOLSA
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FECAPERTURA IS NULL THEN 1 ELSE 0 END AS FLG_NODESEMBOLSADO, -- SE LE APRUEBA Y NO DESEMBOLSA
    
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FLG_REINGRESO_1M = 1 AND m.FECAPERTURA IS NOT NULL THEN 1 ELSE 0 END AS FLG_APROBADO_CON_REINGRESO_1M_CON_DESEMBOLSO, -- SE LE DENIEGA, DESPUES SE LE APRUEBA Y SE DESEMBOLSA
    
    -- ESTO SE BUSCA
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FLG_REINGRESO_1M = 1 AND m.FECAPERTURA IS NULL THEN 1 ELSE 0 END AS FLG_APROBADO_CON_REINGRESO_1M_SIN_DESEMBOLSO, -- DESPUES DE UNA SOLICITUD DENEGADA, SE LE APRUEBA PERO NO DESEMBOLSA
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FLG_REINGRESO_1M = 0 AND m.FECAPERTURA IS NULL THEN 1 ELSE 0 END AS FLG_APROBADO_SIN_REINGRESO_SIN_DESEMBOLSO -- DESPUES DE UNA SOLICITUD APROBADA, NO TIENE REINGRESO Y TAMPOCO DESEMBOLSA
    
    
--    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' THEN COALESCE(m.MTODESEMBOLSADO,0) ELSE 0 END AS MTODESEMBOLSADO,
--    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' THEN COALESCE(m.MTOORIGINALCREDITO,0) ELSE 0 END AS MTOORIGINALCREDITO,
--    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FLG_REINGRESO_1M=1 AND m.FECAPERTURA IS NOT NULL THEN COALESCE(m.MTODESEMBOLSADO,0) ELSE 0 END AS MTODESEMBOLSADO_REINGRESO_1M
  FROM MATCH_ONE m
),

SBS_DEUDA AS (
  SELECT
    CAST(date_format(FECDIA,'yyyyMM') AS INT) AS CODMESDEUDA,
    CODCLAVEPARTYCLI,
    SUM(MTODEUDASOL) AS MTODEUDASOL_SISTEMA
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_DEUDORSBSDETALLE
  WHERE CAST(date_format(FECDIA,'yyyyMM') AS INT) BETWEEN 202412 AND 202512
    AND NBREMPSISTEMAFINANCIERO NOT IN ('BANCO DE CREDITO DEL PERÚ')
  GROUP BY CAST(date_format(FECDIA,'yyyyMM') AS INT), CODCLAVEPARTYCLI
),

BASE_MESREF AS (
  SELECT
    b.*,
    CAST(date_format(add_months(to_date(concat(CAST(b.CODMESSOLICITUDEVALUACION AS STRING),'01'),'yyyyMMdd'),-1),'yyyyMM') AS INT) AS CODMES_SBS_MENOS_1,
    b.CODMESSOLICITUDEVALUACION AS CODMES_SBS_MES
  FROM BASE_FLAGS b
),
BASE_SBS AS (
  SELECT
    x.*,
    COALESCE(s1.MTODEUDASOL_SISTEMA,0) AS MTO_DEUDA_SBS_MES_MENOS_1,
    COALESCE(s2.MTODEUDASOL_SISTEMA,0) AS MTO_DEUDA_SBS_MES,
    COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) AS DELTA_DEUDA_SBS,
    CASE WHEN COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) > 0 THEN 1 ELSE 0 END AS FLG_AUMENTO_DEUDA_SBS, -- VERIFICAR SI ES POR INTERESES
    CASE WHEN COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) > 0 THEN COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) ELSE 0 END AS MTO_AUMENTO_DEUDA_SBS, -- VERIFICAR SI ES POR INTERESES
    CASE WHEN (COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0)) > 100 THEN 1 ELSE 0 END AS FLG_AUMENTO_DEUDA_SBS_REGLA,
    CASE WHEN (COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0)) > 100 THEN (COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0)) ELSE 0 END AS MTO_AUMENTO_DEUDA_SBS_REGLA
  FROM BASE_MESREF x
  LEFT JOIN SBS_DEUDA s1
    ON x.CODCLAVEPARTYCLI = s1.CODCLAVEPARTYCLI
   AND x.CODMES_SBS_MENOS_1 = s1.CODMESDEUDA
  LEFT JOIN SBS_DEUDA s2
    ON x.CODCLAVEPARTYCLI = s2.CODCLAVEPARTYCLI
   AND x.CODMES_SBS_MES = s2.CODMESDEUDA
)
  SELECT 
  CODMESSOLICITUDEVALUACION,
  DESCANALVENTARBM,
  --CANAL_MDPREST,
  --DESCAMPANIASOLICITUD,
  --DESTIPEVALUACIONSOLICITUDCREDITO,
  COUNT(*) AS N_SOLICITUDES,
  SUM(FLG_APROBADO) AS CTDSOLICITUDESAPROBADAS,
  SUM(FLG_DENEGADO) AS CTDSOLICITUDESDENEGADAS,
  SUM(FLG_REINGRESO_1M) AS CTDSOLICITUDESREINGRESADAS,
--  SUM(FLG_DENEGADO_CON_REINGRESO_1M) AS N_DENEG_REING_NO_VTA,
--  SUM(FLG_DENEGADO_SIN_REINGRESO_1M) AS N_DENEG_NOREING_NO_VTA,

  SUM(FLG_DESEMBOLSADO) AS CTDSOLICITUDESDESEMBOLSADAS,
  SUM(FLG_NODESEMBOLSADO) AS CTDSOLICITUDESNODESEMBOLSADAS,
  
  SUM(FLG_APROBADO_CON_REINGRESO_1M_CON_DESEMBOLSO) AS CTDSOLICITUDESAPROBADASDESEMBOLSADASREINGRESO,
  
  SUM(FLG_APROBADO_CON_REINGRESO_1M_SIN_DESEMBOLSO) AS CTDSOLICITUDESAPROBADASNODESEMBOLSADASREINGRESO,
  SUM(FLG_APROBADO_SIN_REINGRESO_SIN_DESEMBOLSO) AS CTDSOLICITUDESAPROBADASNODESEMBOLSADASSINREINGRESO,
  
--  SUM(MTODESEMBOLSADO) AS MTO_TOTAL_DESEMBOLSADO,
--  SUM(MTOORIGINALCREDITO) AS MTO_TOTAL_ORIGINAL,
--  SUM(MTODESEMBOLSADO_REINGRESO_1M) AS MTO_DESEMBOLSADO_REINGRESO_1M,
  SUM(FLG_AUMENTO_DEUDA_SBS_REGLA) AS CTDSOLICITUDESAUMENTARONDEUDASBS,
-- SUM(MTO_AUMENTO_DEUDA_SBS_REGLA) AS MTO_AUM_DEUDA_SBS_REGLA,

  SUM(CASE WHEN FLG_DENEGADO = 1 AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1) AS CTDSOLICITUDESDENEGADAS,
  SUM(CASE WHEN FLG_NODESEMBOLSADO = 1 AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1 THEN 1 ELSE 0 END) AS CTDSOLICITUDESNODESEMBOLSADASAUMENTARONDEUDASBS, --BASE DE DENEGADAS CON REINGRESO Y SIN VENTAS
  SUM(CASE WHEN FLG_NODESEMBOLSADO = 1 AND FLG_AUMENTO_DEUDA_SBS_REGLA = 0 THEN 1 ELSE 0 END) AS CTDSOLICITUDESNODESEMBOLSADASNOAUMENTARONDEUDASBS -- BASE DE DENEGADAS SIN REINGRESO Y SIN VENTA

  FROM BASE_SBS 
  WHERE CODMESSOLICITUDEVALUACION BETWEEN 202501 AND 202512 AND DESCANALVENTARBM NOT IN ('SALEFORCE')
  GROUP BY 
  CODMESSOLICITUDEVALUACION, DESCANALVENTARBM;
  --CANAL_MDPREST,
  --DESCAMPANIASOLICITUD,
  --DESTIPEVALUACIONSOLICITUDCREDITO;
