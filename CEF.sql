AHORA SI?
CREATE OR REPLACE TABLE CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_UNIONWEEKLY
LOCATION 'abfss://bcp-edv-rbmbdn@adlscu1lhclbackp05.dfs.core.windows.net/T72496/TABLAS_DELTA/UNIONWEEKLY/'
AS
WITH
TP_TIPOCAMBIO AS (
	SELECT 3.81 AS TC_USD_SOL
),
TP_BASESOLICITUDES AS (
	SELECT
		CODMES,
    	CODSOLICITUD,
    	MATANALISTA
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASESOLICITUDES
),
TP_COLABORADORANALISTA AS (
	SELECT
		CODMES,
    	MATORGANICO,
    	MATSUPERIOR
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_ORGANICO
),
TP_COLABORADORVENDEDOR AS (
	SELECT
		CODMES,
		MATORGANICO,
    	NBRUNIDADORGANIZATIVA AS NBRUNIDADORGANIZATIVAVENDEDOR,
    	NBRAREAUNIDADORGANIZATIVA AS NBRAREAUNIDADORGANIZATIVAVENDEDOR,
    	NBRSERVUNIDADORGANIZATIVA AS NBRSERVUNIDADORGANIZATIVAVENDEDOR,
    	MATSUPERIOR
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_ORGANICO
),
TP_SALESFORCEESTADOS AS (
	SELECT
    	CODSOLICITUD,
    	ESTADOSOLICITUD
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_SALESFORCEESTADOS
	WHERE ESTADOSOLICITUD IN ('APROBADO', 'RECHAZADO')
),
TP_SALESFORCEPRODUCTOS AS (
	SELECT
    	CODSOLICITUD,
    	PRODUCTO AS PRODUCTOSALESFORCE,
    	DESPRODUCTO AS DESPRODUCTOSALESFORCE,
    	ETAPA AS ETAPASALESFORCE
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_SALESFORCEPRODUCTOS
),
TP_SOLICITUDINDIVIDUO AS (
	SELECT
    	CODSOLICITUD,
    	TIPRENTA
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDINDIVIDUO
	WHERE DESTIPROLSOLICITUD = 'TITULAR'
),
TP_SOLICITUDCREDITOCONSUMO AS (
	SELECT
		A.CODSOLICITUD,
		A.DESTIPSOLICITUD AS TIPOPERACION,
		A.DESPRODUCTO AS DESTIPOPERACION,
		UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		A.DESTIPEVALUACIONRIESGO,
		A.CODMATRICULACOLABORADORVENDEDOR,
		A.FECSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECSOLICITUD, LPAD(A.HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECINICIOCALIF, LPAD(A.HORINICIOCALIF, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORINICIOEVALUACION,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECFINCALIF, LPAD(A.HORFINCALIF, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORFINEVALUACION,
		(CASE
			WHEN A.NBRMONEDA LIKE '%SOL%' THEN 'SOLES'
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN 'DOLARES'
			ELSE NULL
		END) AS NBRMONEDA,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOSOLICITADO * B.TC_USD_SOL
			ELSE A.MTOSOLICITADO
		END) AS MTOSOLICITADO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
		A.FECDESEMBOLSO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN
				(CASE
					WHEN A.FECDESEMBOLSO IS NOT NULL THEN A.MTOAPROBADO * B.TC_USD_SOL
					ELSE NULL 
				END)
            ELSE
            	(CASE
            		WHEN A.FECDESEMBOLSO IS NOT NULL THEN A.MTOAPROBADO 
            		ELSE NULL
            	END)
		END) AS MTODESEMBOLSADO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO A
	CROSS JOIN TP_TIPOCAMBIO B
),
TP_SOLICITUDTARJETACREDITO AS (
	SELECT
		A.CODSOLICITUD,
		(CASE
			WHEN A.DESTIPFLUJOVENTATARJETACREDITO IN ('ADICIONAL', 'UPGRADE', 'AMPLIACION', 'BT', 'EP') THEN 'TARJETA CREDITO STOCK'
			ELSE 'TARJETA CREDITO NUEVA'
		END) AS TIPOPERACION,
		A.DESTIPFLUJOVENTATARJETACREDITO AS DESTIPOPERACION,
		UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		(CASE
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%100%%' THEN '100% APROBADO'
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%PREAPROBADO%' THEN 'PREAPROBADO'
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%REACTIVO%' THEN 'REACTIVO'
			ELSE 'OTROS'
		END) AS DESTIPEVALUACIONRIESGO,
		A.CODMATRICULACOLABORADORVENDEDOR,
		A.FECSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECSOLICITUD, LPAD(A.HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECINICIOEVALUACION, LPAD(A.HORINICIOEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORINICIOEVALUACION,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECFINEVALUACION, LPAD(A.HORFINEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORFINEVALUACION,
		(CASE
			WHEN A.NBRMONEDA LIKE '%SOL%' THEN 'SOLES'
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN 'DOLARES'
			ELSE NULL
		END) AS NBRMONEDA,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOSOLICITADO * B.TC_USD_SOL
			ELSE A.MTOSOLICITADO
		END) AS MTOSOLICITADO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
		A.FECEMISIONTARJETACREDITO AS FECDESEMBOLSO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN
				(CASE
					WHEN A.FECEMISIONTARJETACREDITO IS NOT NULL THEN A.MTOAPROBADO * B.TC_USD_SOL
					ELSE NULL 
				END)
            ELSE
            	(CASE
            		WHEN A.FECEMISIONTARJETACREDITO IS NOT NULL THEN A.MTOAPROBADO 
            		ELSE NULL
            	END)
		END) AS MTODESEMBOLSADO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDTARJETACREDITO A
	CROSS JOIN TP_TIPOCAMBIO B
	WHERE A.CODTIPREGAPP IN ('0126O000001xsIYQAY','0126O000001h0WaQAI','0126O000001h0WbQAI')
),
TP_UNION AS (
	SELECT * FROM TP_SOLICITUDCREDITOCONSUMO
	UNION ALL
	SELECT * FROM TP_SOLICITUDTARJETACREDITO
),
TP_BASE AS (
	SELECT
		A.CODMES,
		A.CODSOLICITUD,
		A.MATANALISTA,
		E.MATSUPERIOR,
    	G.NBRUNIDADORGANIZATIVAVENDEDOR,
    	G.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
    	G.NBRSERVUNIDADORGANIZATIVAVENDEDOR,
		B.TIPOPERACION,
		COALESCE(B.DESTIPOPERACION, D.PRODUCTOSALESFORCE) AS DESTIPOPERACION,
		B.DESCAMPANIA,
		B.DESTIPEVALUACIONRIESGO,
		B.FECSOLICITUD,
		ROUND(date_diff(SECOND, B.FECHORSOLICITUD, B.FECDESEMBOLSO) / 3600, 2) AS HORASSOLICITUDTOTAL,
		ROUND(date_diff(SECOND, B.FECHORSOLICITUD, B.FECHORFINEVALUACION) / 3600, 2) AS HORASSOLICITUD,
		ROUND(date_diff(SECOND, B.FECHORINICIOEVALUACION, B.FECHORFINEVALUACION) / 3600, 2) AS HORASATENCION,
		B.MTOSOLICITADO,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'APROBADO' THEN B.MTOAPROBADO
			ELSE 0
		END) AS MTOAPROBADO,
		B.FECDESEMBOLSO,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'APROBADO' AND B.FECDESEMBOLSO IS NOT NULL THEN B.MTODESEMBOLSADO
			ELSE 0
		END) AS MTODESEMBOLSADO,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'APROBADO' AND B.MTOSOLICITADO <> B.MTOAPROBADO THEN (B.MTOSOLICITADO - B.MTOAPROBADO)
			ELSE 0
		END) AS MTORENEGOCIADO,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'RECHAZADO' THEN B.MTOSOLICITADO
			ELSE 0
		END) AS MTODENEGADO,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'APROBADO' AND B.FECDESEMBOLSO IS NULL THEN B.MTOAPROBADO
			ELSE 0
		END) AS MTONODESEMBOLSADO,
		C.ESTADOSOLICITUD,
		F.TIPRENTA
	FROM TP_BASESOLICITUDES A
	INNER JOIN TP_UNION B ON (A.CODSOLICITUD = B.CODSOLICITUD)
	INNER JOIN TP_SALESFORCEESTADOS C ON (A.CODSOLICITUD = C.CODSOLICITUD)
	LEFT JOIN TP_SALESFORCEPRODUCTOS D ON (A.CODSOLICITUD = D.CODSOLICITUD)
	INNER JOIN TP_COLABORADORANALISTA E ON (A.MATANALISTA = E.MATORGANICO AND A.CODMES = E.CODMES)
	LEFT JOIN TP_SOLICITUDINDIVIDUO F ON (A.CODSOLICITUD = F.CODSOLICITUD)
	LEFT JOIN TP_COLABORADORVENDEDOR G ON (B.CODMATRICULACOLABORADORVENDEDOR = G.MATORGANICO AND A.CODMES = G.CODMES)
),
TP_BASE_TIEMPOS AS (
	SELECT
		CODMES,
		CODSOLICITUD,
		MATANALISTA,
		MATSUPERIOR,
	    NBRUNIDADORGANIZATIVAVENDEDOR,
	    NBRAREAUNIDADORGANIZATIVAVENDEDOR,
	    NBRSERVUNIDADORGANIZATIVAVENDEDOR,
		TIPOPERACION,
		DESTIPOPERACION,
		DESCAMPANIA,
		DESTIPEVALUACIONRIESGO,
		FECSOLICITUD,
		MTOSOLICITADO,
		MTOAPROBADO,
		MTODENEGADO,
		MTORENEGOCIADO,
		FECDESEMBOLSO,
		MTODESEMBOLSADO,
		MTONODESEMBOLSADO,
		ESTADOSOLICITUD,
		TIPRENTA,
		(CASE
			WHEN HORASSOLICITUDTOTAL IS NULL THEN 'SIN DESEMBOLSO'
		    WHEN HORASSOLICITUDTOTAL <= 6 THEN '<= 6h'
		    WHEN HORASSOLICITUDTOTAL <= 12 THEN '<= 12h'
		    WHEN HORASSOLICITUDTOTAL <= 24 THEN '<= 24h'
	    	ELSE '> 24h'
		END) AS BRACKETSOLICITUDTOTAL,
		(CASE
			WHEN HORASSOLICITUD IS NULL THEN 'NA'
		    WHEN HORASSOLICITUD <= 6 THEN '<= 6h'
		    WHEN HORASSOLICITUD <= 12 THEN '<= 12h'
		    WHEN HORASSOLICITUD <= 24 THEN '<= 24h'
	    	ELSE '> 24h'
		END) AS BRACKETSOLICITUD,
		(CASE
			WHEN HORASATENCION IS NULL THEN 'NA'
		    WHEN HORASATENCION <= 6 THEN '<= 6h'
		    WHEN HORASATENCION <= 12 THEN '<= 12h'
		    WHEN HORASATENCION <= 24 THEN '<= 24h'
	    	ELSE '> 24h'
		END) AS BRACKETATENCION
	FROM TP_BASE
)
SELECT
	CODMES,
	MATANALISTA,
	MATSUPERIOR,
    NBRUNIDADORGANIZATIVAVENDEDOR,
    NBRAREAUNIDADORGANIZATIVAVENDEDOR,
    NBRSERVUNIDADORGANIZATIVAVENDEDOR,
	COUNT(CODSOLICITUD) AS CTDSOLICITUDES,
	TIPOPERACION,
	DESTIPOPERACION,
	DESCAMPANIA,
	DESTIPEVALUACIONRIESGO,
	FECSOLICITUD,
	SUM(MTOSOLICITADO) AS MTOSOLICITADO,
	SUM(MTOAPROBADO) AS MTOAPROBADO,
	SUM(MTODENEGADO) AS MTODENEGADO,
	SUM(MTORENEGOCIADO) AS MTORENEGOCIADO,
	FECDESEMBOLSO,
	SUM(MTODESEMBOLSADO) AS MTODESEMBOLSADO,
	SUM(MTONODESEMBOLSADO) AS MTONODESEMBOLSADO,
	ESTADOSOLICITUD,
	TIPRENTA,
	BRACKETSOLICITUDTOTAL,
	BRACKETSOLICITUD,
	BRACKETATENCION
FROM TP_BASE_TIEMPOS
GROUP BY 
	CODMES, MATANALISTA, MATSUPERIOR, NBRUNIDADORGANIZATIVAVENDEDOR, NBRAREAUNIDADORGANIZATIVAVENDEDOR,
	NBRSERVUNIDADORGANIZATIVAVENDEDOR, TIPOPERACION, DESTIPOPERACION, DESCAMPANIA, DESTIPEVALUACIONRIESGO, 
	FECSOLICITUD, FECDESEMBOLSO, ESTADOSOLICITUD, TIPRENTA, BRACKETSOLICITUDTOTAL, BRACKETSOLICITUD, BRACKETATENCION;
