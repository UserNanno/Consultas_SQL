WITH base_clean AS (
  SELECT
    CODMES,
    CODSOLICITUD,
    CENTROATENCION,
    CANAL,
    SEGMENTO,
    DESCAMPANIA,
    DESTIPRENTA,
    PRODUCTO,
    DESPRODUCTO,
    FECSOLICITUD,
    FLGAPROBADO,
    FLGDESEMBOLSADO,

    -- Fecha de desembolso (STRING -> DATE) robusta por patrones comunes
    CASE
      WHEN FECDESEMBOLSO RLIKE '^\\d{4}-\\d{2}-\\d{2}$' THEN TO_DATE(FECDESEMBOLSO, 'yyyy-MM-dd')
      WHEN FECDESEMBOLSO RLIKE '^\\d{2}/\\d{2}/\\d{4}$' THEN TO_DATE(FECDESEMBOLSO, 'dd/MM/yyyy')
      ELSE TO_DATE(FECDESEMBOLSO) -- último intento
    END AS FEC_DESE_DATE,

    -- Monto desembolsado (STRING -> DECIMAL)
    CAST(
      REGEXP_REPLACE(
        REGEXP_REPLACE(COALESCE(MTODESEMBOLSADO,'0'), '\\.', ''), -- quita miles con punto (1.234,56)
        ',', '.'                                                 -- coma decimal -> punto
      )
      AS DECIMAL(25,6)
    ) AS MTO_DESE_DEC

  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_HM_SOLICITUDES_SCRM
  WHERE CENTROATENCION = 'CENTRALIZADO'
    AND CODMES BETWEEN '202510' AND '202602'
),

-- =========================
-- (A) KPIs por semana del mes de SOLICITUD (cohorte)
-- SemanaMes = 1 (1-7), 2 (8-14), 3 (15-21), 4 (22-28), 5 (29-31)
-- =========================
cohorte AS (
  SELECT
    CODMES,
    FLOOR((DAY(FECSOLICITUD) - 1) / 7) + 1 AS SEMANA_MES_SOL,
    DATE_TRUNC('month', FECSOLICITUD) AS MES_SOL
  FROM base_clean
),
kpi_cohorte AS (
  SELECT
    b.CODMES,
    FLOOR((DAY(b.FECSOLICITUD) - 1) / 7) + 1 AS SEMANA_MES_SOL,
    CONCAT(b.CODMES, '-S', CAST(FLOOR((DAY(b.FECSOLICITUD) - 1) / 7) + 1 AS INT)) AS ETIQUETA_SEMANA,

    COUNT(DISTINCT b.CODSOLICITUD) AS N_SOL,
    SUM(CASE WHEN b.FLGAPROBADO = 1 THEN 1 ELSE 0 END) AS N_APR,

    -- desembolsados de esa cohorte (aunque el desembolso haya sido después)
    SUM(CASE WHEN b.FLGDESEMBOLSADO = 1 THEN 1 ELSE 0 END) AS N_DESE,
    SUM(CASE WHEN b.FLGDESEMBOLSADO = 1 THEN b.MTO_DESE_DEC ELSE 0 END) AS MTO_DESE,

    -- tasas útiles
    (SUM(CASE WHEN b.FLGAPROBADO = 1 THEN 1 ELSE 0 END) * 1.0 / NULLIF(COUNT(DISTINCT b.CODSOLICITUD),0)) AS TASA_APR_COHORTE,
    (SUM(CASE WHEN b.FLGDESEMBOLSADO = 1 THEN 1 ELSE 0 END) * 1.0 / NULLIF(SUM(CASE WHEN b.FLGAPROBADO = 1 THEN 1 ELSE 0 END),0)) AS TASA_DESE_POST_COHORTE,
    (SUM(CASE WHEN b.FLGDESEMBOLSADO = 1 THEN b.MTO_DESE_DEC ELSE 0 END) * 1.0 / NULLIF(SUM(CASE WHEN b.FLGDESEMBOLSADO = 1 THEN 1 ELSE 0 END),0)) AS TICKET_COHORTE

  FROM base_clean b
  GROUP BY
    b.CODMES,
    FLOOR((DAY(b.FECSOLICITUD) - 1) / 7) + 1,
    CONCAT(b.CODMES, '-S', CAST(FLOOR((DAY(b.FECSOLICITUD) - 1) / 7) + 1 AS INT))
),

kpi_cohorte_delta AS (
  SELECT
    *,
    (MTO_DESE - LAG(MTO_DESE) OVER (ORDER BY CODMES, SEMANA_MES_SOL)) AS DELTA_MTO_DESE
  FROM kpi_cohorte
),

-- =========================
-- (B) Drivers por semana del mes de DESEMBOLSO (evento)
-- =========================
base_dese AS (
  SELECT
    *,
    DATE_TRUNC('month', FEC_DESE_DATE) AS MES_DESE,
    FLOOR((DAY(FEC_DESE_DATE) - 1) / 7) + 1 AS SEMANA_MES_DESE,
    DATE_ADD(DATE_TRUNC('month', FEC_DESE_DATE), (FLOOR((DAY(FEC_DESE_DATE) - 1) / 7) * 7)) AS SEMANA_DESE_INI
  FROM base_clean
  WHERE FLGDESEMBOLSADO = 1
    AND FEC_DESE_DATE IS NOT NULL
),

agg_dims AS (
  -- SEGMENTO
  SELECT
    DATE_FORMAT(MES_DESE, 'yyyyMM') AS CODMES_DESE,
    SEMANA_MES_DESE,
    SEMANA_DESE_INI,
    CONCAT(DATE_FORMAT(MES_DESE, 'yyyyMM'), '-S', CAST(SEMANA_MES_DESE AS INT)) AS ETIQUETA_SEMANA,
    'SEGMENTO' AS DIM_TIPO,
    SEGMENTO AS DIM,
    SUM(MTO_DESE_DEC) AS MTO_DESE
  FROM base_dese
  GROUP BY 1,2,3,4,5,6

  UNION ALL
  -- CAMPANIA
  SELECT
    DATE_FORMAT(MES_DESE, 'yyyyMM'),
    SEMANA_MES_DESE,
    SEMANA_DESE_INI,
    CONCAT(DATE_FORMAT(MES_DESE, 'yyyyMM'), '-S', CAST(SEMANA_MES_DESE AS INT)),
    'CAMPANIA',
    DESCAMPANIA,
    SUM(MTO_DESE_DEC)
  FROM base_dese
  GROUP BY 1,2,3,4,5,6

  UNION ALL
  -- TIPO RENTA
  SELECT
    DATE_FORMAT(MES_DESE, 'yyyyMM'),
    SEMANA_MES_DESE,
    SEMANA_DESE_INI,
    CONCAT(DATE_FORMAT(MES_DESE, 'yyyyMM'), '-S', CAST(SEMANA_MES_DESE AS INT)),
    'TIPO_RENTA',
    DESTIPRENTA,
    SUM(MTO_DESE_DEC)
  FROM base_dese
  GROUP BY 1,2,3,4,5,6

  UNION ALL
  -- CANAL
  SELECT
    DATE_FORMAT(MES_DESE, 'yyyyMM'),
    SEMANA_MES_DESE,
    SEMANA_DESE_INI,
    CONCAT(DATE_FORMAT(MES_DESE, 'yyyyMM'), '-S', CAST(SEMANA_MES_DESE AS INT)),
    'CANAL',
    CANAL,
    SUM(MTO_DESE_DEC)
  FROM base_dese
  GROUP BY 1,2,3,4,5,6

  UNION ALL
  -- PRODUCTO (usa DESPRODUCTO si existe)
  SELECT
    DATE_FORMAT(MES_DESE, 'yyyyMM'),
    SEMANA_MES_DESE,
    SEMANA_DESE_INI,
    CONCAT(DATE_FORMAT(MES_DESE, 'yyyyMM'), '-S', CAST(SEMANA_MES_DESE AS INT)),
    'PRODUCTO',
    COALESCE(DESPRODUCTO, PRODUCTO),
    SUM(MTO_DESE_DEC)
  FROM base_dese
  GROUP BY 1,2,3,4,5,6
),

delta_dims AS (
  SELECT
    *,
    (MTO_DESE - LAG(MTO_DESE) OVER (PARTITION BY DIM_TIPO, DIM ORDER BY SEMANA_DESE_INI)) AS DELTA_DIM
  FROM agg_dims
),

delta_total AS (
  SELECT
    SEMANA_DESE_INI,
    SUM(DELTA_DIM) AS DELTA_TOTAL
  FROM delta_dims
  GROUP BY SEMANA_DESE_INI
)

-- =========================
-- OUTPUT: KPIs + Drivers (última semana disponible)
-- =========================
SELECT
  'KPI_COHORTE_SOLICITUD' AS SECCION,
  CODMES,
  ETIQUETA_SEMANA,
  SEMANA_MES_SOL AS SEMANA_MES,

  N_SOL,
  N_APR,
  N_DESE,
  MTO_DESE,

  TASA_APR_COHORTE   AS TASA_APR,
  TASA_DESE_POST_COHORTE AS TASA_DESE_POST,
  TICKET_COHORTE     AS TICKET,

  DELTA_MTO_DESE,

  CAST(NULL AS STRING) AS DIM_TIPO,
  CAST(NULL AS STRING) AS DIM,
  CAST(NULL AS DECIMAL(25,6)) AS DELTA_DIM,
  CAST(NULL AS DOUBLE) AS CONTRIB_PCT

FROM kpi_cohorte_delta

UNION ALL

SELECT
  'DRIVERS_ULT_SEMANA_DESE' AS SECCION,
  d.CODMES_DESE AS CODMES,
  d.ETIQUETA_SEMANA,
  d.SEMANA_MES_DESE AS SEMANA_MES,

  CAST(NULL AS BIGINT) AS N_SOL,
  CAST(NULL AS BIGINT) AS N_APR,
  CAST(NULL AS BIGINT) AS N_DESE,
  CAST(NULL AS DECIMAL(25,6)) AS MTO_DESE,

  CAST(NULL AS DOUBLE) AS TASA_APR,
  CAST(NULL AS DOUBLE) AS TASA_DESE_POST,
  CAST(NULL AS DOUBLE) AS TICKET,

  t.DELTA_TOTAL AS DELTA_MTO_DESE,

  d.DIM_TIPO,
  d.DIM,
  d.DELTA_DIM,
  (d.DELTA_DIM * 1.0 / NULLIF(t.DELTA_TOTAL,0)) AS CONTRIB_PCT

FROM delta_dims d
JOIN delta_total t
  ON d.SEMANA_DESE_INI = t.SEMANA_DESE_INI
WHERE d.DIM IS NOT NULL
  AND d.SEMANA_DESE_INI = (SELECT MAX(SEMANA_DESE_INI) FROM delta_dims)
ORDER BY SECCION, CODMES DESC, SEMANA_MES DESC, ABS(DELTA_DIM) DESC;
