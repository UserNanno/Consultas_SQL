WITH
TP_TIPOCAMBIO AS (
 SELECT 3.81 AS TC_USD_SOL
),
BASE_PDC AS (
 SELECT
   CODMES,
   CODSOLICITUD,
   ESTADOFINAL,
   FLGCAMPANIA
 FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASE_PDC
 WHERE TIPOPERACION = 'CREDITO CONSUMO NUEVO'
   AND ESTADOFINAL IN ('ACEPTADAS', 'DENEGADAS')
   AND CODMES BETWEEN 202501 AND 202512
),
M_SOLICITUDCREDITOCONSUMO AS (
 SELECT
   A.CODSOLICITUD,
   A.CODCLAVEPARTYCLI,
   (CASE WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOSOLICITADO * B.TC_USD_SOL ELSE A.MTOSOLICITADO END) AS MTOSOLICITADO
 FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO A
 CROSS JOIN TP_TIPOCAMBIO B
),
BASE AS (
 SELECT
   p.CODMES,
   p.CODSOLICITUD,
   p.ESTADOFINAL,
   COALESCE(p.FLGCAMPANIA,0) AS FLGCAMPANIA,
   s.CODCLAVEPARTYCLI,
   s.MTOSOLICITADO
 FROM BASE_PDC p
 LEFT JOIN M_SOLICITUDCREDITOCONSUMO s
   ON p.CODSOLICITUD = s.CODSOLICITUD
),
CLIENTE_MES_DENEG AS (
 SELECT
   CODMES,
   CODCLAVEPARTYCLI,
   MAX(CASE WHEN ESTADOFINAL='DENEGADAS' AND FLGCAMPANIA=1 THEN 1 ELSE 0 END) AS FLG_DENE_CON_LEAD,
   MAX(CASE WHEN ESTADOFINAL='DENEGADAS' AND FLGCAMPANIA=0 THEN 1 ELSE 0 END) AS FLG_DENE_SIN_LEAD,
   MAX(COALESCE(MTOSOLICITADO,0)) AS MTO_SOL_MAX
 FROM BASE
 WHERE ESTADOFINAL = 'DENEGADAS'
   AND CODCLAVEPARTYCLI IS NOT NULL
 GROUP BY CODMES, CODCLAVEPARTYCLI
),
SBS AS (
 SELECT
   CAST(date_format(FECDIA,'yyyyMM') AS INT) AS CODMESDEUDA,
   CODCLAVEPARTYCLI,
   SUM(MTODEUDASOL) AS MTODEUDASOL_SISTEMA,
   MAX(
     CASE
       WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('NORMAL') THEN 1
       WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('CON PROBLEMAS POTENCIALES(CPP)','CPP','CON PROBLEMAS POTENCIALES (CPP)') THEN 2
       WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('DEFICIENTE') THEN 3
       WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('DUDOSO') THEN 4
       WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('PERDIDA','PÃ‰RDIDA') THEN 5
       ELSE 0
     END
   ) AS RIESGO_PEOR_ORD
 FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_DEUDORSBSDETALLE
 WHERE UPPER(TRIM(NBREMPSISTEMAFINANCIERO)) NOT LIKE 'BANCO DE CREDITO DEL PER%'
   AND UPPER(TRIM(DESCTACONTABLESBS)) NOT LIKE '%TARJET%'
   AND DESTIPCREDITO IN ('CREDITO DE CONSUMO NO REVOLVENTE','CREDITO HIPOTECARIOS PARA VIVIENDA')
 GROUP BY CAST(date_format(FECDIA,'yyyyMM') AS INT), CODCLAVEPARTYCLI
),
CLIENTE_MES_SBS AS (
 SELECT
   c.*,
   COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) AS DELTA_DEUDA_SBS,
   GREATEST(COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0), 0) AS DELTA_DEUDA_SBS_POS,
   COALESCE(s2.RIESGO_PEOR_ORD,0) AS DESTIPCLASIFRIESGO_PEOR_ORD,
   CASE COALESCE(s2.RIESGO_PEOR_ORD,0)
     WHEN 1 THEN 'NORMAL'
     WHEN 2 THEN 'CON PROBLEMAS POTENCIALES(CPP)'
     WHEN 3 THEN 'DEFICIENTE'
     WHEN 4 THEN 'DUDOSO'
     WHEN 5 THEN 'PERDIDA'
     ELSE 'SIN INFO'
   END AS DESTIPCLASIFRIESGO_PEOR
 FROM CLIENTE_MES_DENEG c
 LEFT JOIN SBS s1
   ON c.CODCLAVEPARTYCLI = s1.CODCLAVEPARTYCLI
  AND CAST(date_format(add_months(to_date(concat(CAST(c.CODMES AS STRING),'01'),'yyyyMMdd'),-1),'yyyyMM') AS INT) = s1.CODMESDEUDA
 LEFT JOIN SBS s2
   ON c.CODCLAVEPARTYCLI = s2.CODCLAVEPARTYCLI
  AND c.CODMES = s2.CODMESDEUDA
),
AGG_CLIENTES AS (
 SELECT
   CODMES,
   DESTIPCLASIFRIESGO_PEOR,
   DESTIPCLASIFRIESGO_PEOR_ORD,
   COUNT(DISTINCT CASE WHEN FLG_DENE_CON_LEAD = 1 THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_DENEG_CON_LEAD,
   COUNT(DISTINCT CASE WHEN FLG_DENE_SIN_LEAD = 1 THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_DENEG_SIN_LEAD,
   COUNT(DISTINCT CASE
     WHEN FLG_DENE_CON_LEAD = 1 AND MTO_SOL_MAX > 0 AND DELTA_DEUDA_SBS >= 0.50 * MTO_SOL_MAX
     THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_DENEG_CON_LEAD_SBS_50PCT,
   COUNT(DISTINCT CASE
     WHEN FLG_DENE_SIN_LEAD = 1 AND MTO_SOL_MAX > 0 AND DELTA_DEUDA_SBS >= 0.50 * MTO_SOL_MAX
     THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_DENEG_SIN_LEAD_SBS_50PCT,
   SUM(CASE
     WHEN FLG_DENE_CON_LEAD = 1 AND MTO_SOL_MAX > 0 AND DELTA_DEUDA_SBS >= 0.50 * MTO_SOL_MAX
     THEN DELTA_DEUDA_SBS_POS ELSE 0 END) AS MTO_AUM_SBS_CON_LEAD_50PCT,
   SUM(CASE
     WHEN FLG_DENE_SIN_LEAD = 1 AND MTO_SOL_MAX > 0 AND DELTA_DEUDA_SBS >= 0.50 * MTO_SOL_MAX
     THEN DELTA_DEUDA_SBS_POS ELSE 0 END) AS MTO_AUM_SBS_SIN_LEAD_50PCT
 FROM CLIENTE_MES_SBS
 GROUP BY CODMES, DESTIPCLASIFRIESGO_PEOR, DESTIPCLASIFRIESGO_PEOR_ORD
)
SELECT *
FROM AGG_CLIENTES
ORDER BY CODMES, DESTIPCLASIFRIESGO_PEOR_ORD;



No te olvides de agregarle lo del DESTIPCLASIFRIESGO_PEOR
