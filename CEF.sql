WITH
TP_TIPOCAMBIO AS (
  SELECT 3.81 AS TC_USD_SOL
),

BASE_CENTRALIZADO AS (
  SELECT
    CODMES,
    CODSOLICITUD,
    ESTADOFINAL,
    FLGCAMPANIA,
    FLGCASTIGONUEVO,
    FLGDESEMBOLSO,
    (CASE WHEN FLGCAMPANIA = 'Con Campania' THEN 1 ELSE 0 END) AS FLGCAMPANIAORD,
    (CASE WHEN FLGCASTIGONUEVO = 'Con Castigo' THEN 1 ELSE 0 END) AS FLGCASTIGOORD,
    (CASE WHEN FLGDESEMBOLSO = 'Desembolsado' THEN 1 ELSE 0 END) AS FLGDESEMBOLSOORD
  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASE_DESEMBOLSOS_CENTRALIZADO
  WHERE TIPOPERACION = 'Credito Consumo Nuevo'
    AND ESTADOFINAL IN ('ACEPTADAS', 'DENEGADAS')
    AND CODMES BETWEEN 202501 AND 202512
),

M_SOLICITUDCREDITOCONSUMO AS (
  SELECT
    A.CODSOLICITUD,
    A.CODCLAVEPARTYCLI,
    (CASE WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOSOLICITADO * B.TC_USD_SOL ELSE A.MTOSOLICITADO END) AS MTOSOLICITADO,
    (CASE WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOAPROBADO   * B.TC_USD_SOL ELSE A.MTOAPROBADO   END) AS MTOAPROBADO
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO A
  CROSS JOIN TP_TIPOCAMBIO B
),

BASE AS (
  SELECT
    c.CODMES,
    c.CODSOLICITUD,
    c.ESTADOFINAL,
    c.FLGCAMPANIAORD,
    c.FLGCASTIGOORD,
    c.FLGDESEMBOLSOORD,
    s.CODCLAVEPARTYCLI,
    COALESCE(s.MTOSOLICITADO,0) AS MTOSOLICITADO,
    COALESCE(s.MTOAPROBADO,0)   AS MTOAPROBADO
  FROM BASE_CENTRALIZADO c
  LEFT JOIN M_SOLICITUDCREDITOCONSUMO s
    ON c.CODSOLICITUD = s.CODSOLICITUD
),

-- Nos quedamos solo con el universo que te interesa “fuga potencial”:
-- 1) DENEGADAS (camp/sin camp)
-- 2) ACEPTADAS SIN DESEMBOLSO (camp/sin camp x con/sin reneg)
BASE_INTERES AS (
  SELECT *
  FROM BASE
  WHERE CODCLAVEPARTYCLI IS NOT NULL
    AND (
      ESTADOFINAL = 'DENEGADAS'
      OR (ESTADOFINAL = 'ACEPTADAS' AND FLGDESEMBOLSOORD = 0)
    )
),

CLIENTE_MES_UNIV AS (
  SELECT
    CODMES,
    CODCLAVEPARTYCLI,

    -- ===== DENEGADAS =====
    MAX(CASE WHEN ESTADOFINAL='DENEGADAS' AND FLGCAMPANIAORD=1 THEN 1 ELSE 0 END) AS FLG_DENE_CON_CAMP,
    MAX(CASE WHEN ESTADOFINAL='DENEGADAS' AND FLGCAMPANIAORD=0 THEN 1 ELSE 0 END) AS FLG_DENE_SIN_CAMP,
    MAX(CASE WHEN ESTADOFINAL='DENEGADAS' AND FLGCAMPANIAORD=1 THEN MTOSOLICITADO ELSE 0 END) AS MTO_SOL_MAX_DENE_CON_CAMP,
    MAX(CASE WHEN ESTADOFINAL='DENEGADAS' AND FLGCAMPANIAORD=0 THEN MTOSOLICITADO ELSE 0 END) AS MTO_SOL_MAX_DENE_SIN_CAMP,

    -- ===== ACEPTADAS SIN DESEMBOLSO (4 segmentos) =====
    MAX(CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGDESEMBOLSOORD=0 AND FLGCAMPANIAORD=1 AND FLGCASTIGOORD=1 THEN 1 ELSE 0 END)
      AS FLG_ACC_CON_CAMP_CON_RENEG_SIN_DES,
    MAX(CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGDESEMBOLSOORD=0 AND FLGCAMPANIAORD=1 AND FLGCASTIGOORD=0 THEN 1 ELSE 0 END)
      AS FLG_ACC_CON_CAMP_SIN_RENEG_SIN_DES,
    MAX(CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGDESEMBOLSOORD=0 AND FLGCAMPANIAORD=0 AND FLGCASTIGOORD=1 THEN 1 ELSE 0 END)
      AS FLG_ACC_SIN_CAMP_CON_RENEG_SIN_DES,
    MAX(CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGDESEMBOLSOORD=0 AND FLGCAMPANIAORD=0 AND FLGCASTIGOORD=0 THEN 1 ELSE 0 END)
      AS FLG_ACC_SIN_CAMP_SIN_RENEG_SIN_DES,

    MAX(CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGDESEMBOLSOORD=0 AND FLGCAMPANIAORD=1 AND FLGCASTIGOORD=1 THEN MTOAPROBADO ELSE 0 END)
      AS MTO_APR_MAX_ACC_CON_CAMP_CON_RENEG_SIN_DES,
    MAX(CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGDESEMBOLSOORD=0 AND FLGCAMPANIAORD=1 AND FLGCASTIGOORD=0 THEN MTOAPROBADO ELSE 0 END)
      AS MTO_APR_MAX_ACC_CON_CAMP_SIN_RENEG_SIN_DES,
    MAX(CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGDESEMBOLSOORD=0 AND FLGCAMPANIAORD=0 AND FLGCASTIGOORD=1 THEN MTOAPROBADO ELSE 0 END)
      AS MTO_APR_MAX_ACC_SIN_CAMP_CON_RENEG_SIN_DES,
    MAX(CASE WHEN ESTADOFINAL='ACEPTADAS' AND FLGDESEMBOLSOORD=0 AND FLGCAMPANIAORD=0 AND FLGCASTIGOORD=0 THEN MTOAPROBADO ELSE 0 END)
      AS MTO_APR_MAX_ACC_SIN_CAMP_SIN_RENEG_SIN_DES

  FROM BASE_INTERES
  GROUP BY CODMES, CODCLAVEPARTYCLI
),

SBS AS (
  SELECT
    CAST(date_format(FECDIA,'yyyyMM') AS INT) AS CODMESDEUDA,
    CODCLAVEPARTYCLI,
    SUM(MTODEUDASOL) AS MTODEUDASOL_SISTEMA,
    MAX(
      CASE
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('NORMAL') THEN 1
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('CON PROBLEMAS POTENCIALES(CPP)','CPP','CON PROBLEMAS POTENCIALES (CPP)') THEN 2
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('DEFICIENTE') THEN 3
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('DUDOSO') THEN 4
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('PERDIDA','PÉRDIDA') THEN 5
        ELSE 0
      END
    ) AS RIESGO_PEOR_ORD
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_DEUDORSBSDETALLE
  WHERE UPPER(TRIM(NBREMPSISTEMAFINANCIERO)) NOT LIKE 'BANCO DE CREDITO DEL PER%'
    AND UPPER(TRIM(DESCTACONTABLESBS)) NOT LIKE '%TARJET%'
    AND DESTIPCREDITO IN ('CREDITO DE CONSUMO NO REVOLVENTE','CREDITO HIPOTECARIOS PARA VIVIENDA')
  GROUP BY CAST(date_format(FECDIA,'yyyyMM') AS INT), CODCLAVEPARTYCLI
),

CLIENTE_MES_SBS AS (
  SELECT
    u.*,

    COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) AS DELTA_DEUDA_SBS,
    GREATEST(COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0), 0) AS DELTA_DEUDA_SBS_POS,

    COALESCE(s2.RIESGO_PEOR_ORD,0) AS DESTIPCLASIFRIESGO_PEOR_ORD,
    CASE COALESCE(s2.RIESGO_PEOR_ORD,0)
      WHEN 1 THEN 'NORMAL'
      WHEN 2 THEN 'CON PROBLEMAS POTENCIALES(CPP)'
      WHEN 3 THEN 'DEFICIENTE'
      WHEN 4 THEN 'DUDOSO'
      WHEN 5 THEN 'PERDIDA'
      ELSE 'SIN INFO'
    END AS DESTIPCLASIFRIESGO_PEOR

  FROM CLIENTE_MES_UNIV u
  LEFT JOIN SBS s1
    ON u.CODCLAVEPARTYCLI = s1.CODCLAVEPARTYCLI
   AND CAST(date_format(add_months(to_date(concat(CAST(u.CODMES AS STRING),'01'),'yyyyMMdd'),-1),'yyyyMM') AS INT) = s1.CODMESDEUDA
  LEFT JOIN SBS s2
    ON u.CODCLAVEPARTYCLI = s2.CODCLAVEPARTYCLI
   AND u.CODMES = s2.CODMESDEUDA
),

AGG_CLIENTES AS (
  SELECT
    CODMES,
    DESTIPCLASIFRIESGO_PEOR,
    DESTIPCLASIFRIESGO_PEOR_ORD,

    -- =======================
    -- DENEGADAS (clientes)
    -- =======================
    COUNT(DISTINCT CASE WHEN FLG_DENE_CON_CAMP = 1 THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_DENE_CON_CAMP,
    COUNT(DISTINCT CASE WHEN FLG_DENE_SIN_CAMP = 1 THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_DENE_SIN_CAMP,

    COUNT(DISTINCT CASE
      WHEN FLG_DENE_CON_CAMP = 1 AND MTO_SOL_MAX_DENE_CON_CAMP > 0 AND DELTA_DEUDA_SBS >= 0.50 * MTO_SOL_MAX_DENE_CON_CAMP
      THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_DENE_CON_CAMP_SBS_50PCT,

    COUNT(DISTINCT CASE
      WHEN FLG_DENE_SIN_CAMP = 1 AND MTO_SOL_MAX_DENE_SIN_CAMP > 0 AND DELTA_DEUDA_SBS >= 0.50 * MTO_SOL_MAX_DENE_SIN_CAMP
      THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_DENE_SIN_CAMP_SBS_50PCT,

    SUM(CASE
      WHEN FLG_DENE_CON_CAMP = 1 AND MTO_SOL_MAX_DENE_CON_CAMP > 0 AND DELTA_DEUDA_SBS >= 0.50 * MTO_SOL_MAX_DENE_CON_CAMP
      THEN DELTA_DEUDA_SBS_POS ELSE 0 END) AS MTO_AUM_SBS_DENE_CON_CAMP_50PCT,

    SUM(CASE
      WHEN FLG_DENE_SIN_CAMP = 1 AND MTO_SOL_MAX_DENE_SIN_CAMP > 0 AND DELTA_DEUDA_SBS >= 0.50 * MTO_SOL_MAX_DENE_SIN_CAMP
      THEN DELTA_DEUDA_SBS_POS ELSE 0 END) AS MTO_AUM_SBS_DENE_SIN_CAMP_50PCT,

    -- ==========================================
    -- ACEPTADAS SIN DESEMBOLSO (clientes, 4 seg)
    -- ==========================================
    COUNT(DISTINCT CASE WHEN FLG_ACC_CON_CAMP_CON_RENEG_SIN_DES = 1 THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_ACC_CON_CAMP_CON_RENEG_SIN_DES,
    COUNT(DISTINCT CASE WHEN FLG_ACC_CON_CAMP_SIN_RENEG_SIN_DES = 1 THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_ACC_CON_CAMP_SIN_RENEG_SIN_DES,
    COUNT(DISTINCT CASE WHEN FLG_ACC_SIN_CAMP_CON_RENEG_SIN_DES = 1 THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_ACC_SIN_CAMP_CON_RENEG_SIN_DES,
    COUNT(DISTINCT CASE WHEN FLG_ACC_SIN_CAMP_SIN_RENEG_SIN_DES = 1 THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_ACC_SIN_CAMP_SIN_RENEG_SIN_DES,

    COUNT(DISTINCT CASE
      WHEN FLG_ACC_CON_CAMP_CON_RENEG_SIN_DES = 1
       AND MTO_APR_MAX_ACC_CON_CAMP_CON_RENEG_SIN_DES > 0
       AND DELTA_DEUDA_SBS >= 0.50 * MTO_APR_MAX_ACC_CON_CAMP_CON_RENEG_SIN_DES
      THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_ACC_CON_CAMP_CON_RENEG_SIN_DES_SBS_50PCT,

    COUNT(DISTINCT CASE
      WHEN FLG_ACC_CON_CAMP_SIN_RENEG_SIN_DES = 1
       AND MTO_APR_MAX_ACC_CON_CAMP_SIN_RENEG_SIN_DES > 0
       AND DELTA_DEUDA_SBS >= 0.50 * MTO_APR_MAX_ACC_CON_CAMP_SIN_RENEG_SIN_DES
      THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_ACC_CON_CAMP_SIN_RENEG_SIN_DES_SBS_50PCT,

    COUNT(DISTINCT CASE
      WHEN FLG_ACC_SIN_CAMP_CON_RENEG_SIN_DES = 1
       AND MTO_APR_MAX_ACC_SIN_CAMP_CON_RENEG_SIN_DES > 0
       AND DELTA_DEUDA_SBS >= 0.50 * MTO_APR_MAX_ACC_SIN_CAMP_CON_RENEG_SIN_DES
      THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_ACC_SIN_CAMP_CON_RENEG_SIN_DES_SBS_50PCT,

    COUNT(DISTINCT CASE
      WHEN FLG_ACC_SIN_CAMP_SIN_RENEG_SIN_DES = 1
       AND MTO_APR_MAX_ACC_SIN_CAMP_SIN_RENEG_SIN_DES > 0
       AND DELTA_DEUDA_SBS >= 0.50 * MTO_APR_MAX_ACC_SIN_CAMP_SIN_RENEG_SIN_DES
      THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_ACC_SIN_CAMP_SIN_RENEG_SIN_DES_SBS_50PCT,

    SUM(CASE
      WHEN FLG_ACC_CON_CAMP_CON_RENEG_SIN_DES = 1
       AND MTO_APR_MAX_ACC_CON_CAMP_CON_RENEG_SIN_DES > 0
       AND DELTA_DEUDA_SBS >= 0.50 * MTO_APR_MAX_ACC_CON_CAMP_CON_RENEG_SIN_DES
      THEN DELTA_DEUDA_SBS_POS ELSE 0 END) AS MTO_AUM_SBS_ACC_CON_CAMP_CON_RENEG_SIN_DES_50PCT,

    SUM(CASE
      WHEN FLG_ACC_CON_CAMP_SIN_RENEG_SIN_DES = 1
       AND MTO_APR_MAX_ACC_CON_CAMP_SIN_RENEG_SIN_DES > 0
       AND DELTA_DEUDA_SBS >= 0.50 * MTO_APR_MAX_ACC_CON_CAMP_SIN_RENEG_SIN_DES
      THEN DELTA_DEUDA_SBS_POS ELSE 0 END) AS MTO_AUM_SBS_ACC_CON_CAMP_SIN_RENEG_SIN_DES_50PCT,

    SUM(CASE
      WHEN FLG_ACC_SIN_CAMP_CON_RENEG_SIN_DES = 1
       AND MTO_APR_MAX_ACC_SIN_CAMP_CON_RENEG_SIN_DES > 0
       AND DELTA_DEUDA_SBS >= 0.50 * MTO_APR_MAX_ACC_SIN_CAMP_CON_RENEG_SIN_DES
      THEN DELTA_DEUDA_SBS_POS ELSE 0 END) AS MTO_AUM_SBS_ACC_SIN_CAMP_CON_RENEG_SIN_DES_50PCT,

    SUM(CASE
      WHEN FLG_ACC_SIN_CAMP_SIN_RENEG_SIN_DES = 1
       AND MTO_APR_MAX_ACC_SIN_CAMP_SIN_RENEG_SIN_DES > 0
       AND DELTA_DEUDA_SBS >= 0.50 * MTO_APR_MAX_ACC_SIN_CAMP_SIN_RENEG_SIN_DES
      THEN DELTA_DEUDA_SBS_POS ELSE 0 END) AS MTO_AUM_SBS_ACC_SIN_CAMP_SIN_RENEG_SIN_DES_50PCT

  FROM CLIENTE_MES_SBS
  GROUP BY CODMES, DESTIPCLASIFRIESGO_PEOR, DESTIPCLASIFRIESGO_PEOR_ORD
)

SELECT *
FROM AGG_CLIENTES
ORDER BY CODMES, DESTIPCLASIFRIESGO_PEOR_ORD;