WITH
MD_VENTACOMISIONABLEBANCAMINORISTA AS (
    SELECT
        CODSOLICITUD,
        CODCLAVEPARTYCLI,
        FECTRX AS FECDEUDA,
        DESTIPPRODUCTOBCAMINORISTA AS PRODUCTODEUDA,
        DESAPPVENTABCAMINORISTA AS APPDEUDA,
        MTOVENTABCAMINORISTA AS MTODEUDA
    FROM CATALOG_LHCL_PROD_BCP.BCP_DDV_PBM_REMVAR_VU.MD_VENTACOMISIONABLEBANCAMINORISTA
    WHERE CODMES BETWEEN 202601 AND 202602
      AND MTOVENTABCAMINORISTA >= 1
),

HD_CONSOLIDADOCAMPANIACRM AS (
    SELECT
        CODMESCAMPANIA,
        UPPER(TRIM(CODINTERNOCOMPUTACIONAL)) AS CODINTERNOCOMPUTACIONAL,
        DESPRODUCTOVENTACRM,
        DESTIPOFERTACRM,
        TIPSEGMENTORIESGOSCORERBM,
        DESTIPSEGMENTORIESGOSCORERBM,
        FECRUTINA
    FROM CATALOG_LHCL_PROD_BCP.BCP_DDV_CRM_CAMPANIAMASIVA_VU.HD_CONSOLIDADOCAMPANIACRM
    WHERE CODMESCAMPANIA = 202602
      AND CODPRODUCTOVENTACRM IN ('0017', '0018')
      AND TIPOFERTACRM IN ('0123', '0003')
    QUALIFY ROW_NUMBER() OVER (
        PARTITION BY CODMESCAMPANIA, UPPER(TRIM(CODINTERNOCOMPUTACIONAL))
        ORDER BY FECRUTINA DESC
    ) = 1
),

HM_SOLICITUDES_SCRM AS (
    SELECT
        CODMES,
        CODSOLICITUD,
        FECSOLICITUD,
        ESTADOSOLICITUD,
        MTOOFERTADO,
        MTOSOLICITADO,
        MTOAPROBADO,
        MTOCEM,
        FECDESEMBOLSO,
        MTODESEMBOLSADO,
        DESCAMPANIA,
        (CASE WHEN DESCAMPANIA IS NOT NULL THEN 1 ELSE 0 END) AS FLGLEAD
    FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_HM_SOLICITUDES_SCRM
    WHERE CODMES = 202602
      AND CENTROATENCION = 'CENTRALIZADO'
      AND DESTIPOPERACION = 'TARJETA CREDITO NUEVA'
      AND DESCAMPANIA NOT LIKE '%TC + BT%'
      AND DESCAMPANIA NOT IN ('SIN CAMPANA', 'TC, VENTA CON GARANTIA LIQUIDA')
      AND DESCAMPANIA NOT LIKE '%SOLO REACTIVO%'
),

M_SOLICITUDTARJETACREDITO AS (
    SELECT
        CODSOLICITUD,
        UPPER(TRIM(CODINTERNOCOMPUTACIONAL)) AS CODINTERNOCOMPUTACIONAL,
        CODCLAVEPARTYCLI
    FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDTARJETACREDITO
    WHERE CODTIPREGAPP IN ('0126O000001xsIYQAY','0126O000001h0WaQAI','0126O000001h0WbQAI')
),

TP_BASE AS (
    SELECT
        A.CODMES,
        A.CODSOLICITUD,
        A.FECSOLICITUD,
        A.ESTADOSOLICITUD,
        A.MTOOFERTADO,
        A.MTOSOLICITADO,
        A.MTOAPROBADO,
        A.MTOCEM,
        A.DESCAMPANIA,
        A.FECDESEMBOLSO,
        A.MTODESEMBOLSADO,
        A.FLGLEAD,
        B.CODINTERNOCOMPUTACIONAL,
        B.CODCLAVEPARTYCLI
    FROM HM_SOLICITUDES_SCRM A
    LEFT JOIN M_SOLICITUDTARJETACREDITO B
        ON A.CODSOLICITUD = B.CODSOLICITUD
),

/* OpciÃ³n B: agrego transacciones en ventana por CODSOLICITUD */
TRX_EN_VENTANA AS (
    SELECT
        A.CODSOLICITUD,
        SUM(C.MTODEUDA) AS MTODEUDA,
        1 AS FLGREGLADEUDA
    FROM TP_BASE A
    JOIN MD_VENTACOMISIONABLEBANCAMINORISTA C
        ON A.CODCLAVEPARTYCLI = C.CODCLAVEPARTYCLI
       AND A.FECSOLICITUD IS NOT NULL
       AND C.FECDEUDA >= DATE '2026-01-26'
       AND C.FECDEUDA <= A.FECSOLICITUD
    GROUP BY A.CODSOLICITUD
),

TP_BASE_1 AS (
    SELECT
        A.CODSOLICITUD,
        A.FECSOLICITUD,
        A.CODINTERNOCOMPUTACIONAL,
        A.FLGLEAD,
        A.DESCAMPANIA,
        A.ESTADOSOLICITUD,
        A.MTOOFERTADO,
        A.MTOCEM,
        A.MTOSOLICITADO,
        (CASE WHEN A.FLGLEAD = 1 THEN B.TIPSEGMENTORIESGOSCORERBM ELSE NULL END) AS TIPSEGMENTORIESGOSCORERBM,
        (CASE WHEN A.FLGLEAD = 1 THEN B.DESTIPOFERTACRM ELSE NULL END) AS DESTIPOFERTACRM,
        A.MTOAPROBADO,
        (CASE
            WHEN A.FLGLEAD = 1 AND B.TIPSEGMENTORIESGOSCORERBM = 'A' THEN 26
            WHEN A.FLGLEAD = 1 AND B.TIPSEGMENTORIESGOSCORERBM = 'B' THEN 25
            WHEN A.FLGLEAD = 1 AND B.TIPSEGMENTORIESGOSCORERBM = 'C' THEN 24
            WHEN A.FLGLEAD = 1 AND B.TIPSEGMENTORIESGOSCORERBM IN ('D', 'E') THEN 23
            ELSE NULL
        END) AS FACTORSEGMENTORIESGO,

        COALESCE(T.FLGREGLADEUDA, 0) AS FLGREGLADEUDA,
        COALESCE(T.MTODEUDA, 0)      AS MTODEUDA

    FROM TP_BASE A
    LEFT JOIN HD_CONSOLIDADOCAMPANIACRM B
        ON A.CODMES = B.CODMESCAMPANIA
       AND A.CODINTERNOCOMPUTACIONAL = B.CODINTERNOCOMPUTACIONAL
    LEFT JOIN TRX_EN_VENTANA T
        ON A.CODSOLICITUD = T.CODSOLICITUD
)

SELECT
    CODSOLICITUD,
    FECSOLICITUD,
    CODINTERNOCOMPUTACIONAL,
    FLGLEAD,
    ESTADOSOLICITUD,
    MTOOFERTADO,
    MTOSOLICITADO,
    MTOCEM,
    TIPSEGMENTORIESGOSCORERBM,
    FACTORSEGMENTORIESGO,
    FLGREGLADEUDA,
    MTODEUDA
FROM TP_BASE_1;
