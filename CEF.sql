CREATE OR REPLACE TABLE CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_HM_SOLICITUDES_SCRM
LOCATION 'abfss://bcp-edv-rbmbdn@adlscu1lhclbackp05.dfs.core.windows.net/T72496/TABLAS_DELTA/HM_SOLICITUDES_SCRM/'
AS
WITH
TP_TIPOCAMBIO AS (
	SELECT 3.81 AS TC_USD_SOL
),
TP_BASESOLICITUDESSALESFORCE AS (
	SELECT
		A.CODMESEVALUACION AS CODMESEVALUACION,
    	A.CODSOLICITUD,
    	(CASE
			WHEN A.NBRDIVISA = 'USD' THEN A.MTOSOLICITADO * B.TC_USD_SOL
			ELSE A.MTOSOLICITADO
		END) AS MTOSOLICITADO,
     	(CASE
			WHEN A.NBRDIVISA = 'USD' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
    	A.MATANALISTA_FINAL AS MATRICULA,
    	A.ESTADOSOLICITUDANALISTA AS ESTADOSOLICITUD,
    	A.TIPACCION AS DESTIPPRODUCTO,
    	A.NBRPRODUCTO AS DESPRODUCTO,
    	A.ETAPA AS DESTIPETAPA,
		A.MOTIVOMALADERIVACION,
		(CASE WHEN A.MOTIVORESULTADOANALISTA = 'DEBIO APROBARSE EN PDC' THEN 1 ELSE 0 END) AS FLGCAMBIOTASA,
		A.SUBMOTIVOMALADERIVACION,
		A.FECINICIOEVALUACION_ULT AS FECINICIOEVALUACION
	FROM CATALOG_LHCL_PROD_BCP_EXPL.BCP_EDV_RBMBDN.TP_SOLICITUDES_CENTRALIZADO A
	CROSS JOIN TP_TIPOCAMBIO B
),
TP_COLABORADOR AS (
    SELECT
        FECDIA,
        date_format(FECDIA, 'yyyyMM') AS CODMES,
        CODMATRICULA,
        CODMATRICULASUP,
        NBRUNIDADORGANIZATIVA,
        NBRAREAUNIDADORGANIZATIVA,
        NBRSERVUNIDADORGANIZATIVA,
        (CASE
        	WHEN NBRAREAUNIDADORGANIZATIVA IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1') THEN 'DCA'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS' THEN 'TLMK'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA BANCA AFLUENTE' AND NBRSERVUNIDADORGANIZATIVA = 'GERENCIA DE BANCA ENALTA' THEN 'ENALTA'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA BANCA AFLUENTE' AND NBRSERVUNIDADORGANIZATIVA = 'GERENCIA DE BANCA EXCLUSIVA DIGITAL' THEN 'BEX'
			ELSE 'OTROS'
		END) AS CANAL,
		FECACTUALIZACIONREGISTRO
    FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_COLABORADOR
    WHERE DESTIPESTADOLABORAL = 'Activo'
),
TP_COLABORADORANALISTA AS (
    SELECT
        FECDIA,
        CODMES,
        MATORGANICO,
        MATSUPERIOR,
        NBRAREAUNIDADORGANIZATIVA
    FROM (
        SELECT
            FECDIA,
            CODMES,
            CODMATRICULA       AS MATORGANICO,
            CODMATRICULASUP    AS MATSUPERIOR,
            NBRAREAUNIDADORGANIZATIVA,
            ROW_NUMBER() OVER (
                PARTITION BY FECDIA, CODMATRICULA
                ORDER BY FECACTUALIZACIONREGISTRO DESC
            ) AS rn
        FROM TP_COLABORADOR
    ) x
    WHERE rn = 1
),
TP_COLABORADORANALISTA_FALLBACK AS (
 SELECT
   CODSOLICITUD,
   NBRAREAUNIDADORGANIZATIVA,
   MATSUPERIOR
 FROM (
   SELECT
     A.CODSOLICITUD,
     B.NBRAREAUNIDADORGANIZATIVA,
     B.MATSUPERIOR,
     ROW_NUMBER() OVER (
       PARTITION BY A.CODSOLICITUD
       ORDER BY B.FECDIA DESC
     ) AS rn
   FROM TP_BASESOLICITUDESSALESFORCE A
   JOIN TP_COLABORADORANALISTA B
     ON B.MATORGANICO = A.MATRICULA
    AND B.FECDIA <= to_date(A.FECINICIOEVALUACION)
    AND B.FECDIA >= date_sub(to_date(A.FECINICIOEVALUACION), 7)   -- ventana hacia atras
 ) t
 WHERE rn = 1
),
TP_BASE_SOLICITUDES AS (
 SELECT
   A.CODMESEVALUACION AS CODMES,
   A.CODSOLICITUD,
   (CASE
     WHEN A.ESTADOSOLICITUD = 'PENDIENTE' AND A.DESTIPETAPA = 'DESESTIMADA' THEN 'RECHAZADO'
     ELSE A.ESTADOSOLICITUD
   END) AS ESTADOSOLICITUD,
   A.MOTIVOMALADERIVACION,
   A.SUBMOTIVOMALADERIVACION,
   A.FLGCAMBIOTASA,
   A.MTOSOLICITADO,
   A.MTOAPROBADO,
   A.MATRICULA AS MATANALISTA,
   A.DESTIPPRODUCTO AS PRODUCTO,
   A.DESPRODUCTO,
   A.DESTIPETAPA,
   B.NBRAREAUNIDADORGANIZATIVA,
   B.MATSUPERIOR
 FROM TP_BASESOLICITUDESSALESFORCE A
 LEFT JOIN TP_COLABORADORANALISTA_FALLBACK B
   ON B.CODSOLICITUD = A.CODSOLICITUD
),
TP_COLABORADORVENDEDOR AS (
    SELECT
        FECDIA,
        CODMES,
        MATORGANICO,
        MATSUPERIOR,
        NBRUNIDADORGANIZATIVAVENDEDOR,
        NBRAREAUNIDADORGANIZATIVAVENDEDOR,
        NBRSERVUNIDADORGANIZATIVAVENDEDOR,
        CANAL
    FROM (
        SELECT
            FECDIA,
            CODMES,
            CODMATRICULA       AS MATORGANICO,
            CODMATRICULASUP    AS MATSUPERIOR,
            NBRUNIDADORGANIZATIVA     AS NBRUNIDADORGANIZATIVAVENDEDOR,
            NBRAREAUNIDADORGANIZATIVA AS NBRAREAUNIDADORGANIZATIVAVENDEDOR,
            NBRSERVUNIDADORGANIZATIVA AS NBRSERVUNIDADORGANIZATIVAVENDEDOR,
            CANAL,
            ROW_NUMBER() OVER (
                PARTITION BY FECDIA, CODMATRICULA
                ORDER BY FECACTUALIZACIONREGISTRO DESC
            ) AS rn
        FROM TP_COLABORADOR
    ) x
    WHERE rn = 1
),
TP_SOLICITUDINDIVIDUO AS (
	SELECT
    	CODSOLICITUD,
    	(CASE
			WHEN CODSUBSEGMENTO IN ('X1N', 'X1E') THEN 'BEX'
			WHEN CODSUBSEGMENTO IN ('Q1N', 'Q1E') THEN 'PYME'
			WHEN CODSUBSEGMENTO IN ('P1N', 'P1E') THEN 'PRIVADA'
			WHEN CODSUBSEGMENTO IN ('NBN', 'NBE') THEN 'NO BANCO'
			WHEN CODSUBSEGMENTO IN ('M1N', 'M1E') THEN 'CONSUMO'
			WHEN CODSUBSEGMENTO IN ('LEN', 'LEE') THEN 'ENALTA'
			WHEN CODSUBSEGMENTO IN ('C1N', 'C1E') THEN 'NEGOCIOS'
			WHEN CODSUBSEGMENTO = 'G1N' THEN 'GREMIO 94'
			ELSE 'OTROS'
		END) AS SEGMENTO,
    	(CASE
			WHEN TIPRENTA = 5 THEN '5TA'
			WHEN TIPRENTA = 4 THEN '4TA'
			WHEN TIPRENTA = 3 THEN '3RA'
			WHEN TIPRENTA = 2 THEN '2DA'
			WHEN TIPRENTA = 1 THEN '1RA'
			ELSE 'OTROS'
		END) AS DESTIPRENTA
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDINDIVIDUO
	WHERE DESTIPROLSOLICITUD = 'TITULAR'
),
TP_SOLICITUDCREDITOCONSUMO AS (
	SELECT
		A.CODSOLICITUD,
		A.DESTIPETAPA,
		A.DESTIPESTADOSOLICITUD,
		A.DESTIPSOLICITUD AS TIPOPERACION,
		A.DESTIPSOLICITUD AS DESTIPOPERACION,
		(CASE
			WHEN A.CODPRODUCTO IN ('EFME', 'EFDP') THEN 'LIBRE DISPONIBILIDAD' -- EFDP: CONVENIO
			WHEN A.CODPRODUCTO = 'EFCD' THEN 'COMPRA DEUDA'
			ELSE 'OTROS'
		END) AS PRODUCTO,
		CAST(NULL AS STRING) AS DESPRODUCTO,
		UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		A.DESTIPEVALUACIONRIESGO,
		A.CODMATRICULACOLABORADORANALISTA,
		A.CODMATRICULACOLABORADORVENDEDOR,
		A.NBRAGE,
		date_format(A.FECSOLICITUD, 'yyyyMM') AS CODMES,
		A.FECSOLICITUD,
		substring(HORINICIOCALIF, 1, 2) AS HORINICIOATENCION,
		dayofmonth(FECINICIOCALIF) AS NUMDIAINICIOATENCION,
		(CASE
			WHEN dayofmonth(FECINICIOCALIF) BETWEEN 1 AND 7 THEN 'S1'
			WHEN dayofmonth(FECINICIOCALIF) BETWEEN 8 AND 14 THEN 'S2'
			WHEN dayofmonth(FECINICIOCALIF) BETWEEN 15 AND 21 THEN 'S3'
			ELSE 'S4'
		END) AS NUMSEMANAMESINICIOATENCION,
		(CASE pmod(dayofweek(FECINICIOCALIF) + 5, 7) + 1
			WHEN 1 THEN 'LUN'
			WHEN 2 THEN 'MAR'
			WHEN 3 THEN 'MIE'
			WHEN 4 THEN 'JUE'
			WHEN 5 THEN 'VIE'
			WHEN 6 THEN 'SAB'
			WHEN 7 THEN 'DOM'
		END) AS NBRDIASEMANAINICIOATENCION,
		pmod(dayofweek(FECINICIOCALIF) + 5, 7) + 1 AS NBRDIASEMANAINICIOATENCION_ORD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECSOLICITUD, LPAD(A.HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECINICIOCALIF, LPAD(A.HORINICIOCALIF, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORINICIOEVALUACION,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECFINCALIF, LPAD(A.HORFINCALIF, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORFINEVALUACION,
		(CASE
			WHEN A.NBRMONEDA LIKE '%SOL%' THEN 'SOLES'
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN 'DOLARES'
			ELSE NULL
		END) AS NBRMONEDA,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOSOLICITADO * B.TC_USD_SOL
			ELSE A.MTOSOLICITADO
		END) AS MTOSOLICITADO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
		A.FECDESEMBOLSO,
		TO_TIMESTAMP(CONCAT(A.FECDESEMBOLSO, ' 23:59:59'), 'yyyy-MM-dd HH:mm:ss') AS FECHORDESEMBOLSO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO A
	CROSS JOIN TP_TIPOCAMBIO B
),
TP_SOLICITUDTARJETACREDITO AS (
	SELECT
		A.CODSOLICITUD,
		A.DESTIPETAPA,
		A.DESTIPESTADOSOLICITUD,
		A.DESTIPSOLICITUD AS TIPOPERACION,
		(CASE
			WHEN A.DESTIPFLUJOVENTATARJETACREDITO IN ('ADICIONAL', 'AMPLIACION', 'EP', 'UPGRADE', 'BT') THEN 'TARJETA CREDITO STOCK'
			WHEN A.DESTIPFLUJOVENTATARJETACREDITO IN ('TC', 'SEGUNDA TC') THEN 'TARJETA CREDITO NUEVA'
			ELSE NULL
		END) AS DESTIPOPERACION,
		A.DESTIPFLUJOVENTATARJETACREDITO AS PRODUCTO,
		UPPER(A.DESPRODUCTO) AS DESPRODUCTO,
		UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		(CASE
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%100%%' THEN '100% APROBADO'
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%PREA%' THEN 'PREAPROBADO' -- [PREAPROBADO, PREAPROB, PREAPRO, PREAPR]
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%REACTIVO%' THEN 'REACTIVO'
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) = 'TC NUEVA CHIP' THEN 'TC NUEVA CHIP'
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%GARANTIA LIQUIDA%' THEN 'GARANTIA LIQUIDA'
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%GREMIO%' THEN 'GREMIO'
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%INVITADO%' THEN 'INVITADO'
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%SIN CAMPA%' THEN 'SIN CAMPANA'
			ELSE 'OTROS'
		END) AS DESTIPEVALUACIONRIESGO,
		A.CODMATRICULACOLABORADORAPROBADOR AS CODMATRICULACOLABORADORANALISTA,
		A.CODMATRICULACOLABORADORVENDEDOR,
		A.NBRAGE,
		date_format(A.FECSOLICITUD, 'yyyyMM') AS CODMES,
		A.FECSOLICITUD,
		substring(HORINICIOEVALUACION, 1, 2) AS HORINICIOATENCION,
		dayofmonth(FECINICIOEVALUACION) AS NUMDIAINICIOATENCION,
		(CASE
			WHEN dayofmonth(FECINICIOEVALUACION) BETWEEN 1 AND 7 THEN 'S1'
			WHEN dayofmonth(FECINICIOEVALUACION) BETWEEN 8 AND 14 THEN 'S2'
			WHEN dayofmonth(FECINICIOEVALUACION) BETWEEN 15 AND 21 THEN 'S3'
			ELSE 'S4'
		END) AS NUMSEMANAMESINICIOATENCION,
		(CASE pmod(dayofweek(FECINICIOEVALUACION) + 5, 7) + 1
			WHEN 1 THEN 'LUN'
			WHEN 2 THEN 'MAR'
			WHEN 3 THEN 'MIE'
			WHEN 4 THEN 'JUE'
			WHEN 5 THEN 'VIE'
			WHEN 6 THEN 'SAB'
			WHEN 7 THEN 'DOM'
		END) AS NBRDIASEMANAINICIOATENCION,
		pmod(dayofweek(FECINICIOEVALUACION) + 5, 7) + 1 AS NBRDIASEMANAINICIOATENCION_ORD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECSOLICITUD, LPAD(A.HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECINICIOEVALUACION, LPAD(A.HORINICIOEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORINICIOEVALUACION,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECFINEVALUACION, LPAD(A.HORFINEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORFINEVALUACION,
		(CASE
			WHEN A.NBRMONEDA LIKE '%SOL%' THEN 'SOLES'
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN 'DOLARES'
			ELSE NULL
		END) AS NBRMONEDA,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOSOLICITADO * B.TC_USD_SOL
			ELSE A.MTOSOLICITADO
		END) AS MTOSOLICITADO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
		A.FECEMISIONTARJETACREDITO AS FECDESEMBOLSO,
		TO_TIMESTAMP(CONCAT(A.FECEMISIONTARJETACREDITO, ' 23:59:59'), 'yyyy-MM-dd HH:mm:ss') AS FECHORDESEMBOLSO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDTARJETACREDITO A
	CROSS JOIN TP_TIPOCAMBIO B
	WHERE A.CODTIPREGAPP IN ('0126O000001xsIYQAY','0126O000001h0WaQAI','0126O000001h0WbQAI')
),
TP_UNION AS (
	SELECT * FROM TP_SOLICITUDCREDITOCONSUMO
	UNION ALL
	SELECT * FROM TP_SOLICITUDTARJETACREDITO
),
TP_COLABORADORVENDEDOR_FALLBACK AS (
 SELECT
   CODSOLICITUD,
   NBRUNIDADORGANIZATIVAVENDEDOR,
   NBRAREAUNIDADORGANIZATIVAVENDEDOR,
   NBRSERVUNIDADORGANIZATIVAVENDEDOR,
   CANAL
 FROM (
   SELECT
     A.CODSOLICITUD,
     B.NBRUNIDADORGANIZATIVAVENDEDOR,
     B.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
     B.NBRSERVUNIDADORGANIZATIVAVENDEDOR,
     B.CANAL,
     ROW_NUMBER() OVER (
       PARTITION BY A.CODSOLICITUD
       ORDER BY B.FECDIA DESC
     ) AS rn
   FROM TP_UNION A
   JOIN TP_COLABORADORVENDEDOR B
     ON B.MATORGANICO = A.CODMATRICULACOLABORADORVENDEDOR
    AND B.FECDIA <= A.FECSOLICITUD
    AND B.FECDIA >= date_sub(A.FECSOLICITUD, 7)   -- ventana hacia atrás
   WHERE A.CODMATRICULACOLABORADORVENDEDOR IS NOT NULL
 ) t
 WHERE rn = 1
),
TP_BASE_UNION AS (
 SELECT
   A.*,
   B.NBRUNIDADORGANIZATIVAVENDEDOR,
   B.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
   B.NBRSERVUNIDADORGANIZATIVAVENDEDOR,
   B.CANAL,
   C.DESTIPRENTA,
   C.SEGMENTO,
   ROUND(date_diff(SECOND, A.FECHORSOLICITUD, A.FECHORDESEMBOLSO) / 3600, 2) AS TIEMPOATENCIONSOLICITUD,
   ROUND(date_diff(SECOND, A.FECHORSOLICITUD, A.FECHORINICIOEVALUACION) / 3600, 2) AS TIEMPODERIVACIONANALISTA,
   ROUND(date_diff(SECOND, A.FECHORINICIOEVALUACION, A.FECHORFINEVALUACION) / 3600, 2) AS TIEMPOATENCIONANALISTA,
   ROUND(date_diff(SECOND, A.FECHORSOLICITUD, A.FECHORFINEVALUACION) / 3600, 2) AS TIEMPOATENCIONSOLICITUDANALISTA
 FROM TP_UNION A
 LEFT JOIN TP_COLABORADORVENDEDOR_FALLBACK B
   ON A.CODSOLICITUD = B.CODSOLICITUD
 LEFT JOIN TP_SOLICITUDINDIVIDUO C
   ON A.CODSOLICITUD = C.CODSOLICITUD
),
CALENDARIO AS (
    SELECT explode(
        sequence(to_date('2024-01-01'), to_date('2026-12-31'), interval 1 day)
    ) AS FECHA
),
DIMCALENDARIO AS (
    SELECT
        A.FECHA,
        (CASE
            WHEN dayofweek(A.FECHA) = 1 THEN 0       -- domingo (1)
            WHEN B.FECHA IS NOT NULL THEN 0              -- feriado
            ELSE 1
        END) AS FLGDIAUTIL
    FROM CALENDARIO A
    LEFT JOIN CATALOG_LHCL_PROD_BCP_EXPL.BCP_EDV_RBMBDN.T72496_DE_DIASNOHABILES B ON A.FECHA = B.FECHA
),
TP_BASE_PREV AS (
	SELECT
		A.CODMES,
		A.CODSOLICITUD,
		B.MATANALISTA,
		B.NBRAREAUNIDADORGANIZATIVA AS NBRAREAUNIDADORGANIZATIVAANALISTA,
		B.MATSUPERIOR,
		A.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
		A.NBRAGE,
		A.CANAL,
		A.TIPOPERACION,
		A.DESTIPOPERACION,
		COALESCE(A.PRODUCTO, B.PRODUCTO) AS PRODUCTO,
		(CASE
			WHEN A.DESPRODUCTO IS NULL AND A.TIPOPERACION = 'CREDITO CONSUMO' THEN B.DESPRODUCTO
			ELSE COALESCE(B.DESPRODUCTO, A.DESPRODUCTO)
		END) AS DESPRODUCTO,
		A.DESCAMPANIA,
		A.DESTIPEVALUACIONRIESGO,
		A.FECSOLICITUD,
		A.HORINICIOATENCION,
		A.NUMDIAINICIOATENCION,
		A.NUMSEMANAMESINICIOATENCION,
		A.NBRDIASEMANAINICIOATENCION,
		A.NBRDIASEMANAINICIOATENCION_ORD,
		(CASE
			WHEN C.FLGDIAUTIL = 1 THEN 'SI'
			ELSE 'NO'
		END) AS FLGDIAUTIL,
		A.FECHORSOLICITUD,
		A.FECHORINICIOEVALUACION,
		A.FECHORFINEVALUACION,
		A.FECDESEMBOLSO,
		A.FECHORDESEMBOLSO,
		A.TIEMPOATENCIONSOLICITUD,
		A.TIEMPODERIVACIONANALISTA,
		A.TIEMPOATENCIONANALISTA,
		A.TIEMPOATENCIONSOLICITUDANALISTA,
		--A.TIEMPODESEMBOLSOPOSTATENCIONANALISTA,
		A.DESTIPRENTA,
		A.SEGMENTO,
		COALESCE(B.MTOSOLICITADO, A.MTOSOLICITADO) AS MTOSOLICITADO,
		COALESCE(B.MTOAPROBADO, A.MTOAPROBADO) AS MTOAPROBADO,
		A.DESTIPESTADOSOLICITUD,
		B.ESTADOSOLICITUD,
		CASE
		   -----------------------------------------------------------------
		   -- 1) CENTRALIZADO
		   -----------------------------------------------------------------
		   WHEN B.MATANALISTA IS NOT NULL
		        AND B.NBRAREAUNIDADORGANIZATIVA = 'TRIBU RIESGOS BDN Y CREDITOS MINORISTAS'
		   THEN 'CENTRALIZADO'
		   -----------------------------------------------------------------
		   -- 2) PUNTO DE CONTACTO - CREDITO CONSUMO
		   -----------------------------------------------------------------
		   WHEN A.TIPOPERACION = 'CREDITO CONSUMO'
		        AND A.DESTIPESTADOSOLICITUD IN ('ACEPTADA', 'DESACTIVADA', 'DENEGADA')
		        AND A.NBRAREAUNIDADORGANIZATIVAVENDEDOR IN (
		        	'AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 
		        	'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1', 
		        	'GCIA DE AREA BANCA AFLUENTE', 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS'
		        )
		        /*AND A.CODMATRICULACOLABORADORANALISTA IS NULL*/ -- ANALISTAS QUE FIGURAN EN CORE DE DATABRICKS NUNCA ATENDIERON LAS SOLICITUDES
		   THEN 'PUNTO DE CONTACTO'
		   -----------------------------------------------------------------
		   -- 3) PUNTO DE CONTACTO - TARJETA DE CREDITO
		   -----------------------------------------------------------------
		   WHEN A.TIPOPERACION = 'TARJETA DE CREDITO'
		        AND A.DESTIPESTADOSOLICITUD IN ('ACEPTADA', 'DENEGADA')
		        AND A.DESTIPETAPA = 'CERRADA'
		        AND A.NBRAREAUNIDADORGANIZATIVAVENDEDOR IN (
		        	'AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 
		        	'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1', 
		        	'GCIA DE AREA BANCA AFLUENTE', 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS'
		        )
		   THEN 'PUNTO DE CONTACTO'
		   -----------------------------------------------------------------
		   -- 4) Resto
		   -----------------------------------------------------------------
		   ELSE 'SIN INFORMACION'
		END AS CENTROATENCION,
		B.MOTIVOMALADERIVACION,
		B.SUBMOTIVOMALADERIVACION,
		B.FLGCAMBIOTASA
	FROM TP_BASE_UNION A
	LEFT JOIN TP_BASE_SOLICITUDES B ON (A.CODSOLICITUD = B.CODSOLICITUD)
	LEFT JOIN DIMCALENDARIO C ON (A.FECSOLICITUD = C.FECHA)
	
),
TP_BASE_PREV2 AS (
	SELECT
		CODMES,
		CODSOLICITUD,
		MATANALISTA,
		NBRAREAUNIDADORGANIZATIVAANALISTA,
		MATSUPERIOR,
		NBRAREAUNIDADORGANIZATIVAVENDEDOR,
		CANAL,
		NBRAGE,
		TIPOPERACION,
		DESTIPOPERACION,
		PRODUCTO,
		DESPRODUCTO,
		DESCAMPANIA,
		DESTIPEVALUACIONRIESGO,
		FECSOLICITUD,
		HORINICIOATENCION,
		NUMDIAINICIOATENCION,
		NUMSEMANAMESINICIOATENCION,
		NBRDIASEMANAINICIOATENCION,
		NBRDIASEMANAINICIOATENCION_ORD,
		FLGDIAUTIL,
		FECHORSOLICITUD,
		FECHORINICIOEVALUACION,
		FECHORFINEVALUACION,
		FECDESEMBOLSO,
		FECHORDESEMBOLSO,
		TIEMPOATENCIONSOLICITUD,
		TIEMPODERIVACIONANALISTA,
		TIEMPOATENCIONANALISTA,
		TIEMPOATENCIONSOLICITUDANALISTA,
		--TIEMPODESEMBOLSOPOSTATENCIONANALISTA,
		DESTIPRENTA,
		SEGMENTO,
		MTOSOLICITADO,
		MTOAPROBADO,
		CENTROATENCION,
		(CASE
           -----------------------------------------------------------------
           -- CENTRALIZADO: manda el estado del analista / Salesforce
           -----------------------------------------------------------------
           WHEN A.CENTROATENCION = 'CENTRALIZADO'
           THEN A.ESTADOSOLICITUD
           -----------------------------------------------------------------
           -- PUNTO DE CONTACTO: APROBADO / RECHAZADO según estado origen
           -----------------------------------------------------------------
           WHEN A.CENTROATENCION = 'PUNTO DE CONTACTO'
                AND A.DESTIPESTADOSOLICITUD = 'ACEPTADA'
           THEN 'APROBADO'
           WHEN A.CENTROATENCION = 'PUNTO DE CONTACTO'
                AND A.DESTIPESTADOSOLICITUD IN ('DESACTIVADA', 'DENEGADA')
           THEN 'RECHAZADO'
           -----------------------------------------------------------------
           -- Fallback: devuelve lo que tenga, priorizando analista
           -----------------------------------------------------------------
           ELSE COALESCE(A.ESTADOSOLICITUD, A.DESTIPESTADOSOLICITUD)
       END) AS ESTADOSOLICITUD,
       MOTIVOMALADERIVACION,
       SUBMOTIVOMALADERIVACION,
       FLGCAMBIOTASA
   FROM TP_BASE_PREV A
),
TP_BASE AS (
	SELECT
		CODMES,
		CODSOLICITUD,
		MATANALISTA,
		NBRAREAUNIDADORGANIZATIVAANALISTA,
		(CASE
			WHEN MATSUPERIOR = 'U18900' THEN 'EQUIPO CM'
			WHEN MATSUPERIOR = 'U17560' THEN 'EQUIPO PM'
			WHEN MATSUPERIOR = 'U13421' THEN 'EQUIPO MA'
			WHEN MATSUPERIOR = 'S18795' THEN 'EQUIPO EC'
			WHEN MATSUPERIOR = 'E19330' THEN 'EQUIPO SL'
			WHEN MATSUPERIOR = 'E12624' THEN 'EQUIPO GP'
			ELSE 'SIN INF.'
		END) AS NBREQUIPO,
		NBRAREAUNIDADORGANIZATIVAVENDEDOR,
		CANAL,
		NBRAGE,
		TIPOPERACION,
		DESTIPOPERACION,
		PRODUCTO,
		DESPRODUCTO,
		DESCAMPANIA,
		DESTIPEVALUACIONRIESGO,
		FECSOLICITUD,
		HORINICIOATENCION,
		NUMDIAINICIOATENCION,
		NUMSEMANAMESINICIOATENCION,
		NBRDIASEMANAINICIOATENCION,
		NBRDIASEMANAINICIOATENCION_ORD,
		FLGDIAUTIL,
		FECHORSOLICITUD,
		FECHORINICIOEVALUACION,
		FECHORFINEVALUACION,
		FECDESEMBOLSO,
		FECHORDESEMBOLSO,
		TIEMPOATENCIONSOLICITUD,
		TIEMPODERIVACIONANALISTA,
		TIEMPOATENCIONANALISTA,
		TIEMPOATENCIONSOLICITUDANALISTA,
		--TIEMPODESEMBOLSOPOSTATENCIONANALISTA,
		DESTIPRENTA,
		SEGMENTO,
		MTOSOLICITADO,
		CENTROATENCION,
		ESTADOSOLICITUD,
		(CASE
			WHEN MOTIVOMALADERIVACION IS NOT NULL AND ESTADOSOLICITUD = 'RECHAZADO' THEN MOTIVOMALADERIVACION
			ELSE NULL
		END) AS MOTIVOMALADERIVACION,
		(CASE
			WHEN MOTIVOMALADERIVACION IS NOT NULL AND ESTADOSOLICITUD = 'RECHAZADO' THEN SUBMOTIVOMALADERIVACION
			ELSE NULL
		END) AS SUBMOTIVOMALADERIVACION,
		(CASE WHEN ESTADOSOLICITUD = 'RECUPERADA' THEN 1 ELSE 0 END) AS FLGRECUPERADA,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' THEN 1 ELSE 0 END) AS FLGAPROBADO,
		(CASE WHEN ESTADOSOLICITUD = 'RECHAZADO' THEN 1 ELSE 0 END) AS FLGDENEGADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL THEN 1 ELSE 0 END) AS FLGDESEMBOLSADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NULL THEN 1 ELSE 0 END) AS FLGNODESEMBOLSADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOSOLICITADO = MTOAPROBADO THEN 1 ELSE 0 END) AS FLGAPROBADONORENEGOCIADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOSOLICITADO <> MTOAPROBADO THEN 1 ELSE 0 END) AS FLGAPROBADORENEGOCIADO,
		(CASE WHEN ESTADOSOLICITUD = 'RECUPERADA' THEN MTOSOLICITADO ELSE 0 END) AS MTOSOLICITADORECUPERADA,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADO,
		(CASE WHEN ESTADOSOLICITUD = 'RECHAZADO' THEN MTOSOLICITADO ELSE 0 END) AS MTODENEGADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL THEN MTOAPROBADO ELSE 0 END) AS MTODESEMBOLSADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NULL THEN MTOAPROBADO ELSE 0 END) AS MTONODESEMBOLSADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOSOLICITADO = MTOAPROBADO THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADONORENEGOCIADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOSOLICITADO <> MTOAPROBADO THEN MTOSOLICITADO - MTOAPROBADO ELSE 0 END) AS MTOAPROBADORENEGOCIADO,
		( (CASE WHEN ESTADOSOLICITUD = 'RECHAZADO' THEN MTOSOLICITADO ELSE 0 END) + (CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOSOLICITADO <> MTOAPROBADO THEN MTOSOLICITADO - MTOAPROBADO ELSE 0 END) ) AS MTODENEGADOTOTAL,
		FLGCAMBIOTASA
	FROM TP_BASE_PREV2
)
	SELECT
		CODMES,--
		CODSOLICITUD, --
		CENTROATENCION, --
		CANAL, -- 
		NBRAGE, --
		MATANALISTA, --
		NBREQUIPO, --
	    NBRAREAUNIDADORGANIZATIVAVENDEDOR, --
	    TIPOPERACION,
	    DESTIPOPERACION, 
	    PRODUCTO, 
	    DESPRODUCTO, 
	    DESCAMPANIA,--
	    DESTIPEVALUACIONRIESGO, --
		FECSOLICITUD,
		HORINICIOATENCION,--
		NUMDIAINICIOATENCION,--
		NUMSEMANAMESINICIOATENCION,--
		NBRDIASEMANAINICIOATENCION,--
		NBRDIASEMANAINICIOATENCION_ORD,--
		day(FECSOLICITUD) AS NUMDIA,--
		FLGDIAUTIL,
		FECHORSOLICITUD,
		FECHORINICIOEVALUACION,--
		FECHORFINEVALUACION,--
		FECDESEMBOLSO,--
		FECHORDESEMBOLSO,
	    TIEMPOATENCIONSOLICITUD,
	    TIEMPODERIVACIONANALISTA,
	    --TIEMPODESEMBOLSOPOSTATENCIONANALISTA,
	    DESTIPRENTA,--
	    SEGMENTO,--
	    ESTADOSOLICITUD,--
	    (CASE
			WHEN MOTIVOMALADERIVACION IS NOT NULL THEN 1
			ELSE 0
		END) AS FLGDENEGADAMALDERIVADA,
	    (CASE
			WHEN MOTIVOMALADERIVACION IS NOT NULL THEN MTOSOLICITADO
			ELSE 0
		END) AS MTODENEGADOMALDERIVADO,
		MOTIVOMALADERIVACION,
		SUBMOTIVOMALADERIVACION,
		(CASE WHEN FLGCAMBIOTASA = 1 THEN 'SI' ELSE 'NO' END) AS FLGCAMBIOTASA,
		FLGAPROBADO,--
		FLGDENEGADO,--
		FLGAPROBADONORENEGOCIADO,
		FLGAPROBADORENEGOCIADO,
		FLGDESEMBOLSADO,--
		FLGNODESEMBOLSADO,--
		FLGRECUPERADA,
		MTOSOLICITADO,--
		MTOSOLICITADORECUPERADA,
		MTOAPROBADO,--
		MTODENEGADO,
		MTOAPROBADONORENEGOCIADO,
		MTOAPROBADORENEGOCIADO,
		MTODESEMBOLSADO,
		MTONODESEMBOLSADO,
		MTODENEGADOTOTAL,
		TIEMPOATENCIONANALISTA,
		(CASE
			WHEN MTOAPROBADO > 0 AND MTOAPROBADO <= 100000 THEN 'ANALISTA'
			WHEN MTOAPROBADO > 100000 AND MTOAPROBADO <=240000 THEN 'SUPERVISOR'
			WHEN MTOAPROBADO > 240000 THEN 'GERENTE'
			ELSE 'NO AUTONOMIA'
		END) AS NIVELAUTONOMIA,
--		(CASE WHEN MTOAPROBADO > 0 THEN 1 ELSE 0 END) AS FLGAUTONOMIA,
--		(CASE WHEN MTOAPROBADO > 0 THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADOAUTONOMIA,
--		(CASE WHEN MTOAPROBADO > 0 AND FLGDESEMBOLSADO > 0 THEN 1 ELSE 0 END) AS FLGDESEMBOLSOAUTONOMIA,
--		(CASE WHEN MTOAPROBADO > 0 AND MTODESEMBOLSADO > 0 THEN MTODESEMBOLSADO ELSE 0 END) AS MTODESEMBOLSADOAUTONOMIA,
		(CASE
			WHEN MTOAPROBADORENEGOCIADO IS NULL THEN 'SIN INF.'
			WHEN MTOAPROBADORENEGOCIADO >= 0 AND MTOAPROBADORENEGOCIADO < 10000 THEN '0 - 10,000'
			WHEN MTOAPROBADORENEGOCIADO >= 10000 AND MTOAPROBADORENEGOCIADO < 20000 THEN '10,000 - 20,000'
			WHEN MTOAPROBADORENEGOCIADO >= 20000 AND MTOAPROBADORENEGOCIADO < 30000 THEN '20,000 - 30,000'
			WHEN MTOAPROBADORENEGOCIADO >= 30000 AND MTOAPROBADORENEGOCIADO < 40000 THEN '30,000 - 40,000'
			WHEN MTOAPROBADORENEGOCIADO >= 40000 AND MTOAPROBADORENEGOCIADO < 50000 THEN '40,000 - 50,000'
			ELSE '>= 50,000'
		END) AS BRACKETRENEGOCIADO,
		(CASE
			WHEN TIEMPOATENCIONSOLICITUD IS NULL THEN 'SIN INF.'
		    WHEN TIEMPOATENCIONSOLICITUD > 0 AND TIEMPOATENCIONSOLICITUD <= 12 THEN '0h - 12h'
		    WHEN TIEMPOATENCIONSOLICITUD > 12 and TIEMPOATENCIONSOLICITUD <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETATENCIONSOLICITUD,
		(CASE
			WHEN TIEMPOATENCIONSOLICITUD IS NULL THEN 1
			WHEN TIEMPOATENCIONSOLICITUD > 0 AND TIEMPOATENCIONSOLICITUD <= 12 THEN 2
			WHEN TIEMPOATENCIONSOLICITUD > 12 and TIEMPOATENCIONSOLICITUD <= 24 THEN 3
			ELSE 4
		END) AS BRACKETATENCIONSOLICITUD_ORD,
		(CASE
			WHEN TIEMPODERIVACIONANALISTA IS NULL THEN 'SIN INF.'
		    WHEN TIEMPODERIVACIONANALISTA > 0 and TIEMPODERIVACIONANALISTA <= 12 THEN '0h - 12h'
		    WHEN TIEMPODERIVACIONANALISTA > 12 and TIEMPODERIVACIONANALISTA <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETDERIVACIONANALISTA,
		(CASE
			WHEN TIEMPODERIVACIONANALISTA IS NULL THEN 1
			WHEN TIEMPODERIVACIONANALISTA > 0 AND TIEMPODERIVACIONANALISTA <= 12 THEN 2
			WHEN TIEMPODERIVACIONANALISTA > 12 AND TIEMPODERIVACIONANALISTA <= 24 THEN 3
			ELSE 4
		END) AS BRACKETDERIVACIONANALISTA_ORD, 
		(CASE
			WHEN TIEMPOATENCIONANALISTA IS NULL THEN 'SIN INF.'
			WHEN TIEMPOATENCIONANALISTA < 0 THEN 'VALOR INVÁLIDO'
		    WHEN TIEMPOATENCIONANALISTA >= 0 AND TIEMPOATENCIONANALISTA < 1 THEN '0h - 1h'
		    WHEN TIEMPOATENCIONANALISTA >= 1 AND TIEMPOATENCIONANALISTA < 2 THEN '1h - 2h'
		    WHEN TIEMPOATENCIONANALISTA >= 2 AND TIEMPOATENCIONANALISTA < 3 THEN '2h - 3h'
		    WHEN TIEMPOATENCIONANALISTA >= 3 AND TIEMPOATENCIONANALISTA < 4 THEN '3h - 4h'
		    WHEN TIEMPOATENCIONANALISTA >= 4 AND TIEMPOATENCIONANALISTA < 5 THEN '4h - 5h'
		    WHEN TIEMPOATENCIONANALISTA >= 5 AND TIEMPOATENCIONANALISTA < 6 THEN '5h - 6h'
		    WHEN TIEMPOATENCIONANALISTA >= 6 AND TIEMPOATENCIONANALISTA < 7 THEN '6h - 7h'
		    WHEN TIEMPOATENCIONANALISTA >= 7 AND TIEMPOATENCIONANALISTA < 8 THEN '7h - 8h'
		    WHEN TIEMPOATENCIONANALISTA >= 8 AND TIEMPOATENCIONANALISTA < 9 THEN '8h - 9h'
	    	ELSE '>=9h'
		END) AS BRACKETATENCIONANALISTA,
		-- COLUMN ORDINAL
		
		(CASE
			WHEN TIEMPOATENCIONANALISTA IS NULL THEN 1
			WHEN TIEMPOATENCIONANALISTA < 0 THEN 2
			WHEN TIEMPOATENCIONANALISTA >= 0 AND TIEMPOATENCIONANALISTA < 1 THEN 3
			WHEN TIEMPOATENCIONANALISTA >= 1 AND TIEMPOATENCIONANALISTA < 2 THEN 4
			WHEN TIEMPOATENCIONANALISTA >= 2 AND TIEMPOATENCIONANALISTA < 3 THEN 5
			WHEN TIEMPOATENCIONANALISTA >= 3 AND TIEMPOATENCIONANALISTA < 4 THEN 6
			WHEN TIEMPOATENCIONANALISTA >= 4 AND TIEMPOATENCIONANALISTA < 5 THEN 7
			WHEN TIEMPOATENCIONANALISTA >= 5 AND TIEMPOATENCIONANALISTA < 6 THEN 8
			WHEN TIEMPOATENCIONANALISTA >= 6 AND TIEMPOATENCIONANALISTA < 7 THEN 9
			WHEN TIEMPOATENCIONANALISTA >= 7 AND TIEMPOATENCIONANALISTA < 8 THEN 10
			WHEN TIEMPOATENCIONANALISTA >= 8 AND TIEMPOATENCIONANALISTA < 9 THEN 11
			ELSE 12
		END) AS BRACKETATENCIONANALISTA_ORD,
		(CASE
			WHEN TIEMPOATENCIONSOLICITUDANALISTA IS NULL THEN 'SIN INF.'
		    WHEN TIEMPOATENCIONSOLICITUDANALISTA > 0 AND TIEMPOATENCIONSOLICITUDANALISTA <= 12 THEN '0h - 12h'
		    WHEN TIEMPOATENCIONSOLICITUDANALISTA > 12 AND TIEMPOATENCIONSOLICITUDANALISTA <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETATENCIONSOLICITUDANALISTA,
		(CASE
			WHEN TIEMPOATENCIONSOLICITUDANALISTA IS NULL THEN 1
			WHEN TIEMPOATENCIONSOLICITUDANALISTA > 0 AND TIEMPOATENCIONSOLICITUDANALISTA <= 12 THEN 2
			WHEN TIEMPOATENCIONSOLICITUDANALISTA > 12 AND TIEMPOATENCIONSOLICITUDANALISTA <= 24 THEN 3
			ELSE 4
		END) AS BRACKETATENCIONSOLICITUDANALISTA_ORD
		/*(CASE
			WHEN TIEMPODESEMBOLSOPOSTATENCIONANALISTA IS NULL THEN 'SIN INF.'
		    WHEN TIEMPODESEMBOLSOPOSTATENCIONANALISTA > 0 AND TIEMPODESEMBOLSOPOSTATENCIONANALISTA <= 12 THEN '0h - 12h'
		    WHEN TIEMPODESEMBOLSOPOSTATENCIONANALISTA > 12 AND TIEMPODESEMBOLSOPOSTATENCIONANALISTA <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETDESEMBOLSOPOSTATENCIONANALISTA*/
	FROM TP_BASE
	WHERE CENTROATENCION IN ('CENTRALIZADO', 'PUNTO DE CONTACTO')
