BASE_FLAGS AS (
  SELECT
    m.CODEVALUACIONSOLICITUD,
    m.CODINTERNOCOMPUTACIONAL,
    m.CODCLAVEPARTYCLI,
    m.CODMESEVALUACION AS CODMESSOLICITUDEVALUACION,
    m.FECSOLICITUDEVALUACION,
    m.DESCANALVENTARBMPER AS DESCANALVENTARBM,
    m.DESTIPDECISIONRESULTADORBM,
    m.DESCAMPANIASOLICITUD,
    m.DESTIPEVALUACIONSOLICITUDCREDITO,
    m.CANAL_MDPREST,
    m.FLG_REINGRESO_1M,
    
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' THEN 1 ELSE 0 END AS FLG_APROBADO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM IN ('Decline','Investigate') THEN 1 ELSE 0 END AS FLG_DENEGADO,
    
    CASE WHEN m.DESTIPDECISIONRESULTADORBM IN ('Decline','Investigate') AND m.FLG_REINGRESO_1M = 1 THEN 1 ELSE 0 END AS FLG_DENEGADO_CON_REINGRESO_1M, -- SE VOLVIO A DENEGAR UNA SOLICITUD
    CASE WHEN m.DESTIPDECISIONRESULTADORBM IN ('Decline','Investigate') AND m.FLG_REINGRESO_1M = 0 THEN 1 ELSE 0 END AS FLG_DENEGADO_SIN_REINGRESO_1M, -- SE LE DENEGO Y NO VOLVIO A INGRESAR SOLICITUD
    
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FECAPERTURA IS NOT NULL THEN 1 ELSE 0 END AS FLG_DESEMBOLSADO, -- SE LE APRUEBA Y DESEMBOLSA
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FECAPERTURA IS NULL THEN 1 ELSE 0 END AS FLG_NODESEMBOLSADO, -- SE LE APRUEBA Y NO DESEMBOLSA
    
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FLG_REINGRESO_1M = 1 AND m.FECAPERTURA IS NOT NULL THEN 1 ELSE 0 END AS FLG_APROBADO_CON_REINGRESO_1M_CON_DESEMBOLSO, -- SE LE DENIEGA, DESPUES SE LE APRUEBA Y SE DESEMBOLSA
    
    -- ESTO SE BUSCA
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FLG_REINGRESO_1M = 1 AND m.FECAPERTURA IS NULL THEN 1 ELSE 0 END AS FLG_APROBADO_CON_REINGRESO_1M_SIN_DESEMBOLSO, -- DESPUES DE UNA SOLICITUD DENEGADA, SE LE APRUEBA PERO NO DESEMBOLSA
    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FLG_REINGRESO_1M = 0 AND m.FECAPERTURA IS NULL THEN 1 ELSE 0 END AS FLG_APROBADO_SIN_REINGRESO_SIN_DESEMBOLSO -- DESPUES DE UNA SOLICITUD APROBADA, NO TIENE REINGRESO Y TAMPOCO DESEMBOLSA
    
    
--    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' THEN COALESCE(m.MTODESEMBOLSADO,0) ELSE 0 END AS MTODESEMBOLSADO,
--    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' THEN COALESCE(m.MTOORIGINALCREDITO,0) ELSE 0 END AS MTOORIGINALCREDITO,
--    CASE WHEN m.DESTIPDECISIONRESULTADORBM='Approve' AND m.FLG_REINGRESO_1M=1 AND m.FECAPERTURA IS NOT NULL THEN COALESCE(m.MTODESEMBOLSADO,0) ELSE 0 END AS MTODESEMBOLSADO_REINGRESO_1M
  FROM MATCH_ONE m
),

SBS_DEUDA AS (
  SELECT
    CAST(date_format(FECDIA,'yyyyMM') AS INT) AS CODMESDEUDA,
    CODCLAVEPARTYCLI,
    SUM(MTODEUDASOL) AS MTODEUDASOL_SISTEMA
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_DEUDORSBSDETALLE
  WHERE CAST(date_format(FECDIA,'yyyyMM') AS INT) BETWEEN 202412 AND 202512
    AND NBREMPSISTEMAFINANCIERO NOT IN ('BANCO DE CREDITO DEL PERÃš')
  GROUP BY CAST(date_format(FECDIA,'yyyyMM') AS INT), CODCLAVEPARTYCLI
),

BASE_MESREF AS (
  SELECT
    b.*,
    CAST(date_format(add_months(to_date(concat(CAST(b.CODMESSOLICITUDEVALUACION AS STRING),'01'),'yyyyMMdd'),-1),'yyyyMM') AS INT) AS CODMES_SBS_MENOS_1,
    b.CODMESSOLICITUDEVALUACION AS CODMES_SBS_MES
  FROM BASE_FLAGS b
),
BASE_SBS AS (
  SELECT
    x.*,
    COALESCE(s1.MTODEUDASOL_SISTEMA,0) AS MTO_DEUDA_SBS_MES_MENOS_1,
    COALESCE(s2.MTODEUDASOL_SISTEMA,0) AS MTO_DEUDA_SBS_MES,
    COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) AS DELTA_DEUDA_SBS,
    CASE WHEN COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) > 0 THEN 1 ELSE 0 END AS FLG_AUMENTO_DEUDA_SBS, -- VERIFICAR SI ES POR INTERESES
    CASE WHEN COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) > 0 THEN COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) ELSE 0 END AS MTO_AUMENTO_DEUDA_SBS, -- VERIFICAR SI ES POR INTERESES
    CASE WHEN (COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0)) > 100 THEN 1 ELSE 0 END AS FLG_AUMENTO_DEUDA_SBS_REGLA,
    CASE WHEN (COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0)) > 100 THEN (COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0)) ELSE 0 END AS MTO_AUMENTO_DEUDA_SBS_REGLA
  FROM BASE_MESREF x
  LEFT JOIN SBS_DEUDA s1
    ON x.CODCLAVEPARTYCLI = s1.CODCLAVEPARTYCLI
   AND x.CODMES_SBS_MENOS_1 = s1.CODMESDEUDA
  LEFT JOIN SBS_DEUDA s2
    ON x.CODCLAVEPARTYCLI = s2.CODCLAVEPARTYCLI
   AND x.CODMES_SBS_MES = s2.CODMESDEUDA
)
