WITH
TP_TIPOCAMBIO AS (
	SELECT 3.81 AS TC_USD_SOL
),
TP_BASESOLICITUDESSALESFORCE AS (
	SELECT
		A.CODMESEVALUACION AS CODMESEVALUACION,
    	A.CODSOLICITUD,
    	(CASE
			WHEN A.NBRDIVISA = 'USD' THEN A.MTOSOLICITADO * B.TC_USD_SOL
			ELSE A.MTOSOLICITADO
		END) AS MTOSOLICITADO,
     	(CASE
			WHEN A.NBRDIVISA = 'USD' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
    	A.MATANALISTA_FINAL AS MATRICULA,
    	A.ESTADOSOLICITUD,
    	A.ESTADOSOLICITUDPASO,
    	A.TIPACCION AS DESTIPPRODUCTO,
    	A.NBRPRODUCTO AS DESPRODUCTO,
    	A.ETAPA AS DESTIPETAPA,
		A.MOTIVOMALADERIVACION,
		A.SUBMOTIVOMALADERIVACION,
		A.FECINICIOEVALUACION_ULT AS FECINICIOEVALUACION
	FROM CATALOG_LHCL_PROD_BCP_EXPL.BCP_EDV_RBMBDN.TP_SOLICITUDES_CENTRALIZADO A
	CROSS JOIN TP_TIPOCAMBIO B
),
TP_COLABORADOR AS (
    SELECT
        FECDIA,
        date_format(FECDIA, 'yyyyMM') AS CODMES,
        CODMATRICULA,
        CODMATRICULASUP,
        NBRUNIDADORGANIZATIVA,
        NBRAREAUNIDADORGANIZATIVA,
        NBRSERVUNIDADORGANIZATIVA,
        (CASE
        	WHEN NBRAREAUNIDADORGANIZATIVA IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1') THEN 'DCA'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS' THEN 'TLMK'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA BANCA AFLUENTE' AND NBRSERVUNIDADORGANIZATIVA = 'GERENCIA DE BANCA ENALTA' THEN 'ENALTA'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA BANCA AFLUENTE' AND NBRSERVUNIDADORGANIZATIVA = 'GERENCIA DE BANCA EXCLUSIVA DIGITAL' THEN 'BEX'
			ELSE 'OTROS'
		END) AS CANAL
    FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_COLABORADOR
    WHERE DESTIPESTADOLABORAL = 'Activo'
),
TP_COLABORADORANALISTA AS (
    SELECT
        FECDIA,
        CODMES,
        MATORGANICO,
        MATSUPERIOR,
        NBRAREAUNIDADORGANIZATIVA
    FROM (
        SELECT
            FECDIA,
            CODMES,
            CODMATRICULA       AS MATORGANICO,
            CODMATRICULASUP    AS MATSUPERIOR,
            NBRAREAUNIDADORGANIZATIVA,
            ROW_NUMBER() OVER (
                PARTITION BY FECDIA, CODMATRICULA
                ORDER BY FECDIA DESC
            ) AS rn
        FROM TP_COLABORADOR
    ) x
    WHERE rn = 1
),
TP_BASE_SOLICITUDES AS (
	SELECT
		A.CODMESEVALUACION AS CODMES,
	    A.CODSOLICITUD,
	    (CASE 
	    	WHEN A.ESTADOSOLICITUD = 'PENDIENTE' AND A.DESTIPETAPA = 'DESESTIMADA' THEN 'RECHAZADO'
	    	WHEN A.ESTADOSOLICITUD = 'RECUPERADA' AND A.DESTIPETAPA = 'DESESTIMADA' THEN 'RECHAZADO'
	    	ELSE A.ESTADOSOLICITUD
	    END) AS ESTADOSOLICITUD,
	    A.ESTADOSOLICITUDPASO,
		A.MOTIVOMALADERIVACION,
		A.SUBMOTIVOMALADERIVACION,
	    A.MTOSOLICITADO,
		A.MTOAPROBADO,
	    A.MATRICULA AS MATANALISTA,
	    A.DESTIPPRODUCTO AS PRODUCTO,
	    A.DESPRODUCTO,
	    A.DESTIPETAPA,
	    B.NBRAREAUNIDADORGANIZATIVA,
	    B.MATSUPERIOR
	FROM TP_BASESOLICITUDESSALESFORCE A
	LEFT JOIN TP_COLABORADORANALISTA B ON (B.FECDIA = A.FECINICIOEVALUACION AND B.MATORGANICO = A.MATRICULA)
),
