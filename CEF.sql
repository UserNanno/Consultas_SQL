CREATE OR REPLACE TABLE CATALOG_LHCL_PROD_BCP_EXPL.BCP_EDV_RBMBDN.T72496_MIGRACION_PLANCHON
AS
WITH
TP_TIPOCAMBIO AS (
	SELECT 3.81 AS TC_USD_SOL
),
PLANCHON AS (
	SELECT
		CODMES,
		CODSOLICITUD,
		CENTROATENCION,
		DESTIPOPERACION,
		MATANALISTA,
		ESTADOSOLICITUD,
		DESTIPEVALUACIONRIESGO,
		NBREQUIPO,
		DESTIPRENTA,
		SEGMENTO,
		(CASE WHEN MOTIVORESULTADOANALISTA = 'DEBIO APROBARSE EN PDC' THEN 'SI' ELSE 'NO' END) AS FLGCAMBIOTASA,
		(CASE
			WHEN MOTIVOMALADERIVACION IS NOT NULL AND ESTADOSOLICITUD = 'RECHAZADO' THEN MOTIVOMALADERIVACION
			ELSE NULL
		END) AS MOTIVOMALADERIVACION,
		(CASE
			WHEN MOTIVOMALADERIVACION IS NOT NULL AND ESTADOSOLICITUD = 'RECHAZADO' THEN SUBMOTIVOMALADERIVACION
			ELSE NULL
		END) AS SUBMOTIVOMALADERIVACION,
		MTOSOLICITADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FLGDESEMBOLSO = 1 THEN FECDESEMBOLSO ELSE NULL END) AS FECDESEMBOLSO,
		(CASE WHEN ESTADOSOLICITUD = 'RECHAZADO' THEN 1 ELSE 0 END) AS FLGDENEGADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' THEN 1 ELSE 0 END) AS FLGAPROBADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FLGDESEMBOLSO = 1 AND FECDESEMBOLSO IS NOT NULL THEN 1 ELSE 0 END) AS FLGDESEMBOLSADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FLGDESEMBOLSO = 0 AND FECDESEMBOLSO IS NULL THEN 1 ELSE 0 END) AS FLGNODESEMBOLSADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOSOLICITADO = MTOAPROBADO THEN 1 ELSE 0 END) AS FLGAPROBADONORENEGOCIADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOSOLICITADO <> MTOAPROBADO THEN 1 ELSE 0 END) AS FLGAPROBADORENEGOCIADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADO,
		(CASE WHEN ESTADOSOLICITUD = 'RECHAZADO' THEN MTOSOLICITADO ELSE 0 END) AS MTODENEGADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FLGDESEMBOLSO = 1 AND FECDESEMBOLSO IS NOT NULL THEN MTODESEMBOLSADO ELSE 0 END) AS MTODESEMBOLSADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FLGDESEMBOLSO = 0 AND FECDESEMBOLSO IS NULL THEN MTOAPROBADO ELSE 0 END) AS MTONODESEMBOLSADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOSOLICITADO = MTOAPROBADO THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADONORENEGOCIADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOSOLICITADO <> MTOAPROBADO THEN MTOSOLICITADO - MTOAPROBADO ELSE 0 END) AS MTOAPROBADORENEGOCIADO,
		( (CASE WHEN ESTADOSOLICITUD = 'RECHAZADO' THEN MTOSOLICITADO ELSE 0 END) + (CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOSOLICITADO <> MTOAPROBADO THEN MTOSOLICITADO - MTOAPROBADO ELSE 0 END) ) AS MTODENEGADOTOTAL
		
	FROM CATALOG_LHCL_PROD_BCP_EXPL.BCP_EDV_RBMBDN.T72496_TP_PLANCHON_1
),
TP_COLABORADOR AS (
    SELECT
        FECDIA,
        date_format(FECDIA, 'yyyyMM') AS CODMES,
        CODMATRICULA,
        CODMATRICULASUP,
        NBRUNIDADORGANIZATIVA,
        NBRAREAUNIDADORGANIZATIVA,
        NBRSERVUNIDADORGANIZATIVA,
        (CASE
        	WHEN NBRAREAUNIDADORGANIZATIVA IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1') THEN 'DCA'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS' THEN 'TLMK'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA BANCA AFLUENTE' AND NBRSERVUNIDADORGANIZATIVA = 'GERENCIA DE BANCA ENALTA' THEN 'ENALTA'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA BANCA AFLUENTE' AND NBRSERVUNIDADORGANIZATIVA = 'GERENCIA DE BANCA EXCLUSIVA DIGITAL' THEN 'BEX'
			ELSE 'OTROS'
		END) AS CANAL,
		FECACTUALIZACIONREGISTRO
    FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_COLABORADOR
    WHERE DESTIPESTADOLABORAL = 'Activo'
),
TP_COLABORADORVENDEDOR AS (
    SELECT
        FECDIA,
        CODMES,
        MATORGANICO,
        MATSUPERIOR,
        NBRUNIDADORGANIZATIVAVENDEDOR,
        NBRAREAUNIDADORGANIZATIVAVENDEDOR,
        NBRSERVUNIDADORGANIZATIVAVENDEDOR,
        CANAL
    FROM (
        SELECT
            FECDIA,
            CODMES,
            CODMATRICULA       AS MATORGANICO,
            CODMATRICULASUP    AS MATSUPERIOR,
            NBRUNIDADORGANIZATIVA     AS NBRUNIDADORGANIZATIVAVENDEDOR,
            NBRAREAUNIDADORGANIZATIVA AS NBRAREAUNIDADORGANIZATIVAVENDEDOR,
            NBRSERVUNIDADORGANIZATIVA AS NBRSERVUNIDADORGANIZATIVAVENDEDOR,
            CANAL,
            ROW_NUMBER() OVER (
                PARTITION BY FECDIA, CODMATRICULA
                ORDER BY FECACTUALIZACIONREGISTRO DESC
            ) AS rn
        FROM TP_COLABORADOR
    ) x
    WHERE rn = 1
),
TP_SOLICITUDCREDITOCONSUMO AS (
	SELECT
		A.CODSOLICITUD,
		(CASE
			WHEN A.CODPRODUCTO IN ('EFME', 'EFDP') THEN 'LIBRE DISPONIBILIDAD' -- EFDP: CONVENIO
			WHEN A.CODPRODUCTO = 'EFCD' THEN 'COMPRA DEUDA'
			ELSE 'OTROS'
		END) AS PRODUCTO,
		CAST(NULL AS STRING) AS DESPRODUCTO,
		UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		A.CODMATRICULACOLABORADORVENDEDOR,
		A.NBRAGE,
		date_format(A.FECSOLICITUD, 'yyyyMM') AS CODMES,
		A.FECSOLICITUD,
		substring(HORINICIOCALIF, 1, 2) AS HORINICIOATENCION,
		dayofmonth(FECINICIOCALIF) AS NUMDIAINICIOATENCION,
		(CASE
			WHEN dayofmonth(FECINICIOCALIF) BETWEEN 1 AND 7 THEN 'S1'
			WHEN dayofmonth(FECINICIOCALIF) BETWEEN 8 AND 14 THEN 'S2'
			WHEN dayofmonth(FECINICIOCALIF) BETWEEN 15 AND 21 THEN 'S3'
			ELSE 'S4'
		END) AS NUMSEMANAMESINICIOATENCION,
		(CASE pmod(dayofweek(FECINICIOCALIF) + 5, 7) + 1
			WHEN 1 THEN 'LUN'
			WHEN 2 THEN 'MAR'
			WHEN 3 THEN 'MIE'
			WHEN 4 THEN 'JUE'
			WHEN 5 THEN 'VIE'
			WHEN 6 THEN 'SAB'
			WHEN 7 THEN 'DOM'
		END) AS NBRDIASEMANAINICIOATENCION,
		pmod(dayofweek(FECINICIOCALIF) + 5, 7) + 1 AS NBRDIASEMANAINICIOATENCION_ORD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECSOLICITUD, LPAD(A.HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECINICIOCALIF, LPAD(A.HORINICIOCALIF, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORINICIOEVALUACION,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECFINCALIF, LPAD(A.HORFINCALIF, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORFINEVALUACION,
		CAST(NULL AS STRING) AS MTOAPROBADO,
		CAST(NULL AS STRING) AS FECDESEMBOLSO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO A
),
TP_SOLICITUDTARJETACREDITO AS (
	SELECT
		A.CODSOLICITUD,
		A.DESTIPFLUJOVENTATARJETACREDITO AS PRODUCTO,
		UPPER(A.DESPRODUCTO) AS DESPRODUCTO,
		UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		A.CODMATRICULACOLABORADORVENDEDOR,
		A.NBRAGE,
		date_format(A.FECSOLICITUD, 'yyyyMM') AS CODMES,
		A.FECSOLICITUD,
		substring(HORINICIOEVALUACION, 1, 2) AS HORINICIOATENCION,
		dayofmonth(FECINICIOEVALUACION) AS NUMDIAINICIOATENCION,
		(CASE
			WHEN dayofmonth(FECINICIOEVALUACION) BETWEEN 1 AND 7 THEN 'S1'
			WHEN dayofmonth(FECINICIOEVALUACION) BETWEEN 8 AND 14 THEN 'S2'
			WHEN dayofmonth(FECINICIOEVALUACION) BETWEEN 15 AND 21 THEN 'S3'
			ELSE 'S4'
		END) AS NUMSEMANAMESINICIOATENCION,
		(CASE pmod(dayofweek(FECINICIOEVALUACION) + 5, 7) + 1
			WHEN 1 THEN 'LUN'
			WHEN 2 THEN 'MAR'
			WHEN 3 THEN 'MIE'
			WHEN 4 THEN 'JUE'
			WHEN 5 THEN 'VIE'
			WHEN 6 THEN 'SAB'
			WHEN 7 THEN 'DOM'
		END) AS NBRDIASEMANAINICIOATENCION,
		pmod(dayofweek(FECINICIOEVALUACION) + 5, 7) + 1 AS NBRDIASEMANAINICIOATENCION_ORD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECSOLICITUD, LPAD(A.HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECINICIOEVALUACION, LPAD(A.HORINICIOEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORINICIOEVALUACION,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECFINEVALUACION, LPAD(A.HORFINEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORFINEVALUACION,
		-- INCORPORANDO MONTOS Y FECHAS DE DESEMBOLSOS DE TC PARA RELLENAR 2025
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
		A.FECEMISIONTARJETACREDITO AS FECDESEMBOLSO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDTARJETACREDITO A
	CROSS JOIN TP_TIPOCAMBIO B
	WHERE A.CODTIPREGAPP IN ('0126O000001xsIYQAY','0126O000001h0WaQAI','0126O000001h0WbQAI')
),
TP_UNION AS (
	SELECT * FROM TP_SOLICITUDCREDITOCONSUMO
	UNION ALL
	SELECT * FROM TP_SOLICITUDTARJETACREDITO
),
TP_COLABORADORVENDEDOR_FALLBACK AS (
 SELECT
   CODSOLICITUD,
   NBRUNIDADORGANIZATIVAVENDEDOR,
   NBRAREAUNIDADORGANIZATIVAVENDEDOR,
   NBRSERVUNIDADORGANIZATIVAVENDEDOR,
   CANAL
 FROM (
   SELECT
     A.CODSOLICITUD,
     B.NBRUNIDADORGANIZATIVAVENDEDOR,
     B.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
     B.NBRSERVUNIDADORGANIZATIVAVENDEDOR,
     B.CANAL,
     ROW_NUMBER() OVER (
       PARTITION BY A.CODSOLICITUD
       ORDER BY B.FECDIA DESC
     ) AS rn
   FROM TP_UNION A
   JOIN TP_COLABORADORVENDEDOR B
     ON B.MATORGANICO = A.CODMATRICULACOLABORADORVENDEDOR
    AND B.FECDIA <= A.FECSOLICITUD
    AND B.FECDIA >= date_sub(A.FECSOLICITUD, 7)   -- ventana hacia atrás
   WHERE A.CODMATRICULACOLABORADORVENDEDOR IS NOT NULL
 ) t
 WHERE rn = 1
),
TP_BASE_UNION AS (
 SELECT
   A.*,
   B.NBRUNIDADORGANIZATIVAVENDEDOR,
   B.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
   B.NBRSERVUNIDADORGANIZATIVAVENDEDOR,
   B.CANAL,
   ROUND(date_diff(SECOND, A.FECHORSOLICITUD, A.FECHORINICIOEVALUACION) / 3600, 2) AS TIEMPODERIVACIONANALISTA,
   ROUND(date_diff(SECOND, A.FECHORINICIOEVALUACION, A.FECHORFINEVALUACION) / 3600, 2) AS TIEMPOATENCIONANALISTA,
   ROUND(date_diff(SECOND, A.FECHORSOLICITUD, A.FECHORFINEVALUACION) / 3600, 2) AS TIEMPOATENCIONSOLICITUDANALISTA
 FROM TP_UNION A
 LEFT JOIN TP_COLABORADORVENDEDOR_FALLBACK B ON (A.CODSOLICITUD = B.CODSOLICITUD)
),
CALENDARIO AS (
    SELECT explode(
        sequence(to_date('2024-01-01'), to_date('2026-12-31'), interval 1 day)
    ) AS FECHA
),
DIMCALENDARIO AS (
    SELECT
        A.FECHA,
        (CASE
            WHEN dayofweek(A.FECHA) = 1 THEN 0       -- domingo (1)
            WHEN B.FECHA IS NOT NULL THEN 0              -- feriado
            ELSE 1
        END) AS FLGDIAUTIL
    FROM CALENDARIO A
    LEFT JOIN CATALOG_LHCL_PROD_BCP_EXPL.BCP_EDV_RBMBDN.T72496_DE_DIASNOHABILES B ON A.FECHA = B.FECHA
),
TP_BASE AS(
	SELECT
		B.CODMES, -- CAMBIAR ALIAS "A" PARA MANTENER MISMOS NUMEROS DEL PLANCHON ORIGINAL (ERRORES) - ISSUE FECSOLICITUD DESFASADA CON CODMES ORIGINAL
		A.CODSOLICITUD,
		A.CENTROATENCION,
		B.CANAL,
		B.NBRAGE,
		A.MATANALISTA,
		A.NBREQUIPO,
		B.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
		A.DESTIPOPERACION,
		B.PRODUCTO,
		B.DESPRODUCTO,
		B.DESCAMPANIA,
		A.DESTIPEVALUACIONRIESGO,
		B.FECSOLICITUD,
		B.HORINICIOATENCION,
		B.NUMDIAINICIOATENCION,
		B.NUMSEMANAMESINICIOATENCION,
		B.NBRDIASEMANAINICIOATENCION,
		B.NBRDIASEMANAINICIOATENCION_ORD,
		day(B.FECSOLICITUD) AS NUMDIA,
		B.FECHORSOLICITUD,
		B.FECHORINICIOEVALUACION,
		B.FECHORFINEVALUACION,
		-- RELLENANDO DESEMBOLSOS
		(CASE
			WHEN A.FECDESEMBOLSO IS NOT NULL THEN A.FECDESEMBOLSO
			WHEN ESTADOSOLICITUD = 'APROBADO' AND A.DESTIPOPERACION IN ('TARJETA CREDITO STOCK', 'TARJETA CREDITO NUEVA') AND A.FECDESEMBOLSO IS NULL AND B.FECDESEMBOLSO IS NOT NULL THEN B.FECDESEMBOLSO
			ELSE NULL
		END) AS FECDESEMBOLSO,
		TO_TIMESTAMP(CONCAT(A.FECDESEMBOLSO, ' 23:59:59'), 'yyyy-MM-dd HH:mm:ss') AS FECHORDESEMBOLSO,
		B.TIEMPODERIVACIONANALISTA,
		A.DESTIPRENTA,
		A.SEGMENTO,
		A.ESTADOSOLICITUD,
		(CASE
			WHEN A.MOTIVOMALADERIVACION IS NOT NULL THEN 1
			ELSE 0
		END) AS FLGDENEGADAMALDERIVADA,
		(CASE
			WHEN A.MOTIVOMALADERIVACION IS NOT NULL THEN MTOSOLICITADO
			ELSE 0
		END) AS MTODENEGADOMALDERIVADO,
		A.MOTIVOMALADERIVACION,
		A.SUBMOTIVOMALADERIVACION,
		A.FLGCAMBIOTASA,
		A.FLGAPROBADO,
		A.FLGDENEGADO,
		A.FLGAPROBADONORENEGOCIADO,
		A.FLGAPROBADORENEGOCIADO,
		(CASE
			WHEN A.FLGDESEMBOLSADO IS NOT NULL THEN A.FLGDESEMBOLSADO
			WHEN A.ESTADOSOLICITUD = 'APROBADO' AND A.FLGDESEMBOLSADO = 0 AND A.FECDESEMBOLSO IS NULL AND A.DESTIPOPERACION IN ('TARJETA CREDITO STOCK', 'TARJETA CREDITO NUEVA') AND B.FECDESEMBOLSO IS NOT NULL THEN 1
			ELSE 0 
		END) AS FLGDESEMBOLSADO,
		(CASE
			WHEN A.FLGNODESEMBOLSADO IS NOT NULL THEN A.FLGNODESEMBOLSADO
			WHEN A.ESTADOSOLICITUD = 'APROBADO' AND A.FLGNODESEMBOLSADO = 0 AND A.FECDESEMBOLSO IS NULL AND A.DESTIPOPERACION IN ('TARJETA CREDITO STOCK', 'TARJETA CREDITO NUEVA') AND B.FECDESEMBOLSO IS NULL THEN 1
			ELSE 0
		END) AS FLGNODESEMBOLSADO,
		A.FLGNODESEMBOLSADO,
		0 AS FLGRECUPERADA,
		A.MTOSOLICITADO,
		0 AS MTOSOLICITADORECUPERADA,
		A.MTOAPROBADO,
		A.MTODENEGADO,
		A.MTOAPROBADONORENEGOCIADO,
		A.MTOAPROBADORENEGOCIADO,
		(CASE
			WHEN A.MTODESEMBOLSADO IS NOT NULL THEN A.MTODESEMBOLSADO
			WHEN A.ESTADOSOLICITUD = 'APROBADO' AND A.FLGDESEMBOLSADO = 0 AND A.FECDESEMBOLSO IS NULL AND A.DESTIPOPERACION IN ('TARJETA CREDITO STOCK', 'TARJETA CREDITO NUEVA') AND B.FECDESEMBOLSO IS NOT NULL AND B.MTOAPROBADO IS NOT NULL THEN B.MTOAPROBADO
			ELSE 0
		END) AS MTODESEMBOLSADO,
		(CASE
			WHEN A.MTONODESEMBOLSADO IS NOT NULL THEN A.MTODESEMBOLSADO
			WHEN A.ESTADOSOLICITUD = 'APROBADO' AND A.FLGDESEMBOLSADO = 0 AND A.FECDESEMBOLSO IS NULL AND A.DESTIPOPERACION IN ('TARJETA CREDITO STOCK', 'TARJETA CREDITO NUEVA') AND B.FECDESEMBOLSO IS NULL THEN A.MTOAPROBADO
			ELSE NULL
		END) AS MTONODESEMBOLSADO,
		A.MTONODESEMBOLSADO,
		A.MTODENEGADOTOTAL,
		B.TIEMPOATENCIONANALISTA,
		(CASE
			WHEN A.MTOAPROBADO > 0 AND A.MTOAPROBADO <= 100000 THEN 'ANALISTA'
			WHEN A.MTOAPROBADO > 100000 AND A.MTOAPROBADO <=240000 THEN 'SUPERVISOR'
			WHEN A.MTOAPROBADO > 240000 THEN 'GERENTE'
			ELSE 'NO AUTONOMIA'
		END) AS NIVELAUTONOMIA,
		(CASE
			WHEN A.MTOAPROBADORENEGOCIADO IS NULL THEN 'SIN INF.'
			WHEN A.MTOAPROBADORENEGOCIADO >= 0 AND A.MTOAPROBADORENEGOCIADO < 10000 THEN '0 - 10,000'
			WHEN A.MTOAPROBADORENEGOCIADO >= 10000 AND A.MTOAPROBADORENEGOCIADO < 20000 THEN '10,000 - 20,000'
			WHEN A.MTOAPROBADORENEGOCIADO >= 20000 AND A.MTOAPROBADORENEGOCIADO < 30000 THEN '20,000 - 30,000'
			WHEN A.MTOAPROBADORENEGOCIADO >= 30000 AND A.MTOAPROBADORENEGOCIADO < 40000 THEN '30,000 - 40,000'
			WHEN A.MTOAPROBADORENEGOCIADO >= 40000 AND A.MTOAPROBADORENEGOCIADO < 50000 THEN '40,000 - 50,000'
			ELSE '>= 50,000'
		END) AS BRACKETRENEGOCIADO,
		(CASE
			WHEN B.TIEMPODERIVACIONANALISTA IS NULL THEN 'SIN INF.'
		    WHEN B.TIEMPODERIVACIONANALISTA > 0 AND B.TIEMPODERIVACIONANALISTA <= 12 THEN '0h - 12h'
		    WHEN B.TIEMPODERIVACIONANALISTA > 12 AND B.TIEMPODERIVACIONANALISTA <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETDERIVACIONANALISTA,
		(CASE
			WHEN B.TIEMPODERIVACIONANALISTA IS NULL THEN 1
			WHEN B.TIEMPODERIVACIONANALISTA > 0 AND B.TIEMPODERIVACIONANALISTA <= 12 THEN 2
			WHEN B.TIEMPODERIVACIONANALISTA > 12 AND B.TIEMPODERIVACIONANALISTA <= 24 THEN 3
			ELSE 4
		END) AS BRACKETDERIVACIONANALISTA_ORD, 
		(CASE
			WHEN B.TIEMPOATENCIONANALISTA IS NULL THEN 'SIN INF.'
			WHEN B.TIEMPOATENCIONANALISTA < 0 THEN 'VALOR INVÁLIDO'
		    WHEN B.TIEMPOATENCIONANALISTA >= 0 AND B.TIEMPOATENCIONANALISTA < 1 THEN '0h - 1h'
		    WHEN B.TIEMPOATENCIONANALISTA >= 1 AND B.TIEMPOATENCIONANALISTA < 2 THEN '1h - 2h'
		    WHEN B.TIEMPOATENCIONANALISTA >= 2 AND B.TIEMPOATENCIONANALISTA < 3 THEN '2h - 3h'
		    WHEN B.TIEMPOATENCIONANALISTA >= 3 AND B.TIEMPOATENCIONANALISTA < 4 THEN '3h - 4h'
		    WHEN B.TIEMPOATENCIONANALISTA >= 4 AND B.TIEMPOATENCIONANALISTA < 5 THEN '4h - 5h'
		    WHEN B.TIEMPOATENCIONANALISTA >= 5 AND B.TIEMPOATENCIONANALISTA < 6 THEN '5h - 6h'
		    WHEN B.TIEMPOATENCIONANALISTA >= 6 AND B.TIEMPOATENCIONANALISTA < 7 THEN '6h - 7h'
		    WHEN B.TIEMPOATENCIONANALISTA >= 7 AND B.TIEMPOATENCIONANALISTA < 8 THEN '7h - 8h'
		    WHEN B.TIEMPOATENCIONANALISTA >= 8 AND B.TIEMPOATENCIONANALISTA < 9 THEN '8h - 9h'
	    	ELSE '>=9h'
		END) AS BRACKETATENCIONANALISTA,
		-- COLUMN ORDINAL
		(CASE
			WHEN B.TIEMPOATENCIONANALISTA IS NULL THEN 1
			WHEN B.TIEMPOATENCIONANALISTA < 0 THEN 2
			WHEN B.TIEMPOATENCIONANALISTA >= 0 AND B.TIEMPOATENCIONANALISTA < 1 THEN 3
			WHEN B.TIEMPOATENCIONANALISTA >= 1 AND B.TIEMPOATENCIONANALISTA < 2 THEN 4
			WHEN B.TIEMPOATENCIONANALISTA >= 2 AND B.TIEMPOATENCIONANALISTA < 3 THEN 5
			WHEN B.TIEMPOATENCIONANALISTA >= 3 AND B.TIEMPOATENCIONANALISTA < 4 THEN 6
			WHEN B.TIEMPOATENCIONANALISTA >= 4 AND B.TIEMPOATENCIONANALISTA < 5 THEN 7
			WHEN B.TIEMPOATENCIONANALISTA >= 5 AND B.TIEMPOATENCIONANALISTA < 6 THEN 8
			WHEN B.TIEMPOATENCIONANALISTA >= 6 AND B.TIEMPOATENCIONANALISTA < 7 THEN 9
			WHEN B.TIEMPOATENCIONANALISTA >= 7 AND B.TIEMPOATENCIONANALISTA < 8 THEN 10
			WHEN B.TIEMPOATENCIONANALISTA >= 8 AND B.TIEMPOATENCIONANALISTA < 9 THEN 11
			ELSE 12
		END) AS BRACKETATENCIONANALISTA_ORD,
		(CASE
			WHEN TIEMPOATENCIONSOLICITUDANALISTA IS NULL THEN 'SIN INF.'
			WHEN TIEMPOATENCIONSOLICITUDANALISTA > 0 AND TIEMPOATENCIONSOLICITUDANALISTA <= 4 THEN '0h - 4h'
			WHEN TIEMPOATENCIONSOLICITUDANALISTA > 4 AND TIEMPOATENCIONSOLICITUDANALISTA <= 8 THEN '4h - 8h'
			WHEN TIEMPOATENCIONSOLICITUDANALISTA > 8 AND TIEMPOATENCIONSOLICITUDANALISTA <= 12 THEN '8h - 12h'
		    WHEN TIEMPOATENCIONSOLICITUDANALISTA > 12 AND TIEMPOATENCIONSOLICITUDANALISTA <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETATENCIONSOLICITUDANALISTA,
		(CASE
			WHEN TIEMPOATENCIONSOLICITUDANALISTA IS NULL THEN 1
			WHEN TIEMPOATENCIONSOLICITUDANALISTA > 0 AND TIEMPOATENCIONSOLICITUDANALISTA <= 4 THEN 2
			WHEN TIEMPOATENCIONSOLICITUDANALISTA > 4 AND TIEMPOATENCIONSOLICITUDANALISTA <= 8 THEN 3
			WHEN TIEMPOATENCIONSOLICITUDANALISTA > 8 AND TIEMPOATENCIONSOLICITUDANALISTA <= 12 THEN 4
			WHEN TIEMPOATENCIONSOLICITUDANALISTA > 12 AND TIEMPOATENCIONSOLICITUDANALISTA <= 24 THEN 5
			ELSE 6
		END) AS BRACKETATENCIONSOLICITUDANALISTA_ORD
	FROM PLANCHON A
	LEFT JOIN TP_BASE_UNION B ON (A.CODSOLICITUD = B.CODSOLICITUD)
)
SELECT
	A.*,
	(CASE
		WHEN B.FLGDIAUTIL = 1 THEN 'SI'
		ELSE 'NO'
	END) AS FLGDIAUTIL
FROM TP_BASE A
LEFT JOIN DIMCALENDARIO B ON (A.FECSOLICITUD = B.FECHA)
WHERE A.CODMES BETWEEN 202501 AND 202512;
