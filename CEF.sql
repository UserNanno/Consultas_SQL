WITH BASE AS (
  SELECT
    A.CODMES,
    A.CODSOLICITUD,
    B.CODINTERNOCOMPUTACIONAL,
    A.ESTADOFINAL,
    COALESCE(A.FLGCAMPANIA,0) AS FLGCAMPANIA
  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASE_PDC A
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_V.M_SOLICITUDCREDITOCONSUMO B
    ON A.CODSOLICITUD = B.CODSOLICITUD
  WHERE A.TIPOPERACION = 'CREDITO CONSUMO NUEVO'
),

BASE_CLIENTE AS (
  SELECT
    x.*,
    c.CODCLAVEPARTYCLI
  FROM BASE x
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_V.M_CLIENTE c
    ON UPPER(TRIM(x.CODINTERNOCOMPUTACIONAL)) = UPPER(TRIM(c.CODINTERNOCOMPUTACIONAL))
),

CLIENTE_MES AS (
  SELECT
    CODMES,
    CODCLAVEPARTYCLI,

    COUNT(*) AS N_SOLICITUDES_TOTAL,
    SUM(CASE WHEN FLGCAMPANIA = 1 THEN 1 ELSE 0 END) AS N_SOLIC_CON_CAMPANIA,
    SUM(CASE WHEN FLGCAMPANIA = 0 THEN 1 ELSE 0 END) AS N_SOLIC_SIN_CAMPANIA,

    MAX(CASE WHEN FLGCAMPANIA = 1 THEN 1 ELSE 0 END) AS FLG_TIENE_CON_CAMPANIA,
    MAX(CASE WHEN FLGCAMPANIA = 0 THEN 1 ELSE 0 END) AS FLG_TIENE_SIN_CAMPANIA
  FROM BASE_CLIENTE
  WHERE CODCLAVEPARTYCLI IS NOT NULL
  GROUP BY CODMES, CODCLAVEPARTYCLI
)

SELECT
  CODMES,
  CODCLAVEPARTYCLI,
  N_SOLICITUDES_TOTAL,
  N_SOLIC_CON_CAMPANIA,
  N_SOLIC_SIN_CAMPANIA
FROM CLIENTE_MES
WHERE FLG_TIENE_CON_CAMPANIA = 1
  AND FLG_TIENE_SIN_CAMPANIA = 1
ORDER BY CODMES, N_SOLICITUDES_TOTAL DESC;
