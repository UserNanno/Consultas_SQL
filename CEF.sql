CREATE OR REPLACE TABLE CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_UNIONWEEKLY
LOCATION 'abfss://bcp-edv-rbmbdn@adlscu1lhclbackp05.dfs.core.windows.net/T72496/TABLAS_DELTA/UNIONWEEKLY/'
AS
WITH
TP_BASESOLICITUDES AS (
	SELECT
		CODMES,
    	CODSOLICITUD,
    	MATANALISTA
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASESOLICITUDES
),
TP_ORGANICO AS (
	SELECT
		CODMES,
    	MATORGANICO,
    	MATSUPERIOR
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_ORGANICO
),
TP_COLABORADOR AS (
	SELECT
		CODMATRICULA,
    	UPPER(TRANSLATE(NBRUNIDADORGANIZATIVA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS NBRUNIDADORGANIZATIVAVENDEDOR,
    	UPPER(TRANSLATE(NBRDIVISIONUNIDADORGANIZATIVA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS NBRDIVISIONUNIDADORGANIZATIVAVENDEDOR,
    	UPPER(TRANSLATE(NBRAREAUNIDADORGANIZATIVA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS NBRAREAUNIDADORGANIZATIVAVENDEDOR,
    	UPPER(TRANSLATE(NBRSERVUNIDADORGANIZATIVA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS NBRSERVUNIDADORGANIZATIVAVENDEDOR,
    	CODMATRICULASUP
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_COLABORADOR
),
TP_SALESFORCEESTADOS AS (
	SELECT
    	CODSOLICITUD,
    	ESTADOSOLICITUD
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_SALESFORCEESTADOS
	WHERE ESTADOSOLICITUD IN ('APROBADO', 'RECHAZADO')
),
TP_SALESFORCEPRODUCTOS AS (
	SELECT
    	CODSOLICITUD,
    	PRODUCTO AS PRODUCTOSALESFORCE,
    	DESPRODUCTO AS DESPRODUCTOSALESFORCE,
    	ETAPA AS ETAPASALESFORCE
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_SALESFORCEPRODUCTOS
),
TP_SOLICITUDINDIVIDUO AS (
	SELECT
    	CODSOLICITUD,
    	TIPRENTA
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDINDIVIDUO
	WHERE DESTIPROLSOLICITUD = 'TITULAR'
),
TP_SOLICITUDCREDITOCONSUMO AS (
	SELECT
		CODSOLICITUD,
		DESTIPSOLICITUD AS TIPOPERACION,
		DESPRODUCTO AS DESTIPOPERACION,
		UPPER(TRANSLATE(DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		DESTIPEVALUACIONRIESGO,
		CODMATRICULACOLABORADORVENDEDOR,
		FECSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', FECSOLICITUD, LPAD(HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', FECINICIOCALIF, LPAD(HORINICIOCALIF, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORINICIOEVALUACION,
		TO_TIMESTAMP(CONCAT_WS(' ', FECFINCALIF, LPAD(HORFINCALIF, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORFINEVALUACION,
		(CASE
			WHEN NBRMONEDA LIKE '%SOL%' THEN 'SOLES'
			WHEN NBRMONEDA LIKE '%DOL%' THEN 'DOLARES'
			ELSE NULL
		END) AS NBRMONEDA,
		(CASE
			WHEN NBRMONEDA LIKE '%DOL%' THEN MTOSOLICITADO * 3.51
			ELSE MTOSOLICITADO
		END) AS MTOSOLICITADO,
		(CASE
			WHEN NBRMONEDA LIKE '%DOL%' THEN MTOAPROBADO * 3.51
			ELSE MTOAPROBADO
		END) AS MTOAPROBADO,
		FECDESEMBOLSO,
		(CASE
			WHEN NBRMONEDA LIKE '%DOL%' THEN
				(CASE
					WHEN FECDESEMBOLSO IS NOT NULL THEN MTOAPROBADO * 3.51
					ELSE NULL 
				END)
            ELSE
            	(CASE
            		WHEN FECDESEMBOLSO IS NOT NULL THEN MTOAPROBADO 
            		ELSE NULL
            	END)
		END) AS MTODESEMBOLSADO,
		CODINTERNOCOMPUTACIONAL
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO
),
TP_SOLICITUDTARJETACREDITO AS (
	SELECT
		CODSOLICITUD,
		(CASE
			WHEN DESTIPFLUJOVENTATARJETACREDITO IN ('ADICIONAL', 'UPGRADE', 'AMPLIACION', 'BT', 'EP') THEN 'TARJETA CREDITO STOCK'
			ELSE 'TARJETA CREDITO NUEVA'
		END) AS TIPOPERACION,
		DESTIPFLUJOVENTATARJETACREDITO AS DESTIPOPERACION,
		UPPER(TRANSLATE(DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		(CASE
			WHEN UPPER(TRANSLATE(DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%100%%' THEN '100% APROBADO'
			WHEN UPPER(TRANSLATE(DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%PREAPROBADO%' THEN 'PREAPROBADO'
			WHEN UPPER(TRANSLATE(DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%REACTIVO%' THEN 'REACTIVO'
			ELSE 'OTROS'
		END) AS DESTIPEVALUACIONRIESGO,
		CODMATRICULACOLABORADORVENDEDOR,
		FECSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', FECSOLICITUD, LPAD(HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', FECINICIOEVALUACION, LPAD(HORINICIOEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORINICIOEVALUACION,
		TO_TIMESTAMP(CONCAT_WS(' ', FECFINEVALUACION, LPAD(HORFINEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORFINEVALUACION,
		(CASE
			WHEN NBRMONEDA LIKE '%SOL%' THEN 'SOLES'
			WHEN NBRMONEDA LIKE '%DOL%' THEN 'DOLARES'
			ELSE NULL
		END) AS NBRMONEDA,
		(CASE
			WHEN NBRMONEDA LIKE '%DOL%' THEN MTOSOLICITADO * 3.51
			ELSE MTOSOLICITADO
		END) AS MTOSOLICITADO,
		(CASE
			WHEN NBRMONEDA LIKE '%DOL%' THEN MTOAPROBADO * 3.51
			ELSE MTOAPROBADO
		END) AS MTOAPROBADO,
		FECEMISIONTARJETACREDITO AS FECDESEMBOLSO,
		(CASE
			WHEN NBRMONEDA LIKE '%DOL%' THEN
				(CASE
					WHEN FECEMISIONTARJETACREDITO IS NOT NULL THEN MTOAPROBADO * 3.51
					ELSE NULL 
				END)
            ELSE
            	(CASE
            		WHEN FECEMISIONTARJETACREDITO IS NOT NULL THEN MTOAPROBADO 
            		ELSE NULL
            	END)
		END) AS MTODESEMBOLSADO,
		CODINTERNOCOMPUTACIONAL
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDTARJETACREDITO
	WHERE CODTIPREGAPP IN ('0126O000001xsIYQAY','0126O000001h0WaQAI','0126O000001h0WbQAI')
),
TP_UNION AS (
	SELECT * FROM TP_SOLICITUDCREDITOCONSUMO
	UNION ALL
	SELECT * FROM TP_SOLICITUDTARJETACREDITO
),
TP_BASE AS (
	SELECT
		A.CODMES,
		A.CODSOLICITUD,
		A.MATANALISTA,
		E.MATSUPERIOR,
    	G.NBRUNIDADORGANIZATIVAVENDEDOR,
    	G.NBRDIVISIONUNIDADORGANIZATIVAVENDEDOR,
    	G.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
    	G.NBRSERVUNIDADORGANIZATIVAVENDEDOR,
		B.TIPOPERACION,
		COALESCE(B.DESTIPOPERACION, D.PRODUCTOSALESFORCE) AS DESTIPOPERACION,
		B.DESCAMPANIA,
		B.DESTIPEVALUACIONRIESGO,
		B.FECSOLICITUD,
		ROUND(date_diff(SECOND, B.FECHORSOLICITUD, B.FECDESEMBOLSO) / 3600, 2) AS HORASSOLICITUDTOTAL,
		ROUND(date_diff(SECOND, B.FECHORSOLICITUD, B.FECHORFINEVALUACION) / 3600, 2) AS HORASSOLICITUD,
		ROUND(date_diff(SECOND, B.FECHORINICIOEVALUACION, B.FECHORFINEVALUACION) / 3600, 2) AS HORASATENCION,
		B.MTOSOLICITADO,
		B.NBRMONEDA,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'APROBADO' THEN B.MTOAPROBADO
			ELSE 0
		END) AS MTOAPROBADO,
		B.FECDESEMBOLSO,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'APROBADO' AND B.FECDESEMBOLSO IS NOT NULL THEN B.MTODESEMBOLSADO
			ELSE 0
		END) AS MTODESEMBOLSADO,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'APROBADO' AND B.MTOSOLICITADO <> B.MTOAPROBADO THEN (B.MTOSOLICITADO - B.MTOAPROBADO)
			ELSE 0
		END) AS MTORENEGOCIADO,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'RECHAZADO' THEN B.MTOSOLICITADO
			ELSE 0
		END) AS MTODENEGADO,
		(CASE
			WHEN C.ESTADOSOLICITUD = 'APROBADO' AND B.MTOAPROBADO > B.MTODESEMBOLSADO THEN (B.MTOAPROBADO - B.MTODESEMBOLSADO)
			ELSE 0
		END) AS MTONODESEMBOLSADO,
		C.ESTADOSOLICITUD,
		D.DESPRODUCTOSALESFORCE,
		D.ETAPASALESFORCE,
		F.TIPRENTA
	FROM TP_BASESOLICITUDES A
	INNER JOIN TP_UNION B ON (A.CODSOLICITUD = B.CODSOLICITUD)
	INNER JOIN TP_SALESFORCEESTADOS C ON (A.CODSOLICITUD = C.CODSOLICITUD)
	LEFT JOIN TP_SALESFORCEPRODUCTOS D ON (A.CODSOLICITUD = D.CODSOLICITUD)
	INNER JOIN TP_ORGANICO E ON (A.MATANALISTA = E.MATORGANICO AND A.CODMES = E.CODMES)
	LEFT JOIN TP_SOLICITUDINDIVIDUO F ON (A.CODSOLICITUD = F.CODSOLICITUD)
	LEFT JOIN TP_COLABORADOR G ON (B.CODMATRICULACOLABORADORVENDEDOR = G.CODMATRICULA)
),
TP_BASE_TIEMPOS AS (
	SELECT
		CODMES,
		CODSOLICITUD,
		MATANALISTA,
		MATSUPERIOR,
	    NBRUNIDADORGANIZATIVAVENDEDOR,
	    NBRDIVISIONUNIDADORGANIZATIVAVENDEDOR,
	    NBRAREAUNIDADORGANIZATIVAVENDEDOR,
	    NBRSERVUNIDADORGANIZATIVAVENDEDOR,
		TIPOPERACION,
		DESTIPOPERACION,
		DESCAMPANIA,
		DESTIPEVALUACIONRIESGO,
		FECSOLICITUD,
		MTOSOLICITADO,
		NBRMONEDA,
		MTOAPROBADO,
		MTODENEGADO,
		MTORENEGOCIADO,
		FECDESEMBOLSO,
		MTODESEMBOLSADO,
		MTONODESEMBOLSADO,
		ESTADOSOLICITUD,
		DESPRODUCTOSALESFORCE,
		ETAPASALESFORCE,
		TIPRENTA,
		(CASE
			WHEN HORASSOLICITUDTOTAL IS NULL THEN 'SIN DESEMBOLSO'
		    WHEN HORASSOLICITUDTOTAL <= 6 THEN '<= 6h'
		    WHEN HORASSOLICITUDTOTAL <= 12 THEN '<= 12h'
		    WHEN HORASSOLICITUDTOTAL <= 24 THEN '<= 24h'
	    	ELSE '> 24h'
		END) AS BRACKETSOLICITUDTOTAL,
		(CASE
			WHEN HORASSOLICITUD IS NULL THEN 'NA'
		    WHEN HORASSOLICITUD <= 6 THEN '<= 6h'
		    WHEN HORASSOLICITUD <= 12 THEN '<= 12h'
		    WHEN HORASSOLICITUD <= 24 THEN '<= 24h'
	    	ELSE '> 24h'
		END) AS BRACKETSOLICITUD,
		(CASE
			WHEN HORASATENCION IS NULL THEN 'NA'
		    WHEN HORASATENCION <= 6 THEN '<= 6h'
		    WHEN HORASATENCION <= 12 THEN '<= 12h'
		    WHEN HORASATENCION <= 24 THEN '<= 24h'
	    	ELSE '> 24h'
		END) AS BRACKETATENCION
	FROM TP_BASE
)
SELECT
	CODMES,
	MATANALISTA,
	MATSUPERIOR,
    NBRUNIDADORGANIZATIVAVENDEDOR,
    NBRDIVISIONUNIDADORGANIZATIVAVENDEDOR,
    NBRAREAUNIDADORGANIZATIVAVENDEDOR,
    NBRSERVUNIDADORGANIZATIVAVENDEDOR,
	COUNT(CODSOLICITUD) AS CTDSOLICITUDES,
	TIPOPERACION,
	DESTIPOPERACION,
	DESCAMPANIA,
	DESTIPEVALUACIONRIESGO,
	FECSOLICITUD,
	SUM(MTOSOLICITADO) AS MTOSOLICITADO,
	NBRMONEDA,
	SUM(MTOAPROBADO) AS MTOAPROBADO,
	SUM(MTODENEGADO) AS MTODENEGADO,
	SUM(MTORENEGOCIADO) AS MTORENEGOCIADO,
	FECDESEMBOLSO,
	SUM(MTODESEMBOLSADO) AS MTODESEMBOLSADO,
	SUM(MTONODESEMBOLSADO) AS MTONODESEMBOLSADO,
	ESTADOSOLICITUD,
	DESPRODUCTOSALESFORCE,
	ETAPASALESFORCE,
	TIPRENTA,
	BRACKETSOLICITUDTOTAL,
	BRACKETSOLICITUD,
	BRACKETATENCION
FROM TP_BASE_TIEMPOS
GROUP BY 
	CODMES, MATANALISTA, MATSUPERIOR, NBRUNIDADORGANIZATIVAVENDEDOR, NBRDIVISIONUNIDADORGANIZATIVAVENDEDOR, 
	NBRAREAUNIDADORGANIZATIVAVENDEDOR, NBRSERVUNIDADORGANIZATIVAVENDEDOR, TIPOPERACION, DESTIPOPERACION, DESCAMPANIA, DESTIPEVALUACIONRIESGO,
	FECSOLICITUD, NBRMONEDA, FECDESEMBOLSO, ESTADOSOLICITUD, DESPRODUCTOSALESFORCE, ETAPASALESFORCE, TIPRENTA, BRACKETSOLICITUDTOTAL,
	BRACKETSOLICITUD, BRACKETATENCION;
