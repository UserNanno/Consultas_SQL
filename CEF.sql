CREATE OR REPLACE TABLE CATALOG_LHCL_PROD_BCP_EXPL.BCP_EDV_RBMBDN.T72496_UNIONWEEKLY
AS
WITH
TP_TIPOCAMBIO AS (
	SELECT 3.81 AS TC_USD_SOL
),
TP_BASESOLICITUDESSALESFORCE AS (
	SELECT
		CODMESEVALUACION,
    	CODSOLICITUD,
    	MATRICULA,
    	ESTADOSOLICITUD,
    	DESTIPPRODUCTO,
    	DESPRODUCTO,
    	DESTIPETAPA
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_SALESFORCEBASESOLICITUDES
),
TP_BASESOLICITUDESAPPS AS (
	SELECT
		CODMES,
		CODSOLICITUD,
		MATANALISTA,
		RESULTADOANALISTA,
		PRODUCTO
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_BASESOLICITUDES
),
TP_COLABORADOR AS (
    SELECT
        FECDIA,
        date_format(FECDIA, 'yyyyMM') AS CODMES,
        CODMATRICULA,
        CODMATRICULASUP,
        NBRUNIDADORGANIZATIVA,
        NBRAREAUNIDADORGANIZATIVA,
        NBRSERVUNIDADORGANIZATIVA,
        (CASE
        	WHEN NBRAREAUNIDADORGANIZATIVA IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1') THEN 'DCA'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS' THEN 'TLMK'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA BANCA AFLUENTE' AND NBRSERVUNIDADORGANIZATIVA = 'GERENCIA DE BANCA ENALTA' THEN 'ENALTA'
			WHEN NBRAREAUNIDADORGANIZATIVA = 'GCIA DE AREA BANCA AFLUENTE' AND NBRSERVUNIDADORGANIZATIVA = 'GERENCIA DE BANCA EXCLUSIVA DIGITAL' THEN 'BEX'
			ELSE 'OTROS'
		END) AS CANAL
    FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_COLABORADOR
    WHERE DESTIPESTADOLABORAL = 'Activo'
),
TP_COLABORADORANALISTA AS (
    SELECT
        CODMES,
        MATORGANICO,
        MATSUPERIOR,
        NBRAREAUNIDADORGANIZATIVA
    FROM (
        SELECT
            CODMES,
            CODMATRICULA      AS MATORGANICO,
            CODMATRICULASUP   AS MATSUPERIOR,
            NBRAREAUNIDADORGANIZATIVA,
            ROW_NUMBER() OVER (
                PARTITION BY CODMES, CODMATRICULA
                ORDER BY FECDIA DESC   -- última foto del mes
            ) AS rn
        FROM TP_COLABORADOR
    ) x
    WHERE rn = 1
),
TP_BASE_SOLICITUDES AS (
	SELECT
		COALESCE(B.CODMESEVALUACION, A.CODMES) AS CODMES,
	    COALESCE(B.CODSOLICITUD, A.CODSOLICITUD) AS CODSOLICITUD,
	    (CASE 
	    	WHEN COALESCE(B.ESTADOSOLICITUD, A.RESULTADOANALISTA) = 'PENDIENTE' AND B.DESTIPETAPA = 'DESESTIMADA' THEN 'RECHAZADO'
	    	ELSE COALESCE(B.ESTADOSOLICITUD, A.RESULTADOANALISTA)
	    END) AS ESTADOSOLICITUD,
	    COALESCE(B.MATRICULA, A.MATANALISTA) AS MATANALISTA,
	    COALESCE(B.DESTIPPRODUCTO, A.PRODUCTO) AS PRODUCTO,
	    B.DESPRODUCTO,
	    B.DESTIPETAPA,
	    CASE 
	        WHEN A.CODSOLICITUD IS NOT NULL AND B.CODSOLICITUD IS NOT NULL THEN 'AMBOS'
	        WHEN B.CODSOLICITUD IS NOT NULL THEN 'SOLO_SF'
	    END AS ORIGEN,
	    C.NBRAREAUNIDADORGANIZATIVA,
	    C.MATSUPERIOR
	FROM TP_BASESOLICITUDESAPPS A
	FULL OUTER JOIN TP_BASESOLICITUDESSALESFORCE B ON (A.CODSOLICITUD = B.CODSOLICITUD)
	LEFT JOIN TP_COLABORADORANALISTA C ON (C.CODMES = COALESCE(A.CODMES, B.CODMESEVALUACION) AND C.MATORGANICO = COALESCE(A.MATANALISTA, B.MATRICULA))
	WHERE B.CODSOLICITUD IS NOT NULL
),
TP_COLABORADORVENDEDOR AS (
    SELECT
        FECDIA,
        CODMES,
        MATORGANICO,
        MATSUPERIOR,
        NBRUNIDADORGANIZATIVAVENDEDOR,
        NBRAREAUNIDADORGANIZATIVAVENDEDOR,
        NBRSERVUNIDADORGANIZATIVAVENDEDOR,
        CANAL
    FROM (
        SELECT
            FECDIA,
            CODMES,
            CODMATRICULA       AS MATORGANICO,
            CODMATRICULASUP    AS MATSUPERIOR,
            NBRUNIDADORGANIZATIVA     AS NBRUNIDADORGANIZATIVAVENDEDOR,
            NBRAREAUNIDADORGANIZATIVA AS NBRAREAUNIDADORGANIZATIVAVENDEDOR,
            NBRSERVUNIDADORGANIZATIVA AS NBRSERVUNIDADORGANIZATIVAVENDEDOR,
            CANAL,
            ROW_NUMBER() OVER (
                PARTITION BY FECDIA, CODMATRICULA
                ORDER BY FECDIA DESC
            ) AS rn
        FROM TP_COLABORADOR
    ) x
    WHERE rn = 1
),
TP_SOLICITUDINDIVIDUO AS (
	SELECT
    	CODSOLICITUD,
    	(CASE
			WHEN CODSUBSEGMENTO IN ('X1N', 'X1E') THEN 'BEX'
			WHEN CODSUBSEGMENTO IN ('Q1N', 'Q1E') THEN 'PYME'
			WHEN CODSUBSEGMENTO IN ('P1N', 'P1E') THEN 'PRIVADA'
			WHEN CODSUBSEGMENTO IN ('NBN', 'NBE') THEN 'NO BANCO'
			WHEN CODSUBSEGMENTO IN ('M1N', 'M1E') THEN 'CONSUMO'
			WHEN CODSUBSEGMENTO IN ('LEN', 'LEE') THEN 'ENALTA'
			WHEN CODSUBSEGMENTO IN ('C1N', 'C1E') THEN 'NEGOCIOS'
			WHEN CODSUBSEGMENTO = 'G1N' THEN 'GREMIO 94'
			ELSE 'OTROS'
		END) AS SEGMENTO,
    	(CASE
			WHEN TIPRENTA = 5 THEN '5TA'
			WHEN TIPRENTA = 4 THEN '4TA'
			WHEN TIPRENTA = 3 THEN '3RA'
			WHEN TIPRENTA = 2 THEN '2DA'
			WHEN TIPRENTA = 1 THEN '1RA'
			ELSE 'OTROS'
		END) AS DESTIPRENTA
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDINDIVIDUO
	WHERE DESTIPROLSOLICITUD = 'TITULAR'
),
TP_SOLICITUDCREDITOCONSUMO AS (
	SELECT
		A.CODSOLICITUD,
		A.DESTIPESTADOSOLICITUD,
		A.DESTIPSOLICITUD AS TIPOPERACION,
		A.DESTIPSOLICITUD AS DESTIPOPERACION,
		(CASE
			WHEN A.CODPRODUCTO = 'EFME' THEN 'LIBRE DISPONIBILIDAD'
			WHEN A.CODPRODUCTO = 'EFCD' THEN 'COMPRA DEUDA'
			WHEN A.CODPRODUCTO = 'EFDP' THEN 'CONVENIO'
			ELSE 'OTROS'
		END) AS PRODUCTO,
		CAST(NULL AS STRING) AS DESPRODUCTO,
		UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		A.DESTIPEVALUACIONRIESGO,
		A.CODMATRICULACOLABORADORVENDEDOR,
		date_format(A.FECSOLICITUD, 'yyyyMM') AS CODMES,
		A.FECSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECSOLICITUD, LPAD(A.HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECINICIOCALIF, LPAD(A.HORINICIOCALIF, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORINICIOEVALUACION,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECFINCALIF, LPAD(A.HORFINCALIF, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORFINEVALUACION,
		(CASE
			WHEN A.NBRMONEDA LIKE '%SOL%' THEN 'SOLES'
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN 'DOLARES'
			ELSE NULL
		END) AS NBRMONEDA,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOSOLICITADO * B.TC_USD_SOL
			ELSE A.MTOSOLICITADO
		END) AS MTOSOLICITADO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
		A.FECDESEMBOLSO,
		TO_TIMESTAMP(CONCAT(A.FECDESEMBOLSO, ' 23:59:59'), 'yyyy-MM-dd HH:mm:ss') AS FECHORDESEMBOLSO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN
				(CASE
					WHEN A.FECDESEMBOLSO IS NOT NULL THEN A.MTOAPROBADO * B.TC_USD_SOL
					ELSE NULL 
				END)
            ELSE
            	(CASE
            		WHEN A.FECDESEMBOLSO IS NOT NULL THEN A.MTOAPROBADO 
            		ELSE NULL
            	END)
		END) AS MTODESEMBOLSADO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO A
	CROSS JOIN TP_TIPOCAMBIO B
),
TP_SOLICITUDTARJETACREDITO AS (
	SELECT
		A.CODSOLICITUD,
		A.DESTIPESTADOSOLICITUD,
		A.DESTIPSOLICITUD AS TIPOPERACION,
		(CASE
			WHEN A.DESTIPFLUJOVENTATARJETACREDITO IN ('ADICIONAL', 'AMPLIACION', 'EP', 'UPGRADE', 'BT') THEN 'TARJETA CREDITO STOCK'
			WHEN A.DESTIPFLUJOVENTATARJETACREDITO IN ('TC', 'SEGUNDA TC') THEN 'TARJETA CREDITO NUEVA'
			ELSE NULL
		END) AS DESTIPOPERACION,
		A.DESTIPFLUJOVENTATARJETACREDITO AS PRODUCTO,
		UPPER(A.DESPRODUCTO) AS DESPRODUCTO,
		UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) AS DESCAMPANIA,
		(CASE
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%100%%' THEN '100% APROBADO'
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%PREA%' THEN 'PREAPROBADO' -- [PREAPROBADO, PREAPROB, PREAPRO, PREAPR]
			WHEN UPPER(TRANSLATE(A.DESCAMPANIA, 'ÁÉÍÓÚÜÑáéíóúüñ', 'AEIOUUNAEIOUUN')) LIKE '%REACTIVO%' THEN 'REACTIVO'
			ELSE 'OTROS'
		END) AS DESTIPEVALUACIONRIESGO,
		A.CODMATRICULACOLABORADORVENDEDOR,
		date_format(A.FECSOLICITUD, 'yyyyMM') AS CODMES,
		A.FECSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECSOLICITUD, LPAD(A.HORSOLICITUD, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORSOLICITUD,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECINICIOEVALUACION, LPAD(A.HORINICIOEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORINICIOEVALUACION,
		TO_TIMESTAMP(CONCAT_WS(' ', A.FECFINEVALUACION, LPAD(A.HORFINEVALUACION, 6, '0')), 'yyyy-MM-dd HHmmss') AS FECHORFINEVALUACION,
		(CASE
			WHEN A.NBRMONEDA LIKE '%SOL%' THEN 'SOLES'
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN 'DOLARES'
			ELSE NULL
		END) AS NBRMONEDA,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOSOLICITADO * B.TC_USD_SOL
			ELSE A.MTOSOLICITADO
		END) AS MTOSOLICITADO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN A.MTOAPROBADO * B.TC_USD_SOL
			ELSE A.MTOAPROBADO
		END) AS MTOAPROBADO,
		A.FECEMISIONTARJETACREDITO AS FECDESEMBOLSO,
		TO_TIMESTAMP(CONCAT(A.FECEMISIONTARJETACREDITO, ' 23:59:59'), 'yyyy-MM-dd HH:mm:ss') AS FECHORDESEMBOLSO,
		(CASE
			WHEN A.NBRMONEDA LIKE '%DOL%' THEN
				(CASE
					WHEN A.FECEMISIONTARJETACREDITO IS NOT NULL THEN A.MTOAPROBADO * B.TC_USD_SOL
					ELSE NULL 
				END)
            ELSE
            	(CASE
            		WHEN A.FECEMISIONTARJETACREDITO IS NOT NULL THEN A.MTOAPROBADO 
            		ELSE NULL
            	END)
		END) AS MTODESEMBOLSADO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDTARJETACREDITO A
	CROSS JOIN TP_TIPOCAMBIO B
	WHERE A.CODTIPREGAPP IN ('0126O000001xsIYQAY','0126O000001h0WaQAI','0126O000001h0WbQAI')
),
TP_UNION AS (
	SELECT * FROM TP_SOLICITUDCREDITOCONSUMO
	UNION ALL
	SELECT * FROM TP_SOLICITUDTARJETACREDITO
),
TP_BASE_UNION AS (
	SELECT 
		A.*,
		B.NBRUNIDADORGANIZATIVAVENDEDOR,
		B.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
		B.NBRSERVUNIDADORGANIZATIVAVENDEDOR,
		B.CANAL,
		C.DESTIPRENTA,
		C.SEGMENTO,
		ROUND(date_diff(SECOND, A.FECHORSOLICITUD, A.FECHORDESEMBOLSO) / 3600, 2) AS TIEMPOATENCIONSOLICITUD,
		ROUND(date_diff(SECOND, A.FECHORSOLICITUD, A.FECHORINICIOEVALUACION) / 3600, 2) AS TIEMPODERIVACIONANALISTA,
		ROUND(date_diff(SECOND, A.FECHORINICIOEVALUACION, A.FECHORFINEVALUACION) / 3600, 2) AS TIEMPOATENCIONANALISTA,
		ROUND(date_diff(SECOND, A.FECHORSOLICITUD, A.FECHORFINEVALUACION) / 3600, 2) AS TIEMPOATENCIONSOLICITUDANALISTA,
		ROUND(date_diff(SECOND, A.FECHORFINEVALUACION, A.FECHORDESEMBOLSO) / 3600, 2) AS TIEMPODESEMBOLSOPOSTATENCIONANALISTA
	FROM TP_UNION A
	LEFT JOIN TP_COLABORADORVENDEDOR B ON (A.FECSOLICITUD = B.FECDIA AND A.CODMATRICULACOLABORADORVENDEDOR = B.MATORGANICO)
	LEFT JOIN TP_SOLICITUDINDIVIDUO C ON (A.CODSOLICITUD = C.CODSOLICITUD)
),
CALENDARIO AS (
    SELECT explode(
        sequence(to_date('2024-01-01'), to_date('2025-12-31'), interval 1 day)
    ) AS FECHA
),
DIMCALENDARIO AS (
    SELECT
        A.FECHA,
        (CASE
            WHEN dayofweek(A.FECHA) = 1 THEN 0       -- domingo (1)
            WHEN B.FECHA IS NOT NULL THEN 0              -- feriado
            ELSE 1
        END) AS FLGDIAUTIL
    FROM CALENDARIO A
    LEFT JOIN CATALOG_LHCL_PROD_BCP_EXPL.BCP_EDV_RBMBDN.T72496_DE_DIASNOHABILES B ON A.FECHA = B.FECHA
),
TP_BASE_PREV AS (
	SELECT
		A.CODMES,
		A.CODSOLICITUD,
		B.MATANALISTA,
		B.NBRAREAUNIDADORGANIZATIVA AS NBRAREAUNIDADORGANIZATIVAANALISTA,
		B.MATSUPERIOR,
		A.NBRAREAUNIDADORGANIZATIVAVENDEDOR,
		A.CANAL,
		A.TIPOPERACION,
		A.DESTIPOPERACION,
		COALESCE(A.PRODUCTO, B.PRODUCTO) AS PRODUCTO,
		(CASE
			WHEN A.DESPRODUCTO IS NULL AND A.TIPOPERACION = 'CREDITO CONSUMO' THEN B.DESPRODUCTO
			ELSE COALESCE(B.DESPRODUCTO, A.DESPRODUCTO)
		END) AS DESPRODUCTO,
		A.DESCAMPANIA,
		A.DESTIPEVALUACIONRIESGO,
		A.FECSOLICITUD,
		(CASE
			WHEN C.FLGDIAUTIL = 1 THEN 'SI'
			ELSE 'NO'
		END) AS FLGDIAUTIL,
		A.FECHORSOLICITUD,
		A.FECHORINICIOEVALUACION,
		A.FECHORFINEVALUACION,
		A.FECDESEMBOLSO,
		A.FECHORDESEMBOLSO,
		A.TIEMPOATENCIONSOLICITUD,
		A.TIEMPODERIVACIONANALISTA,
		A.TIEMPOATENCIONANALISTA,
		A.TIEMPOATENCIONSOLICITUDANALISTA,
		A.TIEMPODESEMBOLSOPOSTATENCIONANALISTA,
		A.NBRMONEDA,
		A.DESTIPRENTA,
		A.SEGMENTO,
		A.MTOSOLICITADO,
		A.MTOAPROBADO,
		A.MTODESEMBOLSADO,
		(CASE
			WHEN 
				A.NBRAREAUNIDADORGANIZATIVAVENDEDOR IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1', 'GCIA DE AREA BANCA AFLUENTE', 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS') 
				AND B.MATANALISTA IS NULL 
				AND A.DESTIPESTADOSOLICITUD IN ('DESACTIVADA', 'ACEPTADA') THEN 'PUNTO DE CONTACTO'
			WHEN B.MATANALISTA IS NOT NULL AND B.NBRAREAUNIDADORGANIZATIVA = 'TRIBU RIESGOS BDN Y CREDITOS MINORISTAS' THEN 'CENTRALIZADO'
			ELSE 'SIN INFORMACION'
		END) AS CENTROATENCION,
		(CASE
			-- Para CENTRALIZADO, manda ESTADOSOLICITUD (analista/SF)
			WHEN 
				(CASE
					WHEN 
						A.NBRAREAUNIDADORGANIZATIVAVENDEDOR IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1', 'GCIA DE AREA BANCA AFLUENTE', 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS') 
						AND B.MATANALISTA IS NULL 
						AND A.DESTIPESTADOSOLICITUD IN ('DESACTIVADA', 'ACEPTADA') THEN 'PUNTO DE CONTACTO'
					WHEN B.MATANALISTA IS NOT NULL AND B.NBRAREAUNIDADORGANIZATIVA = 'TRIBU RIESGOS BDN Y CREDITOS MINORISTAS' THEN 'CENTRALIZADO'
					ELSE 'SIN INFORMACION'
				END) = 'CENTRALIZADO'
				THEN B.ESTADOSOLICITUD

			-- Para PUNTO DE CONTACTO, mapeas DESTIPESTADOSOLICITUD a APROBADO/RECHAZADO
			WHEN 
				(CASE
					WHEN 
						A.NBRAREAUNIDADORGANIZATIVAVENDEDOR IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1', 'GCIA DE AREA BANCA AFLUENTE', 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS') 
						AND B.MATANALISTA IS NULL 
						AND A.DESTIPESTADOSOLICITUD IN ('DESACTIVADA', 'ACEPTADA') THEN 'PUNTO DE CONTACTO'
					WHEN B.MATANALISTA IS NOT NULL AND B.NBRAREAUNIDADORGANIZATIVA = 'TRIBU RIESGOS BDN Y CREDITOS MINORISTAS' THEN 'CENTRALIZADO'
					ELSE 'SIN INFORMACION'
				END) = 'PUNTO DE CONTACTO'
				AND A.DESTIPESTADOSOLICITUD = 'ACEPTADA'
				THEN 'APROBADO'

			WHEN 
				(CASE
					WHEN 
						A.NBRAREAUNIDADORGANIZATIVAVENDEDOR IN ('AREA COMERCIAL PROVINCIAS 1', 'AREA COMERCIAL PROVINCIAS 2', 'AREA COMERCIAL LIMA 2', 'AREA COMERCIAL LIMA 1', 'GCIA DE AREA BANCA AFLUENTE', 'GCIA DE AREA CENTRO DE CONTACTO Y VENTAS') 
						AND B.MATANALISTA IS NULL 
						AND A.DESTIPESTADOSOLICITUD IN ('DESACTIVADA', 'ACEPTADA') THEN 'PUNTO DE CONTACTO'
					WHEN B.MATANALISTA IS NOT NULL AND B.NBRAREAUNIDADORGANIZATIVA = 'TRIBU RIESGOS BDN Y CREDITOS MINORISTAS' THEN 'CENTRALIZADO'
					ELSE 'SIN INFORMACION'
				END) = 'PUNTO DE CONTACTO'
				AND A.DESTIPESTADOSOLICITUD = 'DESACTIVADA'
				THEN 'RECHAZADO'

			-- FALLBACK
			ELSE COALESCE(B.ESTADOSOLICITUD, A.DESTIPESTADOSOLICITUD)
		END) AS ESTADOSOLICITUD
	FROM TP_BASE_UNION A
	LEFT JOIN TP_BASE_SOLICITUDES B ON (A.CODSOLICITUD = B.CODSOLICITUD)
	LEFT JOIN DIMCALENDARIO C ON (A.FECSOLICITUD = C.FECHA)
),
TP_BASE AS (
	SELECT
		CODMES,
		CODSOLICITUD,
		MATANALISTA,
		NBRAREAUNIDADORGANIZATIVAANALISTA,
		MATSUPERIOR,
		NBRAREAUNIDADORGANIZATIVAVENDEDOR,
		CANAL,
		TIPOPERACION,
		DESTIPOPERACION,
		PRODUCTO,
		DESPRODUCTO,
		DESCAMPANIA,
		DESTIPEVALUACIONRIESGO,
		FECSOLICITUD,
		FLGDIAUTIL,
		FECHORSOLICITUD,
		FECHORINICIOEVALUACION,
		FECHORFINEVALUACION,
		FECDESEMBOLSO,
		FECHORDESEMBOLSO,
		TIEMPOATENCIONSOLICITUD,
		TIEMPODERIVACIONANALISTA,
		TIEMPOATENCIONANALISTA,
		TIEMPOATENCIONSOLICITUDANALISTA,
		TIEMPODESEMBOLSOPOSTATENCIONANALISTA,
		NBRMONEDA,
		DESTIPRENTA,
		SEGMENTO,
		MTOSOLICITADO,
		CENTROATENCION,
		ESTADOSOLICITUD,
		
		-- UNIDADES: APROBADO / DENEGADO
		(CASE WHEN ESTADOSOLICITUD = 'RECHAZADO' OR (ESTADOSOLICITUD = 'APROBADO' AND MTOAPROBADO < MTOSOLICITADO) THEN 1 ELSE 0 END) AS FLGDENEGADA,  -- CONSIDERAR ESTO EN LOGICA DE NEGOCIO
		(CASE WHEN ESTADOSOLICITUD = 'RECHAZADO' THEN 1 ELSE 0 END) AS FLGDENEGADAINTEGRA,  -- BASE
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOAPROBADO < MTOSOLICITADO AND MTOAPROBADO > 0 THEN 1 ELSE 0 END) AS FLGDENEGADAPARCIAL,
		
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' THEN 1 ELSE 0 END) AS FLGAPROBADA,   -- BASE
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOAPROBADO = MTOSOLICITADO THEN 1 ELSE 0 END) AS FLGAPROBADAINTEGRA,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOAPROBADO <> MTOSOLICITADO THEN 1 ELSE 0 END) AS FLGAPROBADAPARCIAL, -- SE REEMPLAZA (MTOAPROBADO < MTOSOLICITADO AND MTOAPROBADO > 0)
		
		-- UNIDADES: DESEMBOLSO / NO DESEMBOLSO
		
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL THEN 1 ELSE 0 END) AS FLGDESEMBOLSADABASE,   -- BASE
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL AND MTODESEMBOLSADO > 0 THEN 1 ELSE 0 END) AS FLGDESEMBOLSADA,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL AND MTODESEMBOLSADO = MTOAPROBADO THEN 1 ELSE 0 END) AS FLGDESEMBOLSADAINTEGRA,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL AND MTODESEMBOLSADO < MTOAPROBADO AND MTODESEMBOLSADO > 0 THEN 1 ELSE 0 END) AS FLGDESEMBOLSADOPARCIAL,
		
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NULL THEN 1 ELSE 0 END) AS FLGNODESEMBOLSADABASE,   -- BASE
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND (FECDESEMBOLSO IS NULL OR MTODESEMBOLSADO = 0) THEN 1 ELSE 0 END) AS FLGNODESEMBOLSADAINTEGRA,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL AND MTODESEMBOLSADO < MTOAPROBADO AND MTODESEMBOLSADO > 0 THEN 1 ELSE 0 END) AS FLGNODESEMBOLSADOPARCIAL,
		
		 -- MONTOS: APROBADO / DENEGADO
		 
		(CASE WHEN ESTADOSOLICITUD = 'RECHAZADO' THEN MTOSOLICITADO ELSE 0 END) AS MTODENEGADOINTEGRO,   -- BASE
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOAPROBADO < MTOSOLICITADO AND MTOAPROBADO > 0 THEN MTOSOLICITADO - MTOAPROBADO ELSE 0 END) AS MTODENEGADOPARCIAL,
		((CASE WHEN ESTADOSOLICITUD = 'RECHAZADO' THEN MTOSOLICITADO ELSE 0 END) + (CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOAPROBADO < MTOSOLICITADO AND MTOAPROBADO > 0 THEN MTOSOLICITADO - MTOAPROBADO ELSE 0 END) ) AS MTODENEGADO,
		
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADO,   -- BASE
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOAPROBADO = MTOSOLICITADO THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADOINTEGRO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND MTOAPROBADO <> MTOSOLICITADO THEN MTOAPROBADO ELSE 0 END) AS MTOAPROBADOPARCIAL, -- SE REEMPLAZA (MTOAPROBADO < MTOSOLICITADO AND MTOAPROBADO > 0 )
		
		-- MONTOS: DESEMBOLSADO / NO DESEMBOLSADO
		
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL THEN MTODESEMBOLSADO ELSE 0 END) AS MTODESEMBOLSADOBASE,   -- BASE
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL AND MTODESEMBOLSADO > 0 THEN MTODESEMBOLSADO ELSE 0 END) AS MTODESEMBOLSADO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL AND MTODESEMBOLSADO = MTOAPROBADO THEN MTODESEMBOLSADO ELSE 0 END) AS MTODESEMBOLSADOINTEGRO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL AND MTODESEMBOLSADO < MTOAPROBADO AND MTODESEMBOLSADO > 0 THEN MTODESEMBOLSADO ELSE 0 END) AS MTODESEMBOLSADOPARCIAL,
		
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NULL THEN MTODESEMBOLSADO ELSE 0 END) AS MTONODESEMBOLSADOBASE,   -- BASE
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND (FECDESEMBOLSO IS NULL OR MTODESEMBOLSADO = 0) THEN MTOAPROBADO ELSE 0 END) AS MTONODESEMBOLSADOINTEGRO,
		(CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL AND MTODESEMBOLSADO < MTOAPROBADO AND MTODESEMBOLSADO > 0 THEN MTOAPROBADO - MTODESEMBOLSADO ELSE 0 END) AS MTONODESEMBOLSADOPARCIAL,
		( (CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND (FECDESEMBOLSO IS NULL OR MTODESEMBOLSADO = 0) THEN MTOAPROBADO ELSE 0 END) + (CASE WHEN ESTADOSOLICITUD = 'APROBADO' AND FECDESEMBOLSO IS NOT NULL AND MTODESEMBOLSADO < MTOAPROBADO AND MTODESEMBOLSADO > 0 THEN MTOAPROBADO - MTODESEMBOLSADO ELSE 0 END) ) AS MTONODESEMBOLSADO

	FROM TP_BASE_PREV
),
TP_BASE_TIEMPOS AS (
	SELECT
		CODMES,
		CODSOLICITUD,
		CENTROATENCION,
		CANAL,
		MATANALISTA,
		MATSUPERIOR,
	    NBRAREAUNIDADORGANIZATIVAVENDEDOR,
	    TIPOPERACION,
	    DESTIPOPERACION,
	    PRODUCTO,
	    DESPRODUCTO,
	    DESCAMPANIA,
	    DESTIPEVALUACIONRIESGO,
		FECSOLICITUD,
		FLGDIAUTIL,
		FECHORSOLICITUD,
		FECHORINICIOEVALUACION,
		FECHORFINEVALUACION,
		FECDESEMBOLSO,
		FECHORDESEMBOLSO,
	    TIEMPOATENCIONSOLICITUD,
	    TIEMPODERIVACIONANALISTA,
	    TIEMPOATENCIONANALISTA,
	    TIEMPODESEMBOLSOPOSTATENCIONANALISTA,
	    NBRMONEDA,
	    DESTIPRENTA,
	    SEGMENTO,
	    ESTADOSOLICITUD,
	    FLGDENEGADA,
	    FLGDENEGADAINTEGRA,
		FLGDENEGADAPARCIAL,
		FLGAPROBADA,
		FLGAPROBADAINTEGRA,
		FLGAPROBADAPARCIAL,
		FLGDESEMBOLSADA,
		FLGDESEMBOLSADAINTEGRA,
		FLGDESEMBOLSADOPARCIAL,
		FLGNODESEMBOLSADAINTEGRA,
		FLGNODESEMBOLSADOPARCIAL,
		FLGDESEMBOLSADABASE,
		FLGNODESEMBOLSADABASE,
		MTOSOLICITADO,
		MTODENEGADOINTEGRO,
		MTODENEGADOPARCIAL,
		MTODENEGADO,
		MTOAPROBADO,
		MTOAPROBADOINTEGRO,
		MTOAPROBADOPARCIAL,
		MTODESEMBOLSADO,
		MTODESEMBOLSADOINTEGRO,
		MTODESEMBOLSADOPARCIAL,
		MTONODESEMBOLSADOINTEGRO,
		MTONODESEMBOLSADOPARCIAL,
		MTONODESEMBOLSADO,
		MTODESEMBOLSADOBASE,
		MTONODESEMBOLSADOBASE,
		TIEMPOATENCIONANALISTA,
		(CASE
			WHEN TIEMPOATENCIONSOLICITUD IS NULL THEN 'SIN INF.'
		    WHEN TIEMPOATENCIONSOLICITUD > 0 AND TIEMPOATENCIONSOLICITUD <= 12 THEN '0h - 12h'
		    WHEN TIEMPOATENCIONSOLICITUD > 12 and TIEMPOATENCIONSOLICITUD <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETATENCIONSOLICITUD,
		(CASE
			WHEN TIEMPODERIVACIONANALISTA IS NULL THEN 'SIN INF.'
		    WHEN TIEMPODERIVACIONANALISTA > 0 and TIEMPODERIVACIONANALISTA <= 12 THEN '0h - 12h'
		    WHEN TIEMPODERIVACIONANALISTA > 12 and TIEMPODERIVACIONANALISTA <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETDERIVACIONANALISTA,
		(CASE
			WHEN TIEMPOATENCIONANALISTA IS NULL THEN 'SIN INF.'
		    WHEN TIEMPOATENCIONANALISTA > 0 AND TIEMPOATENCIONANALISTA <= 12 THEN '0h - 12h'
		    WHEN TIEMPOATENCIONANALISTA > 12 AND TIEMPOATENCIONANALISTA <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETATENCIONANALISTA,
		(CASE
			WHEN TIEMPOATENCIONSOLICITUDANALISTA IS NULL THEN 'SIN INF.'
		    WHEN TIEMPOATENCIONSOLICITUDANALISTA > 0 AND TIEMPOATENCIONSOLICITUDANALISTA <= 12 THEN '0h - 12h'
		    WHEN TIEMPOATENCIONSOLICITUDANALISTA > 12 AND TIEMPOATENCIONSOLICITUDANALISTA <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETATENIONSOLICITUDANALISTA,
		(CASE
			WHEN TIEMPODESEMBOLSOPOSTATENCIONANALISTA IS NULL THEN 'SIN INF.'
		    WHEN TIEMPODESEMBOLSOPOSTATENCIONANALISTA > 0 AND TIEMPODESEMBOLSOPOSTATENCIONANALISTA <= 12 THEN '0h - 12h'
		    WHEN TIEMPODESEMBOLSOPOSTATENCIONANALISTA > 12 AND TIEMPODESEMBOLSOPOSTATENCIONANALISTA <= 24 THEN '12h - 24h'
	    	ELSE '>24h'
		END) AS BRACKETDESEMBOLSOPOSTATENCIONANALISTA
	FROM TP_BASE
	WHERE CENTROATENCION IN ('CENTRALIZADO', 'PUNTO DE CONTACTO')
)
SELECT
	CODMES,
	CENTROATENCION,
	CANAL,
	MATANALISTA,
	MATSUPERIOR,
    NBRAREAUNIDADORGANIZATIVAVENDEDOR,
    ESTADOSOLICITUD,
    TIEMPOATENCIONANALISTA,
	COUNT(CODSOLICITUD) AS CTDSOLICITUDES,
	SUM(FLGDENEGADA) AS CTDSOLICITUDESDENEGADAS,
	SUM(FLGDENEGADAINTEGRA) AS CTDSOLICITUDESDENEGADASINTEGRAS,
	SUM(FLGDENEGADAPARCIAL) AS CTDSOLICITUDESDENEGADASPARCIALES,
	SUM(FLGAPROBADA) AS CTDSOLICITUDESAPROBADAS,
	SUM(FLGAPROBADAINTEGRA) AS CTDSOLICITUDESAPROBADASINTEGRAS,
	SUM(FLGAPROBADAPARCIAL) AS CTDSOLICITUDESAPROBADASPARCIALES,
	SUM(FLGDESEMBOLSADA) AS CTDSOLICITUDESDESEMBOLSADAS,
	SUM(FLGDESEMBOLSADAINTEGRA) AS CTDSOLICITUDESDESEMBOLSADASINTEGRAS,
	SUM(FLGDESEMBOLSADOPARCIAL) AS CTDSOLICITUDESDESEMBOLSADASPARCIALES,
	SUM(FLGNODESEMBOLSADAINTEGRA) AS CTDSOLICITUDESNODESEMBOLSADAINTEGRA,
	SUM(FLGNODESEMBOLSADOPARCIAL) AS CTDSOLICITUDESNODESEMBOLSADASPARCIALES,
	SUM(FLGDESEMBOLSADABASE) AS CTDSOLICITUDESDESEMBOLSADASBASE,
  	SUM(FLGNODESEMBOLSADABASE) AS CTDSOLICITUDESNODESEMBOLSADASBASE,
	SUM(MTOSOLICITADO) AS MTOSOLICITADO,
	SUM(MTODENEGADOINTEGRO) AS MTODENEGADOINTEGRO,
	SUM(MTODENEGADOPARCIAL) AS MTODENEGADOPARCIAL,
	SUM(MTODENEGADO) AS MTODENEGADO,
	SUM(MTOAPROBADO) AS MTOAPROBADO,
	SUM(MTOAPROBADOINTEGRO) AS MTOAPROBADOINTEGRO,
	SUM(MTOAPROBADOPARCIAL) AS MTOAPROBADOPARCIAL,
	SUM(MTODESEMBOLSADO) AS MTODESEMBOLSADO,
	SUM(MTODESEMBOLSADOINTEGRO) AS MTODESEMBOLSADOINTEGRO,
	SUM(MTODESEMBOLSADOPARCIAL) AS MTODESEMBOLSADOPARCIAL,
	SUM(MTONODESEMBOLSADOINTEGRO) AS MTONODESEMBOLSADOINTEGRO,
	SUM(MTONODESEMBOLSADOPARCIAL) AS MTONODESEMBOLSADOPARCIAL,
	SUM(MTONODESEMBOLSADO) AS MTONODESEMBOLSADO,
  	SUM(MTODESEMBOLSADOBASE) AS MTODESEMBOLSADOBASE,
  	SUM(MTONODESEMBOLSADOBASE) AS MTONODESEMBOLSADOBASE,
	TIPOPERACION,
	DESTIPOPERACION,
	PRODUCTO,
	DESPRODUCTO,
	DESCAMPANIA,
	DESTIPEVALUACIONRIESGO,
	FECSOLICITUD,
	FLGDIAUTIL,
	DESTIPRENTA,
	SEGMENTO,
	BRACKETATENCIONSOLICITUD,
	BRACKETDERIVACIONANALISTA,
	BRACKETATENCIONANALISTA,
	BRACKETATENIONSOLICITUDANALISTA,
	BRACKETDESEMBOLSOPOSTATENCIONANALISTA
FROM TP_BASE_TIEMPOS
GROUP BY
    CODMES, CENTROATENCION, CANAL, MATANALISTA, MATSUPERIOR, NBRAREAUNIDADORGANIZATIVAVENDEDOR, TIPOPERACION, DESTIPOPERACION, PRODUCTO, DESPRODUCTO,
    DESCAMPANIA, DESTIPEVALUACIONRIESGO, FECSOLICITUD, FLGDIAUTIL, ESTADOSOLICITUD, DESTIPRENTA, SEGMENTO, TIEMPOATENCIONANALISTA,
    BRACKETATENCIONSOLICITUD, BRACKETDERIVACIONANALISTA, BRACKETATENCIONANALISTA, BRACKETATENIONSOLICITUDANALISTA, BRACKETDESEMBOLSOPOSTATENCIONANALISTA;
