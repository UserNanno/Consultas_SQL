WITH
SOLICITUDES_CENTRALIZADO AS (
  SELECT
    MES AS CODMES,
    FECSOLICITUD,
    NROSOLICITUD AS CODSOLICITUD,
    PRODUCTO,
    DETPRODUCTO AS DESPRODUCTO,
    ESTADOFINAL,
    ETAPA,
    CANAL
  FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.T72496_PLANCHON
),
M_SOLICITUDCREDITOCONSUMO AS (
  SELECT
    CODSOLICITUD,
    CODINTERNOCOMPUTACIONAL
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_SOLICITUDCREDITOCONSUMO
),
CLIENTES AS (
  SELECT
    A.CODMES,
    A.CODSOLICITUD,
    A.FECSOLICITUD,
    A.PRODUCTO,
    A.DESPRODUCTO,
    A.CANAL,
    A.ETAPA,
    A.ESTADOFINAL,
    B.CODINTERNOCOMPUTACIONAL
  FROM SOLICITUDES_CENTRALIZADO A
  LEFT JOIN M_SOLICITUDCREDITOCONSUMO B
    ON A.CODSOLICITUD = B.CODSOLICITUD
),
MARCADOS AS (
  SELECT
    CODMES,
    CODSOLICITUD,
    FECSOLICITUD,
    CODINTERNOCOMPUTACIONAL,
    ESTADOFINAL,

    -- ¿Hubo algún rechazo antes (del mismo cliente y mes)?
    MAX(CASE WHEN ESTADOFINAL = 'RECHAZADO' THEN 1 ELSE 0 END) OVER (
      PARTITION BY CODINTERNOCOMPUTACIONAL, CODMES
      ORDER BY FECSOLICITUD, CODSOLICITUD
      ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
    ) AS TIENE_RECHAZO_PREVIO_MES
  FROM CLIENTES
  WHERE CODINTERNOCOMPUTACIONAL IS NOT NULL
)
SELECT
  CODMES,
  COUNT(CASE WHEN ESTADOFINAL = 'APROBADO' THEN 1 END) AS APROBADAS_TOTAL,
  COUNT(CASE WHEN ESTADOFINAL = 'APROBADO' AND TIENE_RECHAZO_PREVIO_MES = 1 THEN 1 END) AS APROBADAS_REINGRESO,
  (COUNT(CASE WHEN ESTADOFINAL = 'APROBADO' AND TIENE_RECHAZO_PREVIO_MES = 1 THEN 1 END)
   / NULLIF(COUNT(CASE WHEN ESTADOFINAL = 'APROBADO' THEN 1 END), 0)
  ) AS PCT_APROBADAS_REINGRESO
FROM MARCADOS
GROUP BY CODMES
ORDER BY CODMES;
