WITH
/* ====== Reusa EXACTAMENTE el mismo WITH del query (1) hasta BASE_FLAGS_LEAD ======
   Copia/pega el WITH completo de arriba (SOL ... BASE_FLAGS_LEAD)
   y luego continúa con estas CTEs:
*/

CLIENTE_MES_UNIV AS (
  SELECT
    CODMESSOLICITUDEVALUACION AS CODMES,
    DESCANALVENTARBM,
    CODCLAVEPARTYCLI,
    TIPO_LEAD,

    -- Universos por cliente-mes (flags)
    MAX(FLG_DENEGADO)      AS FLG_TUVO_DENEGADO,
    MAX(FLG_NODESEMBOLSADO) AS FLG_TUVO_APR_SIN_DESEMBOLSO,

    -- Si quieres más universos, los puedes sumar igual:
    MAX(FLG_DESEMBOLSADO)  AS FLG_TUVO_DESEMBOLSO,
    MAX(FLG_APROBADO)      AS FLG_TUVO_APROBADO

  FROM BASE_FLAGS_LEAD
  WHERE CODMESSOLICITUDEVALUACION BETWEEN 202501 AND 202512
    AND DESCANALVENTARBM NOT IN ('SALEFORCE')
    AND CODCLAVEPARTYCLI IS NOT NULL
  GROUP BY
    CODMESSOLICITUDEVALUACION,
    DESCANALVENTARBM,
    CODCLAVEPARTYCLI,
    TIPO_LEAD
),

SBS_DEUDA AS (
  SELECT
    CAST(date_format(FECDIA,'yyyyMM') AS INT) AS CODMESDEUDA,
    CODCLAVEPARTYCLI,
    SUM(MTODEUDASOL) AS MTODEUDASOL_SISTEMA,
    MAX(
      CASE
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) = 'NORMAL' THEN 1
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('CON PROBLEMAS POTENCIALES(CPP)','CPP','CON PROBLEMAS POTENCIALES (CPP)') THEN 2
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) = 'DEFICIENTE' THEN 3
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) = 'DUDOSO' THEN 4
        WHEN UPPER(TRIM(DESTIPCLASIFRIESGO)) IN ('PERDIDA','PÉRDIDA') THEN 5
        ELSE 0
      END
    ) AS RIESGO_PEOR_ORD
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_DEUDORSBSDETALLE
  WHERE CAST(date_format(FECDIA,'yyyyMM') AS INT) BETWEEN 202412 AND 202512
    AND UPPER(TRIM(NBREMPSISTEMAFINANCIERO)) NOT LIKE 'BANCO DE CREDITO DEL PER%'
  GROUP BY CAST(date_format(FECDIA,'yyyyMM') AS INT), CODCLAVEPARTYCLI
),

CLIENTE_MES_SBS AS (
  SELECT
    c.*,

    COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0) AS DELTA_DEUDA_SBS,
    GREATEST(COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0), 0) AS DELTA_DEUDA_SBS_POS,

    -- regla (tu umbral actual; cámbialo si quieres)
    CASE WHEN (COALESCE(s2.MTODEUDASOL_SISTEMA,0) - COALESCE(s1.MTODEUDASOL_SISTEMA,0)) > 100 THEN 1 ELSE 0 END AS FLG_AUMENTO_DEUDA_SBS_REGLA,

    COALESCE(s2.RIESGO_PEOR_ORD,0) AS DESTIPCLASIFRIESGO_PEOR_ORD,
    CASE COALESCE(s2.RIESGO_PEOR_ORD,0)
      WHEN 1 THEN 'NORMAL'
      WHEN 2 THEN 'CON PROBLEMAS POTENCIALES(CPP)'
      WHEN 3 THEN 'DEFICIENTE'
      WHEN 4 THEN 'DUDOSO'
      WHEN 5 THEN 'PERDIDA'
      ELSE 'SIN INFO'
    END AS DESTIPCLASIFRIESGO_PEOR

  FROM CLIENTE_MES_UNIV c
  LEFT JOIN SBS_DEUDA s1
    ON c.CODCLAVEPARTYCLI = s1.CODCLAVEPARTYCLI
   AND CAST(date_format(add_months(to_date(concat(CAST(c.CODMES AS STRING),'01'),'yyyyMMdd'),-1),'yyyyMM') AS INT) = s1.CODMESDEUDA
  LEFT JOIN SBS_DEUDA s2
    ON c.CODCLAVEPARTYCLI = s2.CODCLAVEPARTYCLI
   AND c.CODMES = s2.CODMESDEUDA
),

AGG_CLIENTES AS (
  SELECT
    CODMES,
    DESCANALVENTARBM,
    DESTIPCLASIFRIESGO_PEOR,
    DESTIPCLASIFRIESGO_PEOR_ORD,
    TIPO_LEAD,

    COUNT(DISTINCT CODCLAVEPARTYCLI) AS CTD_CLIENTES_UNICOS,

    COUNT(DISTINCT CASE WHEN FLG_TUVO_DENEGADO = 1 THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_CON_DENEGADA,
    COUNT(DISTINCT CASE WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1 THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_APR_SIN_DESEMBOLSO,

    COUNT(DISTINCT CASE WHEN FLG_AUMENTO_DEUDA_SBS_REGLA = 1 THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_AUM_SBS_REGLA,

    COUNT(DISTINCT CASE
      WHEN FLG_TUVO_DENEGADO = 1 AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1
      THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_DENEG_AUM_SBS_REGLA,

    COUNT(DISTINCT CASE
      WHEN FLG_TUVO_APR_SIN_DESEMBOLSO = 1 AND FLG_AUMENTO_DEUDA_SBS_REGLA = 1
      THEN CODCLAVEPARTYCLI END) AS CTD_CLIENTES_APR_SIN_DES_AUM_SBS_REGLA,

    -- Montos sin inflar: 1 delta por cliente-mes
    SUM(CASE WHEN FLG_AUMENTO_DEUDA_SBS_REGLA = 1 THEN DELTA_DEUDA_SBS_POS ELSE 0 END) AS MTO_AUM_SBS_REGLA

  FROM CLIENTE_MES_SBS
  GROUP BY
    CODMES,
    DESCANALVENTARBM,
    DESTIPCLASIFRIESGO_PEOR,
    DESTIPCLASIFRIESGO_PEOR_ORD,
    TIPO_LEAD
)

SELECT *
FROM AGG_CLIENTES
ORDER BY
  CODMES,
  DESCANALVENTARBM,
  DESTIPCLASIFRIESGO_PEOR_ORD,
  TIPO_LEAD;
