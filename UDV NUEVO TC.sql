-- ============================================================
-- CONSOLIDADO SOLICITUDES CC (RBM) + FLAG REINGRESO 1 MES
-- + ADJUDICACIÓN DE VENTA (M_CUENTACREDITOPERSONAL)
-- Considera CODEVALUACIONSOLICITUD como texto (incluye OP-####)
-- ============================================================

WITH SOL AS (
  SELECT
    A.CODMESEVALUACION,
    A.FECSOLICITUDEVALUACION,
    A.FECEVALUACION,
    A.DESCANALVENTARBMPER,
    A.TIPPRODUCTOSOLICITUDRBM,
    A.DESCANALVENTASOLICITUDRBM,
    A.DESTIPDECISIONRESULTADORBM,
    A.CODINTERNOCOMPUTACIONAL,
    A.DESTIPDECISIONRESULTADOPRIORIZACION,
    A.DESCAMPANIASOLICITUD,
    A.DESTIPEVALUACIONSOLICITUDCREDITO,

    -- llaves / desambiguadores
    A.CODIDVALUACION,
    A.CODEVALUACIONSOLICITUD,
    A.CODSECUENCIALDECISIONRBM,
    A.NUMSOLICITUDEVALUACION,

    -- "corto" para empatar con CODSOLICITUDCORTO en ventas
    (CASE
      WHEN A.DESCANALVENTARBMPER = 'SALEFORCE' THEN SUBSTR(TRIM(A.NUMSOLICITUDEVALUACION), 5, 7)
      WHEN A.DESCANALVENTARBMPER = 'LOANS'     THEN SUBSTR(TRIM(A.NUMSOLICITUDEVALUACION), 3, 8)
      ELSE TRIM(A.NUMSOLICITUDEVALUACION)
    END) AS NUMSOLICITUDEVALUACIONCORTO,

    B.CODCLAVEPARTYCLI
  FROM CATALOG_LHCL_PROD_BCP.BCP_DDV_RBMRBMPER_MODELOGESTION_VU.MD_EVALUACIONSOLICITUDCREDITO A
  LEFT JOIN CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_CLIENTE B
    ON TRIM(A.CODINTERNOCOMPUTACIONAL) = TRIM(B.CODINTERNOCOMPUTACIONAL)
  WHERE A.TIPPRODUCTOSOLICITUDRBM = 'CC'
    AND A.DESCANALVENTARBMPER NOT IN ('YAPE', 'OTROS')
    -- si quieres filtrar un cliente específico, descomenta:
    -- AND TRIM(B.CODINTERNOCOMPUTACIONAL) = '23045191'
),

-- Normalización para ordenar CODEVALUACIONSOLICITUD (texto con posibles OP-)
SOL_NORM AS (
  SELECT
    s.*,
    CASE WHEN s.CODEVALUACIONSOLICITUD LIKE 'OP-%' THEN 1 ELSE 0 END AS FLG_OP_PREFIX,
    COALESCE(
      CAST(NULLIF(regexp_extract(s.CODEVALUACIONSOLICITUD, '([0-9]+)', 1), '') AS BIGINT),
      -1
    ) AS CODEVAL_NUM
  FROM SOL s
),

-- Orden determinístico + LAG para reingreso
SOL_ORD AS (
  SELECT
    n.*,

    ROW_NUMBER() OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION ASC,
        n.FLG_OP_PREFIX ASC,          -- primero no-OP, luego OP-
        n.CODEVAL_NUM ASC,            -- parte numérica (sirve para '123' y 'OP-123')
        n.CODEVALUACIONSOLICITUD ASC, -- desempate estable
        n.CODSECUENCIALDECISIONRBM ASC,
        n.CODIDVALUACION ASC
    ) AS RN_SOL,

    LAG(n.FECSOLICITUDEVALUACION) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION ASC,
        n.FLG_OP_PREFIX ASC,
        n.CODEVAL_NUM ASC,
        n.CODEVALUACIONSOLICITUD ASC,
        n.CODSECUENCIALDECISIONRBM ASC,
        n.CODIDVALUACION ASC
    ) AS PREV_FECSOL,

    LAG(n.FLG_OP_PREFIX) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION ASC,
        n.FLG_OP_PREFIX ASC,
        n.CODEVAL_NUM ASC,
        n.CODEVALUACIONSOLICITUD ASC,
        n.CODSECUENCIALDECISIONRBM ASC,
        n.CODIDVALUACION ASC
    ) AS PREV_FLG_OP,

    LAG(n.CODEVAL_NUM) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION ASC,
        n.FLG_OP_PREFIX ASC,
        n.CODEVAL_NUM ASC,
        n.CODEVALUACIONSOLICITUD ASC,
        n.CODSECUENCIALDECISIONRBM ASC,
        n.CODIDVALUACION ASC
    ) AS PREV_CODEVAL_NUM,

    LAG(n.CODEVALUACIONSOLICITUD) OVER (
      PARTITION BY n.CODINTERNOCOMPUTACIONAL
      ORDER BY
        n.FECSOLICITUDEVALUACION ASC,
        n.FLG_OP_PREFIX ASC,
        n.CODEVAL_NUM ASC,
        n.CODEVALUACIONSOLICITUD ASC,
        n.CODSECUENCIALDECISIONRBM ASC,
        n.CODIDVALUACION ASC
    ) AS PREV_CODEVAL_TXT

  FROM SOL_NORM n
),

-- Flag reingreso (ventana 1 mes calendario inclusive)
-- Regla de "posterior": fecha mayor, o misma fecha y "orden" mayor (por prefijo+num+texto)
SOL_REING AS (
  SELECT
    o.*,

    CASE
      WHEN o.PREV_FECSOL IS NULL THEN 0

      WHEN (
        o.FECSOLICITUDEVALUACION > o.PREV_FECSOL
        OR (
          o.FECSOLICITUDEVALUACION = o.PREV_FECSOL
          AND (
            o.FLG_OP_PREFIX > o.PREV_FLG_OP
            OR (o.FLG_OP_PREFIX = o.PREV_FLG_OP AND o.CODEVAL_NUM > o.PREV_CODEVAL_NUM)
            OR (o.FLG_OP_PREFIX = o.PREV_FLG_OP AND o.CODEVAL_NUM = o.PREV_CODEVAL_NUM AND o.CODEVALUACIONSOLICITUD > o.PREV_CODEVAL_TXT)
          )
        )
      )
      AND o.FECSOLICITUDEVALUACION <= add_months(o.PREV_FECSOL, 1)
      THEN 1 ELSE 0
    END AS FLG_REINGRESO_1M,

    -- ID de episodio (cada vez que NO está dentro de 1 mes, empieza uno nuevo)
    SUM(
      CASE
        WHEN o.PREV_FECSOL IS NULL THEN 1
        WHEN o.FECSOLICITUDEVALUACION > add_months(o.PREV_FECSOL, 1) THEN 1
        ELSE 0
      END
    ) OVER (
      PARTITION BY o.CODINTERNOCOMPUTACIONAL
      ORDER BY
        o.FECSOLICITUDEVALUACION ASC,
        o.FLG_OP_PREFIX ASC,
        o.CODEVAL_NUM ASC,
        o.CODEVALUACIONSOLICITUD ASC,
        o.CODSECUENCIALDECISIONRBM ASC,
        o.CODIDVALUACION ASC
      ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    ) AS ID_EPISODIO_1M

  FROM SOL_ORD o
),

-- Ventas / cuentas (MDPREST)
VENTA AS (
  SELECT
    CAST(date_format(FECAPERTURA, 'yyyyMM') AS INT) AS CODMESAPERTURA,
    CODSOLICITUD,

    (CASE
      WHEN SUBSTR(TRIM(CODSOLICITUD), 1, 2) IN ('CX', 'DX') THEN SUBSTR(TRIM(CODSOLICITUD), 3, 8) -- LOANS
      WHEN CODSOLICITUD LIKE '2________'                 THEN SUBSTR(TRIM(CODSOLICITUD), 3, 7) -- SF
      WHEN CODSOLICITUD LIKE '      2________'           THEN SUBSTR(TRIM(CODSOLICITUD), 3, 7) -- SF
      WHEN CODSOLICITUD LIKE 'O%'                        THEN SUBSTR(TRIM(CODSOLICITUD), 3, 7) -- SF
      ELSE TRIM(CODSOLICITUD) -- BMO / CUOTEALO
    END) AS CODSOLICITUDCORTO,

    (CASE
      WHEN CODPRODUCTO = 'CPEFIA' THEN 'CUOTEALO'
      WHEN SUBSTR(TRIM(CODSOLICITUD), 1, 2) = 'PE' THEN 'CUOTEALO'
      WHEN CODPRODUCTO = 'CPEYAP' THEN 'YAPE'
      WHEN SUBSTR(TRIM(CODSOLICITUD), 1, 2) = 'YP' THEN 'YAPE'
      WHEN SUBSTR(TRIM(CODSOLICITUD), 1, 2) = 'JB' THEN 'BANCA MÓVIL'
      WHEN SUBSTR(TRIM(CODSOLICITUD), 1, 2) IN ('CX', 'DX') THEN 'LOANS'
      WHEN CODSOLICITUD LIKE '2________' THEN 'SALEFORCE'
      WHEN CODSOLICITUD LIKE '      2________' THEN 'SALEFORCE'
      WHEN CODSOLICITUD LIKE 'O%' THEN 'SALEFORCE'
      ELSE 'OTROS'
    END) AS CANAL_MDPREST,

    FECAPERTURA,
    FECDESEMBOLSO,
    MTOORIGINALCREDITO,
    MTODESEMBOLSADO,
    MTODESEMBOLSADOCONTRAVALORSBSSOL,
    CODCLAVEPARTYCLI
  FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.M_CUENTACREDITOPERSONAL
  WHERE CODPRODUCTO IN ('CPEEFM','CPECMC','CPEDPP','CPECEM','CPEECV','CPEGEN','CPEADH','CPEFIA')
    AND FLGREGELIMINADOFUENTE = 'N'
    -- si quieres filtrar un cliente específico, descomenta:
    -- AND TRIM(CODCLAVEPARTYCLI) = '...'
),

-- Candidatos de match SOL<->VENTA por:
-- cliente + canal + corto + (apertura entre 0..40 días desde solicitud)
MATCH_CAND AS (
  SELECT
    s.*,

    v.CODMESAPERTURA,
    v.CODSOLICITUD,
    v.CODSOLICITUDCORTO,
    v.CANAL_MDPREST,
    v.FECAPERTURA,
    v.FECDESEMBOLSO,
    v.MTOORIGINALCREDITO,
    v.MTODESEMBOLSADO,
    v.MTODESEMBOLSADOCONTRAVALORSBSSOL,

    ABS(datediff(v.FECAPERTURA, s.FECSOLICITUDEVALUACION)) AS ABS_DIF_APERTURA,
    datediff(v.FECAPERTURA, s.FECSOLICITUDEVALUACION) AS DIF_APERTURA

  FROM SOL_REING s
  LEFT JOIN VENTA v
    ON s.CODCLAVEPARTYCLI = v.CODCLAVEPARTYCLI
   AND s.DESCANALVENTARBMPER = v.CANAL_MDPREST
   AND TRIM(s.NUMSOLICITUDEVALUACIONCORTO) = TRIM(v.CODSOLICITUDCORTO)
   AND datediff(v.FECAPERTURA, s.FECSOLICITUDEVALUACION) BETWEEN 0 AND 40
),

-- 1 venta por solicitud (si existiera más de una candidata, elige la más cercana)
MATCH_ONE AS (
  SELECT *
  FROM (
    SELECT
      m.*,
      ROW_NUMBER() OVER (
        PARTITION BY m.CODINTERNOCOMPUTACIONAL, m.CODIDVALUACION, m.CODEVALUACIONSOLICITUD
        ORDER BY
          m.ABS_DIF_APERTURA ASC,
          m.FECAPERTURA ASC,
          m.CODSOLICITUD ASC
      ) AS RN_MATCH
    FROM MATCH_CAND m
  ) x
  WHERE RN_MATCH = 1
)

SELECT
  -- Identificadores
  CODINTERNOCOMPUTACIONAL,
  CODCLAVEPARTYCLI,

  -- Solicitud RBM
  CODMESEVALUACION,
  FECSOLICITUDEVALUACION,
  FECEVALUACION,
  DESCANALVENTARBMPER,
  TIPPRODUCTOSOLICITUDRBM,
  DESCANALVENTASOLICITUDRBM,
  DESTIPDECISIONRESULTADORBM,
  DESTIPDECISIONRESULTADOPRIORIZACION,
  DESCAMPANIASOLICITUD,
  DESTIPEVALUACIONSOLICITUDCREDITO,

  -- Keys / desambiguación
  NUMSOLICITUDEVALUACION,
  NUMSOLICITUDEVALUACIONCORTO,
  CODIDVALUACION,
  CODEVALUACIONSOLICITUD,
  CODSECUENCIALDECISIONRBM,

  -- Orden y reingreso
  RN_SOL,
  PREV_FECSOL,
  FLG_REINGRESO_1M,
  ID_EPISODIO_1M,

  -- Venta adjudicada (si existe)
  CODMESAPERTURA,
  CODSOLICITUD,
  CODSOLICITUDCORTO,
  CANAL_MDPREST,
  FECAPERTURA,
  FECDESEMBOLSO,
  MTOORIGINALCREDITO,
  MTODESEMBOLSADO,
  MTODESEMBOLSADOCONTRAVALORSBSSOL

FROM MATCH_ONE
;
