...
),

RBM_VTA_SOL AS (
  SELECT
    A.CODMES_EVAL AS CODMES,
    A.FEC_EVALUACION,
    A.CIC,
    A.NUMSOLICITUD_RBM,
    A.NUMSOLICITUD_CORTO,
    A.CANAL_RBM,
    A.RESULTADO_CDA,
    A.DECISION_RBM,
    A.CAMPANIA_RBM,
    A.TIPO_CAMPANIA_RBM,
    A.LEAD_CEF,
    B.MTO_DESEMBOLSO_SOL_VTA,
    C.FEC_SOLICITUD,
    C.MTO_SOLICITADO,
    C.MTO_APROBADO
  FROM RBM_UNICOS A
  LEFT JOIN VENTAS_CONSOL B
    ON A.NUMSOLICITUD_CORTO = B.NUMSOLICITUD_CORTO_VTA
   AND A.CANAL_RBM          = B.CANAL_VTA
   AND A.CIC                = B.CIC
  LEFT JOIN SOL_CONSUMO C
    ON A.CODMES_EVAL        = C.CODMES_SOL
   AND A.NUMSOLICITUD_RBM   = C.NUMSOLICITUD_RBM
),

LEADS_RAW AS (
  SELECT
    ROUND(A.CODLOTEOFERTA,0)               AS CODMES_LEAD,
    TRIM(A.CODINTERNOCOMPUTACIONAL) AS CIC,
    ROUND(A.TIPVENTA,0)             AS TIPVENTA,
    ROUND(A.TIPOFERTA,0)            AS TIPOFERTA,
    A.DESCAMPANA                    AS DESCAMPANA_LEAD,
    A.CODCONDICIONCLIENTE,
    ROUND(A.MTOFINALOFERTADOSOL,1)  AS MTO_OFERTA,
    ROUND(A.NUMPLAZO,0)             AS PLAZO_LEAD,
    A.PCTTASAEFECTIVAANUAL          AS TEA_LEAD,
    A.FECINICIOVIGENCIA,

    CASE
      WHEN A.TIPVENTA=6   AND A.TIPOFERTA=3  AND A.CODCONDICIONCLIENTE IN (\'APR\',\'PRE\') THEN 1
      WHEN A.TIPVENTA=6   AND A.TIPOFERTA=3  AND A.CODCONDICIONCLIENTE=\'OPT\'              THEN 2
      WHEN A.TIPVENTA=6   AND A.TIPOFERTA=41 AND A.CODCONDICIONCLIENTE IN (\'APR\',\'PRE\') THEN 3
      WHEN A.TIPVENTA=6   AND A.TIPOFERTA=38 AND A.CODCONDICIONCLIENTE IN (\'APR\',\'PRE\') THEN 4
      WHEN A.TIPVENTA=6   AND A.TIPOFERTA IN (89,98)                                       THEN 5
      WHEN A.TIPVENTA=6   AND A.TIPOFERTA=3  AND A.CODCONDICIONCLIENTE=\'INV\'              THEN 6
      WHEN A.TIPVENTA=6   AND A.TIPOFERTA=187                                               THEN 7
      WHEN A.TIPVENTA=110 AND A.TIPOFERTA=3                                                  THEN 8
      WHEN A.TIPVENTA=110 AND A.TIPOFERTA=41                                                 THEN 9
      WHEN A.TIPVENTA=110 AND A.TIPOFERTA=38                                                 THEN 10
      ELSE 11
    END AS PRIORIDAD_LEAD,

    CASE
      WHEN A.TIPVENTA=6   AND A.TIPOFERTA=3  AND A.CODCONDICIONCLIENTE IN (\'APR\',\'PRE\') THEN \'LD APR\'
      WHEN A.TIPVENTA=6   AND A.TIPOFERTA=3  AND A.CODCONDICIONCLIENTE=\'OPT\'              THEN \'LD OPT\'
      WHEN A.TIPVENTA=6   AND A.TIPOFERTA IN (89,98)                                       THEN \'LD SHD\'
      WHEN A.TIPVENTA=6   AND A.TIPOFERTA=41 AND A.CODCONDICIONCLIENTE IN (\'APR\',\'PRE\') THEN \'CDD APR\'
      WHEN A.TIPVENTA=6   AND A.TIPOFERTA=187                                               THEN \'CDD INS\'
      WHEN A.TIPVENTA=6   AND A.TIPOFERTA=38 AND A.CODCONDICIONCLIENTE IN (\'APR\',\'PRE\') THEN \'REE APR\'
      WHEN A.TIPVENTA=6   AND A.TIPOFERTA=3  AND A.CODCONDICIONCLIENTE=\'INV\'              THEN \'LD INV\'
      WHEN A.TIPVENTA=110 AND A.TIPOFERTA=3                                                  THEN \'LD CONV\'
      WHEN A.TIPVENTA=110 AND A.TIPOFERTA=41                                                 THEN \'CDD CONV\'
      WHEN A.TIPVENTA=110 AND A.TIPOFERTA=38                                                 THEN \'REE CONV\'
      ELSE \'OTRO\'
    END AS LEAD_CEF
  FROM catalog_lhcl_prod_bcp.bcp_edv_rbmbdn.HM_LEADS_BDI A
  CROSS JOIN PARAMS P
  WHERE A.CODPAUTARBM <> 41
    AND (A.TIPVENTA = 6 OR A.TIPVENTA = 110)
    AND A.DESCAMPANA NOT IN (\'CREDITO PERSONAL, VENTA AMPLIACION PLAZO\', \'VENTA SKIP\')
    AND to_date(A.FECINICIOVIGENCIA,\'yyyyMM\') = date_trunc(\'MM\', to_date(cast(P.CODMES AS STRING),\'yyyyMM\'))
),

LEADS_BASE AS (
  SELECT *
  FROM LEADS_RAW
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY CODMES_LEAD, CIC, TIPVENTA, TIPOFERTA
    ORDER BY FECINICIOVIGENCIA
  ) = 1
),

LEADS_UNICOS AS (
  SELECT *
  FROM LEADS_BASE
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY CIC
    ORDER BY PRIORIDAD_LEAD ASC
  ) = 1
),

LEADS_MES AS (
  SELECT DISTINCT CODMES_LEAD AS CODMES, CIC
  FROM LEADS_BASE
),

SOLICITUDES_LEAD AS (
  SELECT
    A.*,
    COALESCE(B.MTO_OFERTA, C.MTO_OFERTA) AS MTO_OFERTA_LEAD
  FROM RBM_VTA_SOL A
  LEFT JOIN LEADS_UNICOS B
    ON A.CIC = B.CIC
   AND A.LEAD_CEF = B.LEAD_CEF
  LEFT JOIN LEADS_UNICOS C
    ON A.CIC = C.CIC
),

BASE AS (
  SELECT DISTINCT
    A.CODMES                                 AS CODMESEVALUACION,
    A.FEC_EVALUACION                         AS FECEVALUACION,
    A.CIC                                    AS CODINTERNOCOMPUTACIONAL,
    A.CANAL_RBM                               AS TIPO_CANAL,
    \'DIGITAL\'                               AS CANAL_F,
    \'PUNTO DE CONTACTO\'                     AS TIPO_EVALUACION,

    CASE
      WHEN COALESCE(A.MTO_DESEMBOLSO_SOL_VTA,0) > 0 THEN \'1. Aprobado\'
      WHEN A.RESULTADO_CDA=\'Approve\'             THEN \'1. Aprobado\'
      ELSE \'2. Denegado\'
    END AS RESULTADO_FINAL,

    CASE WHEN A.MTO_OFERTA_LEAD IS NOT NULL THEN \'1. Con lead\' ELSE \'2. Sin lead\' END AS TIPO_LEAD_TMP,

    A.MTO_SOLICITADO                          AS MTOSOLICITADO_SLF,
    COALESCE(A.MTO_DESEMBOLSO_SOL_VTA,0)       AS MTODESEMBOLSADOSOL_VTA,
    A.RESULTADO_CDA                           AS RESULTADO_CDA,
    A.CAMPANIA_RBM                            AS DESCAMPANA,
    A.DECISION_RBM                            AS DECISION,
    COALESCE(A.MTO_OFERTA_LEAD,0)             AS MTO_OFERTA
  FROM SOLICITUDES_LEAD A
),

BASE1 AS (
  SELECT
    A.CODMESEVALUACION,
    A.FECEVALUACION,
    A.CODINTERNOCOMPUTACIONAL,

    CASE
      WHEN D.CODINTERNOCOMPUTACIONAL IS NOT NULL THEN \'1. Venta\'
      WHEN B.CODINTERNOCOMPUTACIONAL IS NULL     THEN \'2. Aprobado\'
      WHEN C.CODINTERNOCOMPUTACIONAL IS NULL     THEN \'3. Denegado\'
      ELSE \'4. Mix\'
    END AS RESULTADO_FINAL_UNICO,

    A.TIPO_EVALUACION,
    A.TIPO_CANAL,
    A.CANAL_F,
    A.TIPO_LEAD_TMP AS TIPO_LEAD,
    A.RESULTADO_FINAL,

    CASE WHEN A.MTOSOLICITADO_SLF IS NULL OR A.MTOSOLICITADO_SLF=0 THEN 0 ELSE 1 END AS FLG_MTOSOLICITUD,
    CASE WHEN A.MTODESEMBOLSADOSOL_VTA IS NULL OR A.MTODESEMBOLSADOSOL_VTA=0 THEN 0 ELSE 1 END AS FLG_MTOVENTA,

    A.RESULTADO_CDA,
    A.DESCAMPANA,
    A.DECISION,
    A.MTODESEMBOLSADOSOL_VTA,
    A.MTOSOLICITADO_SLF,
    A.MTO_OFERTA,

    COUNT(1) OVER (PARTITION BY A.CODINTERNOCOMPUTACIONAL, A.CODMESEVALUACION) AS NUM_SOLICITUDES

  FROM BASE A
  LEFT JOIN (
    SELECT DISTINCT CODMESEVALUACION, CODINTERNOCOMPUTACIONAL
    FROM BASE
    WHERE RESULTADO_FINAL=\'2. Denegado\'
  ) B ON A.CODMESEVALUACION=B.CODMESEVALUACION AND A.CODINTERNOCOMPUTACIONAL=B.CODINTERNOCOMPUTACIONAL

  LEFT JOIN (
    SELECT DISTINCT CODMESEVALUACION, CODINTERNOCOMPUTACIONAL
    FROM BASE
    WHERE RESULTADO_FINAL=\'1. Aprobado\'
  ) C ON A.CODMESEVALUACION=C.CODMESEVALUACION AND A.CODINTERNOCOMPUTACIONAL=C.CODINTERNOCOMPUTACIONAL

  LEFT JOIN (
    SELECT DISTINCT CODMESEVALUACION, CODINTERNOCOMPUTACIONAL
    FROM BASE
    WHERE MTODESEMBOLSADOSOL_VTA > 0
  ) D ON A.CODMESEVALUACION=D.CODMESEVALUACION AND A.CODINTERNOCOMPUTACIONAL=D.CODINTERNOCOMPUTACIONAL
),

BASE2 AS (
  SELECT A.*, 1 AS RK
  FROM BASE1 A
  WHERE COALESCE(A.MTODESEMBOLSADOSOL_VTA,0) > 0

  UNION ALL

  SELECT
    A.*,
    ROW_NUMBER() OVER (PARTITION BY A.CODMESEVALUACION, A.CODINTERNOCOMPUTACIONAL ORDER BY A.FECEVALUACION DESC) AS RK
  FROM BASE1 A
  LEFT JOIN (
    SELECT DISTINCT CODMESEVALUACION, CODINTERNOCOMPUTACIONAL
    FROM BASE1
    WHERE COALESCE(MTODESEMBOLSADOSOL_VTA,0) > 0
  ) B
    ON A.CODMESEVALUACION=B.CODMESEVALUACION
   AND A.CODINTERNOCOMPUTACIONAL=B.CODINTERNOCOMPUTACIONAL
  WHERE B.CODINTERNOCOMPUTACIONAL IS NULL
),

BASE_RK1 AS (
  SELECT * FROM BASE2 WHERE RK=1
)

SELECT
  ' || CAST(v_mes AS STRING) || ' AS CODMES,
  A.CODINTERNOCOMPUTACIONAL,
  CASE WHEN L.CIC IS NOT NULL THEN \'CON_LEAD\' ELSE \'SIN_LEAD\' END AS TIPO_LEAD,
  A.TIPO_EVALUACION,
  A.TIPO_CANAL,
  A.CANAL_F,
  A.RESULTADO_FINAL,
  A.RESULTADO_FINAL_UNICO,
  A.FLG_MTOSOLICITUD,
  A.FLG_MTOVENTA,
  A.RESULTADO_CDA,
  A.DESCAMPANA,
  A.DECISION,
  COUNT(1)                      AS C,
  SUM(A.MTODESEMBOLSADOSOL_VTA)  AS MTODESEMBOLSO,
  SUM(A.MTOSOLICITADO_SLF)       AS MTOSOLICITADO,
  MAX(A.NUM_SOLICITUDES)         AS NUM_SOLICITUDES,
  SUM(COALESCE(A.MTO_OFERTA,0))  AS MTO_OFERTA
FROM BASE_RK1 A
LEFT JOIN LEADS_MES L
  ON L.CODMES = ' || CAST(v_mes AS STRING) || '
 AND TRIM(L.CIC)=TRIM(A.CODINTERNOCOMPUTACIONAL)
GROUP BY ALL
';

    EXECUTE IMMEDIATE v_sql;

    IF v_mes = v_mes_end THEN
      LEAVE bucle;
    END IF;

    -- siguiente mes YYYYMM
    IF MOD(v_mes, 100) = 12 THEN
      SET v_mes = (DIV(v_mes, 100) + 1) * 100 + 1;
    ELSE
      SET v_mes = v_mes + 1;
    END IF;

    ITERATE bucle;

  END LOOP bucle;
END;

[DELTA_DUPLICATE_COLUMNS_FOUND] Found duplicate column(s) in the data to save: mto_oferta.

