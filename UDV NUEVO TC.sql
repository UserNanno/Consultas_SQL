, SOLICITUDES_LEAD AS (
  SELECT
    A.*,

    -- si es Reactivo/Cons* usa fallback por CIC; si no, usa match exacto y si no existe, cae al fallback
    CASE
      WHEN A.LEAD_CEF IN ('REACTIVO','CONS APR','CONS CONV')
        THEN L_FALLBACK.CODLOTEOFERTA
      ELSE COALESCE(L_EXACT.CODLOTEOFERTA, L_FALLBACK.CODLOTEOFERTA)
    END AS CODMES_LEAD,

    CASE
      WHEN A.LEAD_CEF IN ('REACTIVO','CONS APR','CONS CONV')
        THEN L_FALLBACK.TIPVENTA
      ELSE COALESCE(L_EXACT.TIPVENTA, L_FALLBACK.TIPVENTA)
    END AS TIPVENTA,

    CASE
      WHEN A.LEAD_CEF IN ('REACTIVO','CONS APR','CONS CONV')
        THEN L_FALLBACK.TIPOFERTA
      ELSE COALESCE(L_EXACT.TIPOFERTA, L_FALLBACK.TIPOFERTA)
    END AS TIPOFERTA,

    CASE
      WHEN A.LEAD_CEF IN ('REACTIVO','CONS APR','CONS CONV')
        THEN L_FALLBACK.DESCAMPANA
      ELSE COALESCE(L_EXACT.DESCAMPANA, L_FALLBACK.DESCAMPANA)
    END AS DESCAMPANALEAD,

    CASE
      WHEN A.LEAD_CEF IN ('REACTIVO','CONS APR','CONS CONV')
        THEN L_FALLBACK.CODCONDICIONCLIENTE
      ELSE COALESCE(L_EXACT.CODCONDICIONCLIENTE, L_FALLBACK.CODCONDICIONCLIENTE)
    END AS CODCONDICIONCLIENTE,

    CASE
      WHEN A.LEAD_CEF IN ('REACTIVO','CONS APR','CONS CONV')
        THEN L_FALLBACK.MTOFINALOFERTADOSOL
      ELSE COALESCE(L_EXACT.MTOFINALOFERTADOSOL, L_FALLBACK.MTOFINALOFERTADOSOL)
    END AS MTOFINALOFERTADOSOL,

    CASE
      WHEN A.LEAD_CEF IN ('REACTIVO','CONS APR','CONS CONV')
        THEN L_FALLBACK.NUMPLAZO
      ELSE COALESCE(L_EXACT.NUMPLAZO, L_FALLBACK.NUMPLAZO)
    END AS PLAZO,

    CASE
      WHEN A.LEAD_CEF IN ('REACTIVO','CONS APR','CONS CONV')
        THEN L_FALLBACK.PCTTASAEFECTIVAANUAL
      ELSE COALESCE(L_EXACT.PCTTASAEFECTIVAANUAL, L_FALLBACK.PCTTASAEFECTIVAANUAL)
    END AS TEA

  FROM VENTAS_SOLICITUDES A

  -- match exacto por CIC + LEAD_CEF
  LEFT JOIN LEADS_UNICOS L_EXACT
    ON TRIM(A.CODINTERNOCOMPUTACIONAL) = TRIM(L_EXACT.CODINTERNOCOMPUTACIONAL)
   AND A.LEAD_CEF = L_EXACT.LEAD_CEF

  -- fallback solo por CIC
  LEFT JOIN LEADS_UNICOS L_FALLBACK
    ON TRIM(A.CODINTERNOCOMPUTACIONAL) = TRIM(L_FALLBACK.CODINTERNOCOMPUTACIONAL)
)
