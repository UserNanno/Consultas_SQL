WITH
PARAMS AS (
  SELECT
    ${codmes} AS CODMES,
    CAST(date_format(add_months(to_date(CAST(${codmes} AS STRING),'yyyyMM'),1),'yyyyMM') AS INT) AS CODMES_1
),
MD_EVALUACIONSOLICITUDCREDITO AS (
	SELECT
		A.CODEVALUACIONSOLICITUD,
		A.CODIDEVALUACION,
		A.FECEVALUACION,
		A.CODINTERNOCOMPUTACIONAL,
		A.NUMSOLICITUDEVALUACION,
		A.CODSECUENCIALDECISIONRBM,
		A.DESDECISIONEVALUACION,
		A.DESREGLAPAUTA,
		A.DESTIPDECISIONRESULTADORBM,
		A.DESEVALUACION,
		A.MTOCEMEVALUACION,
		A.DESCAMPANIASOLICITUD,
		A.DESTIPEVALUACIONSOLICITUDCREDITO,
		A.DESCANALVENTARBMPER,
		(CASE
			WHEN A.DESCANALVENTARBMPER = 'SALEFORCE' THEN SUBSTR(TRIM(A.NUMSOLICITUDEVALUACION), 5, 7)
			WHEN A.DESCANALVENTARBMPER = 'LOANS' THEN SUBSTR(TRIM(A.NUMSOLICITUDEVALUACION), 3, 8)
			ELSE TRIM(A.NUMSOLICITUDEVALUACION)
		END) AS NUMSOLICITUDCORTO,
		(CASE
			WHEN A.DESTIPDECISIONRESULTADORBM = 'Approve' then 1
			WHEN A.DESTIPDECISIONRESULTADORBM = 'Decline' then 3
			ELSE 2
		END) AS RESULTADORBMJERARQUIA,
		(CASE
			WHEN A.DESCANALVENTARBMPER = 'BANCA MÓVIL' AND A.DESEVALUACION = 'df_Regular' THEN '0.No valido'
			WHEN A.DESCAMPANIASOLICITUD = 'Reactivo' THEN '1.Reactivo'
			ELSE '2.No Reactivo'
		END) AS EVALUACIONREACTIVO,
		(CASE
			WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO IN ('Regular LD', 'Cuotealo') AND A.DESCAMPANIASOLICITUD IN ('100% Aprobado', 'Pre-Aprobado') THEN 'LD APR'
			WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO IN ('Regular LD', 'Cuotealo') AND A.DESCAMPANIASOLICITUD = 'CEF Shield' THEN 'LD SHD'
			WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'Regular LD' AND A.DESCAMPANIASOLICITUD = 'Convenio' THEN 'LD CONV'
			WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'Regular LD' AND A.DESCAMPANIASOLICITUD = 'Invitado' THEN 'LD INV'
			
			WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'Compra de Deuda' AND A.DESCAMPANIASOLICITUD IN ('100% Aprobado', 'Pre-Aprobado') THEN 'CDD APR'
			WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'Compra de Deuda' AND A.DESCAMPANIASOLICITUD = 'Convenio' THEN 'CDD CONV'
			
			WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'LD + Consolidación' AND A.DESCAMPANIASOLICITUD IN ('100% Aprobado', 'Pre-Aprobado') THEN 'REE APR'
			WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'LD + Consolidación' AND A.DESCAMPANIASOLICITUD = 'Convenio'  THEN 'REE CONV'
			
			WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'LD + Compra de Deuda + Consolidación' AND A.DESCAMPANIASOLICITUD IN ('100% Aprobado', 'Pre-Aprobado') THEN 'CONS APR'
			WHEN A.DESTIPEVALUACIONSOLICITUDCREDITO = 'LD + Compra de Deuda + Consolidación' AND A.DESCAMPANIASOLICITUD = 'Convenio' THEN 'CONS CONV'
			
			ELSE 'REACTIVO'
		END) AS LEAD_CEF
	FROM CATALOG_LHCL_PROD_BCP.BCP_DDV_RBMRBMPER_MODELOGESTION_VU.MD_EVALUACIONSOLICITUDCREDITO A
	CROSS JOIN PARAMS P
	WHERE A.TIPPRODUCTOSOLICITUDRBM = 'CC' AND A.DESCANALVENTARBMPER NOT IN ('YAPE', 'OTROS') AND A.CODMESEVALUACION = P.CODMES
),
SOLICITUDESUNICAS AS (
	SELECT *
	FROM MD_EVALUACIONSOLICITUDCREDITO
	WHERE EVALUACIONREACTIVO <> '0.No valido'
	QUALIFY ROW_NUMBER() OVER (
		PARTITION BY CODINTERNOCOMPUTACIONAL, NUMSOLICITUDEVALUACION
		ORDER BY RESULTADORBMJERARQUIA ASC, FECEVALUACION DESC
	) = 1
),
H_TIPOCAMBIO AS (
	SELECT
		CAST(date_format(A.FECTIPCAMBIO, 'yyyyMM') AS INT) AS CODMES,
		A.FECTIPCAMBIO,
		A.CODMONEDAORIGEN,
		A.CODMONEDADESTINO,
		A.MTOCAMBIOMONEDAORIGENMONEDADESTINO
	FROM CATALOG_LHCL_PROD_BCP.BCP_UDV_INT_VU.H_TIPOCAMBIO A
	CROSS JOIN PARAMS P
	WHERE A.CODMONEDADESTINO = '0001' AND A.CODAPP = 'GLM' AND CAST(date_format(A.FECTIPCAMBIO, 'yyyyMM') AS INT) BETWEEN P.CODMES AND P.CODMES_1
),
TP_TIPOCAMBIO_MAXDAY AS (
	SELECT
		CODMES,
		MAX(FECTIPCAMBIO) AS FECTIPCAMBIO
	FROM H_TIPOCAMBIO
	GROUP BY CODMES
),
M_TIPOCAMBIO AS (
	SELECT
		A.CODMES,
		A.FECTIPCAMBIO,
		A.CODMONEDAORIGEN,
		A.CODMONEDADESTINO,
		A.MTOCAMBIOMONEDAORIGENMONEDADESTINO
	FROM H_TIPOCAMBIO A
	JOIN TP_TIPOCAMBIO_MAXDAY B ON (A.CODMES = B.CODMES AND A.FECTIPCAMBIO = B.FECTIPCAMBIO)
	QUALIFY ROW_NUMBER() OVER (
		PARTITION BY A.CODMES, A.CODMONEDAORIGEN
		ORDER BY A.CODMONEDAORIGEN
	) = 1
)

