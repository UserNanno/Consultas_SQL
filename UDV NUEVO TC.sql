BASE_FLAGS AS (
  SELECT
    m.CODEVALUACIONSOLICITUD,
    m.CODINTERNOCOMPUTACIONAL,
    m.CODMESEVALUACION AS CODMESSOLICITUDEVALUACION,
    m.FECSOLICITUDEVALUACION,
    m.DESCANALVENTARBMPER AS DESCANALVENTARBM,
    m.DESTIPDECISIONRESULTADORBM,
    m.DESCAMPANIASOLICITUD,
    m.DESTIPEVALUACIONSOLICITUDCREDITO,
    m.CANAL_MDPREST,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM = 'Approve' THEN 1 ELSE 0 END AS FLG_APROBADO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM IN ('Decline', 'Investigate') THEN 1 ELSE 0 END AS FLG_DENEGADO,
    m.FLG_REINGRESO_1M,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM = 'Approve' AND m.FECAPERTURA IS NOT NULL THEN 1 ELSE 0 END AS FLG_DESEMBOLSADO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM = 'Approve' AND m.FECAPERTURA IS NULL     THEN 1 ELSE 0 END AS FLG_NODESEMBOLSADO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM = 'Approve' AND m.FLG_REINGRESO_1M = 1 AND m.FECAPERTURA IS NOT NULL THEN 1 ELSE 0 END AS FLG_REINGRESO_1M_DESEMBOLSO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM = 'Approve' AND m.FLG_REINGRESO_1M = 1 AND m.FECAPERTURA IS NULL     THEN 1 ELSE 0 END AS FLG_REINGRESO_1M_NO_DESEMBOLSO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM = 'Approve' AND m.FLG_REINGRESO_1M = 0 AND m.FECAPERTURA IS NULL     THEN 1 ELSE 0 END AS FLG_NOREINGRESO_NODESEMBOLSO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM = 'Approve' THEN COALESCE(m.MTODESEMBOLSADO, 0) ELSE 0 END    AS MTODESEMBOLSADO,
    CASE WHEN m.DESTIPDECISIONRESULTADORBM = 'Approve' THEN COALESCE(m.MTOORIGINALCREDITO, 0) ELSE 0 END AS MTOORIGINALCREDITO,
    CASE
      WHEN m.FLG_REINGRESO_1M = 1 AND m.FECAPERTURA IS NOT NULL THEN COALESCE(m.MTODESEMBOLSADO, 0)
      ELSE 0
    END AS MTODESEMBOLSADO_REINGRESO_1M
  FROM MATCH_ONE m
),
TP_BASE AS (
SELECT
  CODEVALUACIONSOLICITUD,
  CODINTERNOCOMPUTACIONAL,
  CODMESSOLICITUDEVALUACION,
  FECSOLICITUDEVALUACION,
  DESCANALVENTARBM,
  DESTIPDECISIONRESULTADORBM,
  DESCAMPANIASOLICITUD,
  DESTIPEVALUACIONSOLICITUDCREDITO,
  CANAL_MDPREST,
  FLG_APROBADO,
  FLG_DENEGADO,
  FLG_REINGRESO_1M,
  FLG_DESEMBOLSADO,
  FLG_NODESEMBOLSADO,
  FLG_REINGRESO_1M_DESEMBOLSO,
  FLG_REINGRESO_1M_NO_DESEMBOLSO,
  FLG_NOREINGRESO_NODESEMBOLSO,
  MTODESEMBOLSADO,
  MTOORIGINALCREDITO,
  MTODESEMBOLSADO_REINGRESO_1M
FROM BASE_FLAGS
),
FUNNEL AS (
  SELECT
    CODMESSOLICITUDEVALUACION,
    DESCANALVENTARBM,
    CANAL_MDPREST,
    DESCAMPANIASOLICITUD,
    DESTIPEVALUACIONSOLICITUDCREDITO,
    COUNT(*)                         AS N_SOLICITUDES,
    SUM(FLG_APROBADO)               AS N_APROBADAS,
    SUM(FLG_DENEGADO)               AS N_DENEGADAS,
    SUM(FLG_REINGRESO_1M)           AS N_REINGRESOS,
    SUM(FLG_DESEMBOLSADO)           AS N_DESEMBOLSADAS,
    SUM(FLG_NODESEMBOLSADO)         AS N_NO_DESEMBOLSADAS,
    SUM(FLG_REINGRESO_1M_DESEMBOLSO)    AS N_REINGRESO_DESEMBOLSO,
    SUM(FLG_REINGRESO_1M_NO_DESEMBOLSO) AS N_REINGRESO_NO_DESEMBOLSO,
    SUM(FLG_NOREINGRESO_NODESEMBOLSO)   AS N_NOREINGRESO_NO_DESEMBOLSO,
    SUM(MTODESEMBOLSADO)              AS MTO_TOTAL_DESEMBOLSADO,
    SUM(MTOORIGINALCREDITO)           AS MTO_TOTAL_ORIGINAL,
    SUM(MTODESEMBOLSADO_REINGRESO_1M) AS MTO_DESEMBOLSADO_REINGRESO_1M
  FROM BASE_FLAGS
  WHERE CODMESSOLICITUDEVALUACION BETWEEN 202501 AND 202512 AND DESCANALVENTARBM NOT IN ('SALEFORCE')
  
  GROUP BY
    CODMESSOLICITUDEVALUACION,
    DESCANALVENTARBM,
    CANAL_MDPREST,
    DESCAMPANIASOLICITUD,
    DESTIPEVALUACIONSOLICITUDCREDITO
)

SELECT *
FROM FUNNEL
ORDER BY CODMESSOLICITUDEVALUACION, DESCANALVENTARBM;
