HM_LEADS_BDI AS (
	SELECT
		CODLOTEOFERTA,
		CODINTERNOCOMPUTACIONAL,
		TIPVENTA,
		TIPOFERTA,
		DESCAMPANA,
		CODCONDICIONCLIENTE,
		ROUND(MTOFINALOFERTADOSOL, 1) AS MTOFINALOFERTADOSOL,
		ROUND(NUMPLAZO, 0) AS NUMPLAZO,
		PCTTASAEFECTIVAANUAL,
		FECINICIOVIGENCIA,
		CAST(date_format(FECINICIOVIGENCIA, 'yyyyMM') AS INT) AS CODMESINICIOVIGENCIA,
		(CASE
			WHEN TIPVENTA = 6 AND TIPOFERTA = 3 AND CODCONDICIONCLIENTE = 'INV' THEN 'CEF LD INVITADO'
			WHEN TIPVENTA = 6 AND TIPOFERTA = 3 AND CODCONDICIONCLIENTE = 'PRE' THEN 'CEF LD PREAPROBADO'
			WHEN TIPVENTA = 6 AND TIPOFERTA = 3 AND CODCONDICIONCLIENTE = 'APR' THEN 'CEF LD 100% APROBADO'
			WHEN TIPVENTA = 6 AND TIPOFERTA = 3 AND CODCONDICIONCLIENTE = 'OPT' THEN 'CEF LD OPTIMUS'
			WHEN TIPVENTA = 6 AND TIPOFERTA IN (89, 98) THEN 'CEF SHIELD'
			WHEN TIPVENTA = 6 AND TIPOFERTA = 41 AND CODCONDICIONCLIENTE = 'PRE' THEN 'CEF CDD PREAPROBADO'
			WHEN TIPVENTA = 6 AND TIPOFERTA = 41 AND CODCONDICIONCLIENTE = 'APR' THEN 'CEF CDD 100% APROBADO'
			WHEN TIPVENTA = 6 AND TIPOFERTA = 187 THEN 'CEF CDD INSUPERABLE'
			WHEN TIPVENTA = 6 AND TIPOFERTA = 38 AND CODCONDICIONCLIENTE = 'PRE' THEN 'CEF RE PREAPROBADO'
			WHEN TIPVENTA = 6 AND TIPOFERTA = 38 AND CODCONDICIONCLIENTE = 'APR' THEN 'CEF RE 100% APROBADO'
			WHEN TIPVENTA = 110 AND TIPOFERTA = 3 THEN 'CEF CONVENIO LD'
			WHEN TIPVENTA = 110 AND TIPOFERTA = 41 THEN 'CEF CONVENIO CDD'
			WHEN TIPVENTA = 110 AND TIPOFERTA = 38 THEN 'CEF CONVENIO RE'
		END) AS PRODUCTO,
		ROW_NUMBER() OVER (
			PARTITION BY CODLOTEOFERTA, CODINTERNOCOMPUTACIONAL, TIPVENTA, TIPOFERTA
			ORDER BY FECINICIOVIGENCIA
		) AS N
	FROM CATALOG_LHCL_PROD_BCP.BCP_EDV_RBMBDN.HM_LEADS_BDI
	WHERE CODPAUTARBM <> 41 AND TIPVENTA IN (6,110) AND DESCAMPANA NOT IN ('CREDITO PERSONAL, VENTA AMPLIACION PLAZO', 'VENTA SKIP')
),
BASE_LEADS AS (
	SELECT
		A.CODLOTEOFERTA,
		A.CODINTERNOCOMPUTACIONAL,
		A.TIPVENTA,
		A.TIPOFERTA,
		A.DESCAMPANA,
		A.CODCONDICIONCLIENTE,
		A.MTOFINALOFERTADOSOL,
		A.NUMPLAZO,
		A.PCTTASAEFECTIVAANUAL,
		(CASE
			WHEN A.TIPVENTA = 6 AND A.TIPOFERTA = 3 AND A.CODCONDICIONCLIENTE IN ('APR', 'PRE') THEN 1
			WHEN A.TIPVENTA = 6 AND A.TIPOFERTA = 3 AND A.CODCONDICIONCLIENTE = 'OPT' THEN 2
			WHEN A.TIPVENTA = 6 AND A.TIPOFERTA = 41 AND A.CODCONDICIONCLIENTE IN ('APR', 'PRE') THEN 3
			WHEN A.TIPVENTA = 6 AND A.TIPOFERTA = 38 AND A.CODCONDICIONCLIENTE IN ('APR', 'PRE') THEN 4
			WHEN A.TIPVENTA = 6 AND A.TIPOFERTA IN (89, 98) THEN 5
			WHEN A.TIPVENTA = 6 AND A.TIPOFERTA = 3 AND A.CODCONDICIONCLIENTE = 'INV' THEN 6
			WHEN A.TIPVENTA = 6 AND A.TIPOFERTA = 187 THEN 7
			WHEN A.TIPVENTA = 110 AND A.TIPOFERTA = 3 THEN 8
			WHEN A.TIPVENTA = 110 AND A.TIPOFERTA = 41 THEN 9
			WHEN A.TIPVENTA = 110 AND A.TIPOFERTA = 38 THEN 10
		END) AS PRIORIDADLEAD,
		(CASE
			WHEN A.TIPVENTA = 6 AND A.TIPOFERTA = 3 AND A.CODCONDICIONCLIENTE IN ('APR', 'PRE') THEN 'LD APR'
			WHEN A.TIPVENTA = 6 AND A.TIPOFERTA = 3 AND A.CODCONDICIONCLIENTE = 'OPT' THEN 'LD OPT'
			WHEN A.TIPVENTA = 6 AND A.TIPOFERTA = 41 AND A.CODCONDICIONCLIENTE IN ('APR', 'PRE') THEN 'CDD APR'
			WHEN A.TIPVENTA = 6 AND A.TIPOFERTA = 38 AND A.CODCONDICIONCLIENTE IN ('APR', 'PRE') THEN 'REE APR'
			WHEN A.TIPVENTA = 6 AND A.TIPOFERTA IN (89, 98) THEN 'LD SHD'
			WHEN A.TIPVENTA = 6 AND A.TIPOFERTA = 3 AND A.CODCONDICIONCLIENTE = 'INV' THEN 'LD INV'
			WHEN A.TIPVENTA = 6 AND A.TIPOFERTA = 187 THEN 'CDD INS'
			WHEN A.TIPVENTA = 110 AND A.TIPOFERTA = 3 THEN 'LD CONV'
			WHEN A.TIPVENTA = 110 AND A.TIPOFERTA = 41 THEN 'CDD CONV'
			WHEN A.TIPVENTA = 110 AND A.TIPOFERTA = 38 THEN 'REE CONV'
--			WHEN A.TIPVENTA = 127 AND A.TIPOFERTA = 3 THEN 'LD MULTI' - FALTA TRAER TIPVENTA 127 DE BASE DE LEADS
		END) AS LEAD_CEF
	FROM HM_LEADS_BDI A
	CROSS JOIN PARAMS P
	WHERE A.N = 1 AND PRODUCTO IS NOT NULL AND CODMESINICIOVIGENCIA = P.CODMES
)
